<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è’å²›æ±‚ç”Ÿå¤§æŒ‘æˆ˜</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #e8e5e0 0%, #d4d1cc 50%, #c5c2bd 100%);
            color: #5a5753;
            min-height: 100vh;
            padding: 20px;
        }
        .word-item.usable {
            box-shadow: 0 0 0 2px rgba(157, 143, 167, 0.4);
        }
        .spinner {
            border: 4px solid rgba(200, 195, 188, 0.3);
            border-radius: 50%;
            border-top: 4px solid #9fa8b8;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast æç¤ºæ ·å¼ */
        .toast {
            background: rgba(232, 229, 224, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px 20px;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(90, 87, 83, 0.15);
            border: 1px solid rgba(200, 195, 188, 0.3);
            pointer-events: auto;
            animation: toastSlideIn 0.3s ease-out;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast.success {
            border-left: 4px solid #a8b5a0;
        }
        
        .toast.error {
            border-left: 4px solid #c4a5a5;
        }
        
        .toast.warning {
            border-left: 4px solid #c9b89b;
        }
        
        .toast.info {
            border-left: 4px solid #a5aeb8;
        }
        
        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
            color: #5a5753;
        }
        
        .toast-message {
            font-size: 13px;
            color: #7a7773;
            line-height: 1.5;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: #9a9793;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: color 0.2s;
        }
        
        .toast-close:hover {
            color: #5a5753;
        }
        
        .toast.fade-out {
            animation: toastFadeOut 0.3s ease-in forwards;
        }
        
        @keyframes toastFadeOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* æ¨¡æ€å¯¹è¯æ¡†æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(90, 87, 83, 0.5);
            backdrop-filter: blur(5px);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .modal-dialog {
            background: linear-gradient(135deg, rgba(232, 229, 224, 0.98) 0%, rgba(220, 217, 212, 0.98) 100%);
            border-radius: 20px;
            padding: 32px;
            min-width: 400px;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(90, 87, 83, 0.2);
            border: 2px solid rgba(157, 150, 167, 0.4);
            animation: modalSlideIn 0.3s ease-out;
            position: relative;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-30px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .modal-icon {
            font-size: 48px;
            line-height: 1;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }
        
        .modal-content {
            color: #7a7773;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 24px;
        }
        
        .modal-button {
            background: linear-gradient(135deg, #a5aeb8 0%, #9d96a7 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 32px;
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            box-shadow: 0 4px 12px rgba(165, 174, 184, 0.3);
        }
        
        .modal-button:hover {
            background: linear-gradient(135deg, #959ea8 0%, #8d8697 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(165, 174, 184, 0.4);
        }
        
        .modal-button:active {
            transform: translateY(0);
        }
        
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 2.0fr 1.8fr 1.4fr; 
            gap: 20px;
            height: auto;
        }
        
        /* å·¦ä¾§ï¼šèµ„æºä¸çŠ¶æ€ */
        .left-pane {
            display: flex;
            flex-direction: row;
            gap: 16px;
            height: 100%;
        }
        .status-column {
            flex: 0 0 220px;
        }
        .status-column .fusion-area {
            background: rgba(240, 236, 230, 0.7);
            border: 2px solid rgba(201, 184, 155, 0.5);
        }
        .left-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .left-main .fusion-area {
            background: rgba(235, 230, 235, 0.7);
            border: 2px solid rgba(157, 150, 167, 0.5);
        }
        .inventory {
            background: rgba(228, 230, 235, 0.7);
            border-radius: 15px;
            padding: 20px;
            max-height: 55vh;
            overflow-y: auto;
            border: 2px solid rgba(165, 174, 184, 0.5);
        }
        /* èµ„æºåº“ä¸€æ’ä¸¤ä¸ªç‰©èµ„ */
        #word-inventory {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }
        
        .word-item {
            background: rgba(220, 217, 212, 0.7);
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 10px;
            cursor: grab;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(200, 195, 188, 0.3);
            color: #5a5753;
        }
        
        .word-item:hover {
            background: rgba(232, 229, 224, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(90, 87, 83, 0.1);
        }
        
        .word-emoji {
            font-size: 24px;
        }
        
        /* ä¸­é—´ï¼šæ¸¸æˆåŒºåŸŸ */
        .game-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .room-display {
            background: rgba(232, 229, 224, 0.7);
            border-radius: 15px;
            padding: 25px;
            flex-grow: 1;
            border: 2px solid rgba(157, 150, 167, 0.5);
            color: #5a5753;
        }
        
        .fusion-area {
            background: rgba(235, 230, 235, 0.7);
            border-radius: 15px;
            padding: 20px;
            min-height: 200px;
            border: 2px solid rgba(157, 150, 167, 0.5);
        }
        
        .slot {
            display: block;
            width: 100%;
            min-height: 52px;
            margin: 6px 0;
            padding: 10px 14px;
            background: rgba(220, 217, 212, 0.4);
            border-radius: 10px;
            border: 2px dashed #b8b3b5;
            font-size: 16px;
            color: #7a7773;
            text-align: left;
            line-height: 1.4;
        }
        
        .fusion-btn {
            background: linear-gradient(45deg, #9d96a7, #a5aeb8);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .fusion-btn:hover {
            background: linear-gradient(45deg, #8d8697, #959ea8);
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(157, 150, 167, 0.3);
        }
        
        /* å³ä¾§ï¼šç»“æœå±•ç¤º */
        .results {
            background: rgba(230, 235, 230, 0.7);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: calc(100vh - 40px);
            border: 2px solid rgba(168, 181, 160, 0.5);
        }
        
        #fusion-results {
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            max-height: calc(100vh - 120px);
            padding-right: 10px;
            /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
            scrollbar-width: thin;
            scrollbar-color: rgba(159, 168, 184, 0.5) rgba(220, 217, 212, 0.3);
        }
        
        #fusion-results::-webkit-scrollbar {
            width: 8px;
        }
        
        #fusion-results::-webkit-scrollbar-track {
            background: rgba(220, 217, 212, 0.3);
            border-radius: 10px;
        }
        
        #fusion-results::-webkit-scrollbar-thumb {
            background: rgba(159, 168, 184, 0.5);
            border-radius: 10px;
        }
        
        #fusion-results::-webkit-scrollbar-thumb:hover {
            background: rgba(159, 168, 184, 0.7);
        }
        
        .result-card {
            background: rgba(235, 238, 235, 0.6);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid rgba(168, 181, 160, 0.6);
            color: #5a5753;
        }
        
        .word-image {
            width: 100%;
            border-radius: 10px;
            margin: 10px 0;
        }
        /* ç®€å•çš„çŠ¶æ€æ¡æ ·å¼ */
        .status-bar-bg {
            width: 100%;
            height: 10px;
            background: rgba(200, 195, 188, 0.3);
            border-radius: 999px;
            overflow: hidden;
            margin-top: 4px;
        }
        .status-bar-fill {
            height: 100%;
            width: 50%;
            background: linear-gradient(90deg, #aceb5f, #68c6f5);
            border-radius: 999px;
            transition: width 0.3s ease;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
                height: auto;
            }
            .left-pane {
                flex-direction: column;
            }
            .inventory {
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <!-- å¼€å§‹é¡µé¢ -->
    <div id="start-page" style="
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    ">
        <div style="
            background: rgba(232, 229, 224, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(90, 87, 83, 0.2);
            border: 2px solid rgba(157, 150, 167, 0.3);
        ">
            <h1 style="
                text-align: center;
                margin-bottom: 30px;
                color: #5a5753;
                font-size: 2em;
            ">ğŸï¸ è’å²›æ±‚ç”Ÿå¤§æŒ‘æˆ˜ ğŸï¸</h1>
            
            <div style="margin-bottom: 25px;">
                <label style="
                    display: block;
                    margin-bottom: 8px;
                    color: #5a5753;
                    font-weight: 500;
                ">ä½ çš„åå­—ï¼š</label>
                <input type="text" id="player-name-input" placeholder="è¯·è¾“å…¥ä½ çš„åå­—" style="
                    width: 100%;
                    padding: 12px;
                    border: 2px solid rgba(157, 150, 167, 0.4);
                    border-radius: 10px;
                    background: rgba(255, 255, 255, 0.6);
                    color: #5a5753;
                    font-size: 16px;
                    box-sizing: border-box;
                ">
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="
                    display: block;
                    margin-bottom: 8px;
                    color: #5a5753;
                    font-weight: 500;
                ">æè¿°ä½ çš„å½¢è±¡ï¼ˆ20å­—ä»¥å†…ï¼‰ï¼š</label>
                <textarea id="player-appearance-input" placeholder="ä¾‹å¦‚ï¼šæ£•è‰²çŸ­å‘ï¼Œç©¿ç€ç®€å•çš„Tæ¤ï¼Œç¬‘å®¹æ¸©å’Œ" style="
                    width: 100%;
                    padding: 12px;
                    border: 2px solid rgba(157, 150, 167, 0.4);
                    border-radius: 10px;
                    background: rgba(255, 255, 255, 0.6);
                    color: #5a5753;
                    font-size: 16px;
                    min-height: 100px;
                    resize: vertical;
                    box-sizing: border-box;
                    font-family: 'Segoe UI', sans-serif;
                "></textarea>
                <div style="
                    text-align: right;
                    margin-top: 5px;
                    font-size: 14px;
                    color: #7a7773;
                ">
                    <span id="char-count">0</span>/20 å­—
                </div>
            </div>
            
            <div id="character-image-container" style="
                margin-bottom: 25px;
                min-height: 300px;
                background: rgba(220, 217, 212, 0.4);
                border-radius: 15px;
                border: 2px dashed rgba(157, 150, 167, 0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                display: none;
            ">
                <img id="character-image" src="" alt="è§’è‰²å½¢è±¡" style="
                    max-width: 100%;
                    max-height: 400px;
                    border-radius: 15px;
                ">
            </div>
            
            <div id="button-container" style="text-align: center;">
                <button id="generate-image-btn" onclick="generateCharacterImage()" style="
                    background: rgba(168, 181, 160, 0.3);
                    border: 2px solid rgba(168, 181, 160, 0.6);
                    color: #5a5753;
                    padding: 14px 32px;
                    border-radius: 999px;
                    font-size: 16px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.3s;
                ">å¼€å§‹ç”Ÿæˆå½¢è±¡</button>
                
                <div id="after-generate-buttons" style="display: none; gap: 15px;">
                    <button onclick="generateCharacterImage()" style="
                        background: rgba(165, 174, 184, 0.3);
                        border: 2px solid rgba(165, 174, 184, 0.6);
                        color: #5a5753;
                        padding: 14px 32px;
                        border-radius: 999px;
                        font-size: 16px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.3s;
                        margin-right: 15px;
                    ">é‡æ–°ç”Ÿæˆå½¢è±¡</button>
                    <button onclick="startGame()" style="
                        background: rgba(168, 181, 160, 0.4);
                        border: 2px solid rgba(168, 181, 160, 0.7);
                        color: #5a5753;
                        padding: 14px 32px;
                        border-radius: 999px;
                        font-size: 16px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.3s;
                    ">å¼€å§‹æ¸¸æˆ</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä¸»é¡µé¢ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="main-game" style="display: none;">
    <h1 style="text-align: center; margin-bottom: 20px; color: #7a7773;">ğŸï¸ è’å²›æ±‚ç”Ÿå¤§æŒ‘æˆ˜ ğŸï¸</h1>
    
    <div class="container">
        <!-- å·¦ä¾§ï¼šç”Ÿå­˜çŠ¶æ€ + èµ„æºåº“å­˜ -->
        <div class="left-pane">
            <!-- ç”Ÿå­˜çŠ¶æ€æ”¾åœ¨èµ„æºåº“å·¦è¾¹ -->
            <div class="status-column">
                <div class="fusion-area">
                    <h3>ğŸï¸ çŠ¶æ€</h3>
                    <div id="status-panel">
                        <p>ç”Ÿå­˜çŠ¶æ€å€¼ï¼š<span id="survival-value"></span></p>
                        <div class="status-bar-bg">
                            <div id="survival-bar" class="status-bar-fill"></div>
                        </div>
                        <p style="margin-top:8px;">åº‡æŠ¤æ‰€åšå›ºå€¼ï¼š<span id="shelter-durability-value"></span></p>
                        <div class="status-bar-bg">
                            <div id="shelter-durability-bar" class="status-bar-fill"></div>
                        </div>
                        <p style="margin-top:12px;">å½“å‰å¤©æ°”ï¼š<span id="weather-name">åŠ è½½ä¸­...</span></p>
                        <div id="weather-image" style="margin-top:8px; min-height:80px; border-radius:8px; background:rgba(220, 217, 212, 0.3); display:flex; align-items:center; justify-content:center;">
                            <p style="color:#9ca3af; font-size:0.9em;">å¤©æ°”å›¾ç‰‡åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </div>
                <div class="fusion-area" style="margin-top: 10px;">
                    <h3>ğŸ” å¯»æ‰¾ç‰©èµ„(1âš¡)</h3>
                    <p style="font-size: 0.9em; color: #9ca3af; margin: 4px 0 10px 0;">æ¶ˆè€—1è¡ŒåŠ¨ç‚¹æ¢ç´¢åœ°ç‚¹ï¼Œå¯»æ‰¾ç‰©èµ„</p>
                    <div id="location-buttons-container" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- åœ°ç‚¹æŒ‰é’®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <!-- è§£é”ç•Œé¢ -->
                    <div id="unlock-location-modal" style="display: none; margin-top: 10px; padding: 10px; background: rgba(220,217,212,0.5); border-radius: 8px; border: 2px dashed #c9b89b;">
                        <p style="font-size: 0.9em; margin-bottom: 8px; color: #c9b89b;" id="unlock-location-text"></p>
                        <div id="unlock-location-slot" class="slot" style="margin: 0 auto; width: 80%; cursor: pointer; min-height: 40px;">
                            æ‹–æ”¾ç‰©å“åˆ°æ­¤å¤„è§£é”
                        </div>
                        <div style="text-align: center; margin-top: 8px;">
                            <button class="fusion-btn" onclick="confirmUnlockLocation()" id="confirm-unlock-btn" style="display: none;">ç¡®è®¤è§£é”</button>
                            <button class="fusion-btn" onclick="cancelUnlockLocation()" style="background: rgba(196, 165, 165, 0.3); border-color: #c4a5a5; color: #9a8686; margin-left: 8px;">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="left-main">
        <div class="inventory">
                    <h3>ğŸ’ æˆ‘çš„èµ„æºåº“</h3>
            <div id="word-inventory">
                        <!-- ç‰©èµ„ä¼šé€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
                <!-- åˆæˆåŒºåŸŸç§»åŠ¨åˆ°èµ„æºåº“ä¸‹æ–¹ -->
                <div class="fusion-area">
                    <h3>âš—ï¸ ç‰©èµ„åˆæˆ</h3>
                    <p style="margin-top:4px;color:#835780;">å‰©ä½™åˆæˆæ¬¡æ•°ï¼š<span id="fusion-left">0</span></p>
                    
                    <div style="margin: 16px 0;">
                        <div class="slot" id="slot1">æ‹–æ”¾ç‰©èµ„</div>
                        <div style="text-align:center; margin:6px 0; font-size:22px; color:#9d96a7;">ï¼‹</div>
                        <div class="slot" id="slot2">æ‹–æ”¾ç‰©èµ„</div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="fusion-btn" onclick="performFusion()">å¼€å§‹åˆæˆï¼</button>
                        <button class="fusion-btn" onclick="resetSlots()" style="margin-left: 10px; background: rgba(145, 98, 98, 0.3); border-color: #c4a5a5; color: #9a8686;">æ¸…ç©º</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä¸­é—´ï¼šæ¸¸æˆåŒºåŸŸ -->
        <div class="game-area">
            <!-- å½“å‰æŒ‘æˆ˜ -->
        <div class="room-display" id="room-display">
                <h3>ğŸŒŠ å½“å‰ç”Ÿå­˜æŒ‘æˆ˜</h3>
            <p id="challenge-text">åŠ è½½ä¸­...</p>
                <!-- è¡ŒåŠ¨æ§½ä½ï¼šæ‹–åŠ¨ç‰©èµ„é€‰æ‹©è¡ŒåŠ¨ -->
                <div style="margin-top: 20px; padding: 20px; 
                            border: 3px dashed #22c5c53a; 
                        border-radius: 15px; 
                        text-align: center;
                            background: rgba(34, 186, 197, 0.05);
                            min-height: 80px;">
                    <p style="color: #a8b5a0; margin-bottom: 12px; font-weight: 500;">
                        ( 1âš¡) è¡ŒåŠ¨æ§½ä½ï¼šæ‹–åŠ¨ç‰©èµ„åˆ°è¿™é‡Œé€‰æ‹©è¡ŒåŠ¨
                    </p>
                    <div id="action-slot" class="action-slot" style="
                        width: 100%;
                        min-height: 60px;
                        background: rgba(220, 217, 212, 0.4);
                        border-radius: 10px;
                        border: 2px dashed #a8b5a0;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #7a7773;
                        font-size: 14px;
                        margin-bottom: 12px;
                    ">æ‹–æ”¾ç‰©èµ„åˆ°æ­¤å¤„</div>
                    <!-- è¡ŒåŠ¨é€‰æ‹©èœå•ï¼ˆæ‹–å…¥ç‰©èµ„åæ˜¾ç¤ºï¼‰ -->
                    <div id="action-menu" style="display: none;"></div>
                    <!-- æ¸…ç©ºè¡ŒåŠ¨æ§½ä½æŒ‰é’® -->
                    <div style="text-align: center; margin-top: 8px;">
                        <button onclick="resetActionSlot()" style="
                            background: rgba(196, 165, 165, 0.2);
                            border: 1px solid rgba(196, 165, 165, 0.5);
                            color: #9a8686;
                            padding: 4px 12px;
                            border-radius: 999px;
                            font-size: 12px;
                            cursor: pointer;
                        ">æ¸…ç©º</button>
                    </div>
            </div>
                <div style="margin-top: 16px; text-align: right;">
                    <button onclick="endDay()" style="
                        background: rgba(165, 174, 184, 0.2);
                        border: 1px solid rgba(165, 174, 184, 0.5);
                        color: #7a7773;
                        padding: 6px 14px;
                        border-radius: 999px;
                        font-size: 13px;
                        cursor: pointer;
                    ">ç»“æŸä»Šå¤© â–¶</button>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šç»“æœå±•ç¤º -->
        <div class="results">
            <!-- è¡ŒåŠ¨ç‚¹æ˜¾ç¤ºæ¿å— -->
                <div id="action-points-display" style="padding: 15px; background: rgba(235, 238, 235, 0.5); border-radius: 10px; border-left: 4px solid rgba(168, 181, 160, 0.6);">
                    <p style="font-size: 1.1em; color: #5a5753; margin: 0;">
                        <span id="day-action-status"></span>
                    </p>
                </div>
            
            <h3 style="margin-top: 25px;">ğŸ“œ åˆæˆè®°å½•ä¸äº‹ä»¶</h3>
            <div id="fusion-results">
                <!-- åˆæˆç»“æœä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            </div>
        </div>
    </div>
    </div>
    
    <!-- Toast æç¤ºå®¹å™¨ -->
    <div id="toast-container" style="
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 12px;
        pointer-events: none;
    "></div>
    
    <!-- æ¨¡æ€å¯¹è¯æ¡†å®¹å™¨ -->
    <div id="modal-container"></div>
    
    <script>
        // ============== æ ¸å¿ƒæ•°æ® ==============
        // é¢„ç½®çš„åŸºç¡€ç‰©èµ„ï¼ˆå¼€å±€ä»…æœ‰1ä¸ªLv1åŸææ–™"æœ¨æ£"ï¼‰
        const basicWords = [
            { id: 1, text: "æœ¨æ£", emoji: "ğŸŒ¿", tag: "material", level: 1, usesLeft: 2 }
        ];

        // ============== å®Œæ•´ç‰©èµ„åˆ—è¡¨ ==============
        // å®šä¹‰æ‰€æœ‰1-4çº§çš„ç‰©èµ„ï¼Œç”¨äºåˆæˆé…æ–¹åŒ¹é…
        const MATERIAL_DATABASE = {
            // ä¸€çº§ç‰©èµ„
            "æœ¨æ£": { emoji: "ğŸŒ¿", tag: "material", level: 1 },
            "çŸ³å¤´": { emoji: "ğŸª¨", tag: "material", level: 1 },
            "è—¤è”“": { emoji: "ğŸŒ¿", tag: "material", level: 1 },
            "å¹²è‰": { emoji: "ğŸŒ¾", tag: "material", level: 1 },
            "æ¤°å­": { emoji: "ğŸ¥¥", tag: "material", level: 1 },
            "è´å£³": { emoji: "ğŸš", tag: "material", level: 1 },
            "ç”Ÿé±¼": { emoji: "ğŸŸ", tag: "food", level: 1 },
            "é‡æœ": { emoji: "ğŸ", tag: "food", level: 1 },
            "æµ·è‰": { emoji: "ğŸŒ¿", tag: "food", level: 1 },
            "ç”Ÿè‚‰": { emoji: "ğŸ¥©", tag: "food", level: 1 },
            "é¸Ÿè›‹": { emoji: "ğŸ¥š", tag: "food", level: 1 },
            "ç®€æ˜“æœ¨æ–§": { emoji: "ğŸª“", tag: "tool", level: 1 },
            "ç®€æ˜“æœ¨çŸ›": { emoji: "ğŸ”±", tag: "tool", level: 1 },
            "ç®€æ˜“æœ¨å‰": { emoji: "ğŸ”±", tag: "tool", level: 1 },
            
            // äºŒçº§ç‰©èµ„
            "æœ¨æ¿": { emoji: "ğŸªµ", tag: "material", level: 2 },
            "ç²—ç»³": { emoji: "ğŸª¢", tag: "material", level: 2 },
            "çŸ³ç‰‡": { emoji: "ğŸª¨", tag: "material", level: 2 },
            "æœ¨ç‚­": { emoji: "âš«", tag: "material", level: 2 },
            "ç®€æ˜“çŸ³æ–§": { emoji: "ğŸª“", tag: "tool", level: 2 },
            "æœ¨çŸ›": { emoji: "ğŸ”±", tag: "tool", level: 2 },
            "ç¯ç«": { emoji: "ğŸ”¥", tag: "tool", level: 2 },
            "ç®€æ˜“é±¼å‰": { emoji: "ğŸ”±", tag: "tool", level: 2 },
            "çƒ¤é±¼": { emoji: "ğŸŸ", tag: "food", level: 2 },
            "æ¤°è‚‰": { emoji: "ğŸ¥¥", tag: "food", level: 2 },
            "é£å¹²æœå¹²": { emoji: "ğŸ", tag: "food", level: 2 },
            "çƒ¤é¸Ÿè›‹": { emoji: "ğŸ¥š", tag: "food", level: 2 },
            "å°å…½è‚‰": { emoji: "ğŸ–", tag: "food", level: 2 },
            
            // ä¸‰çº§ç‰©èµ„
            "åšéŸ§è—¤æ¡": { emoji: "ğŸŒ¿", tag: "material", level: 3 },
            "æ‰“ç£¨çŸ³ç‰‡": { emoji: "ğŸª¨", tag: "material", level: 3 },
            "æœ¨æ¡†æ¶": { emoji: "ğŸªµ", tag: "material", level: 3 },
            "çŸ³åˆ€": { emoji: "ğŸ”ª", tag: "tool", level: 3 },
            "é•¿çŸ›": { emoji: "ğŸ”±", tag: "tool", level: 3 },
            "ç«æŠŠ": { emoji: "ğŸ”¥", tag: "tool", level: 3 },
            "æ•é±¼ç½‘": { emoji: "ğŸ•¸ï¸", tag: "tool", level: 3 },
            "çƒ¤é±¼ä¸²": { emoji: "ğŸ¢", tag: "food", level: 3 },
            "æ¤°æ±": { emoji: "ğŸ¥¥", tag: "food", level: 3 },
            "ç†è‚‰": { emoji: "ğŸ¥©", tag: "food", level: 3 },
            "çƒ¤å…½è‚‰": { emoji: "ğŸ–", tag: "food", level: 3 },
            "å¤§å—é±¼è‚‰": { emoji: "ğŸŸ", tag: "food", level: 3 },
            "è‚‰å¹²": { emoji: "ğŸ¥“", tag: "food", level: 3 },
            
            // å››çº§ç‰©èµ„
            "ç²¾åˆ¶æœ¨æ": { emoji: "ğŸªµ", tag: "material", level: 4 },
            "çŸ³åˆ¶å·¥å…·": { emoji: "ğŸª¨", tag: "material", level: 4 },
            "å¤åˆå·¥å…·": { emoji: "ğŸ› ï¸", tag: "tool", level: 4 },
            "è¥å…»é¤": { emoji: "ğŸ±", tag: "food", level: 4 },
            "ä¿å­˜é£Ÿç‰©": { emoji: "ğŸ¥«", tag: "food", level: 4 },
            "ç²¾åˆ¶è‚‰æ’": { emoji: "ğŸ¥©", tag: "food", level: 4 },
            "æµ·é²œå¤§é¤": { emoji: "ğŸ¦", tag: "food", level: 4 },
            "å¤§å‹ä¿¡å·ç«": { emoji: "ğŸ”¥", tag: "tool", level: 4 },
            "åå°„ä¿¡å·æ¿": { emoji: "ğŸª", tag: "material", level: 4 }
        };

        // ============== åˆæˆé…æ–¹è¡¨ ==============
        // æ ¼å¼ï¼šinputs: [ç‰©èµ„1åç§°, ç‰©èµ„2åç§°], result: ç»“æœç‰©èµ„åç§°
        // ç‰¹æ®Šé…æ–¹ï¼š
        // 1. ç¯ç«ï¼ˆå·¥å…·ï¼‰+ ç”Ÿé£Ÿï¼ˆé£Ÿç‰©ï¼‰= ç†Ÿé£Ÿï¼ˆé£Ÿç‰©ï¼‰
        // 2. é”‹åˆ©å·¥å…·ï¼ˆçŸ³åˆ€/é•¿çŸ›/ç®€æ˜“çŸ³æ–§/ç®€æ˜“é±¼å‰/æœ¨çŸ›ï¼‰+ æ¤°å­ï¼ˆåŸææ–™ï¼‰= æ¤°è‚‰ï¼ˆé£Ÿç‰©ï¼‰
        const FUSION_RECIPES = [
            // ä¸€çº§ -> äºŒçº§ï¼ˆå·¥å…·åˆ¶ä½œï¼‰
            { inputs: ["æœ¨æ£", "æœ¨æ£"], result: "æœ¨æ¿" },
            { inputs: ["æœ¨æ£", "çŸ³å¤´"], result: "ç®€æ˜“çŸ³æ–§" },
            { inputs: ["æœ¨æ£", "çŸ³ç‰‡"], result: "ç®€æ˜“çŸ³æ–§" },
            { inputs: ["æœ¨æ£", "è—¤è”“"], result: "æœ¨çŸ›" },
            { inputs: ["å¹²è‰", "æœ¨ç‚­"], result: "ç¯ç«" },
            { inputs: ["æœ¨æ£", "çŸ³ç‰‡"], result: "ç®€æ˜“é±¼å‰" },
            
            // ä¸€çº§ -> äºŒçº§ï¼ˆåŸææ–™åˆæˆï¼‰
            { inputs: ["è—¤è”“", "è—¤è”“"], result: "ç²—ç»³" },
            { inputs: ["çŸ³å¤´", "çŸ³å¤´"], result: "çŸ³ç‰‡" },
            { inputs: ["å¹²è‰", "æœ¨æ£"], result: "æœ¨ç‚­" },
            
            // ä¸€çº§ -> äºŒçº§ï¼ˆé£Ÿç‰©å¤„ç†ï¼‰
            { inputs: ["ç¯ç«", "ç”Ÿé±¼"], result: "çƒ¤é±¼" },
            { inputs: ["ç¯ç«", "é‡æœ"], result: "é£å¹²æœå¹²" },
            { inputs: ["ç¯ç«", "æµ·è‰"], result: "é£å¹²æœå¹²" },
            { inputs: ["çŸ³åˆ€", "æ¤°å­"], result: "æ¤°è‚‰" },
            { inputs: ["é•¿çŸ›", "æ¤°å­"], result: "æ¤°è‚‰" },
            { inputs: ["ç®€æ˜“çŸ³æ–§", "æ¤°å­"], result: "æ¤°è‚‰" },
            { inputs: ["ç®€æ˜“é±¼å‰", "æ¤°å­"], result: "æ¤°è‚‰" },
            { inputs: ["æœ¨çŸ›", "æ¤°å­"], result: "æ¤°è‚‰" },
            
            // äºŒçº§ -> ä¸‰çº§ï¼ˆåŸææ–™åˆæˆï¼‰
            { inputs: ["æœ¨æ¿", "ç²—ç»³"], result: "æœ¨æ¡†æ¶" },
            { inputs: ["ç²—ç»³", "ç²—ç»³"], result: "åšéŸ§è—¤æ¡" },
            { inputs: ["çŸ³ç‰‡", "çŸ³ç‰‡"], result: "æ‰“ç£¨çŸ³ç‰‡" },
            
            // äºŒçº§ -> ä¸‰çº§ï¼ˆå·¥å…·åˆ¶ä½œï¼‰
            { inputs: ["çŸ³ç‰‡", "ç²—ç»³"], result: "çŸ³åˆ€" },
            { inputs: ["æœ¨çŸ›", "çŸ³ç‰‡"], result: "é•¿çŸ›" },
            { inputs: ["æœ¨æ£", "æœ¨ç‚­"], result: "ç«æŠŠ" },
            { inputs: ["ç²—ç»³", "è—¤è”“"], result: "æ•é±¼ç½‘" },
            
            // äºŒçº§ -> ä¸‰çº§ï¼ˆé£Ÿç‰©å¤„ç†ï¼‰
            { inputs: ["ç¯ç«", "çƒ¤é±¼"], result: "çƒ¤é±¼ä¸²" },
            { inputs: ["æ¤°è‚‰", "æ¤°å­"], result: "æ¤°æ±" },
            { inputs: ["ç¯ç«", "ç”Ÿé±¼"], result: "ç†è‚‰" },
            
            // ä¸‰çº§ -> å››çº§ï¼ˆåŸææ–™åˆæˆï¼‰
            { inputs: ["æœ¨æ¡†æ¶", "åšéŸ§è—¤æ¡"], result: "åå°„ä¿¡å·æ¿" },
            { inputs: ["æ‰“ç£¨çŸ³ç‰‡", "çŸ³ç‰‡"], result: "çŸ³åˆ¶å·¥å…·" },
            
            // ä¸‰çº§ -> å››çº§ï¼ˆå·¥å…·åˆ¶ä½œï¼‰
            { inputs: ["çŸ³åˆ€", "é•¿çŸ›"], result: "å¤åˆå·¥å…·" },
            { inputs: ["æ‰“ç£¨çŸ³ç‰‡", "è´å£³"], result: "åå°„ä¿¡å·æ¿" },
            
            // ä¸‰çº§ -> å››çº§ï¼ˆé£Ÿç‰©å¤„ç†ï¼‰
            { inputs: ["çƒ¤é±¼ä¸²", "æ¤°æ±"], result: "è¥å…»é¤" },
            { inputs: ["ç†è‚‰", "æ¤°æ±"], result: "ä¿å­˜é£Ÿç‰©" },
            
            // ä¸‰çº§ -> å››çº§ï¼ˆæ±‚æ•‘ä¿¡å·åˆ¶ä½œï¼‰
            { inputs: ["ç«æŠŠ", "å¹²è‰"], result: "å¤§å‹ä¿¡å·ç«" },
            { inputs: ["ç«æŠŠ", "æœ¨ç‚­"], result: "å¤§å‹ä¿¡å·ç«" },
            { inputs: ["åå°„ä¿¡å·æ¿", "ç²¾åˆ¶æœ¨æ"], result: "åå°„ä¿¡å·æ¿" },
            
            // å·¥å…·å‡çº§é…æ–¹ï¼šä¸¤ä¸ªç›¸åŒå·¥å…· -> æ›´é«˜çº§å·¥å…·
            // Lv2å·¥å…· -> Lv3å·¥å…·
            { inputs: ["ç®€æ˜“çŸ³æ–§", "ç®€æ˜“çŸ³æ–§"], result: "çŸ³åˆ€" },
            { inputs: ["æœ¨çŸ›", "æœ¨çŸ›"], result: "é•¿çŸ›" },
            { inputs: ["ç¯ç«", "ç¯ç«"], result: "ç«æŠŠ" },
            { inputs: ["ç®€æ˜“é±¼å‰", "ç®€æ˜“é±¼å‰"], result: "æ•é±¼ç½‘" },
            { inputs: ["å¤åˆå·¥å…·", "å¤åˆå·¥å…·"], result: "åå°„ä¿¡å·æ¿" },
            
            // Lv3å·¥å…· -> Lv4å·¥å…·
            { inputs: ["çŸ³åˆ€", "çŸ³åˆ€"], result: "å¤åˆå·¥å…·" },
            { inputs: ["é•¿çŸ›", "é•¿çŸ›"], result: "å¤åˆå·¥å…·" },
            { inputs: ["ç«æŠŠ", "ç«æŠŠ"], result: "å¤§å‹ä¿¡å·ç«" },
            { inputs: ["ç«æŠŠ", "ç¯ç«"], result: "å¤§å‹ä¿¡å·ç«" },
            { inputs: ["æ•é±¼ç½‘", "æ•é±¼ç½‘"], result: "å¤åˆå·¥å…·" }
        ];

        // ============== è¡ŒåŠ¨é…æ–¹è¡¨ ==============
        // åˆ¶ä½œå·¥å…·é…æ–¹ï¼šåŸææ–™ -> å·¥å…·
        const CRAFT_TOOL_RECIPES = [
            // ä¸€çº§åŸææ–™ -> ä¸€çº§å·¥å…·
            { input: "æœ¨æ£", result: "ç®€æ˜“æœ¨æ–§", probability: 0.3, type: "tool" },
            { input: "æœ¨æ£", result: "ç®€æ˜“æœ¨å‰", probability: 0.7, type: "tool" },
            { input: "çŸ³å¤´", result: "ç®€æ˜“æœ¨æ–§", probability: 0.3, type: "tool" },
            { input: "çŸ³å¤´", result: "ç®€æ˜“çŸ³æ–§", probability: 0.7, type: "tool" },
            { input: "è—¤è”“", result: "ç®€æ˜“æœ¨çŸ›", probability: 1.0, type: "tool" },
            
            // äºŒçº§åŸææ–™ -> äºŒçº§å·¥å…·
            { input: "æœ¨æ¿", result: "ç®€æ˜“æœ¨æ–§", probability: 0.3, type: "tool" },
            { input: "æœ¨æ¿", result: "ç®€æ˜“æœ¨å‰", probability: 0.3, type: "tool" },
            { input: "æœ¨æ¿", result: "ç®€æ˜“æœ¨çŸ›", probability: 0.3, type: "tool" },
            { input: "æœ¨æ¿", result: "é•¿çŸ›", probability: 0.1, type: "tool" },
            { input: "ç²—ç»³", result: "ç®€æ˜“çŸ³æ–§", probability: 0.7, type: "tool" },
            { input: "ç²—ç»³", result: "æ•é±¼ç½‘", probability: 0.3, type: "tool" },
            { input: "çŸ³ç‰‡", result: "ç®€æ˜“çŸ³æ–§", probability: 0.9, type: "tool" },
            { input: "çŸ³ç‰‡", result: "çŸ³åˆ€", probability: 0.1, type: "tool" },
            { input: "æœ¨ç‚­", result: "ç¯ç«", probability: 1.0, type: "tool" },
            
            // ä¸‰çº§åŸææ–™ -> ä¸‰çº§å·¥å…·
            { input: "åšéŸ§è—¤æ¡", result: "é•¿çŸ›", probability: 1.0, type: "tool" },
            { input: "æ‰“ç£¨çŸ³ç‰‡", result: "çŸ³åˆ€", probability: 1.0, type: "tool" },
            { input: "æœ¨æ¡†æ¶", result: "åå°„ä¿¡å·æ¿", probability: 1.0, type: "tool" },
            
            // å››çº§åŸææ–™ -> å››çº§å·¥å…·
            { input: "ç²¾åˆ¶æœ¨æ", result: "åå°„ä¿¡å·æ¿", probability: 0.9, type: "tool" },
            { input: "ç²¾åˆ¶æœ¨æ", result: "å¤§å‹ä¿¡å·ç«", probability: 0.1, type: "tool" },
            { input: "çŸ³åˆ¶å·¥å…·", result: "å¤åˆå·¥å…·", probability: 0.9, type: "tool" },
            { input: "çŸ³åˆ¶å·¥å…·", result: "å¤§å‹ä¿¡å·ç«", probability: 0.1, type: "tool" }
        ];

        // æ•çŒ/é’“é±¼/ç ä¼å·¥å…·åˆ†ç±»
        // æ–§å­ç±»å·¥å…·ï¼ˆç”¨äºç ä¼äº§å‡ºæœ¨ææˆ–çŸ³å¤´ï¼‰
        const AXE_TOOLS = ["ç®€æ˜“æœ¨æ–§", "ç®€æ˜“çŸ³æ–§", "å¤åˆå·¥å…·"];
        
        // çŸ›/åˆ€ç±»å·¥å…·ï¼ˆç”¨äºæ‰“çŒäº§å‡ºå…½è‚‰ç±»é£Ÿç‰©ï¼‰
        const SPEAR_KNIFE_TOOLS = ["ç®€æ˜“æœ¨çŸ›", "æœ¨çŸ›", "é•¿çŸ›", "çŸ³åˆ€", "å¤åˆå·¥å…·"];
        
        // ç«ç±»å·¥å…·ï¼ˆç”¨äºå¸ƒç½®é™·é˜±æŠ“æ•é‡å…½äº§å‡ºå…½è‚‰ç±»é£Ÿç‰©ï¼‰
        const TRAP_TOOLS = ["ç¯ç«", "ç«æŠŠ", "å¤§å‹ä¿¡å·ç«"];
        
        // é±¼å‰/æ¸”ç½‘ç±»å·¥å…·ï¼ˆç”¨äºæ•é±¼äº§å‡ºé±¼ç±»é£Ÿç‰©ï¼‰
        const FISHING_TOOLS = ["ç®€æ˜“æœ¨å‰", "ç®€æ˜“é±¼å‰", "æ•é±¼ç½‘"];
        
        // æ ¹æ®å·¥å…·ç­‰çº§äº§å‡ºå¯¹åº”çš„æœ¨æç±»ç‰©èµ„
        const AXE_WOOD_OUTPUT = {
            1: "æœ¨æ£",    // Lv1æ–§å­ -> æœ¨æ£
            2: "æœ¨æ¿",    // Lv2æ–§å­ -> æœ¨æ¿
            3: "æœ¨æ¡†æ¶",  // Lv3æ–§å­ -> æœ¨æ¡†æ¶
            4: "ç²¾åˆ¶æœ¨æ" // Lv4æ–§å­ -> ç²¾åˆ¶æœ¨æ
        };
        
        // æ ¹æ®å·¥å…·ç­‰çº§äº§å‡ºå¯¹åº”çš„çŸ³å¤´ç±»ç‰©èµ„
        const AXE_STONE_OUTPUT = {
            1: "çŸ³å¤´",      // Lv1æ–§å­ -> çŸ³å¤´
            2: "çŸ³ç‰‡",      // Lv2æ–§å­ -> çŸ³ç‰‡
            3: "æ‰“ç£¨çŸ³ç‰‡",  // Lv3æ–§å­ -> æ‰“ç£¨çŸ³ç‰‡
            4: "çŸ³åˆ¶å·¥å…·"   // Lv4æ–§å­ -> çŸ³åˆ¶å·¥å…·
        };
        
        // æ ¹æ®å·¥å…·ç­‰çº§äº§å‡ºå¯¹åº”çš„å…½è‚‰ç±»é£Ÿç‰©ï¼ˆä¸€çº§å·¥å…·åªèƒ½äº§å‡ºä¸€çº§é£Ÿç‰©ï¼‰
        const MEAT_OUTPUT = {
            1: "ç”Ÿè‚‰",      // Lv1çŸ›/åˆ€ -> ç”Ÿè‚‰
            2: "å°å…½è‚‰",    // Lv2çŸ›/åˆ€ -> å°å…½è‚‰
            3: "çƒ¤å…½è‚‰",    // Lv3çŸ›/åˆ€ -> çƒ¤å…½è‚‰
            4: "ç²¾åˆ¶è‚‰æ’"   // Lv4çŸ›/åˆ€ -> ç²¾åˆ¶è‚‰æ’
        };
        
        // æ ¹æ®å·¥å…·ç­‰çº§äº§å‡ºå¯¹åº”çš„é±¼ç±»é£Ÿç‰©ï¼ˆä¸€çº§å·¥å…·åªèƒ½äº§å‡ºä¸€çº§é£Ÿç‰©ï¼‰
        const FISH_OUTPUT = {
            1: "ç”Ÿé±¼",      // Lv1é±¼å‰/ç½‘ -> ç”Ÿé±¼
            2: "ç”Ÿé±¼",      // Lv2é±¼å‰/ç½‘ -> ç”Ÿé±¼ï¼ˆäºŒçº§å·¥å…·ä¹Ÿèƒ½æ•åˆ°ä¸€çº§é±¼ï¼‰
            3: "å¤§å—é±¼è‚‰",  // Lv3é±¼å‰/ç½‘ -> å¤§å—é±¼è‚‰
            4: "æµ·é²œå¤§é¤"   // Lv4é±¼å‰/ç½‘ -> æµ·é²œå¤§é¤
        };
        
        // ä¸€çº§å·¥å…·åªèƒ½äº§å‡ºçš„ä¸€çº§åŸææ–™ï¼ˆç”¨äºæ–§å­ç±»å·¥å…·ï¼‰
        const LEVEL1_MATERIAL_OUTPUT = {
            wood: "æœ¨æ£",   // ä¸€çº§æ–§å­ -> æœ¨æ£
            stone: "çŸ³å¤´"   // ä¸€çº§æ–§å­ -> çŸ³å¤´
        };

        // è¾…åŠ©å‡½æ•°ï¼šæŸ¥æ‰¾åˆ¶ä½œå·¥å…·é…æ–¹
        function findCraftToolRecipe(material) {
            const materialLevel = material.level || 1;
            let recipes = CRAFT_TOOL_RECIPES.filter(r => r.input === material.text);
            
            // å¦‚æœæ˜¯ä¸€çº§åŸææ–™ï¼Œåªè¿”å›ä¸€çº§å·¥å…·çš„é…æ–¹
            if (materialLevel === 1) {
                recipes = recipes.filter(r => {
                    const resultInfo = MATERIAL_DATABASE[r.result];
                    return resultInfo && resultInfo.level === 1;
                });
            }
            
            if (recipes.length === 0) return null;
            
            // æ ¹æ®æ¦‚ç‡é€‰æ‹©ç»“æœ
            const toolRecipes = recipes.filter(r => r.type === 'tool');
            if (toolRecipes.length > 0) {
                // æ ¹æ®æ¦‚ç‡éšæœºé€‰æ‹©
                const rand = Math.random();
                let cumulative = 0;
                for (const recipe of toolRecipes) {
                    cumulative += recipe.probability;
                    if (rand < cumulative) {
                        return recipe;
                    }
                }
                // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œè¿”å›ç¬¬ä¸€ä¸ª
                return toolRecipes[0];
            }
            
            return null;
        }

        // è¾…åŠ©å‡½æ•°ï¼šæŸ¥æ‰¾æ•çŒ/é’“é±¼/ç ä¼é…æ–¹
        function findHuntFishRecipe(tool) {
            const toolLevel = tool.level || 1;
            
            // å¦‚æœæ˜¯æ–§å­ç±»å·¥å…·ï¼Œæ ¹æ®æ¦‚ç‡äº§å‡ºæœ¨ææˆ–çŸ³å¤´
            if (AXE_TOOLS.includes(tool.text)) {
                // ä¸€çº§å·¥å…·åªèƒ½äº§å‡ºä¸€çº§åŸææ–™
                if (toolLevel === 1) {
                    const rand = Math.random();
                    if (rand < 0.8) {
                        return {
                            input: tool.text,
                            result: LEVEL1_MATERIAL_OUTPUT.wood,
                            type: "material"
                        };
                    } else {
                        return {
                            input: tool.text,
                            result: LEVEL1_MATERIAL_OUTPUT.stone,
                            type: "material"
                        };
                    }
                }
                // äºŒçº§åŠä»¥ä¸Šå·¥å…·æŒ‰åŸé€»è¾‘
                const rand = Math.random();
                if (rand < 0.8) {
                    const woodOutput = AXE_WOOD_OUTPUT[toolLevel] || AXE_WOOD_OUTPUT[1];
                    return {
                        input: tool.text,
                        result: woodOutput,
                        type: "material"
                    };
                } else {
                    const stoneOutput = AXE_STONE_OUTPUT[toolLevel] || AXE_STONE_OUTPUT[1];
                    return {
                        input: tool.text,
                        result: stoneOutput,
                        type: "material"
                    };
                }
            }
            
            // å¦‚æœæ˜¯çŸ›/åˆ€ç±»å·¥å…·ï¼Œäº§å‡ºå…½è‚‰ç±»é£Ÿç‰©
            if (SPEAR_KNIFE_TOOLS.includes(tool.text)) {
                // ä¸€çº§å·¥å…·åªèƒ½äº§å‡ºä¸€çº§é£Ÿç‰©
                if (toolLevel === 1) {
                    return {
                        input: tool.text,
                        result: "ç”Ÿè‚‰",
                        type: "food"
                    };
                }
                const meatOutput = MEAT_OUTPUT[toolLevel] || MEAT_OUTPUT[1];
                return {
                    input: tool.text,
                    result: meatOutput,
                    type: "food"
                };
            }
            
            // å¦‚æœæ˜¯ç«ç±»å·¥å…·ï¼ˆç¯ç«ã€ç«æŠŠã€å¤§å‹ä¿¡å·ç«ï¼‰ï¼Œç”¨äºå¸ƒç½®é™·é˜±æŠ“æ•é‡å…½ï¼Œäº§å‡ºå…½è‚‰ç±»é£Ÿç‰©
            if (TRAP_TOOLS.includes(tool.text)) {
                // ä¸€çº§å·¥å…·åªèƒ½äº§å‡ºä¸€çº§é£Ÿç‰©
                if (toolLevel === 1) {
                    return {
                        input: tool.text,
                        result: "ç”Ÿè‚‰",
                        type: "food"
                    };
                }
                const meatOutput = MEAT_OUTPUT[toolLevel] || MEAT_OUTPUT[1];
                return {
                    input: tool.text,
                    result: meatOutput,
                    type: "food"
                };
            }
            
            // å¦‚æœæ˜¯åå°„ä¿¡å·æ¿ï¼ˆè™½ç„¶æ˜¯materialï¼Œä½†å¦‚æœä½œä¸ºå·¥å…·ä½¿ç”¨ï¼‰ï¼Œä¹Ÿç”¨äºå¸ƒç½®é™·é˜±æŠ“æ•é‡å…½
            if (tool.text === "åå°„ä¿¡å·æ¿") {
                // åå°„ä¿¡å·æ¿æ˜¯Lv4ï¼Œäº§å‡ºLv4çš„è‚‰ç±»
                return {
                    input: tool.text,
                    result: "ç²¾åˆ¶è‚‰æ’",
                    type: "food"
                };
            }
            
            // å¦‚æœæ˜¯é±¼å‰/æ¸”ç½‘ç±»å·¥å…·ï¼Œäº§å‡ºé±¼ç±»é£Ÿç‰©
            if (FISHING_TOOLS.includes(tool.text)) {
                // ä¸€çº§å·¥å…·åªèƒ½äº§å‡ºä¸€çº§é£Ÿç‰©
                if (toolLevel === 1) {
                    return {
                        input: tool.text,
                        result: "ç”Ÿé±¼",
                        type: "food"
                    };
                }
                const fishOutput = FISH_OUTPUT[toolLevel] || FISH_OUTPUT[1];
                return {
                    input: tool.text,
                    result: fishOutput,
                    type: "food"
                };
            }
            
            // å…¶ä»–å·¥å…·é»˜è®¤äº§å‡ºç”Ÿé±¼ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
            return {
                input: tool.text,
                result: "ç”Ÿé±¼",
                type: "food"
            };
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥ä¸¤ä¸ªç‰©èµ„æ˜¯å¦å¯ä»¥åˆæˆ
        function findRecipe(word1, word2) {
            const name1 = word1.text;
            const name2 = word2.text;
            
            // å°è¯•ä¸¤ç§é¡ºåºåŒ¹é…
            for (const recipe of FUSION_RECIPES) {
                if ((recipe.inputs[0] === name1 && recipe.inputs[1] === name2) ||
                    (recipe.inputs[0] === name2 && recipe.inputs[1] === name1)) {
                    return recipe;
                }
            }
            
            // ç‰¹æ®Šé…æ–¹1ï¼šç¯ç« + ä»»ä½•ä¸€çº§ç”Ÿé£Ÿ = å¯¹åº”ç†Ÿé£Ÿ
            const campfire = name1 === "ç¯ç«" ? word1 : (name2 === "ç¯ç«" ? word2 : null);
            const rawFood = campfire ? (name1 === "ç¯ç«" ? word2 : word1) : null;
            
            if (campfire && rawFood && rawFood.tag === "food" && rawFood.level === 1) {
                // æ ¹æ®ç”Ÿé£Ÿç±»å‹è¿”å›å¯¹åº”çš„ç†Ÿé£Ÿ
                if (rawFood.text === "ç”Ÿé±¼") {
                    return { inputs: [name1, name2], result: "çƒ¤é±¼" };
                } else if (rawFood.text === "é‡æœ" || rawFood.text === "æµ·è‰") {
                    return { inputs: [name1, name2], result: "é£å¹²æœå¹²" };
                } else {
                    // å…¶ä»–ä¸€çº§ç”Ÿé£Ÿé»˜è®¤å˜æˆé£å¹²æœå¹²
                    return { inputs: [name1, name2], result: "é£å¹²æœå¹²" };
                }
            }
            
            // ç‰¹æ®Šé…æ–¹2ï¼šé”‹åˆ©å·¥å…· + æ¤°å­ = æ¤°è‚‰ï¼ˆåŒ…å«ä¸€çº§ã€äºŒçº§ã€ä¸‰çº§ä¸­â€œå¸¦åˆƒ/å°–ç«¯â€çš„å·¥å…·ï¼‰
            const sharpTools = [
                "ç®€æ˜“æœ¨æ–§", "ç®€æ˜“æœ¨çŸ›", "ç®€æ˜“æœ¨å‰", // Lv1 å·¥å…·
                "ç®€æ˜“çŸ³æ–§", "ç®€æ˜“é±¼å‰", "æœ¨çŸ›",     // Lv2 å·¥å…·
                "çŸ³åˆ€", "é•¿çŸ›"                      // Lv3 å·¥å…·
            ];
            const isSharpTool = sharpTools.includes(name1) || sharpTools.includes(name2);
            const coconut = name1 === "æ¤°å­" ? word1 : (name2 === "æ¤°å­" ? word2 : null);
            const tool = coconut ? (name1 === "æ¤°å­" ? word2 : word1) : null;
            
            if (isSharpTool && coconut && coconut.text === "æ¤°å­" && coconut.tag === "material" && coconut.level === 1) {
                return { inputs: [name1, name2], result: "æ¤°è‚‰" };
            }
            
            // ç‰¹æ®Šé…æ–¹3ï¼šåŒçº§é£Ÿç‰©ï¼ˆLv2åŠä»¥ä¸Šï¼‰å¯ä»¥åˆæˆé«˜ä¸€çº§é£Ÿç‰©
            if (word1.tag === "food" && word2.tag === "food" && 
                word1.level === word2.level && word1.level >= 2 && word1.level <= 3) {
                const currentLevel = word1.level;
                const nextLevel = currentLevel + 1;
                
                // ä»MATERIAL_DATABASEä¸­ç­›é€‰å‡ºå¯¹åº”ç­‰çº§çš„æ‰€æœ‰é£Ÿç‰©
                const availableFoods = Object.entries(MATERIAL_DATABASE)
                    .filter(([name, info]) => info.tag === "food" && info.level === nextLevel);
                
                if (availableFoods.length > 0) {
                    // éšæœºé€‰æ‹©ä¸€ä¸ªé«˜ä¸€çº§çš„é£Ÿç‰©
                    const [foodName, foodInfo] = availableFoods[Math.floor(Math.random() * availableFoods.length)];
                    return { inputs: [name1, name2], result: foodName };
                }
            }
            
            // ç‰¹æ®Šé…æ–¹4ï¼šåŒçº§å·¥å…·ï¼ˆLv1åŠä»¥ä¸Šï¼‰å¯ä»¥åˆæˆé«˜ä¸€çº§å·¥å…·
            if (word1.tag === "tool" && word2.tag === "tool" && 
                word1.level === word2.level && word1.level >= 1 && word1.level <= 3) {
                const currentLevel = word1.level;
                const nextLevel = currentLevel + 1;
                
                // ä»MATERIAL_DATABASEä¸­ç­›é€‰å‡ºå¯¹åº”ç­‰çº§çš„æ‰€æœ‰å·¥å…·
                const availableTools = Object.entries(MATERIAL_DATABASE)
                    .filter(([name, info]) => info.tag === "tool" && info.level === nextLevel);
                
                if (availableTools.length > 0) {
                    // éšæœºé€‰æ‹©ä¸€ä¸ªé«˜ä¸€çº§çš„å·¥å…·
                    const [toolName, toolInfo] = availableTools[Math.floor(Math.random() * availableTools.length)];
                    return { inputs: [name1, name2], result: toolName };
                }
            }
            
            return null;
        }
        // ============== æ¸¸æˆè¿›åº¦ç³»ç»Ÿ ==============
        // è’å²›æŒ‘æˆ˜æ•°æ®ï¼ˆæ”¹ä¸ºé¢„ç½®å™äº‹ï¼Œä¸å†ä¾èµ–AIç”Ÿæˆï¼‰
        const challenges = [
            {
                id: 1,
                day: 1,
                title: "æŒ‘æˆ˜ä¸€ï¼šæ¼‚æµåçš„é¥¥æ¸´",
                description: "ä½ è¢«æµ·æµªæ¨ä¸Šå²¸ï¼Œèº«ä¸Šè¿˜æ®‹ç•™ç€æµ·æ°´ã€‚å¤ªé˜³ç‚™çƒ¤ï¼Œå˜´å”‡å¼€è£‚ï¼Œé™„è¿‘åªå‰©ç¢æœ¨å’Œå‡ ä¸ªåŠè…åçš„æ¤°å­ã€‚æ—¥è½å‰å¿…é¡»å¼„åˆ°å¯å…¥å£çš„ä¸œè¥¿ï¼Œå¦åˆ™èº«ä½“ä¼šè¿…é€Ÿå®æ‰ã€‚",
                solutionHint: "ä¼˜å…ˆè·å–æ°´å’Œé£Ÿç‰©ï¼Œç®€å•å¤„ç†åå†å…¥å£ï¼Œåˆ«è®©èº«ä½“é€æ”¯ã€‚",
                victoryCondition: { type: 'survival', minSurvival: 50 },
                successDescription: "ä½ æ‰¾åˆ°äº†å¯å…¥å£çš„é£Ÿç‰©å’Œæ°´ï¼Œå‹‰å¼ºå¡«é¥±äº†è‚šå­ã€‚è™½ç„¶è¿‡ç¨‹è‰°éš¾ï¼Œä½†èº«ä½“é‡æ–°è·å¾—äº†åŠ›é‡ï¼Œå¯ä»¥ç»§ç»­åšæŒä¸‹å»ã€‚",
                solved: false
            },
            {
                id: 2, 
                day: 3,
                title: "æŒ‘æˆ˜äºŒï¼šæš´é£é›¨å‹å¢ƒ",
                description: "å‚æ™šï¼Œæµ·å¹³çº¿ä¸Šå †èµ·å¢¨è‰²äº‘å¢™ï¼Œé›·å£°æ»šè¿‡ï¼Œæ½®æ°´æ‹æ‰“ç¤çŸ³ã€‚æ ‘å¶çš„é£å‘å˜äº†ï¼Œä½ å¿…é¡»åœ¨é£æš´æ¥ä¸´å‰æ‰¾åˆ°é®è”½æˆ–åŠ å›ºè¥åœ°ï¼Œå¦åˆ™ä¸€å¤œè¿‡ååªå‰©æ¹¿é€ä¸å¤±æ¸©ã€‚",
                solutionHint: "æ­ä¸ªèƒ½æŒ¡é£é›¨çš„åº‡æŠ¤ï¼Œå‡†å¤‡ç«ç§ä¸å›ºå®šææ–™ï¼Œé™ä½å¤±æ¸©é£é™©ã€‚",
                victoryCondition: { type: 'shelterStats', shelterDurability: 50 },
                successDescription: "ä½ åŠæ—¶åŠ å›ºäº†åº‡æŠ¤æ‰€ï¼Œè™½ç„¶æš´é£é›¨æ¥åŠ¿æ±¹æ±¹ï¼Œä½†ä½ çš„è¥åœ°ç»å—ä½äº†è€ƒéªŒã€‚åœ¨æ¸©æš–å¹²ç‡¥çš„åº‡æŠ¤æ‰€ä¸­ï¼Œä½ å®‰ç¨³åœ°åº¦è¿‡äº†è¿™ä¸ªå±é™©çš„å¤œæ™šã€‚",
                solved: false
            },
            {
                id: 3,
                day: 5,
                title: "æŒ‘æˆ˜ä¸‰ï¼šæš—å¤œçš„çŒæ‰‹",
                description: "å¤œå¹•é™ä¸´ï¼Œæ—é—´ä¼ æ¥ä½æ²‰çš„å–˜æ¯ä¸æå¶æŠ˜æ–­å£°ã€‚æŸç§é‡å…½æ­£åœ¨è¯•æ¢ä½ çš„è¥åœ°ï¼Œä½ å¿…é¡»ç”¨å£°å“ã€ç«æˆ–æ­¦å™¨å‘Šè¯‰å®ƒï¼šè¿™é‡Œä¸å¥½æƒ¹ã€‚",
                solutionHint: "ç«å…‰æˆ–æ­¦å™¨èƒ½å¨æ…‘ï¼Œé™·é˜±/å°–åˆºå¯é˜»æŒ¡é è¿‘ã€‚",
                victoryCondition: { type: 'hasItem', tag: 'tool', level: 3, count: 1 },
                successDescription: "ä½ äº®å‡ºäº†æ‰‹ä¸­çš„æ­¦å™¨ï¼Œç«å…‰åœ¨é»‘å¤œä¸­é—ªçƒã€‚é‡å…½æ„Ÿå—åˆ°äº†å¨èƒï¼ŒçŠ¹è±«ç‰‡åˆ»åè½¬èº«ç¦»å»ã€‚ä½ æˆåŠŸåœ°ä¿æŠ¤äº†è‡ªå·±çš„è¥åœ°ï¼Œè·å¾—äº†æš‚æ—¶çš„å®‰å…¨ã€‚",
                solved: false
            },
            {
                id: 4,
                day: 7,
                title: "æŒ‘æˆ˜å››ï¼šè´§è½®çš„å¾®å…‰",
                description: "ç¬¬ä¸ƒæ—¥é»„æ˜ï¼Œè¿œå¤„æµ·é¢å‡ºç°è´§è½®èˆªç¯ã€‚ç•™ç»™ä½ çš„åªæœ‰å‡ åˆ†é’Ÿï¼Œå¿…é¡»ç”¨çƒŸé›¾ã€å…‰äº®æˆ–åå°„ä¿¡å·æ‰“ç ´æµ·é£ï¼ŒæŠŠå­˜åœ¨æ„Ÿé€è¿›èˆ¹å‘˜çš„è§†çº¿é‡Œã€‚",
                solutionHint: "å‡†å¤‡2ä¸ªå¤§å‹ä¿¡å·ç«ï¼Œæˆ–è€…3ä¸ªåå°„ä¿¡å·æ¿ã€‚",
                victoryCondition: { 
                    type: 'hasItemMultiple', 
                    conditions: [
                        { text: 'å¤§å‹ä¿¡å·ç«', count: 2 },
                        { text: 'åå°„ä¿¡å·æ¿', count: 3 }
                    ]
                },
                successDescription: "ä½ ç‚¹ç‡ƒäº†ä¿¡å·ç«ï¼Œæµ“çƒŸæ»šæ»šå‡èµ·ï¼›ä½ æŒ¥åŠ¨ç€åå°„ä¿¡å·æ¿ï¼Œé˜³å…‰åœ¨é‡‘å±è¡¨é¢é—ªçƒã€‚èˆ¹å‘˜ç»ˆäºæ³¨æ„åˆ°äº†ä½ ï¼Œè´§è½®ç¼“ç¼“è½¬å‘ï¼Œä½ çœ‹åˆ°äº†è·æ•‘çš„å¸Œæœ›ã€‚",
                solved: false
            }
        ];

        let currentChallengeIndex = 0;
        let currentChallenge = challenges[currentChallengeIndex];
        
        // ç”Ÿå­˜çŠ¶æ€å€¼ï¼ˆ0-100ï¼‰ï¼Œåˆå¹¶äº†ç”Ÿå‘½å€¼å’Œé¥±è…¹å€¼
        let survival = 0;
        // åº‡æŠ¤æ‰€åšå›ºå€¼ï¼ˆ0-100ï¼‰ï¼Œåˆå¹¶äº†åšå›ºå€¼å’Œé˜²é›¨å€¼
        let shelterDurability = 0;
        const MIN_STAT_FOR_START = 20; // åˆå§‹è¿‡ä½ç›´æ¥å¤±è´¥é˜ˆå€¼
        
        // åˆæˆæ¬¡æ•°ï¼ˆå½“å‰å…³å¡å¯ç”¨ï¼‰
        let fusionLeft = 0;

        // å¤©æ•°ä¸è¡ŒåŠ¨ç‚¹
        let currentDay = 1;
        const MAX_DAY = 7;
        let actionPoints = 7;
        const MAX_ACTION_POINTS = 10;
        
        // ç©å®¶ä¿¡æ¯
        let playerName = '';
        let playerAppearance = '';
        
        // è¾…åŠ©å‡½æ•°ï¼šå°†æ–‡æœ¬ä¸­çš„"ä½ "æ›¿æ¢ä¸ºç©å®¶åå­—
        function replaceYouWithPlayerName(text) {
            if (!playerName || !text) return text;
            // æ›¿æ¢"ä½ "ä¸ºç©å®¶åå­—ï¼Œä½†è¦é¿å…æ›¿æ¢"ä½ çš„"ã€"ä½ æ˜¯"ç­‰è¯
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é…ç‹¬ç«‹çš„"ä½ "å­—
            return text.replace(/\bä½ \b/g, playerName);
        }
        
        // ============== å¤©æ°”ç³»ç»Ÿ ==============
        // å¯èƒ½çš„å¤©æ°”ç±»å‹
        const WEATHER_TYPES = ['æ™´å¤©', 'å¤šäº‘', 'å°é›¨', 'æš´é›¨', 'å¤§é£', 'é›¾å¤©', 'ç‚çƒ­', 'å‡‰çˆ½'];
        
        // å½“å‰å¤©æ°”çŠ¶æ€
        let currentWeather = 'æ™´å¤©';
        let affectedActions = []; // å—å½“å‰å¤©æ°”å½±å“çš„è¡ŒåŠ¨ç±»å‹åˆ—è¡¨
        let affectedLocations = { forest: false, beach: false, cave: false }; // å—å½“å‰å¤©æ°”å½±å“çš„åœ°ç‚¹åˆ—è¡¨
        let actionPointCounter = 0; // è¡ŒåŠ¨ç‚¹æ¶ˆè€—è®¡æ•°å™¨ï¼Œæ¯3ç‚¹æ¢ä¸€æ¬¡å¤©æ°”
        
        // å¤©æ°”å½±å“ç¼“å­˜ï¼šå­˜å‚¨æ‰€æœ‰å¤©æ°”ç±»å‹çš„å½±å“æ•°æ®
        let weatherEffectsCache = {};

        // å¯»æ‰¾ç‰©èµ„åœ°ç‚¹å®šä¹‰
        const LOCATIONS = {
            forest: {
                name: 'æ ‘æ—',
                emoji: 'ğŸŒ²',
                unlocked: true, // åˆå§‹è§£é”
                unlockRequirement: null, // æ— éœ€è§£é”ç‰©å“
                description: 'èŒ‚å¯†çš„æ ‘æ—ä¸­éšè—ç€å„ç§èµ„æº',
                // æ ‘æ—åå¥½ç‰©èµ„ï¼šæœ¨æ£ã€è—¤è”“ã€å¹²è‰ã€é‡æœã€ç”Ÿè‚‰ã€é¸Ÿè›‹ç­‰
                preferredItems: ['æœ¨æ£', 'è—¤è”“', 'å¹²è‰', 'é‡æœ', 'ç”Ÿè‚‰', 'é¸Ÿè›‹', 'æœ¨æ¿', 'ç²—ç»³', 'åšéŸ§è—¤æ¡', 'çƒ¤å…½è‚‰']
            },
            beach: {
                name: 'æµ·è¾¹',
                emoji: 'ğŸ–ï¸',
                unlocked: false,
                unlockRequirement: { text: 'ç®€æ˜“æœ¨å‰', tag: 'tool' }, // éœ€è¦æäº¤ç®€æ˜“æœ¨å‰æ¥è§£é”
                description: 'æµ·è¾¹å¯ä»¥æ‰¾åˆ°è´å£³ã€æµ·è‰ç­‰ç‰©èµ„',
                // æµ·è¾¹åå¥½ç‰©èµ„ï¼šè´å£³ã€æµ·è‰ã€ç”Ÿé±¼ã€æ¤°å­ç­‰
                preferredItems: ['è´å£³', 'æµ·è‰', 'ç”Ÿé±¼', 'æ¤°å­', 'æ¤°è‚‰', 'çƒ¤é±¼', 'æ¤°æ±', 'å¤§å—é±¼è‚‰']
            },
            cave: {
                name: 'å±±æ´',
                emoji: 'ğŸ•³ï¸',
                unlocked: false,
                unlockRequirement: { text: 'ç¯ç«', tag: 'tool' }, // éœ€è¦æäº¤ç¯ç«æ¥è§£é”
                description: 'é»‘æš—çš„å±±æ´ä¸­å¯èƒ½æœ‰ç¨€æœ‰èµ„æº',
                // å±±æ´åå¥½ç‰©èµ„ï¼šçŸ³å¤´ã€çŸ³ç‰‡ã€æœ¨ç‚­ã€æ‰“ç£¨çŸ³ç‰‡ã€çŸ³åˆ¶å·¥å…·ç­‰
                preferredItems: ['çŸ³å¤´', 'çŸ³ç‰‡', 'æœ¨ç‚­', 'æ‰“ç£¨çŸ³ç‰‡', 'çŸ³åˆ¶å·¥å…·', 'çŸ³åˆ€']
            }
        };

        // è¡ŒåŠ¨ç±»å‹å®šä¹‰ï¼šæ¯ä¸ªè¡ŒåŠ¨æœ‰å›ºå®šçš„æ•°å€¼å˜åŒ–è§„åˆ™ï¼ˆåç»­æŒ‰ç‰©èµ„ç­‰çº§å€ç‡ï¼‰
        const ACTION_TYPES = {
            craftTool: {
                name: "åˆ¶ä½œå·¥å…·",
                emoji: "ğŸ”§",
                description: "ç”¨ç‰©èµ„åˆ¶ä½œå·¥å…·",
                statChanges: { health: -2, hunger: -2 }, // å°†è¢«åˆå¹¶ä¸ºsurvivalå˜åŒ–
                aiPrompt: "æè¿°ç©å®¶å¦‚ä½•ç”¨è¿™ä»¶ç‰©èµ„åˆ¶ä½œä¸€ä¸ªç®€å•å·¥å…·ï¼Œä»¥åŠå·¥å…·å¤–è§‚ä¸ç”¨é€”",
                producesItem: true,
                itemType: "å·¥å…·",
                itemEmoji: "ğŸ› ï¸",
                tags: ["tool"]
            },
            eat: {
                name: "è¿›é£Ÿ",
                emoji: "ğŸš",
                description: "è¿›é£Ÿå¯ä»¥è¡¥å……ç”Ÿå­˜çŠ¶æ€å€¼ï¼Œå¹¶å¢åŠ è¡ŒåŠ¨ç‚¹",
                statChanges: { health: +2, hunger: +12 }, // åŸºç¡€å€¼ï¼Œä¼šè¢«åˆå¹¶ä¸ºsurvivalå˜åŒ–ï¼Œä¼šæ ¹æ®é£Ÿç‰©ç­‰çº§è°ƒæ•´
                aiPrompt: "æè¿°ç©å®¶å¦‚ä½•å¤„ç†å¹¶é£Ÿç”¨è¿™ä»¶ç‰©èµ„ï¼Œä½¿å…¶å¯å…¥å£ä¸”è¡¥å……ä½“åŠ›",
                producesItem: false
            },
            buildShelter: {
                name: "ä¿®å»ºåº‡æŠ¤æ‰€",
                emoji: "ğŸ ",
                description: "åŠ å›ºæˆ–å»ºé€ åº‡æŠ¤æ‰€ï¼Œæå‡å®‰å…¨æ„Ÿ",
                statChanges: { health: 0, hunger: 0 }, // ä¸ç›´æ¥ä¿®æ”¹ç”Ÿå­˜çŠ¶æ€ï¼Œåº‡æŠ¤æ‰€åšå›ºå€¼ç”±ç³»ç»Ÿæ ¹æ®ç‰©èµ„ç­‰çº§è®¡ç®—
                aiPrompt: "æè¿°ç©å®¶å¦‚ä½•ç”¨è¿™ä»¶ç‰©èµ„ä¿®å»ºæˆ–åŠ å›ºåº‡æŠ¤æ‰€ï¼Œä»¥åŠåº‡æŠ¤æ‰€å¸¦æ¥çš„å®‰å…¨æ„Ÿï¼Œå¹¶ç»™å‡ºå¯¹åº‡æŠ¤æ‰€åšå›ºå€¼çš„æ”¹å–„å¹…åº¦",
                producesItem: false,
                improveShelter: true
            },
            huntFish: {
                name: "æ‰“çŒ/é’“é±¼/ç ä¼",
                emoji: "ğŸ£",
                description: "è®¾é™·é˜±ã€ä¸‹æ°´å–é£Ÿæˆ–ç ä¼æœ¨æï¼Œè·å–é£Ÿç‰©æˆ–åŸææ–™",
                statChanges: { health: -4, hunger: -4 }, // å°†è¢«åˆå¹¶ä¸ºsurvivalå˜åŒ–
                aiPrompt: "æè¿°ç©å®¶å¦‚ä½•ç”¨è¿™ä»¶ç‰©èµ„è¿›è¡Œæ‰“çŒã€é’“é±¼æˆ–ç ä¼ï¼Œå¹¶è·å¾—ç‰©èµ„",
                producesItem: true,
                itemType: "é£Ÿç‰©æˆ–åŸææ–™",
                itemEmoji: "ğŸ–",
                tags: ["food", "material"]
            }
        };

        // å½“å‰è¡ŒåŠ¨æ§½ä½ä¸­çš„ç‰©èµ„ï¼ˆç”¨äºé€‰æ‹©è¡ŒåŠ¨ï¼‰
        let actionSlotItem = null;

        // ============== ç”Ÿå­˜æ•°å€¼ç›¸å…³å‡½æ•° ==============
        function initBaseStats() {
            // å›ºå®šåˆå§‹æ•°å€¼
            survival = 30; // ç”Ÿå­˜çŠ¶æ€å€¼åˆå§‹ä¸º30
            shelterDurability = 0; // åº‡æŠ¤æ‰€åšå›ºå€¼åˆå§‹ä¸º0
            updateBaseStatsUI();
            updateDayAndActionUI();
            
            // å¦‚æœåˆå§‹çŠ¶æ€å°±æå·®ï¼Œåˆ™ç›´æ¥åˆ¤å®šä¸ºå¤±è´¥å¼€å±€
            if (survival < MIN_STAT_FOR_START) {
                showGameOverScreen("ä½ åœ¨è¢«å†²ä¸Šè’å²›æ—¶å°±å·²ç»ä¼¤ç—•ç´¯ç´¯ã€é¥¥æ¸´éš¾è€ï¼Œæ²¡æœ‰åšæŒåˆ°çœŸæ­£çš„æ±‚ç”ŸæŒ‘æˆ˜å¼€å§‹ã€‚");
            }
        }

        function updateBaseStatsUI() {
            // åº‡æŠ¤æ‰€å±æ€§å˜åŒ–åæ£€æŸ¥æŒ‘æˆ˜æ˜¯å¦å®Œæˆ
            checkChallengeCompletion();
            // ç¡®ä¿å€¼æ˜¯æœ‰æ•ˆæ•°å­—ï¼ŒNaNæˆ–æ— æ•ˆå€¼è®¾ä¸º0
            const clamp = (v) => {
                const num = (typeof v === 'number' && !isNaN(v) && isFinite(v)) ? v : 0;
                return Math.max(0, Math.min(100, num));
            };
            const surv = clamp(survival);
            const shelter = clamp(shelterDurability);

            const sv = document.getElementById('survival-value');
            const sdv = document.getElementById('shelter-durability-value');
            const sb = document.getElementById('survival-bar');
            const sdb = document.getElementById('shelter-durability-bar');

            if (!sv) return; // é¡µé¢å¯èƒ½å·²è¢«ç»“ç®—ç•Œé¢æ›¿æ¢

            sv.textContent = surv;
            sdv.textContent = shelter;

            sb.style.width = surv + '%';
            sdb.style.width = shelter + '%';
        }

        function applyStatChanges(changes) {
            const nonZero = {};
            // å¤„ç†ç”Ÿå­˜çŠ¶æ€å€¼å˜åŒ–ï¼ˆåˆå¹¶äº†healthå’Œhungerï¼‰
            // ç¡®ä¿å€¼æ˜¯æœ‰æ•ˆæ•°å­—ï¼ˆä¸æ˜¯NaNä¸”æ˜¯finiteï¼‰
            const healthValue = (typeof changes.health === 'number' && !isNaN(changes.health) && isFinite(changes.health)) ? changes.health : 0;
            const hungerValue = (typeof changes.hunger === 'number' && !isNaN(changes.hunger) && isFinite(changes.hunger)) ? changes.hunger : 0;
            const survivalDelta = healthValue + hungerValue;
            if (survivalDelta !== 0) {
                survival += survivalDelta;
                nonZero.survival = survivalDelta;
            }
            // å¤¹ç´§èŒƒå›´ï¼Œç¡®ä¿survivalæ˜¯æœ‰æ•ˆæ•°å­—
            survival = Math.max(0, Math.min(100, isNaN(survival) || !isFinite(survival) ? 0 : survival));

            updateBaseStatsUI();
            return nonZero;
        }

        function isDead() {
            // ç”Ÿå­˜çŠ¶æ€å€¼ <= 0 è§†ä¸ºæ’‘ä¸ä½äº†
            return survival <= 0;
        }

        function updateFusionLeftDisplay() {
            const el = document.getElementById('fusion-left');
            if (el) el.textContent = fusionLeft;
        }
        
        // ============== Toast æç¤ºç³»ç»Ÿ ==============
        /**
         * æ˜¾ç¤ºç¾è§‚çš„Toastæç¤º
         * @param {string} message - æç¤ºæ¶ˆæ¯
         * @param {string} type - æç¤ºç±»å‹: 'success', 'error', 'warning', 'info'
         * @param {string} title - å¯é€‰æ ‡é¢˜
         * @param {number} duration - æ˜¾ç¤ºæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤3000ï¼Œ0è¡¨ç¤ºä¸è‡ªåŠ¨å…³é—­
         */
        function showToast(message, type = 'info', title = '', duration = 3000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // æ ¹æ®ç±»å‹è®¾ç½®å›¾æ ‡
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };
            const icon = icons[type] || icons.info;
            
            // å¦‚æœæ²¡æœ‰æä¾›æ ‡é¢˜ï¼Œæ ¹æ®ç±»å‹è®¾ç½®é»˜è®¤æ ‡é¢˜
            const defaultTitles = {
                success: 'æˆåŠŸ',
                error: 'é”™è¯¯',
                warning: 'è­¦å‘Š',
                info: 'æç¤º'
            };
            const displayTitle = title || defaultTitles[type] || '';
            
            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">
                    ${displayTitle ? `<div class="toast-title">${displayTitle}</div>` : ''}
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
            `;
            
            container.appendChild(toast);
            
            // è‡ªåŠ¨å…³é—­
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.add('fade-out');
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }, duration);
            }
        }
        
        // ============== æ¨¡æ€å¯¹è¯æ¡†ç³»ç»Ÿ ==============
        /**
         * æ˜¾ç¤ºæ¨¡æ€å¯¹è¯æ¡†ï¼ˆéœ€è¦ç”¨æˆ·ç‚¹å‡»ç¡®è®¤æ‰èƒ½å…³é—­ï¼‰
         * @param {string} title - æ ‡é¢˜
         * @param {string} message - æ¶ˆæ¯å†…å®¹
         * @param {string} icon - å›¾æ ‡ï¼ˆemojiï¼‰
         * @param {string} buttonText - ç¡®è®¤æŒ‰é’®æ–‡å­—ï¼Œé»˜è®¤ä¸º"ç¡®å®š"
         * @returns {Promise} ç”¨æˆ·ç‚¹å‡»ç¡®è®¤åresolveçš„Promise
         */
        function showModal(title, message, icon = 'â„¹ï¸', buttonText = 'ç¡®å®š') {
            return new Promise((resolve) => {
                const container = document.getElementById('modal-container');
                if (!container) {
                    resolve();
                    return;
                }
                
                // æ¸…é™¤å·²æœ‰çš„æ¨¡æ€å¯¹è¯æ¡†
                container.innerHTML = '';
                
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                
                overlay.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-header">
                            <div class="modal-icon">${icon}</div>
                            <h2 class="modal-title">${title}</h2>
                        </div>
                        <div class="modal-content">
                            ${message}
                        </div>
                        <button class="modal-button" onclick="this.closest('.modal-overlay').remove(); (window.currentModalResolve && window.currentModalResolve());">
                            ${buttonText}
                        </button>
                    </div>
                `;
                
                container.appendChild(overlay);
                
                // ä¿å­˜resolveå‡½æ•°ï¼Œä¾›æŒ‰é’®ç‚¹å‡»æ—¶è°ƒç”¨
                window.currentModalResolve = () => {
                    window.currentModalResolve = null;
                    resolve();
                };
                
                // ç‚¹å‡»é®ç½©å±‚ä¹Ÿå¯ä»¥å…³é—­ï¼ˆå¯é€‰ï¼‰
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        if (window.currentModalResolve) {
                            window.currentModalResolve();
                        }
                    }
                });
            });
        }
        
        /**
         * æ˜¾ç¤ºå¸¦å›¾ç‰‡çš„æ¨¡æ€å¯¹è¯æ¡†ï¼ˆç”¨äºæŒ‘æˆ˜æˆåŠŸï¼‰
         * @param {string} title - æ ‡é¢˜
         * @param {string} message - æ¶ˆæ¯å†…å®¹
         * @param {string} icon - å›¾æ ‡ï¼ˆemojiï¼‰
         * @param {string} imagePrompt - å›¾ç‰‡ç”Ÿæˆæç¤ºè¯
         * @param {string} buttonText - ç¡®è®¤æŒ‰é’®æ–‡å­—ï¼Œé»˜è®¤ä¸º"ç¡®å®š"
         * @returns {Promise} ç”¨æˆ·ç‚¹å‡»ç¡®è®¤åresolveçš„Promise
         */
        async function showModalWithImage(title, message, icon = 'â„¹ï¸', imagePrompt, buttonText = 'ç¡®å®š') {
            return new Promise(async (resolve) => {
                const container = document.getElementById('modal-container');
                if (!container) {
                    resolve();
                    return;
                }
                
                // æ¸…é™¤å·²æœ‰çš„æ¨¡æ€å¯¹è¯æ¡†
                container.innerHTML = '';
                
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                
                const imagePlaceholderId = 'challenge-success-image-' + Date.now();
                
                overlay.innerHTML = `
                    <div class="modal-dialog" style="max-width: 600px;">
                        <div class="modal-header">
                            <div class="modal-icon">${icon}</div>
                            <h2 class="modal-title">${title}</h2>
                        </div>
                        <div class="modal-content">
                            ${message}
                        </div>
                        <div id="${imagePlaceholderId}" style="margin: 20px 0; text-align: center; min-height: 200px; border-radius: 10px; background: rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;">
                            <div>
                                <div class="spinner"></div>
                                <p style="margin-top: 10px; color: #9ca3af;">æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...</p>
                            </div>
                        </div>
                        <button class="modal-button" onclick="this.closest('.modal-overlay').remove(); (window.currentModalResolve && window.currentModalResolve());">
                            ${buttonText}
                        </button>
                    </div>
                `;
                
                container.appendChild(overlay);
                
                // ä¿å­˜resolveå‡½æ•°ï¼Œä¾›æŒ‰é’®ç‚¹å‡»æ—¶è°ƒç”¨
                window.currentModalResolve = () => {
                    window.currentModalResolve = null;
                    resolve();
                };
                
                // ç‚¹å‡»é®ç½©å±‚ä¹Ÿå¯ä»¥å…³é—­ï¼ˆå¯é€‰ï¼‰
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        if (window.currentModalResolve) {
                            window.currentModalResolve();
                        }
                    }
                });
                
                // å¼‚æ­¥ç”Ÿæˆå›¾ç‰‡
                if (imagePrompt) {
                    try {
                        await generateChallengeSuccessImage(imagePrompt, imagePlaceholderId);
                    } catch (error) {
                        console.error('ç”ŸæˆæŒ‘æˆ˜æˆåŠŸå›¾ç‰‡å¤±è´¥:', error);
                    }
                }
            });
        }
        
        /**
         * ç”ŸæˆæŒ‘æˆ˜æˆåŠŸå›¾ç‰‡
         */
        async function generateChallengeSuccessImage(prompt, placeholderId) {
            const placeholder = document.getElementById(placeholderId);
            if (!placeholder) return;
            
            const requestBody = {
                model: IMG_MODEL,
                prompt: prompt,
                n: 1,
                size: "1280x720",
                quality: "standard"
            };
            
            try {
                const response = await fetchWithTimeout(IMG_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${IMG_API_KEY}`
                    },
                    body: JSON.stringify(requestBody)
                }, 30000);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    if (response.status === 403 && errorText.includes('RPM limit exceeded')) {
                        placeholder.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #fbbf24;">
                                <p>å›¾ç‰‡ç”Ÿæˆå—é™</p>
                                <p style="font-size: 0.9em; opacity: 0.8;">APIè¯·æ±‚é¢‘ç‡å·²è¾¾ä¸Šé™</p>
                            </div>
                        `;
                    } else {
                        throw new Error(`ç”Ÿå›¾APIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`);
                    }
                    return;
                }
                
                const data = await response.json();
                let imageUrl;
                
                if (data.data && data.data[0] && data.data[0].url) {
                    imageUrl = data.data[0].url;
                } else if (data.url) {
                    imageUrl = data.url;
                } else if (data.data && data.data[0] && data.data[0].b64_json) {
                    imageUrl = `data:image/png;base64,${data.data[0].b64_json}`;
                } else {
                    throw new Error('æ— æ³•ä»å“åº”ä¸­è§£æå›¾ç‰‡URL');
                }
                
                placeholder.innerHTML = `<img src="${imageUrl}" style="width: 100%; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);" alt="æŒ‘æˆ˜æˆåŠŸ">`;
                // æ¸…é™¤å ä½ç¬¦å®¹å™¨çš„æ ·å¼ï¼Œé¿å…ç°è‰²èƒŒæ™¯æ®‹ç•™
                placeholder.style.background = '';
                placeholder.style.minHeight = '';
                placeholder.style.display = '';
                placeholder.style.alignItems = '';
                placeholder.style.justifyContent = '';
            } catch (error) {
                console.error('ç”ŸæˆæŒ‘æˆ˜æˆåŠŸå›¾ç‰‡å¤±è´¥:', error);
                placeholder.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #9ca3af;">
                        <p>å›¾ç‰‡ç”Ÿæˆå¤±è´¥</p>
                    </div>
                `;
            }
        }

        function updateDayAndActionUI() {
            const el = document.getElementById('day-action-status');
            if (!el) return;
            el.textContent = `ç¬¬ ${currentDay} å¤© / ${MAX_DAY} å¤© ï½œ ä»Šæ—¥è¡ŒåŠ¨ç‚¹ï¼š${actionPoints}/${MAX_ACTION_POINTS}âš¡`;
        }

        // æ£€æŸ¥æŒ‘æˆ˜æ¡ä»¶å¹¶è¿”å›è¿›åº¦ä¿¡æ¯
        function checkChallengeProgress(challenge) {
            if (!challenge || !challenge.victoryCondition) {
                return { completed: false, progress: '', conditionText: '' };
            }
            
            const condition = challenge.victoryCondition;
            let completed = false;
            let current = 0;
            let required = 1;
            let conditionText = '';
            
            if (condition.type === 'hasItem') {
                // æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šæ ‡ç­¾å’Œç­‰çº§çš„ç‰©èµ„
                const count = countItemsByTag(condition.tag, condition.level);
                current = count;
                required = condition.count || 1;
                completed = count >= required;
                
                const tagName = tagLabel(condition.tag);
                conditionText = `æ‹¥æœ‰ ${required} ä¸ª Lv${condition.level} ${tagName}ç±»ç‰©èµ„`;
            } else if (condition.type === 'hasItemMultiple') {
                // æ£€æŸ¥å¤šä¸ªæ¡ä»¶ï¼ˆäºŒé€‰ä¸€ï¼‰ï¼šåªè¦æ»¡è¶³å…¶ä¸­ä¸€ä¸ªæ¡ä»¶å³å¯
                const conditions = condition.conditions || [];
                let satisfiedCondition = null;
                
                for (const cond of conditions) {
                    const count = playerWords.filter(w => w.text === cond.text).length;
                    if (count >= (cond.count || 1)) {
                        satisfiedCondition = cond;
                        completed = true;
                        break;
                    }
                }
                
                if (satisfiedCondition) {
                    current = playerWords.filter(w => w.text === satisfiedCondition.text).length;
                    required = satisfiedCondition.count;
                    conditionText = `æ‹¥æœ‰ ${required} ä¸ªã€${satisfiedCondition.text}ã€‘`;
                } else {
                    // æ˜¾ç¤ºæ‰€æœ‰æ¡ä»¶ï¼ˆç”¨"æˆ–"è¿æ¥ï¼‰
                    const conditionTexts = conditions.map(cond => {
                        const count = playerWords.filter(w => w.text === cond.text).length;
                        return `æ‹¥æœ‰ ${cond.count} ä¸ªã€${cond.text}ã€‘(${count}/${cond.count})`;
                    });
                    conditionText = conditionTexts.join(' æˆ– ');
                    current = 0;
                    required = 1;
                }
            } else if (condition.type === 'shelterStats') {
                // æ£€æŸ¥åº‡æŠ¤æ‰€åšå›ºå€¼
                const shelterOk = shelterDurability >= (condition.shelterDurability || 0);
                completed = shelterOk;
                current = shelterOk ? 1 : 0;
                required = 1;
                conditionText = `åº‡æŠ¤æ‰€åšå›ºå€¼ â‰¥ ${condition.shelterDurability || 0}`;
            } else if (condition.type === 'survival') {
                // æ£€æŸ¥ç”Ÿå­˜çŠ¶æ€å€¼
                const minSurvival = condition.minSurvival || 0;
                completed = survival > minSurvival;
                current = Math.round(survival);
                required = minSurvival;
                conditionText = `ç”Ÿå­˜çŠ¶æ€å€¼ > ${minSurvival}`;
            }
            
            const progress = completed ? `âœ… å·²å®Œæˆ` : `(${current}/${required})`;
            
            return {
                completed,
                progress,
                conditionText,
                current,
                required
            };
        }

        // æ›´æ–°å½“å‰æŒ‘æˆ˜æ˜¾ç¤ºçš„è¾…åŠ©å‡½æ•°
        function updateChallengeDisplay() {
            document.getElementById('challenge-text').textContent = currentChallenge.title + " - " + (currentChallenge.description || "æ­£åœ¨ç”±AIç¼–å†™è¯¦ç»†æƒ…æ™¯...");
            const challengeImageEl = document.getElementById('challenge-image');
            if (challengeImageEl) {
                challengeImageEl.innerHTML = '';
            }
            
            // æ˜¾ç¤ºæŒ‘æˆ˜æ¡ä»¶ï¼ˆä¸æ˜¾ç¤ºè¿›åº¦ï¼‰
            const progressInfo = checkChallengeProgress(currentChallenge);
            let conditionEl = document.getElementById('challenge-condition');
            if (!conditionEl) {
                conditionEl = document.createElement('div');
                conditionEl.id = 'challenge-condition';
                conditionEl.style = 'margin-top: 15px; padding: 12px; background: rgba(201, 184, 155, 0.2); border-radius: 8px; border-left: 4px solid #c9b89b;';
                const challengeTextEl = document.getElementById('challenge-text');
                challengeTextEl.parentNode.insertBefore(conditionEl, challengeTextEl.nextSibling);
            }
            
            if (progressInfo.conditionText) {
                conditionEl.innerHTML = `
                    <p style="margin: 0 0 6px 0; color: #c9b89b; font-weight: 500;">ğŸ“‹ è¾¾æˆæ¡ä»¶ï¼š</p>
                    <p style="margin: 0; color: #7a7773; font-size: 0.95em;">${progressInfo.conditionText}</p>
                `;
            } else {
                conditionEl.innerHTML = '';
            }
            
            // æ‹‰å–AIç”Ÿæˆçš„æŒ‘æˆ˜æè¿°ä¸åœºæ™¯å›¾
            generateChallengeNarrativeAndImage(currentChallenge);
        }
        
        // å®æ—¶æ£€æŸ¥æŒ‘æˆ˜æ˜¯å¦å®Œæˆ
        async function checkChallengeCompletion() {
            if (!currentChallenge || currentChallenge.solved) return;
            
            const progressInfo = checkChallengeProgress(currentChallenge);
            if (progressInfo.completed) {
                // ç«‹å³å®ŒæˆæŒ‘æˆ˜
                currentChallenge.solved = true;
                
                // æ˜¾ç¤ºå®Œæˆæç¤ºï¼ˆä½¿ç”¨å¸¦å›¾ç‰‡çš„æ¨¡æ€å¯¹è¯æ¡†ï¼‰
                const successDescription = currentChallenge.successDescription || `${currentChallenge.title} çš„è¾¾æˆæ¡ä»¶å·²æ»¡è¶³ï¼`;
                // ä¸ºå›¾ç‰‡ç”Ÿæˆåˆ›å»ºæ›´è¯¦ç»†çš„æç¤ºè¯
                const playerPart = playerAppearance ? `ç©å®¶å½¢è±¡ï¼š${playerAppearance}ï¼Œç©å®¶åœ¨åœºæ™¯ä¸­åšå‡ºç¬¦åˆæƒ…æ™¯çš„ç›¸åº”åŠ¨ä½œï¼Œ` : '';
                const imagePrompt = `è’å²›æ±‚ç”Ÿæ¸¸æˆåœºæ™¯ï¼Œ${currentChallenge.title}æˆåŠŸå®Œæˆï¼Œ${successDescription}ï¼Œ${playerPart}æ’ç”»é£æ ¼ï¼Œç”ŸåŠ¨ç»†è‡´ï¼Œå……æ»¡æˆå°±æ„Ÿå’Œå¸Œæœ›`;
                
                await showModalWithImage(
                    'æŒ‘æˆ˜å®Œæˆï¼',
                    `<strong>${currentChallenge.title}</strong><br><br>${successDescription}`,
                    'ğŸ‰',
                    imagePrompt,
                    'ç»§ç»­'
                );
                
                // æ›´æ–°æ˜¾ç¤º
                updateChallengeDisplay();
                
                // ç«‹å³ç»“ç®—æŒ‘æˆ˜å¹¶åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡
                await resolveChallengeImmediately(currentChallenge, true);
            }
        }
        
        // ç«‹å³ç»“ç®—æŒ‘æˆ˜ï¼ˆä¸ç­‰å¾…æ¯æ—¥ç»“ç®—ï¼‰
        async function resolveChallengeImmediately(challenge, success) {
            if (isDead()) return;
            const allItems = [...playerWords];
            
            // æ ¹æ®æŒ‘æˆ˜ç»“æœè®¾ç½®æ•°å€¼å˜åŒ–ï¼ˆä¿ç•™æ¸¸æˆæœºåˆ¶ï¼Œä½¿ç”¨healthå’Œhungerä»¥ä¾¿applyStatChangesåˆå¹¶ï¼‰
            let statChanges = {};
            if (challenge.id === 1) {
                // æŒ‘æˆ˜ä¸€ï¼šå¹²æ¸´ä¸é¥¥é¥¿
                if (success) {
                    statChanges = { health: 0, hunger: +6 }; // åˆå¹¶åä¸º+6
                } else {
                    statChanges = { health: -4, hunger: -10 }; // åˆå¹¶åä¸º-14
                }
            } else if (challenge.id === 2) {
                // æŒ‘æˆ˜äºŒï¼šæš´é£é›¨
                if (success) {
                    statChanges = { health: -2, hunger: -4 }; // åˆå¹¶åä¸º-6
                } else {
                    statChanges = { health: -12, hunger: -6 }; // åˆå¹¶åä¸º-18
                }
            } else if (challenge.id === 3) {
                // æŒ‘æˆ˜ä¸‰ï¼šæš—å¤œé‡å…½
                if (success) {
                    statChanges = { health: -3, hunger: -4 }; // åˆå¹¶åä¸º-7
                } else {
                    statChanges = { health: -15, hunger: -4 }; // åˆå¹¶åä¸º-19
                }
            } else if (challenge.id === 4) {
                // æŒ‘æˆ˜å››ï¼šè´§è½®é€ƒç”Ÿ
                if (success) {
                    statChanges = {};
                } else {
                    statChanges = { health: -4, hunger: -6 }; // åˆå¹¶åä¸º-10
                }
            }
            
            const challengeTitle = challenge.title;

            // åº”ç”¨æ•°å€¼å˜åŒ–
            if (Object.keys(statChanges).length > 0) {
                applyStatChanges(statChanges);
            }

            // å¦‚æœæŒ‘æˆ˜æˆåŠŸï¼Œç«‹å³å‘æ”¾å¥–åŠ±ï¼ˆä¸ç­‰å¾…æ–‡æœ¬ç”Ÿæˆï¼‰
            if (success && challenge.id !== 4) {
                await grantAiRewardItem(currentChallengeIndex);
            }

            // æ£€æŸ¥æ˜¯å¦æ­»äº¡
            if (isDead()) {
                showGameOverScreen("åœ¨æŒ‘æˆ˜ä¸­ï¼Œä½ çš„çŠ¶æ€å·²ç»è·Œè‡³æé™ï¼Œå†ä¹Ÿæ’‘ä¸ä¸‹å»äº†ã€‚");
                return;
            }

            // è®°å½•æŒ‘æˆ˜äº‹ä»¶ï¼ˆä½¿ç”¨é¢„è®¾æè¿°ï¼‰
            const eventCardId = 'event-' + Date.now();
            const challengeDescription = success && challenge.successDescription 
                ? challenge.successDescription 
                : "æŒ‘æˆ˜å‘ç”Ÿäº†ï¼Œä½ å°½åŠ›åº”å¯¹ã€‚";
            logDayEventToResultsWithId(challengeTitle, challengeDescription, eventCardId);

            // å¦‚æœæŒ‘æˆ˜æˆåŠŸï¼Œç«‹å³æ¨è¿›åˆ°ä¸‹ä¸€å…³ï¼ˆä½†ç¬¬4ä¸ªæŒ‘æˆ˜æ˜¯æœ€ç»ˆæŒ‘æˆ˜ï¼Œä¸æ¨è¿›ï¼‰
            if (success && challenge.id !== 4) {
                // çŸ­æš‚å»¶è¿Ÿåæ¨è¿›ï¼Œè®©ç©å®¶çœ‹åˆ°ç»“ç®—ä¿¡æ¯
                setTimeout(() => {
                    advanceToNextChallenge();
                }, 2000);
            }
            
            // ç¬¬4ä¸ªæŒ‘æˆ˜ï¼ˆæœ€ç»ˆæŒ‘æˆ˜ï¼‰ç‰¹æ®Šå¤„ç†
            if (challenge.id === 4) {
                if (success) {
                    setTimeout(() => {
                        showVictoryScreen();
                    }, 2000);
                } else {
                    if (!isDead()) {
                        setTimeout(() => {
                            showGameOverScreen("ä½ é”™è¿‡äº†å”¯ä¸€æ˜ç¡®çš„è·æ•‘æœºä¼šï¼Œåªèƒ½ç»§ç»­åœ¨è’å²›ä¸Šä¸å­¤ç‹¬ä¸ºä¼ã€‚");
                        }, 2000);
                    }
                }
            }
        }

        // æ¨è¿›åˆ°ä¸‹ä¸€å…³
        function advanceToNextChallenge() {
            // ä¿å­˜å½“å‰æŒ‘æˆ˜ç´¢å¼•ï¼ˆç”¨äºå¥–åŠ±åˆ¤æ–­ï¼‰
            const completedChallengeIndex = currentChallengeIndex;
            
            // æ ‡è®°å½“å‰æŒ‘æˆ˜ä¸ºå·²è§£å†³
            challenges[currentChallengeIndex].solved = true;
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æŒ‘æˆ˜éƒ½å·²å®Œæˆ
            if (currentChallengeIndex >= challenges.length - 1) {
                // æ¸¸æˆé€šå…³ï¼
                showVictoryScreen();
                return;
            }
            
            // æ¨è¿›åˆ°ä¸‹ä¸€å…³
            currentChallengeIndex++;
            currentChallenge = challenges[currentChallengeIndex];
            
            // æ¯ä¸ªæŒ‘æˆ˜èƒœåˆ©è·å¾—4æ¬¡ç‰©èµ„åˆæˆæœºä¼š
            fusionLeft += 4;
            updateFusionLeftDisplay();
            
            // çŸ­æš‚å»¶è¿Ÿåæ›´æ–°æ˜¾ç¤ºï¼Œè®©æˆåŠŸåé¦ˆåœç•™ä¸€ä¼šå„¿
            setTimeout(() => {
                updateChallengeDisplay();
                
                // æ˜¾ç¤ºä¸€ä¸ªç®€å•çš„è¿‡æ¸¡åŠ¨ç”»
                const roomDisplay = document.getElementById('room-display');
                roomDisplay.style.opacity = '0.7';
                setTimeout(() => {
                    roomDisplay.style.opacity = '1';
                }, 300);
            }, 2000);
        }

        // æ¸¸æˆé€šå…³ç•Œé¢
        function showVictoryScreen() {
            const roomDisplay = document.getElementById('room-display');
            roomDisplay.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 80px; margin-bottom: 20px;">ğŸ†</div>
                    <h2 style="color: #7a7773;">è’å²›æ±‚ç”Ÿè¾¾äººï¼</h2>
                    <p>ä½ å‡­å€Ÿå†·é™ä¸åˆ›é€ åŠ›ï¼Œåœ¨ç»å¢ƒä¸­å­˜æ´»äº†ä¸‹æ¥ã€‚</p>
                    <div id="ending-summary" style="margin-top:20px;"></div>
                    <div style="margin: 30px 0;">
                        <button onclick="location.reload()" style="
                            background: linear-gradient(45deg, #fbbf24, #f59e0b);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 25px;
                            font-size: 18px;
                            cursor: pointer;
                            margin: 10px;
                        ">é‡æ–°å¼€å§‹</button>
                    </div>
                </div>
            `;
            
            // ç”ŸæˆåŸºäºèµ„æºåº“çš„æ€§æ ¼è¯„è¯­
            generateEndingSummary(true);
        }

        // ============== ç”Ÿå›¾APIé…ç½® ==============

        // æ³¨æ„ï¼šä½ éœ€è¦æ ¹æ®é€‰æ‹©çš„ç”Ÿå›¾æœåŠ¡å•†ï¼ˆå¦‚DALL-Eã€Midjourney APIã€å›½å†…å¹³å°ç­‰ï¼‰å¡«å†™ä»¥ä¸‹ä¿¡æ¯
        const IMG_API_URL = 'https://api.siliconflow.cn/v1/images/generations'; // æ›¿æ¢ä¸ºç”Ÿå›¾APIçš„çœŸå®åœ°å€
        // const IMG_API_URL = 'https://api.ark.cn-beijing.volces.com/api/v3/images/generations'; 
        const IMG_API_KEY = 'sk-qmqcbvermnhrnqanznlmlfqkwxvijjzfjftflxrhsahmttfa'; // æ›¿æ¢ä¸ºä½ çš„ç”Ÿå›¾APIå¯†é’¥
        // const IMG_API_KEY = 'd5948497-96b2-4006-9444-fd0f0d105590'; 
        const IMG_MODEL = 'Kwai-Kolors/Kolors'; // æˆ– 'dall-e-2', 'midjourney', 'stable-diffusion-v1-6' ç­‰ï¼Œæ ¹æ®æœåŠ¡å•†æ”¯æŒå¡«å†™
        // const IMG_MODEL = 'doubao-seedream-4-0-250828'; 

        // å·¥å…·å‡½æ•°ï¼šå°†ç”Ÿæˆçš„è¯è¯­è½¬æ¢ä¸ºé€‚åˆç”Ÿå›¾çš„æè¿°ï¼ˆPromptï¼‰
        function createImagePrompt(name, description, categoryHint) {
            // ç”¨äºä¸ºå·¥å…·/é£Ÿç‰©ç­‰ç”Ÿæˆæ’ç”»
            const playerPart = playerAppearance ? `ï¼Œç©å®¶å½¢è±¡ï¼š${playerAppearance}ï¼Œç©å®¶åœ¨åœºæ™¯ä¸­åšå‡ºç¬¦åˆæƒ…æ™¯çš„ç›¸åº”åŠ¨ä½œ` : '';
            return `è’å²›æ±‚ç”Ÿæ’ç”»ï¼Œç‰©å“"${name}"ã€‚åœºæ™¯ï¼š${description}${playerPart}ã€‚é£æ ¼ï¼šå†™å®æ’ç”»ï¼Œè‰²å½©é²œæ˜ï¼Œä¸­å¿ƒæ„å›¾ã€‚`;
        }
        
        // ä¸“é—¨ç”¨äºå¯»æ‰¾ç‰©èµ„çš„ç”Ÿå›¾å‡½æ•°
        async function generateAndDisplayImageForSearch(locationName, locationEmoji, weather, itemName, itemEmoji, description, placeholderId) {
            const placeholder = document.getElementById(placeholderId);
            if (!placeholder) {
                console.error('æ‰¾ä¸åˆ°å›¾ç‰‡å ä½ç¬¦:', placeholderId);
                return;
            }

            // æ›´æ–°å ä½ç¬¦å†…å®¹ä¸ºåŠ è½½çŠ¶æ€
            placeholder.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p>ğŸ¨ æ­£åœ¨ç»˜åˆ¶å¯»æ‰¾ç‰©èµ„çš„åœºæ™¯...</p>
                </div>
            `;

            // æ„å»ºç”Ÿå›¾è¯·æ±‚
            const playerPart = playerAppearance ? `ç©å®¶å½¢è±¡ï¼š${playerAppearance}ï¼Œç©å®¶åœ¨åœºæ™¯ä¸­åšå‡ºç¬¦åˆæƒ…æ™¯çš„ç›¸åº”åŠ¨ä½œï¼ˆå¦‚å¯»æ‰¾ã€æ‹¾å–ç­‰ï¼‰ï¼Œ` : '';
            const imagePrompt = `è’å²›æ±‚ç”Ÿæ’ç”»ï¼Œåœ¨ã€${locationName}ã€‘${locationEmoji}å¯»æ‰¾ç‰©èµ„ã€‚å½“å‰å¤©æ°”ï¼š${weather}ã€‚æ‰¾åˆ°äº†ã€${itemName}ã€‘${itemEmoji}ã€‚${playerPart}åœºæ™¯ï¼š${description}ã€‚é£æ ¼ï¼šå†™å®æ’ç”»ï¼Œæ¨ªå‘æ„å›¾ï¼Œå±•ç°åœ°ç‚¹ç¯å¢ƒå’Œå¤©æ°”æ•ˆæœã€‚`;

            const requestBody = {
                model: IMG_MODEL,
                prompt: imagePrompt,
                n: 1,
                // size: "512x384",
                size: "1280x720",
                quality: "standard"
            };

            try {
                console.log(`ğŸ–¼ï¸ æ­£åœ¨è¯·æ±‚ç”Ÿæˆå¯»æ‰¾ç‰©èµ„çš„å›¾ç‰‡...`);

                const response = await fetchWithTimeout(IMG_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${IMG_API_KEY}`
                    },
                    body: JSON.stringify(requestBody)
                }, 30000);

                if (!response.ok) {
                    const errorText = await response.text();
                    const errorMessage = `ç”Ÿå›¾APIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`;
                    // ç‰¹æ®Šå¤„ç†403 RPMé™åˆ¶é”™è¯¯
                    if (response.status === 403 && errorText.includes('RPM limit exceeded')) {
                        showToast('å›¾ç‰‡ç”ŸæˆAPIå·²è¾¾åˆ°è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œè¯·ç¨åå†è¯•æˆ–å®Œæˆèº«ä»½éªŒè¯', 'warning', 'âš ï¸ å›¾ç‰‡ç”Ÿæˆå—é™', 5000);
                        throw new Error('RPM_LIMIT_EXCEEDED');
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('ç”Ÿå›¾APIå®Œæ•´å“åº”:', data);

                // ä»å“åº”ä¸­æå–å›¾ç‰‡URL
                let imageUrl;
                
                if (data.data && data.data[0] && data.data[0].url) {
                    imageUrl = data.data[0].url;
                } else if (data.url) {
                    imageUrl = data.url;
                } else if (data.data && data.data[0] && data.data[0].b64_json) {
                    imageUrl = `data:image/png;base64,${data.data[0].b64_json}`;
                } else {
                    console.warn('æ— æ³•è¯†åˆ«çš„å“åº”æ ¼å¼ï¼Œå°è¯•å…¶ä»–è·¯å¾„...', data);
                    throw new Error('æ— æ³•ä»å“åº”ä¸­è§£æå›¾ç‰‡URLï¼Œè¯·æ£€æŸ¥æ•°æ®ç»“æ„ã€‚');
                }

                // å°†å›¾ç‰‡URLæ’å…¥åˆ°é¡µé¢ä¸­
                placeholder.innerHTML = `
                    <img src="${imageUrl}" 
                        alt="å¯»æ‰¾ç‰©èµ„" 
                        style="width:100%; border-radius:8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);"
                        onerror="this.onerror=null; this.parentElement.innerHTML='<p style=\'color:red;\'>âš ï¸ å›¾ç‰‡åŠ è½½å¤±è´¥</p>';">
                `;
                // æ¸…é™¤å ä½ç¬¦å®¹å™¨çš„æ ·å¼ï¼Œé¿å…ç°è‰²èƒŒæ™¯æ®‹ç•™
                placeholder.style.background = '';
                placeholder.style.minHeight = '';
                placeholder.style.display = '';
                placeholder.style.alignItems = '';
                placeholder.style.justifyContent = '';
                placeholder.style.padding = '';
            } catch (error) {
                console.error('ç”Ÿæˆå¯»æ‰¾ç‰©èµ„å›¾ç‰‡å¤±è´¥:', error);
                // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„å ä½ç¬¦
                if (error.message === 'RPM_LIMIT_EXCEEDED') {
                    placeholder.innerHTML = `
                        <div style="text-align: center; padding: 30px; background: rgba(201, 184, 155, 0.2); border-radius: 10px; border: 2px dashed rgba(201, 184, 155, 0.4);">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ¨</div>
                            <p style="color: #c9b89b; font-weight: 500; margin-bottom: 8px;">å›¾ç‰‡ç”Ÿæˆå—é™</p>
                            <p style="font-size: 0.9em; color: #7a7773; opacity: 0.8;">APIè¯·æ±‚é¢‘ç‡å·²è¾¾ä¸Šé™ï¼Œè¯·ç¨åå†è¯•</p>
                        </div>
                    `;
                } else {
                    placeholder.innerHTML = `
                        <div style="text-align: center; padding: 30px; background: rgba(196, 165, 165, 0.2); border-radius: 10px; border: 2px dashed rgba(196, 165, 165, 0.4);">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ–¼ï¸</div>
                            <p style="color: #c4a5a5; font-weight: 500; margin-bottom: 8px;">å›¾ç‰‡ç”Ÿæˆå¤±è´¥</p>
                            <p style="font-size: 0.9em; color: #7a7773; opacity: 0.8;">è¯·ç¨åé‡è¯•</p>
                        </div>
                    `;
                }
            }
        }

        // ä¸“é—¨ç”¨äºä¿®å»ºåº‡æŠ¤æ‰€çš„ç”Ÿå›¾å‡½æ•°
        async function generateAndDisplayImageForShelter(materialName, description, placeholderId) {
            const placeholder = document.getElementById(placeholderId);
            if (!placeholder) {
                console.error('æ‰¾ä¸åˆ°å›¾ç‰‡å ä½ç¬¦:', placeholderId);
                return;
            }

            // æ›´æ–°å ä½ç¬¦å†…å®¹ä¸ºåŠ è½½çŠ¶æ€
            placeholder.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p>ğŸ¨ æ­£åœ¨ç»˜åˆ¶ä¿®å»ºåº‡æŠ¤æ‰€çš„åœºæ™¯...</p>
                </div>
            `;

            // æ„å»ºç”Ÿå›¾è¯·æ±‚
            const playerPart = playerAppearance ? `ç©å®¶å½¢è±¡ï¼š${playerAppearance}ï¼Œç©å®¶åœ¨åœºæ™¯ä¸­åšå‡ºç¬¦åˆæƒ…æ™¯çš„ç›¸åº”åŠ¨ä½œï¼ˆå¦‚ä¿®å»ºã€æ­å»ºç­‰ï¼‰ï¼Œ` : '';
            const imagePrompt = `è’å²›æ±‚ç”Ÿæ’ç”»ï¼Œä½¿ç”¨ã€${materialName}ã€‘ä¿®å»ºåº‡æŠ¤æ‰€ã€‚${playerPart}åœºæ™¯ï¼š${description}ã€‚é£æ ¼ï¼šå†™å®æ’ç”»ï¼Œæ¨ªå‘æ„å›¾ã€‚`;

            const requestBody = {
                model: IMG_MODEL,
                prompt: imagePrompt,
                n: 1,
                size: "1280x720",
                quality: "standard"
            };

            try {
                console.log(`ğŸ–¼ï¸ æ­£åœ¨è¯·æ±‚ç”Ÿæˆä¿®å»ºåº‡æŠ¤æ‰€çš„å›¾ç‰‡...`);

                const response = await fetchWithTimeout(IMG_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${IMG_API_KEY}`
                    },
                    body: JSON.stringify(requestBody)
                }, 30000);

                if (!response.ok) {
                    const errorText = await response.text();
                    const errorMessage = `ç”Ÿå›¾APIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`;
                    // ç‰¹æ®Šå¤„ç†403 RPMé™åˆ¶é”™è¯¯
                    if (response.status === 403 && errorText.includes('RPM limit exceeded')) {
                        showToast('å›¾ç‰‡ç”ŸæˆAPIå·²è¾¾åˆ°è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œè¯·ç¨åå†è¯•æˆ–å®Œæˆèº«ä»½éªŒè¯', 'warning', 'âš ï¸ å›¾ç‰‡ç”Ÿæˆå—é™', 5000);
                        throw new Error('RPM_LIMIT_EXCEEDED');
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('ç”Ÿå›¾APIå®Œæ•´å“åº”:', data);

                // ä»å“åº”ä¸­æå–å›¾ç‰‡URL
                let imageUrl;
                
                if (data.data && data.data[0] && data.data[0].url) {
                    imageUrl = data.data[0].url;
                } else if (data.url) {
                    imageUrl = data.url;
                } else if (data.data && data.data[0] && data.data[0].b64_json) {
                    imageUrl = `data:image/png;base64,${data.data[0].b64_json}`;
                } else {
                    console.warn('æ— æ³•è¯†åˆ«çš„å“åº”æ ¼å¼ï¼Œå°è¯•å…¶ä»–è·¯å¾„...', data);
                    throw new Error('æ— æ³•ä»å“åº”ä¸­è§£æå›¾ç‰‡URLï¼Œè¯·æ£€æŸ¥æ•°æ®ç»“æ„ã€‚');
                }

                // å°†å›¾ç‰‡URLæ’å…¥åˆ°é¡µé¢ä¸­
                placeholder.innerHTML = `
                    <img src="${imageUrl}" 
                        alt="ä¿®å»ºåº‡æŠ¤æ‰€" 
                        style="width:100%; border-radius:8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);"
                        onerror="this.onerror=null; this.parentElement.innerHTML='<p style=\'color:red;\'>âš ï¸ å›¾ç‰‡åŠ è½½å¤±è´¥</p>';">
                `;
                // æ¸…é™¤å ä½ç¬¦å®¹å™¨çš„æ ·å¼ï¼Œé¿å…ç°è‰²èƒŒæ™¯æ®‹ç•™
                placeholder.style.background = '';
                placeholder.style.minHeight = '';
                placeholder.style.display = '';
                placeholder.style.alignItems = '';
                placeholder.style.justifyContent = '';
                placeholder.style.padding = '';
            } catch (error) {
                console.error('ç”Ÿæˆåº‡æŠ¤æ‰€å›¾ç‰‡å¤±è´¥:', error);
                // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„å ä½ç¬¦
                if (error.message === 'RPM_LIMIT_EXCEEDED') {
                    placeholder.innerHTML = `
                        <div style="text-align: center; padding: 30px; background: rgba(201, 184, 155, 0.2); border-radius: 10px; border: 2px dashed rgba(201, 184, 155, 0.4);">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ¨</div>
                            <p style="color: #c9b89b; font-weight: 500; margin-bottom: 8px;">å›¾ç‰‡ç”Ÿæˆå—é™</p>
                            <p style="font-size: 0.9em; color: #7a7773; opacity: 0.8;">APIè¯·æ±‚é¢‘ç‡å·²è¾¾ä¸Šé™ï¼Œè¯·ç¨åå†è¯•</p>
                        </div>
                    `;
                } else {
                    placeholder.innerHTML = `
                        <div style="text-align: center; padding: 30px; background: rgba(196, 165, 165, 0.2); border-radius: 10px; border: 2px dashed rgba(196, 165, 165, 0.4);">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ–¼ï¸</div>
                            <p style="color: #c4a5a5; font-weight: 500; margin-bottom: 8px;">å›¾ç‰‡ç”Ÿæˆå¤±è´¥</p>
                            <p style="font-size: 0.9em; color: #7a7773; opacity: 0.8;">è¯·ç¨åé‡è¯•</p>
                        </div>
                    `;
                }
            }
    }

        // ============== æ¸¸æˆçŠ¶æ€ ==============
        let playerWords = [...basicWords];  // ç©å®¶æ‹¥æœ‰çš„ç‰©èµ„
        let fusionResults = [];  // åˆæˆè®°å½•
        let selectedWords = [null, null];  // ä¸¤ä¸ªåˆæˆæ§½ä½
        let usedWordIds = new Set();  // å·²ä½¿ç”¨çš„ç‰©èµ„IDï¼ˆé˜²æ­¢ä¸€ä¸ªç‰©èµ„è¢«æ‹–åˆ°å¤šä¸ªä½ç½®ï¼‰
        
        // ============== åœ°ç‚¹ç›¸å…³å‡½æ•° ==============
        let currentUnlockingLocation = null; // å½“å‰æ­£åœ¨è§£é”çš„åœ°ç‚¹ID
        let unlockSlotItem = null; // è§£é”æ§½ä½ä¸­çš„ç‰©å“

        function renderLocationButtons() {
            const container = document.getElementById('location-buttons-container');
            if (!container) return;

            container.innerHTML = '';
            
            // æŒ‰é¡ºåºæ˜¾ç¤ºï¼šæ ‘æ—ã€æµ·è¾¹ã€å±±æ´
            const locationOrder = ['forest', 'beach', 'cave'];
            locationOrder.forEach(locId => {
                const location = LOCATIONS[locId];
                const btn = document.createElement('button');
                btn.className = 'fusion-btn';
                
                // æ£€æŸ¥è¯¥åœ°ç‚¹æ˜¯å¦å—å¤©æ°”å½±å“
                const isAffected = checkLocationWeatherImpact(locId);
                
                if (location.unlocked) {
                    // å¦‚æœå—å¤©æ°”å½±å“ï¼Œæ·»åŠ è­¦å‘Šæ ·å¼
                    if (isAffected) {
                        btn.style.border = '2px solid rgba(196, 165, 165, 0.5)';
                        btn.style.background = 'rgba(196, 165, 165, 0.2)';
                        btn.style.maxWidth = '200px';
                        btn.style.textAlign = 'center';
                        btn.style.lineHeight = '1.4';
                        btn.innerHTML = `âš ï¸ ${location.emoji} ${location.name}<br><span style="color: #c4a5a5; font-size: 0.85em;">å—å¤©æ°”å½±å“</span>`;
                        // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœï¼Œä¸è¡ŒåŠ¨æŒ‰é’®ä¿æŒä¸€è‡´
                        btn.onmouseover = () => {
                            btn.style.background = 'rgba(196, 165, 165, 0.3)';
                            btn.style.borderColor = '#c4a5a5';
                        };
                        btn.onmouseout = () => {
                            btn.style.background = 'rgba(196, 165, 165, 0.2)';
                            btn.style.borderColor = 'rgba(196, 165, 165, 0.5)';
                        };
                    } else {
                        btn.style.border = '';
                        btn.style.background = '';
                        btn.style.maxWidth = '';
                        btn.style.textAlign = '';
                        btn.style.lineHeight = '';
                        btn.innerHTML = `${location.emoji} ${location.name}`;
                    }
                    btn.onclick = () => findRawMaterial(locId);
                    btn.id = `location-btn-${locId}`;
                } else {
                    btn.innerHTML = `ğŸ”’ ${location.emoji} ${location.name}`;
                    btn.onclick = () => showUnlockLocationModal(locId);
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'pointer';
                    btn.id = `location-btn-${locId}`;
                }
                
                container.appendChild(btn);
            });
        }

        function showUnlockLocationModal(locationId) {
            const location = LOCATIONS[locationId];
            if (!location || location.unlocked) return;

            const modal = document.getElementById('unlock-location-modal');
            const textEl = document.getElementById('unlock-location-text');
            const slotEl = document.getElementById('unlock-location-slot');
            
            if (!modal || !textEl || !slotEl) return;

            currentUnlockingLocation = locationId;
            unlockSlotItem = null;
            
            const req = location.unlockRequirement;
            textEl.textContent = `è§£é”${location.name}éœ€è¦ï¼š${req.text}ï¼ˆ${tagLabel(req.tag)}ï¼‰`;
            slotEl.innerHTML = 'æ‹–æ”¾ç‰©å“åˆ°æ­¤å¤„è§£é”';
            slotEl.style.borderColor = '#c9b89b';
            slotEl.style.backgroundColor = 'rgba(201, 184, 155, 0.2)';
            
            document.getElementById('confirm-unlock-btn').style.display = 'none';
            modal.style.display = 'block';

            // è®¾ç½®æ‹–æ”¾äº‹ä»¶
            setupUnlockSlotDragAndDrop(slotEl);
        }

        function setupUnlockSlotDragAndDrop(slotEl) {
            // æ¸…é™¤ä¹‹å‰çš„å†…å®¹å’ŒçŠ¶æ€
            unlockSlotItem = null;
            slotEl.innerHTML = 'æ‹–æ”¾ç‰©å“åˆ°æ­¤å¤„è§£é”';
            slotEl.style.borderColor = '#c9b89b';
            slotEl.style.backgroundColor = 'rgba(201, 184, 155, 0.2)';
            
            // ç§»é™¤ä¹‹å‰çš„æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼ˆé€šè¿‡å…‹éš†èŠ‚ç‚¹ï¼‰
            const newSlotEl = slotEl.cloneNode(true);
            slotEl.parentNode.replaceChild(newSlotEl, slotEl);
            
            // è·å–æ›´æ–°åçš„å…ƒç´ å¼•ç”¨
            const unlockSlot = document.getElementById('unlock-location-slot');
            if (!unlockSlot) return;
            
            unlockSlot.addEventListener('dragover', (e) => {
                e.preventDefault();
                unlockSlot.style.borderColor = '#22c55e';
                unlockSlot.style.backgroundColor = 'rgba(34, 197, 94, 0.2)';
            });

            unlockSlot.addEventListener('dragleave', (e) => {
                e.preventDefault();
                if (!unlockSlotItem) {
                    unlockSlot.style.borderColor = '#c9b89b';
                    unlockSlot.style.backgroundColor = 'rgba(201, 184, 155, 0.2)';
                }
            });

            unlockSlot.addEventListener('drop', (e) => {
                e.preventDefault();
                const wordId = e.dataTransfer.getData('text/plain');
                const word = playerWords.find(w => String(w.id) === wordId);
                
                if (word && !usedWordIds.has(Number(word.id))) {
                    const location = LOCATIONS[currentUnlockingLocation];
                    if (!location) return;
                    const req = location.unlockRequirement;
                    if (!req) return;
                    
                    // æ£€æŸ¥ç‰©å“æ˜¯å¦ç¬¦åˆè¦æ±‚
                    if (word.text === req.text && word.tag === req.tag) {
                        unlockSlotItem = word;
                        usedWordIds.add(Number(word.id));
                        unlockSlot.innerHTML = `
                            <div style="font-size: 16px; font-weight: 500; color: #fff;">
                                ${word.emoji} ${word.text}
                            </div>
                        `;
                        unlockSlot.style.borderColor = '#22c55e';
                        unlockSlot.style.backgroundColor = 'rgba(34, 197, 94, 0.3)';
                        const confirmBtn = document.getElementById('confirm-unlock-btn');
                        if (confirmBtn) {
                            confirmBtn.style.display = 'inline-block';
                        }
                    } else {
                        alert(`éœ€è¦æäº¤ã€${req.text}ã€‘æ¥è§£é”${location.name}ï¼`);
                        unlockSlot.style.borderColor = '#fbbf24';
                        unlockSlot.style.backgroundColor = 'rgba(251, 191, 36, 0.1)';
                    }
                } else if (word && usedWordIds.has(Number(word.id))) {
                    alert('è¯¥ç‰©å“å·²è¢«ä½¿ç”¨ï¼');
                    unlockSlot.style.borderColor = '#c9b89b';
                    unlockSlot.style.backgroundColor = 'rgba(201, 184, 155, 0.2)';
                }
            });
        }

        function confirmUnlockLocation() {
            if (!currentUnlockingLocation || !unlockSlotItem) return;

            const location = LOCATIONS[currentUnlockingLocation];
            const req = location.unlockRequirement;
            
            // éªŒè¯ç‰©å“
            if (unlockSlotItem.text === req.text && unlockSlotItem.tag === req.tag) {
                // æ¶ˆè€—ç‰©å“
                consumeItem(unlockSlotItem, 1);
                renderWordInventory();
                
                // è§£é”åœ°ç‚¹
                location.unlocked = true;
                
                // éšè—è§£é”ç•Œé¢
                cancelUnlockLocation();
                
                // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                renderLocationButtons();
                
                // æ˜¾ç¤ºè§£é”æˆåŠŸæ¶ˆæ¯
                const resultsDiv = document.getElementById('fusion-results');
                if (resultsDiv) {
                    const resultCard = document.createElement('div');
                    resultCard.className = 'result-card';
                    resultCard.style.borderLeftColor = '#c9b89b';
                    resultCard.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 24px;">ğŸ”“</span>
                            <span style="font-size: 18px; font-weight: 500;">è§£é”æ–°åœ°ç‚¹</span>
                        </div>
                        <p style="margin-bottom: 8px;">
                            ä½¿ç”¨ã€${unlockSlotItem.emoji} ${unlockSlotItem.text}ã€‘è§£é”äº†ã€${location.emoji} ${location.name}ã€‘ï¼
                        </p>
                        <div style="text-align: right; font-size: 12px; opacity: 0.7; margin-top: 8px;">
                            ${new Date().toLocaleTimeString()}
                        </div>
                    `;
                    resultsDiv.prepend(resultCard);
                    resultsDiv.scrollTop = 0;
                }
            }
        }

        function cancelUnlockLocation() {
            if (unlockSlotItem) {
                usedWordIds.delete(unlockSlotItem.id);
                unlockSlotItem = null;
            }
            currentUnlockingLocation = null;
            const modal = document.getElementById('unlock-location-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ============== å¤©æ°”ç³»ç»Ÿå‡½æ•° ==============
        async function initWeather() {
            // åˆå§‹åŒ–å¤©æ°”ï¼šå…ˆåŠ è½½æ‰€æœ‰å¤©æ°”çš„å½±å“æ•°æ®ï¼Œç„¶ååˆ‡æ¢å¤©æ°”
            await loadAllWeatherEffects();
            await changeWeather();
        }
        
        // æ˜¾ç¤ºå¤©æ°”åŠ è½½æç¤º
        function showWeatherLoadingModal() {
            const container = document.getElementById('modal-container');
            if (!container) return null;
            
            // æ¸…é™¤å·²æœ‰çš„æ¨¡æ€å¯¹è¯æ¡†
            container.innerHTML = '';
            
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.id = 'weather-loading-modal';
            
            overlay.innerHTML = `
                <div class="modal-dialog" style="max-width: 400px;">
                    <div class="modal-header">
                        <div class="modal-icon">ğŸŒ¤ï¸</div>
                        <h2 class="modal-title">æ­£åœ¨åˆå§‹åŒ–å¤©æ°”ç³»ç»Ÿ</h2>
                    </div>
                    <div class="modal-content" style="text-align: center; padding: 30px 20px;">
                        <div class="spinner" style="margin: 0 auto 20px auto;"></div>
                        <p style="color: #7a7773; font-size: 1em; margin: 0;">æ­£åœ¨åˆ†ææ‰€æœ‰å¤©æ°”å¯¹è¡ŒåŠ¨çš„å½±å“...</p>
                        <p style="color: #9ca3af; font-size: 0.9em; margin-top: 10px;">è¯·ç¨å€™</p>
                    </div>
                </div>
            `;
            
            container.appendChild(overlay);
            return overlay;
        }
        
        // éšè—å¤©æ°”åŠ è½½æç¤º
        function hideWeatherLoadingModal() {
            const modal = document.getElementById('weather-loading-modal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s ease-out';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }
        
        // åœ¨æ¸¸æˆå¼€å§‹æ—¶ä¸€æ¬¡æ€§è·å–æ‰€æœ‰å¤©æ°”çš„å½±å“æ•°æ®
        async function loadAllWeatherEffects() {
            console.log('å¼€å§‹åŠ è½½æ‰€æœ‰å¤©æ°”çš„å½±å“æ•°æ®...');
            
            // å¦‚æœå·²ç»åŠ è½½è¿‡ï¼Œç›´æ¥è¿”å›
            if (Object.keys(weatherEffectsCache).length === WEATHER_TYPES.length) {
                console.log('å¤©æ°”å½±å“æ•°æ®å·²ç¼“å­˜ï¼Œè·³è¿‡åŠ è½½');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            showWeatherLoadingModal();
            
            // æ„å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰å¤©æ°”çš„æç¤º
            const weatherList = WEATHER_TYPES.join('ã€');
            
            try {
                const response = await fetchWithTimeout(LLM_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${LLM_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: LLM_MODEL_NAME,
                        messages: [
                            {
                                role: "system",
                                content: `ä½ æ˜¯è’å²›æ±‚ç”Ÿæ¸¸æˆçš„å¤©æ°”ç³»ç»Ÿã€‚æ ¹æ®å¤©æ°”åˆ¤æ–­å—å½±å“çš„è¡ŒåŠ¨å’Œåœ°ç‚¹ã€‚

è¡ŒåŠ¨ç±»å‹ï¼šsearchLocation, buildShelter, huntFish, craftTool, eat
åœ°ç‚¹ï¼šforest, beach, cave

è¿”å›JSONæ ¼å¼ï¼š
{
  "æ™´å¤©": {
    "affectedActions": [],
    "affectedLocations": {"forest": false, "beach": false, "cave": false}
  },
  "å¤šäº‘": {
    "affectedActions": [],
    "affectedLocations": {"forest": false, "beach": false, "cave": false}
  },
  ...
}

è§„åˆ™ï¼šä½¿ç”¨è‹±æ–‡keyï¼Œå¸ƒå°”å€¼è¡¨ç¤ºæ˜¯å¦å—å½±å“ã€‚ä¸ºæ¯ç§å¤©æ°”è¿”å›affectedActionsæ•°ç»„å’ŒaffectedLocationså¯¹è±¡ã€‚`
                            },
                            {
                                role: "user",
                                content: `è¯·ä¸ºä»¥ä¸‹æ‰€æœ‰å¤©æ°”ç±»å‹åˆ¤æ–­å—å½±å“çš„è¡ŒåŠ¨å’Œåœ°ç‚¹ï¼š${weatherList}ã€‚è¿”å›ä¸€ä¸ªJSONå¯¹è±¡ï¼Œé”®ä¸ºå¤©æ°”åç§°ï¼Œå€¼ä¸ºåŒ…å«affectedActionså’ŒaffectedLocationsçš„å¯¹è±¡ã€‚`
                            }
                        ],
                        temperature: 0.5,
                        max_tokens: 500,
                        response_format: { "type": "json_object" }
                    })
                }, 30000);
                
                if (response.ok) {
                    const data = await response.json();
                    const parsed = safeParseJSON(data.choices[0].message.content);
                    
                    // è½¬æ¢AIè¿”å›çš„æ•°æ®æ ¼å¼
                    const actionNameMap = {
                        'å¯»æ‰¾ç‰©èµ„': 'searchLocation',
                        'ä¿®å»ºåº‡æŠ¤æ‰€': 'buildShelter',
                        'æ‰“çŒ/é’“é±¼/ç ä¼': 'huntFish',
                        'åˆ¶ä½œå·¥å…·': 'craftTool',
                        'è¿›é£Ÿ': 'eat'
                    };
                    
                    // å¤„ç†æ¯ç§å¤©æ°”çš„æ•°æ®
                    for (const weather of WEATHER_TYPES) {
                        const weatherData = parsed[weather];
                        if (weatherData) {
                            // è½¬æ¢å—å½±å“è¡ŒåŠ¨
                            let aiAffectedActions = weatherData.affectedActions || [];
                            const convertedActions = aiAffectedActions.map(action => {
                                if (['searchLocation', 'buildShelter', 'huntFish', 'craftTool', 'eat'].includes(action)) {
                                    return action;
                                }
                                if (actionNameMap[action]) {
                                    return actionNameMap[action];
                                }
                                return action;
                            });
                            
                            // è½¬æ¢å—å½±å“åœ°ç‚¹
                            const convertedLocations = {
                                forest: weatherData.affectedLocations?.forest === true || weatherData.affectedLocations?.['æ ‘æ—'] === true || false,
                                beach: weatherData.affectedLocations?.beach === true || weatherData.affectedLocations?.['æµ·è¾¹'] === true || false,
                                cave: weatherData.affectedLocations?.cave === true || weatherData.affectedLocations?.['å±±æ´'] === true || false
                            };
                            
                            weatherEffectsCache[weather] = {
                                affectedActions: convertedActions,
                                affectedLocations: convertedLocations
                            };
                        } else {
                            // å¦‚æœAIæ²¡æœ‰è¿”å›è¯¥å¤©æ°”çš„æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼
                            weatherEffectsCache[weather] = getDefaultWeatherEffects(weather);
                        }
                    }
                    
                    console.log('æ‰€æœ‰å¤©æ°”å½±å“æ•°æ®åŠ è½½å®Œæˆ:', weatherEffectsCache);
                } else {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                console.error('åŠ è½½å¤©æ°”å½±å“æ•°æ®å¤±è´¥:', error);
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä¸ºæ‰€æœ‰å¤©æ°”è®¾ç½®é»˜è®¤å€¼
                console.warn('ä½¿ç”¨é»˜è®¤çš„å¤©æ°”å½±å“è§„åˆ™');
                for (const weather of WEATHER_TYPES) {
                    weatherEffectsCache[weather] = getDefaultWeatherEffects(weather);
                }
            } finally {
                // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½éšè—åŠ è½½æç¤º
                hideWeatherLoadingModal();
            }
        }
        
        // è·å–é»˜è®¤çš„å¤©æ°”å½±å“ï¼ˆç”¨äºå›é€€ï¼‰
        function getDefaultWeatherEffects(weather) {
            if (weather === 'æš´é›¨' || weather === 'å¤§é£') {
                return {
                    affectedActions: ['searchLocation', 'buildShelter', 'huntFish'],
                    affectedLocations: { forest: true, beach: true, cave: false }
                };
            } else if (weather === 'å°é›¨') {
                return {
                    affectedActions: ['searchLocation', 'huntFish'],
                    affectedLocations: { forest: true, beach: false, cave: false }
                };
            } else if (weather === 'ç‚çƒ­') {
                return {
                    affectedActions: ['huntFish'],
                    affectedLocations: { forest: true, beach: true, cave: false }
                };
            } else if (weather === 'é›¾å¤©') {
                return {
                    affectedActions: ['searchLocation', 'huntFish'],
                    affectedLocations: { forest: true, beach: true, cave: false }
                };
            } else if (weather === 'å‡‰çˆ½') {
                return {
                    affectedActions: [],
                    affectedLocations: { forest: false, beach: false, cave: false }
                };
            } else {
                // æ™´å¤©ã€å¤šäº‘ç­‰é»˜è®¤ä¸å½±å“
                return {
                    affectedActions: [],
                    affectedLocations: { forest: false, beach: false, cave: false }
                };
            }
        }
        
        async function changeWeather() {
            // éšæœºé€‰æ‹©ä¸€ä¸ªå¤©æ°”
            const randomWeather = WEATHER_TYPES[Math.floor(Math.random() * WEATHER_TYPES.length)];
            currentWeather = randomWeather;
            actionPointCounter = 0; // é‡ç½®è®¡æ•°å™¨
            
            // æ›´æ–°å¤©æ°”åç§°æ˜¾ç¤º
            const weatherNameEl = document.getElementById('weather-name');
            if (weatherNameEl) {
                weatherNameEl.textContent = currentWeather;
            }
            
            // ä»ç¼“å­˜ä¸­è·å–è¯¥å¤©æ°”çš„å½±å“æ•°æ®
            const weatherEffects = weatherEffectsCache[currentWeather];
            if (weatherEffects) {
                affectedActions = [...weatherEffects.affectedActions]; // å¤åˆ¶æ•°ç»„
                affectedLocations = { ...weatherEffects.affectedLocations }; // å¤åˆ¶å¯¹è±¡
                console.log('å¤©æ°”åˆ‡æ¢:', currentWeather, 'å—å½±å“è¡ŒåŠ¨:', affectedActions, 'å—å½±å“åœ°ç‚¹:', affectedLocations);
            } else {
                // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼ˆè¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿï¼Œä½†ä½œä¸ºå›é€€ï¼‰
                console.warn('å¤©æ°”å½±å“ç¼“å­˜ä¸­æœªæ‰¾åˆ°', currentWeather, 'ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                const defaultEffects = getDefaultWeatherEffects(currentWeather);
                affectedActions = defaultEffects.affectedActions;
                affectedLocations = defaultEffects.affectedLocations;
            }
            
            // æ›´æ–°åœ°ç‚¹æŒ‰é’®æ˜¾ç¤º
            renderLocationButtons();
            
            // å¦‚æœè¡ŒåŠ¨èœå•å½“å‰æ˜¯æ‰“å¼€çš„ï¼Œåˆ·æ–°å®ƒä»¥æ˜¾ç¤ºæœ€æ–°çš„å—å½±å“è¡ŒåŠ¨
            const menuEl = document.getElementById('action-menu');
            if (menuEl && menuEl.style.display !== 'none' && menuEl.style.display !== '') {
                if (actionSlotItem) {
                    showActionMenu(actionSlotItem);
                }
            }
            
            // ç”Ÿæˆå¤©æ°”å›¾ç‰‡
            generateWeatherImage();
        }
        
        function generateWeatherImage() {
            const weatherImageEl = document.getElementById('weather-image');
            if (!weatherImageEl) {
                console.error('weather-image å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            // å¤©æ°”åç§°åˆ°å›¾ç‰‡æ–‡ä»¶åçš„æ˜ å°„
            const weatherImageMap = {
                'æ™´å¤©': 'sunny.png',
                'å¤šäº‘': 'cloudy.png',
                'å°é›¨': 'rain.png',
                'æš´é›¨': 'storm.png',
                'å¤§é£': 'windy.png',
                'é›¾å¤©': 'foggy.png',
                'ç‚çƒ­': 'hot.png',
                'å‡‰çˆ½': 'cool.png'
            };
            
            // è·å–å¯¹åº”çš„å›¾ç‰‡æ–‡ä»¶å
            const imageFileName = weatherImageMap[currentWeather] || 'sunny.png';
            const imagePath = `image/${imageFileName}`;
            
            console.log('åŠ è½½å¤©æ°”å›¾ç‰‡:', currentWeather, '->', imagePath);
            
            // åˆ›å»ºå›¾ç‰‡å…ƒç´ å¹¶æ·»åŠ åŠ è½½å’Œé”™è¯¯å¤„ç†
            const img = document.createElement('img');
            img.src = imagePath;
            img.style.width = '100%';
            img.style.borderRadius = '8px';
            img.alt = currentWeather;
            
            img.onload = function() {
                console.log('å¤©æ°”å›¾ç‰‡åŠ è½½æˆåŠŸ:', imagePath);
                weatherImageEl.innerHTML = '';
                weatherImageEl.appendChild(img);
            };
            
            img.onerror = function() {
                console.error('å¤©æ°”å›¾ç‰‡åŠ è½½å¤±è´¥:', imagePath);
                weatherImageEl.innerHTML = `<p style="color:#9ca3af; font-size:0.9em; text-align:center;">${currentWeather} (å›¾ç‰‡åŠ è½½å¤±è´¥: ${imagePath})</p>`;
            };
            
            // å…ˆæ¸…ç©ºå®¹å™¨
            weatherImageEl.innerHTML = '';
            weatherImageEl.appendChild(img);
        }
        
        function checkWeatherImpact(actionType) {
            // æ£€æŸ¥è¡ŒåŠ¨æ˜¯å¦å—å¤©æ°”å½±å“
            // ç¡®ä¿ affectedActions æ˜¯æ•°ç»„
            if (!Array.isArray(affectedActions)) {
                console.warn('affectedActions ä¸æ˜¯æ•°ç»„:', affectedActions);
                affectedActions = [];
            }
            const result = affectedActions.includes(actionType);
            return result;
        }
        
        function checkLocationWeatherImpact(locationId) {
            // æ£€æŸ¥åœ°ç‚¹æ˜¯å¦å—å¤©æ°”å½±å“
            // ç¡®ä¿ affectedLocations æ˜¯å¯¹è±¡
            if (!affectedLocations || typeof affectedLocations !== 'object') {
                console.warn('affectedLocations ä¸æ˜¯å¯¹è±¡:', affectedLocations);
                affectedLocations = { forest: false, beach: false, cave: false };
            }
            return affectedLocations[locationId] === true;
        }
        
        // ============== å¼€å§‹é¡µé¢ç›¸å…³å‡½æ•° ==============
        // åˆå§‹åŒ–å¼€å§‹é¡µé¢äº‹ä»¶ç›‘å¬
        function initStartPage() {
            const appearanceInput = document.getElementById('player-appearance-input');
            const charCountEl = document.getElementById('char-count');
            
            if (appearanceInput && charCountEl) {
                appearanceInput.addEventListener('input', function() {
                    const text = this.value;
                    const count = text.length;
                    charCountEl.textContent = count > 20 ? 20 : count;
                    
                    // é™åˆ¶è¾“å…¥é•¿åº¦ä¸º20å­—
                    if (count > 20) {
                        this.value = text.substring(0, 20);
                        charCountEl.textContent = 20;
                    }
                    
                    // æ›´æ–°é¢œè‰²æç¤º
                    if (count > 20) {
                        charCountEl.style.color = '#c4a5a5';
                    } else if (count === 20) {
                        charCountEl.style.color = '#c9b89b';
                    } else {
                        charCountEl.style.color = '#7a7773';
                    }
                });
            }
        }
        
        // ç”Ÿæˆè§’è‰²å½¢è±¡å›¾ç‰‡
        async function generateCharacterImage() {
            const nameInput = document.getElementById('player-name-input');
            const appearanceInput = document.getElementById('player-appearance-input');
            const generateBtn = document.getElementById('generate-image-btn');
            const imageContainer = document.getElementById('character-image-container');
            const characterImage = document.getElementById('character-image');
            const afterGenerateButtons = document.getElementById('after-generate-buttons');
            
            // éªŒè¯è¾“å…¥
            const name = nameInput.value.trim();
            const appearance = appearanceInput.value.trim();
            
            if (!name) {
                showToast('è¯·è¾“å…¥ä½ çš„åå­—', 'warning');
                return;
            }
            
            if (!appearance) {
                showToast('è¯·æè¿°ä½ çš„å½¢è±¡', 'warning');
                return;
            }
            
            if (appearance.length > 20) {
                showToast('å½¢è±¡æè¿°ä¸èƒ½è¶…è¿‡20å­—', 'warning');
                return;
            }
            
            // ä¿å­˜ç©å®¶åå­—å’Œå½¢è±¡æè¿°
            playerName = name;
            playerAppearance = appearance;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            generateBtn.disabled = true;
            generateBtn.textContent = 'â³ æ­£åœ¨ç”Ÿæˆå½¢è±¡...';
            imageContainer.style.display = 'flex';
            imageContainer.innerHTML = `
                <div style="text-align: center;">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; color: #7a7773;">æ­£åœ¨ç”Ÿæˆä½ çš„å½¢è±¡...</p>
                </div>
            `;
            
            // æ„å»ºå›¾ç‰‡ç”Ÿæˆæç¤ºè¯
            const imagePrompt = `æ­£é¢åŠèº«ç…§ï¼Œ${appearance}ï¼Œæ—¥å¼æ’ç”»é£æ ¼ï¼Œç»†è…»çš„çº¿æ¡ï¼ŒæŸ”å’Œçš„è‰²å½©ï¼ŒèƒŒæ™¯ç®€æ´`;
            
            try {
                const requestBody = {
                    model: IMG_MODEL,
                    prompt: imagePrompt,
                    n: 1,
                    size: "1280x1280",
                    quality: "standard"
                };
                
                const response = await fetchWithTimeout(IMG_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${IMG_API_KEY}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    if (response.status === 403 && errorText.includes('RPM limit exceeded')) {
                        showToast('å›¾ç‰‡ç”ŸæˆAPIå·²è¾¾åˆ°è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œè¯·ç¨åå†è¯•', 'warning', 'âš ï¸ å›¾ç‰‡ç”Ÿæˆå—é™', 5000);
                        imageContainer.innerHTML = `
                            <div style="text-align: center; padding: 30px; color: #c4a5a5;">
                                <p style="font-weight: 500; margin-bottom: 8px;">å›¾ç‰‡ç”Ÿæˆå—é™</p>
                                <p style="font-size: 0.9em; opacity: 0.8;">APIè¯·æ±‚é¢‘ç‡å·²è¾¾ä¸Šé™ï¼Œè¯·ç¨åå†è¯•</p>
                            </div>
                        `;
                    } else {
                        throw new Error(`ç”Ÿå›¾APIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`);
                    }
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'å¼€å§‹ç”Ÿæˆå½¢è±¡';
                    return;
                }
                
                const data = await response.json();
                let imageUrl;
                
                if (data.data && data.data[0] && data.data[0].url) {
                    imageUrl = data.data[0].url;
                } else if (data.url) {
                    imageUrl = data.url;
                } else if (data.data && data.data[0] && data.data[0].b64_json) {
                    imageUrl = `data:image/png;base64,${data.data[0].b64_json}`;
                } else {
                    throw new Error('æ— æ³•ä»å“åº”ä¸­è§£æå›¾ç‰‡URL');
                }
                
                // æ˜¾ç¤ºç”Ÿæˆçš„å›¾ç‰‡
                characterImage.src = imageUrl;
                imageContainer.innerHTML = '';
                imageContainer.appendChild(characterImage);
                
                // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
                generateBtn.style.display = 'none';
                afterGenerateButtons.style.display = 'flex';
                afterGenerateButtons.style.justifyContent = 'center';
                
                showToast('å½¢è±¡ç”ŸæˆæˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('ç”Ÿæˆè§’è‰²å½¢è±¡å¤±è´¥:', error);
                imageContainer.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #c4a5a5;">
                        <p style="font-weight: 500; margin-bottom: 8px;">ç”Ÿæˆå¤±è´¥</p>
                        <p style="font-size: 0.9em; opacity: 0.8;">${error.message || 'è¯·ç¨åé‡è¯•'}</p>
                    </div>
                `;
                generateBtn.disabled = false;
                generateBtn.textContent = 'å¼€å§‹ç”Ÿæˆå½¢è±¡';
            }
        }
        
        // å¼€å§‹æ¸¸æˆï¼ˆè·³è½¬åˆ°ä¸»é¡µé¢ï¼‰
        function startGame() {
            const startPage = document.getElementById('start-page');
            const mainGame = document.getElementById('main-game');
            
            if (!startPage || !mainGame) {
                console.error('æ‰¾ä¸åˆ°å¼€å§‹é¡µé¢æˆ–ä¸»é¡µé¢å…ƒç´ ');
                return;
            }
            
            // éšè—å¼€å§‹é¡µé¢ï¼Œæ˜¾ç¤ºä¸»é¡µé¢
            startPage.style.display = 'none';
            mainGame.style.display = 'block';
            
            // åˆå§‹åŒ–æ¸¸æˆ
            initGame();
        }
        
        // ============== åˆå§‹åŒ– ==============
        function initGame() {
            // åˆå§‹åŒ–ç‰©èµ„åº“å­˜
            renderWordInventory();
            
            // åˆå§‹åŒ–éšæœºåŸºç¡€æ•°å€¼
            initBaseStats();
            
            // åˆå§‹åˆæˆæ¬¡æ•°ï¼ˆç¬¬ä¸€å…³å¼€å§‹å‰ç»™ä¸€æ¬¡é¢„å¤‡åˆæˆï¼‰
            fusionLeft = 4;
            updateFusionLeftDisplay();
            
            // åˆå§‹åŒ–æŒ‘æˆ˜
            updateChallengeDisplay();
            
            // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            initDragAndDrop();
            
            // åˆå§‹åŒ–åœ°ç‚¹æŒ‰é’®
            renderLocationButtons();
            
            // åˆå§‹åŒ–å¤©æ°”
            initWeather();
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å¼€å§‹é¡µé¢
        window.addEventListener('DOMContentLoaded', function() {
            initStartPage();
        });
        
        // æ¸²æŸ“è¯è¯­åº“å­˜
        function tagLabel(tag) {
            switch (tag) {
                case 'food': return 'é£Ÿç‰©';
                case 'material': return 'åŸææ–™';
                case 'tool': return 'å·¥å…·';
                default: return 'æœªçŸ¥';
            }
        }

        function getTagDisplayName(tag) {
            return tagLabel(tag);
        }

        function defaultUses(tag) {
            if (tag === 'material') return 2;
            if (tag === 'tool') return 5;
            if (tag === 'food') return 1;
            return 1;
        }

        // ç”Ÿæˆå”¯ä¸€çš„ç‰©èµ„IDï¼ˆæ‰¾åˆ°å½“å‰æœ€å¤§çš„IDï¼Œç„¶å+1ï¼‰
        function getNextWordId() {
            if (playerWords.length === 0) return 1;
            const maxId = Math.max(...playerWords.map(w => w.id || 0));
            return maxId + 1;
        }

        function consumeItem(item, amount = 1) {
            item.usesLeft = (item.usesLeft ?? defaultUses(item.tag)) - amount;
            if (item.usesLeft <= 0) {
                playerWords = playerWords.filter(w => w.id !== item.id);
                renderWordInventory();
            }
        }

        function renderWordInventory() {
            // ç‰©èµ„å˜åŒ–åæ£€æŸ¥æŒ‘æˆ˜æ˜¯å¦å®Œæˆ
            checkChallengeCompletion();
            const container = document.getElementById('word-inventory');
            container.innerHTML = '';
            
            playerWords.forEach(word => {
                const div = document.createElement('div');
                div.className = 'word-item';
                div.draggable = true;
                div.dataset.wordId = word.id;
                
                const lvl = word.level || 1;
                const uses = word.usesLeft ?? defaultUses(word.tag);
                // å¯¹äºå·¥å…·å’ŒåŸææ–™ï¼Œæ˜¾ç¤ºä½¿ç”¨æ¬¡æ•°
                let usesDisplay = '';
                if (word.tag === 'tool' || word.tag === 'material') {
                    usesDisplay = ` [${uses}æ¬¡]`;
                }
                div.innerHTML = `
                    <span class="word-emoji">${word.emoji}</span>
                    <span>${word.text} (Lv${lvl}Â·${tagLabel(word.tag)})${usesDisplay}</span>
                `;
                
                div.addEventListener('dragstart', handleDragStart);
                container.appendChild(div);
            });
        }
        
        // ============== æ‹–æ‹½åŠŸèƒ½ ==============
        function initDragAndDrop() {
            // åªå¤„ç†åˆæˆæ§½ä½ï¼ˆslot1å’Œslot2ï¼‰ï¼Œå¿½ç•¥å…¶ä»–slot
            const slot1 = document.getElementById('slot1');
            const slot2 = document.getElementById('slot2');
            const fusionSlots = [slot1, slot2];
            
            fusionSlots.forEach((slot, index) => {
                if (!slot) return;
                
                slot.addEventListener('dragover', e => {
                    e.preventDefault();
                    slot.style.borderColor = 'rgba(157, 150, 167, 0.8)';
                    slot.style.backgroundColor = 'rgba(235, 230, 235, 0.6)';
                });
                
                slot.addEventListener('dragleave', () => {
                    slot.style.borderColor = '#b8b3b5';
                    slot.style.backgroundColor = 'rgba(220, 217, 212, 0.4)';
                });
                
                slot.addEventListener('drop', e => {
                    e.preventDefault();
                    const wordId = e.dataTransfer.getData('text/plain');
                    
                    // ç¡®ä¿wordIdæœ‰æ•ˆ
                    if (!wordId || wordId === '') {
                        console.error('æ— æ•ˆçš„ç‰©èµ„ID');
                        return;
                    }
                    
                    // ç¡®ä¿IDç±»å‹ä¸€è‡´ï¼ˆè½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒï¼Œå› ä¸ºword.idæ˜¯æ•°å­—ï¼‰
                    const wordIdNum = parseInt(wordId, 10);
                    if (isNaN(wordIdNum)) {
                        console.error('æ— æ³•è§£æç‰©èµ„ID:', wordId);
                        return;
                    }
                    
                    // ä½¿ç”¨ä¸¥æ ¼æ•°å­—åŒ¹é…æŸ¥æ‰¾ç‰©èµ„ï¼ˆç¡®ä¿æ‰¾åˆ°æ­£ç¡®çš„ç‰©èµ„ï¼Œå³ä½¿åç§°ç›¸åŒï¼‰
                    const word = playerWords.find(w => Number(w.id) === wordIdNum);
                    
                    if (word) {
                        // æ£€æŸ¥ç‰©èµ„æ˜¯å¦å·²è¢«ä½¿ç”¨
                        if (usedWordIds.has(wordIdNum)) {
                            showToast('è¯¥ç‰©èµ„å·²è¢«ä½¿ç”¨ï¼Œè¯·å…ˆæ¸…ç©ºå…¶ä»–ä½ç½®', 'warning');
                            return;
                        }
                        
                        // å¦‚æœè¿™ä¸ªæ§½ä½ä¹‹å‰æœ‰ç‰©èµ„ï¼Œå…ˆå–æ¶ˆä¹‹å‰çš„æ ‡è®°
                        if (selectedWords[index]) {
                            const oldWordId = selectedWords[index].id;
                            usedWordIds.delete(oldWordId);
                        }
                        
                        // æ ‡è®°æ–°ç‰©èµ„ä¸ºå·²ä½¿ç”¨
                        usedWordIds.add(wordIdNum);
                        // ç¡®ä¿ä½¿ç”¨æ‰¾åˆ°çš„ç‰©èµ„å¯¹è±¡ï¼Œè€Œä¸æ˜¯é€šè¿‡å…¶ä»–æ–¹å¼è·å–
                        selectedWords[index] = word;
                        slot.innerHTML = `
                            <div>${word.emoji} ${word.text} (Lv${word.level || 1})</div>
                        `;
                        slot.style.borderColor = 'rgba(157, 150, 167, 0.8)';
                        slot.style.background = 'rgba(235, 230, 235, 0.5)';
                    } else {
                        console.error('æ‰¾ä¸åˆ°ç‰©èµ„ï¼ŒwordId:', wordId, 'wordIdNum:', wordIdNum);
                        console.log('å½“å‰ç‰©èµ„åº“:', playerWords.map(w => ({id: w.id, text: w.text})));
                        alert(`æ— æ³•æ‰¾åˆ°ç‰©èµ„ï¼ˆID: ${wordId}ï¼‰ï¼Œè¯·é‡è¯•ã€‚`);
                    }
                });
            });
    
            // è¡ŒåŠ¨æ§½ä½çš„æ‹–æ‹½å¤„ç†
            const actionSlot = document.getElementById('action-slot');
            if (actionSlot) {
                actionSlot.addEventListener('dragover', (e) => {
                e.preventDefault();
                    actionSlot.style.borderColor = 'rgba(168, 181, 160, 0.8)';
                    actionSlot.style.background = 'rgba(230, 235, 230, 0.5)';
            });
            
                actionSlot.addEventListener('dragleave', () => {
                    actionSlot.style.borderColor = '#a8b5a0';
                    actionSlot.style.background = 'rgba(220, 217, 212, 0.4)';
            });
            
                actionSlot.addEventListener('drop', (e) => {
                e.preventDefault();
                    actionSlot.style.borderColor = '#a8b5a0';
                    actionSlot.style.background = 'rgba(220, 217, 212, 0.4)';
                    
                    if (actionPoints <= 0) {
                        alert('ä»Šæ—¥è¡ŒåŠ¨ç‚¹å·²ç”¨å®Œï¼Œæ— æ³•å†æ‰§è¡Œè¡ŒåŠ¨ã€‚è¯·ç»“æŸä»Šå¤©ã€‚');
                        return;
                    }
                
                const wordId = e.dataTransfer.getData('text/plain');
                    
                    // ç¡®ä¿wordIdæœ‰æ•ˆ
                    if (!wordId || wordId === '') {
                        console.error('æ— æ•ˆçš„ç‰©èµ„ID');
                        return;
                    }
                    
                    // ç¡®ä¿IDç±»å‹ä¸€è‡´ï¼ˆè½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒï¼Œå› ä¸ºword.idæ˜¯æ•°å­—ï¼‰
                    const wordIdNum = parseInt(wordId, 10);
                    if (isNaN(wordIdNum)) {
                        console.error('æ— æ³•è§£æç‰©èµ„ID:', wordId);
                        return;
                    }
                    
                    // æ£€æŸ¥ç‰©èµ„æ˜¯å¦å·²è¢«ä½¿ç”¨
                    if (usedWordIds.has(wordIdNum)) {
                        alert('è¯¥ç‰©èµ„å·²è¢«ä½¿ç”¨ï¼Œè¯·å…ˆæ¸…ç©ºå…¶ä»–ä½ç½®ï¼');
                        return;
                    }
                    
                    // ä½¿ç”¨ä¸¥æ ¼åŒ¹é…æŸ¥æ‰¾ç‰©èµ„
                    const word = playerWords.find(w => Number(w.id) === wordIdNum);
                
                    if (word) {
                        // å¦‚æœè¡ŒåŠ¨æ§½ä½ä¹‹å‰æœ‰ç‰©èµ„ï¼Œå…ˆå–æ¶ˆä¹‹å‰çš„æ ‡è®°
                        if (actionSlotItem) {
                            const oldWordId = actionSlotItem.id;
                            usedWordIds.delete(oldWordId);
                        }
                        
                        // æ ‡è®°æ–°ç‰©èµ„ä¸ºå·²ä½¿ç”¨
                        usedWordIds.add(wordIdNum);
                        
                        // ç¡®ä¿ä½¿ç”¨æ‰¾åˆ°çš„ç‰©èµ„ï¼Œè€Œä¸æ˜¯ä¹‹å‰çš„å€¼
                        actionSlotItem = word;
                        actionSlot.innerHTML = `
                            <div style="font-size: 16px; font-weight: 500; color: #5a5753;">
                                ${word.emoji} ${word.text}
                        </div>
                        `;
                        showActionMenu(word);
                    } else {
                        console.error('æ‰¾ä¸åˆ°ç‰©èµ„ï¼ŒwordId:', wordId, 'wordIdNum:', wordIdNum);
                        console.log('å½“å‰ç‰©èµ„åº“:', playerWords.map(w => ({id: w.id, text: w.text})));
                        alert(`æ— æ³•æ‰¾åˆ°ç‰©èµ„ï¼ˆID: ${wordId}ï¼‰ï¼Œè¯·é‡è¯•ã€‚`);
                }
            });
            }
        }
        
        function handleDragStart(e) {
            // ä½¿ç”¨currentTargetç¡®ä¿è·å–åˆ°æ­£ç¡®çš„å…ƒç´ ï¼ˆåŒ…å«dataset.wordIdçš„divï¼‰
            // å› ä¸ºäº‹ä»¶ç›‘å¬å™¨ç»‘å®šåœ¨divä¸Šï¼ŒcurrentTargetåº”è¯¥å°±æ˜¯é‚£ä¸ªdiv
            const target = e.currentTarget;
            let wordId = target.dataset.wordId;
            
            // å¦‚æœå½“å‰å…ƒç´ æ²¡æœ‰wordIdï¼Œå‘ä¸ŠæŸ¥æ‰¾
            if (!wordId) {
                const closest = target.closest('[data-word-id]');
                if (closest && closest.dataset.wordId) {
                    wordId = closest.dataset.wordId;
                }
            }
            
            if (wordId) {
                // ç¡®ä¿wordIdæ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼Œå¹¶æ¸…é™¤å¯èƒ½çš„ç©ºç™½å­—ç¬¦
                const cleanWordId = String(wordId).trim();
                const wordIdNum = parseInt(cleanWordId, 10);
                
                // æ£€æŸ¥ç‰©èµ„æ˜¯å¦å·²è¢«ä½¿ç”¨
                if (usedWordIds.has(wordIdNum)) {
                    e.preventDefault();
                    alert('è¯¥ç‰©èµ„å·²è¢«ä½¿ç”¨ï¼Œè¯·å…ˆæ¸…ç©ºå…¶ä»–ä½ç½®ï¼');
                    return;
                }
                
                e.dataTransfer.setData('text/plain', cleanWordId);
            } else {
                console.error('æ— æ³•æ‰¾åˆ°ç‰©èµ„ID:', {
                    target: target,
                    dataset: target.dataset,
                    closest: target.closest('[data-word-id]')
                });
            }
            }
            
        // æ˜¾ç¤ºè¡ŒåŠ¨é€‰æ‹©èœå•
        function showActionMenu(item) {
            const menuEl = document.getElementById('action-menu');
            if (!menuEl) return;
            
            menuEl.style.display = 'block';
            
            // æ£€æŸ¥å“ªäº›è¡ŒåŠ¨å—å¤©æ°”å½±å“
            const affectedActionKeys = [];
            console.log('=== æ˜¾ç¤ºè¡ŒåŠ¨èœå•è°ƒè¯•ä¿¡æ¯ ===');
            console.log('å½“å‰å¤©æ°”:', currentWeather);
            console.log('å—å½±å“è¡ŒåŠ¨æ•°ç»„:', affectedActions);
            console.log('å—å½±å“è¡ŒåŠ¨æ•°ç»„ç±»å‹:', typeof affectedActions, 'é•¿åº¦:', affectedActions ? affectedActions.length : 'null');
            console.log('æ‰€æœ‰è¡ŒåŠ¨ç±»å‹:', Object.keys(ACTION_TYPES));
            
            Object.keys(ACTION_TYPES).forEach(actionKey => {
                const isAffected = checkWeatherImpact(actionKey);
                console.log(`æ£€æŸ¥è¡ŒåŠ¨ "${actionKey}":`, isAffected);
                if (isAffected) {
                    affectedActionKeys.push(actionKey);
                }
            });
            console.log('æ‰¾åˆ°çš„å—å½±å“è¡ŒåŠ¨é”®:', affectedActionKeys);
            console.log('=== è°ƒè¯•ä¿¡æ¯ç»“æŸ ===');
            
            // æ„å»ºèœå•HTML
            let menuHTML = '<p style="color: #a8b5a0; margin-bottom: 12px; font-weight: 500;">é€‰æ‹©è¦æ‰§è¡Œçš„è¡ŒåŠ¨ï¼š</p>';
            
            // å¦‚æœæœ‰å—å½±å“çš„è¡ŒåŠ¨ï¼Œæ˜¾ç¤ºå¤©æ°”å½±å“è¯´æ˜
            // ä¸´æ—¶æµ‹è¯•ï¼šå¦‚æœå½“å‰æ˜¯æ™´å¤©ä¸”æ²¡æœ‰å—å½±å“è¡ŒåŠ¨ï¼Œå¼ºåˆ¶æ˜¾ç¤ºä¸€ä¸ªæç¤ºï¼ˆç”¨äºæµ‹è¯•ï¼‰
            const shouldShowWarning = affectedActionKeys.length > 0;
            if (shouldShowWarning) {
                console.log('æ˜¾ç¤ºå¤©æ°”å½±å“æç¤º - æœ‰', affectedActionKeys.length, 'ä¸ªè¡ŒåŠ¨å—å½±å“');
                menuHTML += `
                    <div style="margin-bottom: 12px; padding: 10px; background: rgba(196, 165, 165, 0.2); border: 2px solid rgba(196, 165, 165, 0.4); border-radius: 8px;">
                        <p style="color: #b89999; font-weight: 500; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                            <span>âš ï¸</span>
                            <span>å½“å‰å¤©æ°”ã€${currentWeather}ã€‘å½±å“ä»¥ä¸‹è¡ŒåŠ¨ï¼š</span>
                        </p>
                        <p style="color: #b89999; font-size: 12px; line-height: 1.5; margin: 0;">
                            â€¢ å—å½±å“çš„è¡ŒåŠ¨æœ‰<strong style="color: #c4a5a5;">50%å¤±è´¥ç‡</strong>ï¼Œå¤±è´¥æ—¶å¾—ä¸åˆ°ç‰©èµ„/æ”¶ç›Š<br>
                            â€¢ å¦‚æœ<strong style="color: #a8b5a0;">æˆåŠŸ</strong>ï¼Œå°†è·å¾—<strong style="color: #a8b5a0;">åŒå€æ”¶ç›Š</strong>
                        </p>
                    </div>
                `;
            }
            
            menuEl.innerHTML = menuHTML;
            
            const actionsGrid = document.createElement('div');
            actionsGrid.style.display = 'grid';
            actionsGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
            actionsGrid.style.gap = '10px';
            
            Object.keys(ACTION_TYPES).forEach(actionKey => {
                const action = ACTION_TYPES[actionKey];
                const isAffected = checkWeatherImpact(actionKey);
                const btn = document.createElement('button');
                
                // æ ¹æ®æ˜¯å¦å—å¤©æ°”å½±å“è®¾ç½®ä¸åŒçš„æ ·å¼
                if (isAffected) {
                    btn.style.cssText = `
                        padding: 12px;
                        background: rgba(196, 165, 165, 0.2);
                        border: 2px solid rgba(196, 165, 165, 0.5);
                        border-radius: 10px;
                        color: #5a5753;
                        cursor: pointer;
                        transition: all 0.3s;
                        text-align: left;
                        position: relative;
                    `;
                    btn.innerHTML = `
                        <div style="position: absolute; top: 4px; right: 4px; font-size: 16px;">âš ï¸</div>
                        <div style="font-size: 20px; margin-bottom: 4px;">${action.emoji}</div>
                        <div style="font-weight: 500; margin-bottom: 2px; color: #5a5753;">${action.name}</div>
                        <div style="font-size: 12px; color: #7a7773;">${action.description}</div>
                        <div style="font-size: 11px; color: #c4a5a5; margin-top: 4px; font-weight: 500;">âš ï¸ å—å¤©æ°”å½±å“</div>
                    `;
                    btn.onmouseover = () => {
                        btn.style.background = 'rgba(196, 165, 165, 0.3)';
                        btn.style.borderColor = '#c4a5a5';
                    };
                    btn.onmouseout = () => {
                        btn.style.background = 'rgba(196, 165, 165, 0.2)';
                        btn.style.borderColor = 'rgba(196, 165, 165, 0.5)';
                    };
                } else {
                    btn.style.cssText = `
                        padding: 12px;
                        background: rgba(168, 181, 160, 0.2);
                        border: 2px solid rgba(168, 181, 160, 0.4);
                        border-radius: 10px;
                        color: #5a5753;
                        cursor: pointer;
                        transition: all 0.3s;
                        text-align: left;
                    `;
                    btn.innerHTML = `
                        <div style="font-size: 20px; margin-bottom: 4px;">${action.emoji}</div>
                        <div style="font-weight: 500; margin-bottom: 2px; color: #5a5753;">${action.name}</div>
                        <div style="font-size: 12px; color: #7a7773;">${action.description}</div>
                    `;
                    btn.onmouseover = () => {
                        btn.style.background = 'rgba(168, 181, 160, 0.3)';
                        btn.style.borderColor = '#a8b5a0';
                    };
                    btn.onmouseout = () => {
                        btn.style.background = 'rgba(168, 181, 160, 0.2)';
                        btn.style.borderColor = 'rgba(168, 181, 160, 0.4)';
                    };
                }
                
                btn.onclick = () => executeAction(actionKey, item);
                actionsGrid.appendChild(btn);
            });
            
            menuEl.appendChild(actionsGrid);
        }

        // æ‰§è¡Œè¡ŒåŠ¨ï¼šåº”ç”¨æ•°å€¼å˜åŒ– + AIåé¦ˆ
        async function executeAction(actionKey, item) {
            const action = ACTION_TYPES[actionKey];
            if (!action) return;
            const tag = item.tag || 'material';
            // è¡Œä¸ºæ ¡éªŒ
            if (actionKey === 'craftTool' && tag !== 'material') { alert('åˆ¶ä½œå·¥å…·åªèƒ½ä½¿ç”¨åŸææ–™ç±»ç‰©èµ„'); return; }
            if (actionKey === 'eat' && tag !== 'food') { alert('è¿›é£Ÿåªèƒ½ä½¿ç”¨é£Ÿç‰©ç±»ç‰©èµ„'); return; }
            if (actionKey === 'buildShelter' && tag !== 'material') { alert('ä¿®å»ºåº‡æŠ¤æ‰€åªèƒ½ä½¿ç”¨åŸææ–™ç±»ç‰©èµ„'); return; }
            // æ‰“çŒ/é’“é±¼/ç ä¼éœ€è¦å·¥å…·ç±»ç‰©èµ„ï¼Œä½†åå°„ä¿¡å·æ¿è™½ç„¶æ˜¯materialä¹Ÿå¯ä»¥ç”¨äºæ‰“çŒï¼ˆå¸ƒç½®é™·é˜±ï¼‰
            if (actionKey === 'huntFish' && tag !== 'tool' && item.text !== 'åå°„ä¿¡å·æ¿') { alert('æ‰“çŒ/é’“é±¼/ç ä¼éœ€è¦å·¥å…·ç±»ç‰©èµ„'); return; }
            
            // æ¶ˆè€—è¡ŒåŠ¨ç‚¹ï¼ˆè¿›é£Ÿè¡ŒåŠ¨ä¸æ¶ˆè€—è¡ŒåŠ¨ç‚¹ï¼‰
            if (actionKey !== 'eat') {
                if (actionPoints <= 0) { alert('ä»Šæ—¥è¡ŒåŠ¨ç‚¹å·²ç”¨å®Œ'); return; }
                actionPoints -= 1;
                actionPointCounter += 1;
                // æ¯æ¶ˆè€—3è¡ŒåŠ¨ç‚¹æ¢ä¸€æ¬¡å¤©æ°”
                if (actionPointCounter >= 3) {
                    changeWeather();
                }
                updateDayAndActionUI();
            }
            
            // ç¦ç”¨æ‰€æœ‰è¡ŒåŠ¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const actionMenu = document.getElementById('action-menu');
            const actionButtons = actionMenu ? actionMenu.querySelectorAll('button') : [];
            const originalButtonStates = [];
            actionButtons.forEach((btn, index) => {
                originalButtonStates[index] = {
                    disabled: btn.disabled,
                    innerHTML: btn.innerHTML,
                    opacity: btn.style.opacity,
                    cursor: btn.style.cursor
                };
                btn.disabled = true;
                if (btn.innerHTML.includes(action.emoji)) {
                    btn.innerHTML = `â³ ${action.name}ä¸­...`;
                }
                btn.style.opacity = '0.6';
                btn.style.cursor = 'not-allowed';
            });
            
            // å…ˆè®¡ç®—ç³»ç»Ÿé»˜è®¤çš„æ•°å€¼å˜åŒ–ï¼ˆæŒ‰ç‰©èµ„ç­‰çº§è°ƒæ•´ï¼‰
            const lvl = item.level || 1;
            let defaultChanges = {};
            
            if (actionKey === 'eat') {
                // è¿›é£Ÿé€»è¾‘ï¼šç³»ç»Ÿè§„å®šçš„å›ºå®šæ•°å€¼ï¼Œæœ‰åˆç†æ¢¯åº¦ï¼ˆåˆå¹¶ä¸ºsurvivalå˜åŒ–ï¼‰
                // ä¸€çº§é£Ÿç‰©ï¼šç”Ÿçš„æˆ–éš¾å’½ä¸‹çš„ï¼Œæ•ˆæœå·®ï¼Œå¯èƒ½æ‰£ç”Ÿå‘½å€¼
                if (lvl === 1) {
                    defaultChanges = {
                        health: -1,  // ä¸€çº§é£Ÿç‰©å¯èƒ½è½»å¾®æ‰£ç”Ÿå‘½å€¼
                        hunger: 5     // ä¸€çº§é£Ÿç‰©åŠ çš„é¥±è…¹å€¼å°‘ï¼Œåˆå¹¶åä¸º+4
                    };
                } else if (lvl === 2) {
                    // äºŒçº§é£Ÿç‰©ï¼šç®€å•å¤„ç†è¿‡çš„ï¼Œæ•ˆæœä¸€èˆ¬ï¼Œåˆå¹¶åä¸º+13
                    defaultChanges = {
                        health: 3,
                        hunger: 10
                    };
                } else if (lvl === 3) {
                    // ä¸‰çº§é£Ÿç‰©ï¼šè¾ƒå¥½å¤„ç†çš„ï¼Œæ•ˆæœä¸é”™ï¼Œåˆå¹¶åä¸º+21
                    defaultChanges = {
                        health: 6,
                        hunger: 15
                    };
                } else {
                    // å››çº§é£Ÿç‰©ï¼šç²¾å¿ƒåˆ¶ä½œçš„ï¼Œæ•ˆæœå¾ˆå¥½ï¼Œåˆå¹¶åä¸º+30
                    defaultChanges = {
                        health: 10,
                        hunger: 20
                    };
                }
            } else {
                // å…¶ä»–è¡ŒåŠ¨ï¼šæŒ‰ç­‰çº§æ”¾å¤§
                const factor = 1 + 0.5 * (lvl - 1); // Lv1=1.0, Lv4=2.5
                defaultChanges = {
                    health: Math.round((action.statChanges.health || 0) * factor),
                    hunger: Math.round((action.statChanges.hunger || 0) * factor)
                };
            }
            
            // å…ˆæŒ‰é…æ–¹è¡¨ç”Ÿæˆç‰©èµ„ï¼ˆåˆ¶ä½œå·¥å…·å’Œæ•çŒ/é’“é±¼ï¼‰ï¼Œç„¶åå†è°ƒç”¨AI
            let newItem = null;
            let newItemBlock = '';
            
            // æŒ‰ç±»åˆ«æ¶ˆè€—è¾“å…¥ç‰©èµ„
            if (actionKey === 'craftTool' || actionKey === 'buildShelter') {
                if (tag === 'material') consumeItem(item, 1);
            } else if (actionKey === 'eat') {
                if (tag === 'food') consumeItem(item, item.usesLeft || 1);
            } else if (actionKey === 'huntFish') {
                // æ‰“çŒ/é’“é±¼/ç ä¼ä½¿ç”¨å·¥å…·ï¼Œæ¶ˆè€—1æ¬¡ä½¿ç”¨æ¬¡æ•°
                if (tag === 'tool') consumeItem(item, 1);
            }

            // æ£€æŸ¥å¤©æ°”å½±å“
            const isAffectedByWeather = checkWeatherImpact(actionKey);
            let weatherSuccess = true;
            let isDoubleReward = false;
            
            if (isAffectedByWeather) {
                // 50%å¤±è´¥ç‡
                weatherSuccess = Math.random() < 0.5;
                if (weatherSuccess) {
                    // æˆåŠŸåˆ™åŒå€æ”¶ç›Š
                    isDoubleReward = true;
                }
            }
            
            // æŒ‰é…æ–¹è¡¨ç”Ÿæˆç‰©èµ„ï¼ˆåˆ¶ä½œå·¥å…·å’Œæ•çŒ/é’“é±¼ï¼‰
            let actionFailed = false; // æ ‡è®°è¡ŒåŠ¨æ˜¯å¦å› å¤©æ°”å¤±è´¥
            if (actionKey === 'craftTool') {
                if (!weatherSuccess && isAffectedByWeather) {
                    // å¤©æ°”å½±å“å¯¼è‡´å¤±è´¥ï¼Œä¸ç”Ÿæˆç‰©èµ„
                    actionFailed = true;
                    newItem = null;
                    newItemBlock = '';
                } else {
                    const recipe = findCraftToolRecipe(item);
                    if (!recipe) {
                        alert(`æ— æ³•ç”¨ã€${item.text}ã€‘åˆ¶ä½œå·¥å…·ï¼`);
                        actionPoints += 1; // è¿”è¿˜è¡ŒåŠ¨ç‚¹
                        updateDayAndActionUI();
                        return;
                    }
                    const resultInfo = MATERIAL_DATABASE[recipe.result];
                    if (!resultInfo) {
                        alert(`é…æ–¹é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç‰©èµ„ã€${recipe.result}ã€‘çš„ä¿¡æ¯ï¼`);
                        actionPoints += 1; // è¿”è¿˜è¡ŒåŠ¨ç‚¹
                        updateDayAndActionUI();
                        return;
                    }
                    // äº§ç‰©ç­‰çº§ï¼šä¸¥æ ¼æŒ‰ç…§MATERIAL_DATABASEä¸­å®šä¹‰çš„ç­‰çº§
                    const resultLevel = resultInfo.level || 1;
                    newItem = {
                        id: getNextWordId(),
                        text: recipe.result,
                        emoji: resultInfo.emoji,
                        tag: resultInfo.tag,
                        level: resultLevel,
                        usesLeft: defaultUses(resultInfo.tag),
                        effects: {}
                    };
                    // å…ˆæ·»åŠ ç¬¬ä¸€ä¸ªç‰©èµ„ï¼Œç¡®ä¿IDæ­£ç¡®åˆ†é…
                    playerWords.push(newItem);
                    // åŒå€æ”¶ç›Šï¼šé¢å¤–è·å¾—ä¸€ä¸ªï¼ˆåœ¨ç¬¬ä¸€ä¸ªç‰©èµ„æ·»åŠ åï¼ŒgetNextWordIdä¼šè¿”å›æ–°çš„IDï¼‰
                    if (isDoubleReward) {
                        const extraItem = {
                            id: getNextWordId(),
                            text: recipe.result,
                            emoji: resultInfo.emoji,
                            tag: resultInfo.tag,
                            level: resultLevel,
                            usesLeft: defaultUses(resultInfo.tag),
                            effects: {}
                        };
                        playerWords.push(extraItem);
                    }
                    renderWordInventory();
                    newItemBlock = `<p style="margin-bottom: 6px;"><strong>è·å¾—ç‰©èµ„ï¼š</strong>${newItem.emoji} ${newItem.text} (Lv${resultLevel}Â·${tagLabel(resultInfo.tag)})${isDoubleReward ? ' x2ï¼ˆå¤©æ°”åŠ æˆï¼‰' : ''}</p>`;
                }
            } else if (actionKey === 'huntFish') {
                if (!weatherSuccess && isAffectedByWeather) {
                    // å¤©æ°”å½±å“å¯¼è‡´å¤±è´¥ï¼Œä¸ç”Ÿæˆç‰©èµ„
                    actionFailed = true;
                    newItem = null;
                    newItemBlock = '';
                } else {
                    const recipe = findHuntFishRecipe(item);
                    if (!recipe) {
                        alert(`æ— æ³•ç”¨ã€${item.text}ã€‘è¿›è¡Œæ‰“çŒ/é’“é±¼/ç ä¼ï¼`);
                        actionPoints += 1; // è¿”è¿˜è¡ŒåŠ¨ç‚¹
                        updateDayAndActionUI();
                        return;
                    }
                    const resultInfo = MATERIAL_DATABASE[recipe.result];
                    if (!resultInfo) {
                        alert(`é…æ–¹é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç‰©èµ„ã€${recipe.result}ã€‘çš„ä¿¡æ¯ï¼`);
                        actionPoints += 1; // è¿”è¿˜è¡ŒåŠ¨ç‚¹
                        updateDayAndActionUI();
                        return;
                    }
                    // äº§ç‰©ç­‰çº§ï¼šä¸¥æ ¼æŒ‰ç…§MATERIAL_DATABASEä¸­å®šä¹‰çš„ç­‰çº§
                    const resultLevel = resultInfo.level || 1;
                    newItem = {
                        id: getNextWordId(),
                        text: recipe.result,
                        emoji: resultInfo.emoji,
                        tag: resultInfo.tag,
                        level: resultLevel,
                        usesLeft: defaultUses(resultInfo.tag),
                        effects: {}
                    };
                    // å…ˆæ·»åŠ ç¬¬ä¸€ä¸ªç‰©èµ„ï¼Œç¡®ä¿IDæ­£ç¡®åˆ†é…
                    playerWords.push(newItem);
                    // åŒå€æ”¶ç›Šï¼šé¢å¤–è·å¾—ä¸€ä¸ªï¼ˆåœ¨ç¬¬ä¸€ä¸ªç‰©èµ„æ·»åŠ åï¼ŒgetNextWordIdä¼šè¿”å›æ–°çš„IDï¼‰
                    if (isDoubleReward) {
                        const extraItem = {
                            id: getNextWordId(),
                            text: recipe.result,
                            emoji: resultInfo.emoji,
                            tag: resultInfo.tag,
                            level: resultLevel,
                            usesLeft: defaultUses(resultInfo.tag),
                            effects: {}
                        };
                        playerWords.push(extraItem);
                    }
                    renderWordInventory();
                    newItemBlock = `<p style="margin-bottom: 6px;"><strong>è·å¾—ç‰©èµ„ï¼š</strong>${newItem.emoji} ${newItem.text} (Lv${resultLevel}Â·${tagLabel(resultInfo.tag)})${isDoubleReward ? ' x2ï¼ˆå¤©æ°”åŠ æˆï¼‰' : ''}</p>`;
                }
            }

            // è°ƒç”¨AIç”Ÿæˆè¡ŒåŠ¨æè¿°ï¼ˆåªç”Ÿæˆæè¿°ï¼Œä¸å†³å®šæ•°å€¼å˜åŒ–ï¼‰
            // å¦‚æœè¡ŒåŠ¨å¤±è´¥ï¼Œç”Ÿæˆå¤±è´¥æè¿°ï¼›å¦åˆ™ç”Ÿæˆæ­£å¸¸æè¿°
            // å¯¹äºä¿®å»ºåº‡æŠ¤æ‰€ï¼Œä¹Ÿéœ€è¦æ£€æŸ¥æ˜¯å¦å¤±è´¥
            let aiResult;
            // åˆ¤æ–­è¡ŒåŠ¨æ˜¯å¦å¤±è´¥ï¼ˆåŒ…æ‹¬ä¿®å»ºåº‡æŠ¤æ‰€çš„æƒ…å†µï¼‰
            const isActionFailed = actionFailed || (actionKey === 'buildShelter' && isAffectedByWeather && !weatherSuccess);
            if (isActionFailed && isAffectedByWeather) {
                aiResult = await generateActionFailureDescription(action, item, currentWeather);
            } else {
                aiResult = await generateActionDescription(action, item, newItem);
            }
            
            // æ‰€æœ‰è¡ŒåŠ¨éƒ½ä½¿ç”¨ç³»ç»Ÿè§„å®šçš„æ•°å€¼ï¼Œä¸ä½¿ç”¨AIè¿”å›çš„æ•°å€¼
            let finalChanges = {};
            let finalHealthDelta = typeof defaultChanges.health === 'number' && !isNaN(defaultChanges.health) && isFinite(defaultChanges.health) ? defaultChanges.health : 0;
            let finalHungerDelta = typeof defaultChanges.hunger === 'number' && !isNaN(defaultChanges.hunger) && isFinite(defaultChanges.hunger) ? defaultChanges.hunger : 0;
            
            // æ‰“çŒ/é’“é±¼/ç ä¼è¡ŒåŠ¨ä¸å‡†å¢åŠ é¥±è…¹å€¼
            if (actionKey === 'huntFish' && finalHungerDelta > 0) {
                finalHungerDelta = 0; // å¼ºåˆ¶è®¾ä¸º0ï¼Œä¸å…è®¸å¢åŠ 
            }
            
            // æ‰“çŒ/é’“é±¼/ç ä¼è¡ŒåŠ¨æ‰£å‡ç”Ÿå­˜çŠ¶æ€å€¼ä¸Šé™ä¸º10ç‚¹
            if (actionKey === 'huntFish') {
                // åªè®¡ç®—è´Ÿæ•°ï¼ˆæ‰£å‡ï¼‰çš„éƒ¨åˆ†
                const healthLoss = finalHealthDelta < 0 ? Math.abs(finalHealthDelta) : 0;
                const hungerLoss = finalHungerDelta < 0 ? Math.abs(finalHungerDelta) : 0;
                const totalSurvivalLoss = healthLoss + hungerLoss;
                if (totalSurvivalLoss > 10) {
                    // æŒ‰æ¯”ä¾‹ç¼©å°æ‰£å‡éƒ¨åˆ†ï¼Œä½¿æ€»å’Œä¸è¶…è¿‡10
                    const scale = 10 / totalSurvivalLoss;
                    if (finalHealthDelta < 0) {
                        finalHealthDelta = Math.round(finalHealthDelta * scale);
                    }
                    if (finalHungerDelta < 0) {
                        finalHungerDelta = Math.round(finalHungerDelta * scale);
                    }
                }
            }
            
            finalChanges = {
                health: finalHealthDelta,
                hunger: finalHungerDelta
            };
            
            // è¿›é£Ÿå¢åŠ è¡ŒåŠ¨ç‚¹ï¼š4çº§é£Ÿç‰©+3ç‚¹ï¼Œ3çº§é£Ÿç‰©+2ç‚¹ï¼Œ2çº§é£Ÿç‰©+1ç‚¹ï¼Œ1çº§é£Ÿç‰©+0ç‚¹
            if (actionKey === 'eat') {
                let actionPointGain = 0;
                if (lvl === 4) {
                    actionPointGain = 3;
                } else if (lvl === 3) {
                    actionPointGain = 2;
                } else if (lvl === 2) {
                    actionPointGain = 1;
                } else {
                    actionPointGain = 0;
                }
                actionPoints = Math.min(MAX_ACTION_POINTS, actionPoints + actionPointGain);
                updateDayAndActionUI();
            }
            const nonZeroChanges = applyStatChanges(finalChanges);
            // å¤„ç†ä¿®å»ºåº‡æŠ¤æ‰€çš„åšå›ºå€¼å¢åŠ ï¼ˆç”±ç³»ç»Ÿæ ¹æ®ç‰©èµ„ç­‰çº§è®¡ç®—ï¼‰
            let shelterChangeText = '';
            
            // å¤„ç†ä¿®å»ºåº‡æŠ¤æ‰€ï¼šç›´æ¥æ ¹æ®ç‰©èµ„ç­‰çº§è®¡ç®—åšå›ºå€¼å¢åŠ 
            if (actionKey === 'buildShelter') {
                const itemLevel = item.level || 1;
                // æ ¹æ®ç­‰çº§è®¡ç®—å¢åŠ çš„åšå›ºå€¼ï¼šLv1=5, Lv2=10, Lv3=15, Lv4=25
                let baseDelta = 0;
                if (itemLevel === 1) {
                    baseDelta = 5;
                } else if (itemLevel === 2) {
                    baseDelta = 10;
                } else if (itemLevel === 3) {
                    baseDelta = 15;
                } else if (itemLevel >= 4) {
                    baseDelta = 25;
                }
                
                // å¤„ç†å¤©æ°”å½±å“
                if (isAffectedByWeather) {
                    if (!weatherSuccess) {
                        // å¤±è´¥ï¼šä¸å¢åŠ åº‡æŠ¤æ‰€åšå›ºå€¼
                        actionFailed = true;
                        shelterChangeText = '<p style="color:#c4a5a5; margin-top:6px;">âš ï¸ å¤©æ°”å½±å“ï¼šè¡ŒåŠ¨å¤±è´¥ï¼Œæœªèƒ½æå‡åº‡æŠ¤æ‰€</p>';
                    } else if (isDoubleReward) {
                        // æˆåŠŸï¼šåŒå€æ”¶ç›Š
                        const totalDelta = baseDelta * 2;
                        shelterDurability = Math.max(0, Math.min(100, shelterDurability + totalDelta));
                        updateBaseStatsUI();
                        shelterChangeText = `<p style="color:#a8b5a0; margin-top:6px;">âœ¨ å¤©æ°”åŠ æˆï¼šåº‡æŠ¤æ‰€åšå›ºå€¼ +${totalDelta}ï¼ˆåŒå€æ”¶ç›Šï¼‰</p>`;
                    } else {
                        // å¤©æ°”å½±å“ä½†æˆåŠŸï¼ˆéåŒå€ï¼‰
                        shelterDurability = Math.max(0, Math.min(100, shelterDurability + baseDelta));
                        updateBaseStatsUI();
                        shelterChangeText = `<p style="color:#a8b5a0; margin-top:6px;">åº‡æŠ¤æ‰€åšå›ºå€¼ +${baseDelta}</p>`;
                    }
                } else {
                    // æ­£å¸¸æƒ…å†µï¼šç›´æ¥å¢åŠ 
                    shelterDurability = Math.max(0, Math.min(100, shelterDurability + baseDelta));
                    updateBaseStatsUI();
                    shelterChangeText = `<p style="color:#a8b5a0; margin-top:6px;">åº‡æŠ¤æ‰€åšå›ºå€¼ +${baseDelta}</p>`;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æ­»äº¡
            if (isDead()) {
                showGameOverScreen("åœ¨æ‰§è¡Œè¡ŒåŠ¨åï¼Œä½ çš„çŠ¶æ€å·²ç»è·Œè‡³æé™ï¼Œå†ä¹Ÿæ’‘ä¸ä¸‹å»äº†ã€‚");
                return;
            }
            
            // æ˜¾ç¤ºè¡ŒåŠ¨ç»“æœï¼ˆå…ˆæ˜¾ç¤ºæ•°å€¼å˜åŒ–ï¼‰
            const resultsDiv = document.getElementById('fusion-results');
            const resultCard = document.createElement('div');
            resultCard.className = 'result-card';
            
            // å¦‚æœè¡ŒåŠ¨å¤±è´¥ï¼Œä½¿ç”¨çº¢è‰²è¾¹æ¡†ï¼›å¦åˆ™ä½¿ç”¨ç»¿è‰²
            if (isActionFailed && isAffectedByWeather) {
                resultCard.style.borderLeftColor = '#ef4444';
            } else {
                resultCard.style.borderLeftColor = '#22c55e';
            }
            
            // æ„å»ºæ•°å€¼å˜åŒ–æ˜¾ç¤ºæ–‡æœ¬
            const changeTexts = [];
            if (nonZeroChanges.survival !== undefined && nonZeroChanges.survival !== 0) {
                changeTexts.push(`ç”Ÿå­˜çŠ¶æ€å€¼ ${nonZeroChanges.survival > 0 ? '+' : ''}${nonZeroChanges.survival}`);
            }
            // å¦‚æœæ˜¯è¿›é£Ÿè¡ŒåŠ¨ï¼Œæ˜¾ç¤ºè¡ŒåŠ¨ç‚¹å¢åŠ 
            if (actionKey === 'eat') {
                let actionPointGain = 1;
                if (lvl === 4) {
                    actionPointGain = 3;
                } else if (lvl === 2 || lvl === 3) {
                    actionPointGain = 2;
                } else {
                    actionPointGain = 1;
                }
                changeTexts.push(`è¡ŒåŠ¨ç‚¹ +${actionPointGain}`);
            }

            // åº‡æŠ¤æ‰€æå‡å·²åœ¨ä¸Šé¢å¤„ç†ï¼ˆ2315-2337è¡Œï¼‰ï¼Œè¿™é‡Œä¸å†é‡å¤å¤„ç†

            // ä¸ºä¿®å»ºåº‡æŠ¤æ‰€ç”Ÿæˆå”¯ä¸€çš„å›¾ç‰‡IDï¼ˆä»…åœ¨æˆåŠŸæ—¶ç”Ÿæˆï¼Œå¤±è´¥æ—¶ä¸ç”Ÿæˆï¼‰
            // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ£€æŸ¥æ˜¯å¦å› ä¸ºå¤©æ°”å¤±è´¥ï¼Œå¦‚æœå¤±è´¥åˆ™ä¸ç”Ÿæˆå›¾ç‰‡ID
            let shelterImageId = null;
            if (actionKey === 'buildShelter') {
                // åªæœ‰åœ¨è¡ŒåŠ¨æˆåŠŸæ—¶æ‰ç”Ÿæˆå›¾ç‰‡ID
                // å¦‚æœå—å¤©æ°”å½±å“ä¸”å¤±è´¥ï¼Œåˆ™ä¸ç”Ÿæˆ
                const isShelterFailed = isAffectedByWeather && !weatherSuccess;
                if (!isShelterFailed) {
                    shelterImageId = `shelter-image-${Date.now()}`;
                }
            }
            const feedbackId = `action-ai-feedback-${Date.now()}`;
            
            // å¦‚æœè¡ŒåŠ¨å¤±è´¥ï¼Œæ˜¾ç¤ºå¤±è´¥æç¤º
            const failureNotice = isActionFailed && isAffectedByWeather ? 
                `<p style="color:#c4a5a5; margin-bottom:8px; font-weight:500;">âš ï¸ å¤©æ°”å½±å“ï¼šç”±äºã€${currentWeather}ã€‘å¤©æ°”ï¼Œè¡ŒåŠ¨å¤±è´¥ï¼Œæœªèƒ½è·å¾—ç‰©èµ„/æ”¶ç›Šã€‚</p>` : '';
            
            resultCard.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 24px;">${action.emoji}</span>
                    <span style="font-size: 18px; font-weight: 500; ${isActionFailed && isAffectedByWeather ? 'color: #c4a5a5;' : ''}">${action.name}</span>
                </div>
                <p style="margin-bottom: 8px;">
                    <strong>ä½¿ç”¨ç‰©èµ„ï¼š</strong>${item.emoji} ${item.text}
                </p>
                ${failureNotice}
                ${newItemBlock}
                <p style="margin-bottom: 8px; color: #9fa8b8;">
                    <strong>æ•°å€¼å˜åŒ–ï¼š</strong>${changeTexts.join('ï¼Œ') || 'æ— '}${shelterChangeText.includes('<p') ? '' : shelterChangeText}
                </p>
                ${shelterChangeText.includes('<p') ? shelterChangeText : ''}
                ${shelterImageId ? `<div id="${shelterImageId}" style="margin: 12px 0; border-radius: 8px; overflow: hidden;"></div>` : ''}
                <div id="${feedbackId}" style="margin-top: 8px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 5px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 8px; font-size: 0.9em; opacity: 0.8;">æ­£åœ¨ç”Ÿæˆ${actionFailed ? 'å¤±è´¥' : 'è¡ŒåŠ¨'}æè¿°...</p>
                </div>
                <div style="text-align: right; font-size: 12px; opacity: 0.7; margin-top: 8px;">
                    ${new Date().toLocaleTimeString()}
                </div>
            `;
            
            resultsDiv.prepend(resultCard);
            const feedbackEl = document.getElementById(feedbackId);

            // æ˜¾ç¤ºAIæè¿°
            try {
                const aiDescription = aiResult && aiResult.description ? aiResult.description : '';
                if (feedbackEl) {
                    const descriptionLabel = isActionFailed && isAffectedByWeather ? 'å¤±è´¥è¿‡ç¨‹' : 'è¡ŒåŠ¨è¿‡ç¨‹';
                    feedbackEl.innerHTML = `
                        <p style="line-height: 1.6;"><strong>${descriptionLabel}ï¼š</strong>${aiDescription}</p>
                    `;
                }
                
                // å¦‚æœæ˜¯ä¿®å»ºåº‡æŠ¤æ‰€ä¸”è¡ŒåŠ¨æˆåŠŸï¼Œç”Ÿæˆå›¾ç‰‡
                if (actionKey === 'buildShelter' && shelterImageId && aiDescription && !isActionFailed) {
                    // å¼‚æ­¥ç”Ÿæˆå›¾ç‰‡ï¼Œä¸é˜»å¡ä¸»æµç¨‹
                    setTimeout(() => {
                        generateAndDisplayImageForShelter(item.text, aiDescription, shelterImageId);
                    }, 500);
                }
            } catch (error) {
                console.error('ç”Ÿæˆè¡ŒåŠ¨æè¿°å¤±è´¥:', error);
                if (feedbackEl) {
                    feedbackEl.innerHTML = `
                        <p style="opacity: 0.7;">ä½ å®Œæˆäº†è¿™æ¬¡è¡ŒåŠ¨ï¼Œè™½ç„¶è¿‡ç¨‹æœ‰äº›æ¨¡ç³Šï¼Œä½†ç»“æœå·²ç»ä½“ç°åœ¨æ•°å€¼å˜åŒ–ä¸­ã€‚</p>
                    `;
            }
        }
            
            // æ¢å¤è¡ŒåŠ¨æŒ‰é’®çŠ¶æ€ï¼ˆåœ¨æ¸…ç©ºèœå•ä¹‹å‰ï¼‰
            actionButtons.forEach((btn, index) => {
                if (originalButtonStates[index]) {
                    btn.disabled = originalButtonStates[index].disabled;
                    btn.innerHTML = originalButtonStates[index].innerHTML;
                    btn.style.opacity = originalButtonStates[index].opacity || '1';
                    btn.style.cursor = originalButtonStates[index].cursor || 'pointer';
                }
            });
            
            // æ¸…ç©ºè¡ŒåŠ¨æ§½ä½å’Œèœå•
            // å–æ¶ˆè¡ŒåŠ¨æ§½ä½ç‰©èµ„çš„ä½¿ç”¨æ ‡è®°
            if (actionSlotItem) {
                usedWordIds.delete(actionSlotItem.id);
            }
            actionSlotItem = null;
            const actionSlot = document.getElementById('action-slot');
            if (actionSlot) {
                actionSlot.innerHTML = 'æ‹–æ”¾ç‰©èµ„åˆ°æ­¤å¤„';
                actionSlot.style.borderColor = '#a8b5a0';
                actionSlot.style.background = 'rgba(220, 217, 212, 0.4)';
            }
            const menuEl = document.getElementById('action-menu');
            if (menuEl) {
                menuEl.style.display = 'none';
                menuEl.innerHTML = '';
            }
        }

        // ç”Ÿæˆè¡ŒåŠ¨å¤±è´¥æè¿°
        async function generateActionFailureDescription(action, item, weather) {
            try {
                const response = await fetchWithTimeout(LLM_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${LLM_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: LLM_MODEL_NAME,
                        messages: [
                            {
                                role: "system",
                                content: `ä½ æ˜¯ä¸€ä¸ªè’å²›æ±‚ç”Ÿæ¸¸æˆçš„å™äº‹è€…ã€‚
${playerName ? `ç©å®¶åå­—æ˜¯ã€${playerName}ã€‘ã€‚è¯·åœ¨æ‰€æœ‰æè¿°ä¸­ä½¿ç”¨ã€${playerName}ã€‘ä½œä¸ºä¸»è¯­ï¼Œä¸è¦ä½¿ç”¨"ä½ "å­—ã€‚` : ''}
è¯·ç”Ÿæˆä¸€æ®µ50-80å­—çš„æè¿°ï¼Œæè¿°${playerName || 'ç©å®¶'}å› ä¸ºã€${weather}ã€‘å¤©æ°”å½±å“ï¼Œå¯¼è‡´ã€${action.name}ã€‘è¡ŒåŠ¨å¤±è´¥çš„è¿‡ç¨‹ã€‚
è¦æ±‚ï¼šè¯­è¨€ç”ŸåŠ¨ï¼Œæœ‰ä»£å…¥æ„Ÿï¼Œæè¿°å¤©æ°”å¦‚ä½•é˜»ç¢äº†ç©å®¶çš„è¡ŒåŠ¨ï¼Œä»¥åŠå¤±è´¥çš„å…·ä½“åŸå› ã€‚
è¿”å›JSONæ ¼å¼ï¼š
{
  "description": "è¡ŒåŠ¨å¤±è´¥è¿‡ç¨‹çš„æè¿°ï¼ˆ50-80å­—ï¼‰"
}`
                            },
                            {
                                role: "user",
                                content: `ç©å®¶å°è¯•ä½¿ç”¨ã€${item.text}ã€‘è¿›è¡Œã€${action.name}ã€‘è¡ŒåŠ¨ï¼Œä½†å› ä¸ºã€${weather}ã€‘å¤©æ°”çš„å½±å“ï¼Œè¡ŒåŠ¨å¤±è´¥äº†ã€‚è¯·æè¿°å¤±è´¥çš„è¿‡ç¨‹ã€‚`
                            }
                        ],
                        temperature: 0.8,
                        max_tokens: 120,
                        response_format: { "type": "json_object" }
                    })
                }, 30000);
                
                if (!response.ok) throw new Error(`AIæè¿°ç”Ÿæˆå¤±è´¥: ${response.status}`);
                const data = await response.json();
                const parsed = safeParseJSON(data.choices[0].message.content);
                
                const defaultDesc = playerName
                    ? `ç”±äºã€${weather}ã€‘å¤©æ°”çš„å½±å“ï¼Œ${playerName}çš„ã€${action.name}ã€‘è¡ŒåŠ¨å¤±è´¥äº†ã€‚`
                    : `ç”±äºã€${weather}ã€‘å¤©æ°”çš„å½±å“ï¼Œä½ çš„ã€${action.name}ã€‘è¡ŒåŠ¨å¤±è´¥äº†ã€‚`;
                return {
                    description: replaceYouWithPlayerName(parsed.description || defaultDesc),
                    healthDelta: null,
                    hungerDelta: null,
                    sturdyDelta: 0,
                    rainDelta: 0
                };
            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥æè¿°å¤±è´¥:', error);
                const defaultDesc = playerName
                    ? `ç”±äºã€${weather}ã€‘å¤©æ°”çš„å½±å“ï¼Œ${playerName}çš„ã€${action.name}ã€‘è¡ŒåŠ¨å¤±è´¥äº†ã€‚æ¶åŠ£çš„å¤©æ°”æ¡ä»¶è®©${playerName}æ— æ³•å®Œæˆè¿™æ¬¡è¡ŒåŠ¨ã€‚`
                    : `ç”±äºã€${weather}ã€‘å¤©æ°”çš„å½±å“ï¼Œä½ çš„ã€${action.name}ã€‘è¡ŒåŠ¨å¤±è´¥äº†ã€‚æ¶åŠ£çš„å¤©æ°”æ¡ä»¶è®©ä½ æ— æ³•å®Œæˆè¿™æ¬¡è¡ŒåŠ¨ã€‚`;
                return {
                    description: defaultDesc,
                    healthDelta: null,
                    hungerDelta: null,
                    sturdyDelta: 0,
                    rainDelta: 0
                };
            }
        }
        
        // è°ƒç”¨AIç”Ÿæˆè¡ŒåŠ¨æè¿°ï¼ˆå¿…è¦æ—¶è¿”å›ç‰©èµ„åï¼‰
        async function generateActionDescription(action, item, resultItem = null) {
            try {
                // æ„å»ºç³»ç»Ÿæç¤ºè¯
                const playerNamePart = playerName ? `ç©å®¶åå­—æ˜¯ã€${playerName}ã€‘ã€‚` : '';
                let systemPrompt = `ä½ æ˜¯ä¸€ä¸ªè’å²›æ±‚ç”Ÿæ¸¸æˆçš„å™äº‹è€…ã€‚
${playerNamePart}è¯·åœ¨æ‰€æœ‰æè¿°ä¸­ä½¿ç”¨ã€${playerName || 'ç©å®¶'}ã€‘ä½œä¸ºä¸»è¯­ï¼Œä¸è¦ä½¿ç”¨"ä½ "å­—ã€‚
è¯·è¿”å›JSONï¼Œæ ¼å¼ï¼š
{
  "description": "50-80å­—è¡ŒåŠ¨è¿‡ç¨‹æè¿°"
}
æ³¨æ„ï¼šæ‰€æœ‰æ•°å€¼å˜åŒ–ï¼ˆåŒ…æ‹¬ç”Ÿå­˜çŠ¶æ€å€¼å’Œåº‡æŠ¤æ‰€åšå›ºå€¼ï¼‰éƒ½ç”±ç³»ç»Ÿæ ¹æ®è§„åˆ™è‡ªåŠ¨è®¡ç®—ï¼ŒAIåªéœ€è¦ç”Ÿæˆç”ŸåŠ¨çš„æè¿°æ–‡æœ¬å³å¯ã€‚
é‡è¦è§„åˆ™ï¼š
- å¯¹äº"åˆ¶ä½œå·¥å…·"è¡ŒåŠ¨ï¼šæè¿°ç©å®¶å¦‚ä½•ä½¿ç”¨ã€${item.text}ã€‘åˆ¶ä½œå‡ºã€${resultItem ? resultItem.text : 'å·¥å…·'}ã€‘çš„è¿‡ç¨‹ã€‚
- å¯¹äº"æ‰“çŒ/é’“é±¼/ç ä¼"è¡ŒåŠ¨ï¼šæè¿°ç©å®¶å¦‚ä½•ä½¿ç”¨ã€${item.text}ã€‘è¿›è¡Œè¡ŒåŠ¨ï¼Œè·å¾—ã€${resultItem ? resultItem.text : 'ç‰©èµ„'}ã€‘çš„è¿‡ç¨‹ã€‚
  * å…³é”®ï¼šå¿…é¡»æ ¹æ®ä½¿ç”¨çš„å·¥å…·ç±»å‹å’Œè·å¾—çš„ç‰©èµ„ç±»å‹æ¥ç”Ÿæˆåˆç†çš„æè¿°ï¼
  * å¦‚æœä½¿ç”¨æ–§å­ç±»å·¥å…·è·å¾—"åŸææ–™"ï¼ˆå¦‚æœ¨æ£ã€çŸ³å¤´ã€æœ¨æ¿ç­‰ï¼‰ï¼Œå¿…é¡»æè¿°ç ä¼æ ‘æœ¨ã€æŒ–æ˜çŸ³å¤´ç­‰è·å–åŸææ–™çš„è¿‡ç¨‹ï¼Œåœºæ™¯åº”è¯¥åœ¨æ£®æ—ã€çŸ³åœºç­‰ã€‚
  * å¦‚æœä½¿ç”¨çŸ›/åˆ€ç±»å·¥å…·è·å¾—"å…½è‚‰ç±»é£Ÿç‰©"ï¼ˆå¦‚ç”Ÿè‚‰ã€å°å…½è‚‰ã€çƒ¤å…½è‚‰ç­‰ï¼‰ï¼Œå¿…é¡»æè¿°åœ¨ä¸›æ—ã€æ£®æ—ä¸­æ‰“çŒå°å‹åŠ¨ç‰©ï¼ˆå¦‚é‡å…”ã€é¸Ÿç±»ç­‰ï¼‰çš„è¿‡ç¨‹ï¼Œåœºæ™¯åº”è¯¥åœ¨ä¸›æ—ã€æ£®æ—ç­‰ã€‚
  * å¦‚æœä½¿ç”¨ç¯ç«ã€ç«æŠŠã€å¤§å‹ä¿¡å·ç«æˆ–åå°„ä¿¡å·æ¿è·å¾—"å…½è‚‰ç±»é£Ÿç‰©"ï¼ˆå¦‚ç”Ÿè‚‰ã€å°å…½è‚‰ã€çƒ¤å…½è‚‰ç­‰ï¼‰ï¼Œå¿…é¡»æè¿°å¸ƒç½®é™·é˜±æŠ“æ•é‡å…½çš„è¿‡ç¨‹ï¼šè¯´æ˜å¦‚ä½•åˆ©ç”¨ç«å…‰å¸å¼•æˆ–é©±èµ¶é‡å…½ï¼Œåœ¨åˆé€‚çš„ä½ç½®è®¾ç½®é™·é˜±ï¼ˆå¦‚æŒ–å‘ã€è®¾ç½®ç»³å¥—ç­‰ï¼‰ï¼Œç­‰å¾…é‡å…½è½å…¥é™·é˜±åæ•è·ã€‚åœºæ™¯åº”è¯¥åœ¨ä¸›æ—ã€æ£®æ—ç­‰ã€‚
  * å¦‚æœä½¿ç”¨é±¼å‰/æ¸”ç½‘ç±»å·¥å…·è·å¾—"é±¼ç±»é£Ÿç‰©"ï¼ˆå¦‚ç”Ÿé±¼ã€å¤§å—é±¼è‚‰ç­‰ï¼‰ï¼Œå¿…é¡»æè¿°åœ¨æ²³æµã€æµ·è¾¹æ•é±¼çš„è¿‡ç¨‹ï¼Œåœºæ™¯åº”è¯¥åœ¨æ°´è¾¹ã€æµ·è¾¹ç­‰ã€‚
  * æè¿°å¿…é¡»ä¸å·¥å…·ç±»å‹å’Œè·å¾—çš„ç‰©èµ„å®Œå…¨åŒ¹é…ï¼Œä¸èƒ½å‡ºç°"ä½¿ç”¨æœ¨çŸ›åœ¨ä¸›æ—é‡Œæ•æ‰ç”Ÿé±¼"è¿™ç§ä¸åˆç†çš„æƒ…å†µã€‚
- å¯¹äº"ä¿®å»ºåº‡æŠ¤æ‰€"è¡ŒåŠ¨ï¼šæè¿°ç©å®¶å¦‚ä½•ä½¿ç”¨ã€${item.text}ã€‘ä¿®å»ºæˆ–åŠ å›ºåº‡æŠ¤æ‰€çš„è¿‡ç¨‹ã€‚æ³¨æ„ï¼šåº‡æŠ¤æ‰€åšå›ºå€¼çš„å¢åŠ ç”±ç³»ç»Ÿæ ¹æ®ç‰©èµ„ç­‰çº§è‡ªåŠ¨è®¡ç®—ï¼ˆLv1:+5, Lv2:+10, Lv3:+15, Lv4:+25ï¼‰ï¼ŒAIåªéœ€è¦ç”Ÿæˆç”ŸåŠ¨çš„æè¿°æ–‡æœ¬ã€‚
- å¯¹äº"è¿›é£Ÿ"è¡ŒåŠ¨ï¼šæè¿°ç©å®¶å¦‚ä½•å¤„ç†å¹¶é£Ÿç”¨ã€${item.text}ã€‘çš„è¿‡ç¨‹ã€‚æ³¨æ„ï¼šæ•°å€¼å˜åŒ–ç”±ç³»ç»Ÿè§„å®šï¼ŒAIåªéœ€è¦ç”Ÿæˆæè¿°ã€‚
- å¯¹äºå…¶ä»–è¡ŒåŠ¨ï¼šæ•°å€¼å˜åŒ–ç”±ç³»ç»Ÿè§„å®šï¼ŒAIåªéœ€è¦ç”Ÿæˆæè¿°ã€‚`;

                // åˆ¤æ–­è¡ŒåŠ¨ç±»å‹å¯¹åº”çš„key
                let actionTypeKey = '';
                if (action.name === 'åˆ¶ä½œå·¥å…·') actionTypeKey = 'craftTool';
                else if (action.name === 'æ‰“çŒ/é’“é±¼/ç ä¼') actionTypeKey = 'huntFish';
                else if (action.name === 'ä¿®å»ºåº‡æŠ¤æ‰€') actionTypeKey = 'buildShelter';
                else if (action.name === 'å¯»æ‰¾ç‰©èµ„') actionTypeKey = 'searchLocation';
                
                const isWeatherAffected = checkWeatherImpact(actionTypeKey);
                
                let userPrompt = `è¡ŒåŠ¨ç±»å‹ï¼š${action.name}ï¼ˆ${action.description}ï¼‰
ä½¿ç”¨çš„ç‰©èµ„ï¼š${item.text} (Lv${item.level || 1}Â·${tagLabel(item.tag)})
å½“å‰å¤©æ°”ï¼š${currentWeather}
${resultItem ? `è·å¾—çš„ç‰©èµ„ï¼š${resultItem.text} (Lv${resultItem.level || 1}Â·${tagLabel(resultItem.tag)})` : ''}
${resultItem && action.name === 'æ‰“çŒ/é’“é±¼/ç ä¼' ? `\né‡è¦ï¼šä½¿ç”¨çš„å·¥å…·æ˜¯ã€${item.text}ã€‘ï¼Œè·å¾—çš„ç‰©èµ„æ˜¯ã€${resultItem.text}ã€‘ã€‚è¯·æ ¹æ®å·¥å…·ç±»å‹å’Œç‰©èµ„ç±»å‹ç”Ÿæˆåˆç†çš„æè¿°ï¼š
- å¦‚æœå·¥å…·æ˜¯æ–§å­ç±»ä¸”è·å¾—åŸææ–™ï¼Œæè¿°ç ä¼/æŒ–æ˜è¿‡ç¨‹ï¼ˆåœºæ™¯ï¼šæ£®æ—ã€çŸ³åœºï¼‰
- å¦‚æœå·¥å…·æ˜¯çŸ›/åˆ€ç±»ä¸”è·å¾—å…½è‚‰ç±»é£Ÿç‰©ï¼Œæè¿°æ‰“çŒè¿‡ç¨‹ï¼ˆåœºæ™¯ï¼šä¸›æ—ã€æ£®æ—ï¼‰
- å¦‚æœå·¥å…·æ˜¯ç¯ç«ã€ç«æŠŠã€å¤§å‹ä¿¡å·ç«æˆ–åå°„ä¿¡å·æ¿ä¸”è·å¾—å…½è‚‰ç±»é£Ÿç‰©ï¼Œæè¿°å¸ƒç½®é™·é˜±æŠ“æ•é‡å…½çš„è¿‡ç¨‹ï¼ˆåœºæ™¯ï¼šä¸›æ—ã€æ£®æ—ï¼‰ï¼Œè¯´æ˜å¦‚ä½•åˆ©ç”¨ç«å…‰å¸å¼•æˆ–é©±èµ¶é‡å…½ï¼Œè®¾ç½®é™·é˜±æ•è·çŒç‰©
- å¦‚æœå·¥å…·æ˜¯é±¼å‰/æ¸”ç½‘ç±»ä¸”è·å¾—é±¼ç±»é£Ÿç‰©ï¼Œæè¿°æ•é±¼è¿‡ç¨‹ï¼ˆåœºæ™¯ï¼šæ°´è¾¹ã€æµ·è¾¹ï¼‰
ä¸è¦å‡ºç°å·¥å…·ç±»å‹ä¸åœºæ™¯ä¸åŒ¹é…çš„æƒ…å†µï¼ˆå¦‚ç”¨æœ¨çŸ›åœ¨ä¸›æ—æ•é±¼ï¼‰ã€‚` : ''}
${isWeatherAffected ? `\né‡è¦ï¼šå½“å‰å¤©æ°”ã€${currentWeather}ã€‘å½±å“äº†è¿™æ¬¡è¡ŒåŠ¨ã€‚è¯·åœ¨æè¿°ä¸­ä½“ç°å¤©æ°”å¯¹è¡ŒåŠ¨çš„å½±å“ï¼Œæè¿°ç©å®¶å¦‚ä½•åœ¨æ¶åŠ£å¤©æ°”ä¸­è‰°éš¾å®Œæˆè¡ŒåŠ¨ï¼Œæˆ–è€…å› ä¸ºå¤©æ°”åŸå› è¡ŒåŠ¨å—é˜»ã€‚` : `\næ³¨æ„ï¼šå½“å‰å¤©æ°”æ˜¯ã€${currentWeather}ã€‘ï¼Œè¯·åœ¨æè¿°ä¸­é€‚å½“æåŠå¤©æ°”æƒ…å†µã€‚`}
${action.aiPrompt}
è¯·ç”¨JSONæ ¼å¼å›ç­”ã€‚`;

                const response = await fetchWithTimeout(LLM_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${LLM_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: LLM_MODEL_NAME,
                        messages: [
                            {
                                role: "system",
                                content: systemPrompt
                            },
                            {
                                role: "user",
                                content: userPrompt
                            }
                        ],
                        temperature: 0.8,
                        max_tokens: 120,
                        response_format: { "type": "json_object" }
                    })
                }, 30000);
                
                if (!response.ok) throw new Error(`AIæè¿°ç”Ÿæˆå¤±è´¥: ${response.status}`);
                const data = await response.json();
                const parsed = safeParseJSON(data.choices[0].message.content);
                
                // AIåªè¿”å›æè¿°æ–‡æœ¬ï¼Œæ‰€æœ‰æ•°å€¼å˜åŒ–ç”±ç³»ç»Ÿè®¡ç®—
                return {
                    description: replaceYouWithPlayerName(parsed.description || ''),
                    healthDelta: null,
                    hungerDelta: null,
                    sturdyDelta: 0,
                    rainDelta: 0
                };
            } catch (error) {
                console.error('ç”Ÿæˆè¡ŒåŠ¨æè¿°å¤±è´¥:', error);
                // å¦‚æœæ˜¯è¶…æ—¶é”™è¯¯ï¼Œåœ¨æ§åˆ¶å°ç»™å‡ºæ›´è¯¦ç»†çš„æç¤º
                if (error.message && error.message.includes('è¶…æ—¶')) {
                    console.warn('è¡ŒåŠ¨æè¿°APIè¯·æ±‚è¶…æ—¶ï¼Œä½¿ç”¨é»˜è®¤æè¿°');
                }
                const defaultDesc = playerName 
                    ? `${playerName}ç”¨${item.text}å®Œæˆäº†${action.name}ï¼Œè™½ç„¶è¿‡ç¨‹è‰°éš¾ï¼Œä½†æ€»ç®—æœ‰æ‰€æ”¶è·ã€‚`
                    : `ä½ ç”¨${item.text}å®Œæˆäº†${action.name}ï¼Œè™½ç„¶è¿‡ç¨‹è‰°éš¾ï¼Œä½†æ€»ç®—æœ‰æ‰€æ”¶è·ã€‚`;
                return {
                    description: defaultDesc,
                    healthDelta: null,
                    hungerDelta: null,
                    sturdyDelta: 0,
                    rainDelta: 0
                };
            }
        }
        
        // ============== æ ¸å¿ƒåˆæˆåŠŸèƒ½ ==============
        async function performFusion() {
            const [word1, word2] = selectedWords;
            
            if (!word1 || !word2) {
                alert('è¯·é€‰æ‹©ä¸¤ä¸ªç‰©èµ„è¿›è¡Œåˆæˆï¼');
                return;
            }
            if (fusionLeft <= 0) {
                alert('æœ¬è½®åˆæˆæ¬¡æ•°å·²ç”¨å°½ï¼Œè¯·å…ˆæƒ³åŠæ³•é€šè¿‡å½“å‰æŒ‘æˆ˜ï¼');
                return;
            }
            // ç‰©èµ„åˆæˆä¸å†æ¶ˆè€—è¡ŒåŠ¨ç‚¹
            
            // æŸ¥æ‰¾é…æ–¹
            const recipe = findRecipe(word1, word2);
            if (!recipe) {
                alert(`ã€${word1.text}ã€‘å’Œã€${word2.text}ã€‘æ— æ³•åˆæˆï¼`);
                return;
            }
            
            // è·å–ç»“æœç‰©èµ„ä¿¡æ¯
            const resultInfo = MATERIAL_DATABASE[recipe.result];
            if (!resultInfo) {
                alert(`é…æ–¹é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç‰©èµ„ã€${recipe.result}ã€‘çš„ä¿¡æ¯ï¼`);
                return;
        }

            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const fusionBtn = document.querySelector('.fusion-btn[onclick="performFusion()"]');
            const originalText = fusionBtn ? fusionBtn.innerHTML : '';
            if (fusionBtn) {
                fusionBtn.disabled = true;
                fusionBtn.innerHTML = 'â³ åˆæˆä¸­...';
                fusionBtn.style.opacity = '0.6';
                fusionBtn.style.cursor = 'not-allowed';
            }
            
            // æ¶ˆè€—ä¸€æ¬¡åˆæˆæ¬¡æ•°ï¼ˆä¸å†æ¶ˆè€—è¡ŒåŠ¨ç‚¹ï¼‰
            fusionLeft -= 1;
            updateFusionLeftDisplay();
            // æ³¨æ„ï¼šç‰©èµ„åˆæˆä¸æ¶ˆè€—è¡ŒåŠ¨ç‚¹ï¼Œæ‰€ä»¥ä¸æ›´æ–°è¡ŒåŠ¨ç‚¹UIï¼Œä¹Ÿä¸è§¦å‘å¤©æ°”åˆ‡æ¢
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const resultsDiv = document.getElementById('fusion-results');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'result-card';
            loadingDiv.innerHTML = `<div style="text-align: center;">ğŸ”§ æ­£åœ¨å°è¯•åˆæˆæ–°çš„ç‰©èµ„...</div>`;
            resultsDiv.prepend(loadingDiv);
            
            try {
                // è°ƒç”¨å¤§æ¨¡å‹APIï¼šåªç”Ÿæˆæè¿°å’Œå›¾ç‰‡ï¼Œä¸å†³å®šåˆæˆç»“æœ
                const result = await callLLMFusionAPI(
                    word1.text,
                    word2.text,
                    recipe.result
                );
                
                // ç§»é™¤åŠ è½½çŠ¶æ€
                resultsDiv.removeChild(loadingDiv);
                
                // å°†æ–°ç‰©èµ„åŠ å…¥åº“å­˜ï¼ˆä½¿ç”¨é…æ–¹è¡¨çš„ç»“æœï¼‰
                const newWord = {
                    id: getNextWordId(),
                    text: recipe.result,
                    emoji: resultInfo.emoji,
                    tag: resultInfo.tag,
                    level: resultInfo.level,
                    usesLeft: defaultUses(resultInfo.tag),
                    effects: {}
                };
                playerWords.push(newWord);
                renderWordInventory();

                // æ¶ˆè€—åŸææ–™/é£Ÿç‰©/ä¿¡å·çš„ä½¿ç”¨æ¬¡æ•°
                // å¦‚æœæ˜¯å·¥å…·ç±»ç‰©èµ„åˆæˆï¼ˆä¸¤ä¸ªç›¸åŒå·¥å…·åˆæˆæ›´é«˜çº§å·¥å…·ï¼‰ï¼Œç›´æ¥æ¶ˆè€—åˆ°0ï¼ˆç§»é™¤ï¼‰
                const isToolFusion = word1.tag === 'tool' && word2.tag === 'tool' && word1.text === word2.text;
                if (isToolFusion) {
                    // ä¸¤ä¸ªå®Œå…¨ç›¸åŒçš„å·¥å…·åˆæˆæ—¶ï¼Œç›´æ¥æ¶ˆè€—åˆ°0ï¼ˆç§»é™¤ï¼‰
                    playerWords = playerWords.filter(w => w.id !== word1.id && w.id !== word2.id);
                    renderWordInventory();
                } else {
                    // éå·¥å…·åˆæˆæˆ–ä¸åŒå·¥å…·åˆæˆï¼ŒæŒ‰åŸé€»è¾‘æ¶ˆè€—
                    consumeItem(word1, 1);
                    consumeItem(word2, 1);
                }
                
                // ä½¿ç”¨æœ€ç»ˆåç§°æ„é€ ç”¨äºå±•ç¤ºçš„åˆæˆç»“æœï¼Œç¡®ä¿ä¸èµ„æºåº“ä¸€è‡´
                const displayResult = {
                    word1: word1.text,
                    word2: word2.text,
                    itemName: recipe.result,
                    itemType: getTagDisplayName(resultInfo.tag),
                    useDescription: result.useDescription,
                    note: result.note || ''
                };
                
                // æ˜¾ç¤ºç»“æœ
                displayFusionResult(displayResult);
                
                // æ¸…ç©ºåˆæˆæ§½ä½
                resetSlots();
            } catch (error) {
                console.error('åˆæˆå¤±è´¥:', error);
                loadingDiv.innerHTML = `<div style="color: #ff6b6b;">âŒ åˆæˆå¤±è´¥: ${error.message}</div>`;
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (fusionBtn) {
                    fusionBtn.disabled = false;
                    fusionBtn.innerHTML = originalText;
                    fusionBtn.style.opacity = '1';
                    fusionBtn.style.cursor = 'pointer';
        }
            }
        }
        
        // 1. ä½ çš„APIæœåŠ¡å•†æä¾›çš„çœŸå®è¯·æ±‚åœ°å€
        const LLM_API_URL = 'https://api.siliconflow.cn/v1/chat/completions'; 
        // 2. ä½ çš„APIæœåŠ¡å•†æä¾›çš„å¯†é’¥
        const LLM_API_KEY = 'sk-qmqcbvermnhrnqanznlmlfqkwxvijjzfjftflxrhsahmttfa'; 
        // 3. æŒ‡å®šä½¿ç”¨çš„æ¨¡å‹ï¼Œä¾‹å¦‚ 'deepseek-chat', 'gpt-3.5-turbo' ç­‰ï¼Œæ ¹æ®æœåŠ¡å•†æ”¯æŒå¡«å†™
        const LLM_MODEL_NAME = 'deepseek-ai/DeepSeek-V3.2';
        
        // å¸¦è¶…æ—¶çš„ fetch åŒ…è£…å‡½æ•°ï¼ˆé»˜è®¤30ç§’è¶…æ—¶ï¼ŒLLM APIå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ï¼‰
        async function fetchWithTimeout(url, options, timeout = 30000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error(`è¯·æ±‚è¶…æ—¶ï¼ˆ${timeout/1000}ç§’ï¼‰ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•`);
                }
                throw error;
            }
        }

        // ============== è¾…åŠ©å‡½æ•° ==============
        // å®‰å…¨åœ°è§£æJSONå­—ç¬¦ä¸²ï¼Œå¤„ç†å¯èƒ½çš„æ ¼å¼é—®é¢˜
        function safeParseJSON(jsonString) {
            if (!jsonString || typeof jsonString !== 'string') {
                throw new Error('è¾“å…¥ä¸æ˜¯æœ‰æ•ˆçš„å­—ç¬¦ä¸²');
            }
            
            // ç§»é™¤å¯èƒ½çš„ä»£ç å—æ ‡è®°
            let cleaned = jsonString.trim();
            
            // å°è¯•æå–JSONä»£ç å—ï¼ˆå¦‚æœè¢«```json```åŒ…è£…ï¼‰
            const jsonBlockMatch = cleaned.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
            if (jsonBlockMatch) {
                cleaned = jsonBlockMatch[1].trim();
            }
            
            // é¦–å…ˆå°è¯•ç›´æ¥è§£æï¼ˆå¦‚æœå·²ç»æ˜¯æœ‰æ•ˆçš„JSONï¼‰
            try {
                return JSON.parse(cleaned);
            } catch (e) {
                // å¦‚æœç›´æ¥è§£æå¤±è´¥ï¼Œå°è¯•æå–JSONå¯¹è±¡
            }
            
            // å°è¯•æå–ç¬¬ä¸€ä¸ª{...}å—ï¼ˆæ›´å‡†ç¡®åœ°æ‰¾åˆ°JSONå¯¹è±¡ï¼‰
            const firstBrace = cleaned.indexOf('{');
            if (firstBrace === -1) {
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°{ï¼Œå°è¯•æŸ¥æ‰¾[ï¼ˆå¯èƒ½æ˜¯æ•°ç»„ï¼‰
                const firstBracket = cleaned.indexOf('[');
                if (firstBracket !== -1) {
                    // å¤„ç†æ•°ç»„æ ¼å¼
                    let bracketCount = 0;
                    let lastBracket = -1;
                    for (let i = firstBracket; i < cleaned.length; i++) {
                        if (cleaned[i] === '[') bracketCount++;
                        if (cleaned[i] === ']') {
                            bracketCount--;
                            if (bracketCount === 0) {
                                lastBracket = i;
                                break;
                            }
                        }
                    }
                    if (lastBracket !== -1) {
                        try {
                            return JSON.parse(cleaned.substring(firstBracket, lastBracket + 1));
                        } catch (e) {
                            // ç»§ç»­å°è¯•å¯¹è±¡æ ¼å¼
                        }
                    }
                }
                console.error('JSONè§£æå¤±è´¥ - æœªæ‰¾åˆ°JSONå¯¹è±¡å¼€å§‹æ ‡è®°ï¼ŒåŸå§‹å†…å®¹:', cleaned.substring(0, 500));
                throw new Error('æœªæ‰¾åˆ°JSONå¯¹è±¡å¼€å§‹æ ‡è®°');
            }
            
            // ä»ç¬¬ä¸€ä¸ª{å¼€å§‹ï¼Œå‘å‰æŸ¥æ‰¾åŒ¹é…çš„}
            let braceCount = 0;
            let lastBrace = -1;
            let inString = false;
            let escapeNext = false;
            
            for (let i = firstBrace; i < cleaned.length; i++) {
                const char = cleaned[i];
                
                if (escapeNext) {
                    escapeNext = false;
                    continue;
                }
                
                if (char === '\\') {
                    escapeNext = true;
                    continue;
                }
                
                if (char === '"' && !escapeNext) {
                    inString = !inString;
                    continue;
                }
                
                if (!inString) {
                    if (char === '{') braceCount++;
                    if (char === '}') {
                        braceCount--;
                        if (braceCount === 0) {
                            lastBrace = i;
                            break;
                        }
                    }
                }
            }
            
            if (lastBrace === -1 || lastBrace <= firstBrace) {
                console.error('JSONè§£æå¤±è´¥ - æœªæ‰¾åˆ°åŒ¹é…çš„JSONå¯¹è±¡ç»“æŸæ ‡è®°');
                console.error('åŸå§‹å†…å®¹å‰500å­—ç¬¦:', cleaned.substring(0, 500));
                console.error('ç¬¬ä¸€ä¸ª{ä½ç½®:', firstBrace, 'æœ€åä¸€ä¸ª}ä½ç½®:', lastBrace);
                throw new Error('æœªæ‰¾åˆ°åŒ¹é…çš„JSONå¯¹è±¡ç»“æŸæ ‡è®°');
            }
            
            cleaned = cleaned.substring(firstBrace, lastBrace + 1);
            
            try {
                return JSON.parse(cleaned);
            } catch (e) {
                // å¦‚æœä»ç„¶å¤±è´¥ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯å¹¶é‡æ–°æŠ›å‡º
                console.error('JSONè§£æå¤±è´¥ï¼Œæå–çš„å†…å®¹:', cleaned.substring(0, 500));
                console.error('è§£æé”™è¯¯:', e.message);
                throw new Error(`JSONè§£æå¤±è´¥: ${e.message}. è¿™é€šå¸¸æ˜¯å› ä¸ºAIè¿”å›çš„JSONåŒ…å«æœªè½¬ä¹‰çš„å¼•å·æˆ–ç‰¹æ®Šå­—ç¬¦ã€‚`);
            }
        }
        
        // ============== æ ¸å¿ƒAPIè°ƒç”¨å‡½æ•° ==============
        async function callLLMFusionAPI(word1, word2, resultName) {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆå¯é€‰ï¼Œæå‡ä½“éªŒï¼‰
            console.log(`ğŸ”„ æ­£åœ¨è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆæè¿°: ${word1} + ${word2} = ${resultName}`);

            const requestBody = {
                model: LLM_MODEL_NAME, // ä½¿ç”¨é…ç½®çš„æ¨¡å‹å
                messages: [
                    {
                        role: "system",
                        content: `ä½ æ˜¯ä¸€ä¸ª"è’å²›æ±‚ç”Ÿ"æ¸¸æˆçš„æè¿°ç”Ÿæˆå™¨ã€‚
${playerName ? `ç©å®¶åå­—æ˜¯ã€${playerName}ã€‘ã€‚è¯·åœ¨æ‰€æœ‰æè¿°ä¸­ä½¿ç”¨ã€${playerName}ã€‘ä½œä¸ºä¸»è¯­ï¼Œä¸è¦ä½¿ç”¨"ä½ "å­—ã€‚` : ''}
                        ç©å®¶å·²ç»é€šè¿‡é…æ–¹è¡¨ç¡®å®šäº†åˆæˆç»“æœï¼šã€${resultName}ã€‘ã€‚
                        ä½ çš„ä»»åŠ¡æ˜¯ï¼šæ ¹æ®${playerName || 'ç©å®¶'}ä½¿ç”¨çš„ä¸¤ç§ç‰©èµ„ã€${word1}ã€‘å’Œã€${word2}ã€‘ï¼Œç”Ÿæˆä¸€æ®µç”ŸåŠ¨çš„æè¿°ï¼Œè¯´æ˜${playerName || 'ç©å®¶'}æ˜¯å¦‚ä½•åœ¨è’å²›ä¸Šé€šè¿‡å®é™…æ“ä½œå¾—åˆ°ã€${resultName}ã€‘çš„ã€‚
                        
                        è¦æ±‚ï¼š
                        1. æè¿°è¦çœŸå®ã€å…·ä½“ï¼Œç¬¦åˆè’å²›æ±‚ç”Ÿåœºæ™¯
                        2. é‡ç‚¹æè¿°ç©å®¶å¦‚ä½•åˆ©ç”¨ã€${word1}ã€‘å’Œã€${word2}ã€‘ä¸€æ­¥æ­¥åˆ¶ä½œæˆ–å¤„ç†å¾—åˆ°ã€${resultName}ã€‘çš„è¿‡ç¨‹
                        3. ä¸è¦å‡ºç°é­”æ³•æˆ–è¶…è‡ªç„¶ç°è±¡ï¼Œè¦ç¬¦åˆç‰©ç†é€»è¾‘
                        4. æè¿°é•¿åº¦1-3å¥è¯å³å¯
                        
                        è¯·ä¸¥æ ¼è¿”å›ä»¥ä¸‹JSONæ ¼å¼ï¼š
                        {
                            "useDescription": "ç”¨1-3å¥è¯ï¼Œå…·ä½“æè¿°${playerName || 'ç©å®¶'}æ˜¯æ€ä¹ˆç”¨ã€${word1}ã€‘å’Œã€${word2}ã€‘åŠ¨æ‰‹æ“ä½œï¼Œæœ€ç»ˆå¾—åˆ°ã€${resultName}ã€‘çš„å…¨è¿‡ç¨‹",
                            "note": "å¯é€‰çš„ä¸€å¥è¯´æ˜ï¼šè¿™ä¸ªã€${resultName}ã€‘åœ¨è’å²›ç”Ÿå­˜ä¸­ä¸»è¦èƒ½å¸®ä¸Šä»€ä¹ˆå¿™"
                        }`
                    },
                    {
                        role: "user",
                        content: `${playerName || 'ç©å®¶'}ä½¿ç”¨ã€${word1}ã€‘å’Œã€${word2}ã€‘åˆæˆå‡ºäº†ã€${resultName}ã€‘ã€‚
                        è¯·ç”Ÿæˆåˆæˆè¿‡ç¨‹çš„æè¿°ï¼Œä½¿ç”¨${playerName || 'ç©å®¶'}ä½œä¸ºä¸»è¯­ã€‚`
                    }
                ],
                temperature: 0.8, // æ§åˆ¶åˆ›æ„ç¨‹åº¦ (0-1)ï¼Œ0.8æ¯”è¾ƒæœ‰åˆ›æ„
                max_tokens: 100, // é™åˆ¶è¾“å‡ºé•¿åº¦ä»¥åŠ å¿«ç”Ÿæˆé€Ÿåº¦
                // å¤šæ•°æœåŠ¡å•†è¦æ±‚å°†è¿”å›æ ¼å¼è®¾ä¸ºJSONï¼Œä½†å‚æ•°åå¯èƒ½æ˜¯ response_format æˆ–å…¶å®ƒï¼Œè¯·æŸ¥é˜…æ–‡æ¡£
                response_format: { "type": "json_object" }
        };

    try {
        // å‘é€è¯·æ±‚åˆ°ä»£ç†æœåŠ¡
        const response = await fetchWithTimeout(LLM_API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // å¤§å¤šæ•°æœåŠ¡å•†ç”¨ 'Authorization' å¤´ä¼ é€’å¯†é’¥ï¼Œæ ¼å¼å¯èƒ½æ˜¯ 'Bearer KEY' æˆ–ç›´æ¥æ˜¯KEY
                'Authorization': `Bearer ${LLM_API_KEY}`,
                // æŸäº›æœåŠ¡å•†å¯èƒ½æœ‰è‡ªå®šä¹‰å¤´éƒ¨ï¼Œå¦‚ 'api-key'ï¼Œè¯·ä»¥æœåŠ¡å•†æ–‡æ¡£ä¸ºå‡†
                // 'api-key': LLM_API_KEY
            },
            body: JSON.stringify(requestBody)
        }, 30000);

        // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`APIè¯·æ±‚å¤±è´¥ (çŠ¶æ€ç : ${response.status}): ${errorText}`);
        }

        // è§£æè¿”å›çš„JSONæ•°æ®
        const data = await response.json();
        
        // é‡è¦ï¼šä»è¿”å›ç»“æ„ä¸­æå–å†…å®¹ã€‚ä¸åŒæœåŠ¡å•†æ•°æ®ç»“æ„ä¸åŒï¼
        // å¸¸è§æ ¼å¼1: data.choices[0].message.content (OpenAI/DeepSeekå…¼å®¹æ ¼å¼)
        // å¸¸è§æ ¼å¼2: data.result æˆ– data.content
        let resultContent = data.choices[0].message.content; // è¿™æ˜¯æœ€å¸¸è§çš„è·¯å¾„
        
        // å°è¯•è§£æcontentä¸­çš„JSONå­—ç¬¦ä¸²ï¼ˆä½¿ç”¨å®‰å…¨è§£æå‡½æ•°ï¼‰
        const parsedResult = safeParseJSON(resultContent);
        
        // å°†è§£æç»“æœä¸ä½ åŸæœ‰çš„æ¸¸æˆæ•°æ®ç»“æ„å¯¹é½å¹¶è¿”å›
            const defaultDesc = playerName
                ? `${playerName}ä½¿ç”¨ã€${word1}ã€‘å’Œã€${word2}ã€‘åˆ¶ä½œå‡ºäº†ã€${resultName}ã€‘ã€‚`
                : `ä½ ä½¿ç”¨ã€${word1}ã€‘å’Œã€${word2}ã€‘åˆ¶ä½œå‡ºäº†ã€${resultName}ã€‘ã€‚`;
            return {
                useDescription: replaceYouWithPlayerName(parsedResult.useDescription || defaultDesc),
                note: replaceYouWithPlayerName(parsedResult.note || '')
            };

    } catch (error) {
        console.error('âŒ è°ƒç”¨å¤§æ¨¡å‹APIæ—¶å‘ç”Ÿé”™è¯¯:', error);
        console.error('é”™è¯¯è¯¦æƒ…:', error.message);
        // å¦‚æœæ˜¯JSONè§£æé”™è¯¯ï¼Œè®°å½•æ›´å¤šä¿¡æ¯
        if (error.message && (error.message.includes('JSON') || error.message.includes('æœªæ‰¾åˆ°'))) {
            console.error('è¿™å¯èƒ½æ˜¯AIè¿”å›çš„JSONæ ¼å¼ä¸æ­£ç¡®ï¼Œå°†ä½¿ç”¨é»˜è®¤æè¿°');
        }
        // æä¾›ä¸€ä¸ªå‹å¥½çš„é”™è¯¯å›é€€ï¼Œé˜²æ­¢æ¸¸æˆå¡ä½
        const defaultDesc = playerName
            ? `${playerName}ä½¿ç”¨ã€${word1}ã€‘å’Œã€${word2}ã€‘åˆ¶ä½œå‡ºäº†ã€${resultName}ã€‘ã€‚`
            : `ä½ ä½¿ç”¨ã€${word1}ã€‘å’Œã€${word2}ã€‘åˆ¶ä½œå‡ºäº†ã€${resultName}ã€‘ã€‚`;
        return {
            useDescription: defaultDesc,
            note: `AI æè¿°ç”Ÿæˆå‡ºé”™ï¼š${error.message}ï¼Œä¸‹æ¬¡ç½‘ç»œçŠ¶å†µå¥½ç‚¹å†è¯•è¯•ã€‚`
        };
    }
}
        // ============== ç»“æœå±•ç¤º ==============
        function displayFusionResult(result) {
            const resultsDiv = document.getElementById('fusion-results');
            const uniqueImageId = 'image-' + Date.now();
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result-card';
            
            resultDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 24px;">${result.word1}</span>
                    <span style="font-size: 20px;">+</span>
                    <span style="font-size: 24px;">${result.word2}</span>
                    <span style="font-size: 20px;">â†’</span>
                    <span style="font-size: 28px; color: #7a7773;">${result.itemName}</span>
                </div>
                <p style="margin: 6px 0 2px 0;">${result.useDescription}</p>
                ${result.note ? `<p style="font-size:0.85em; opacity:0.9; margin-top:4px;">æç¤ºï¼š${result.note}</p>` : ''}
                <div id="${uniqueImageId}" style="text-align: center; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 5px; margin: 10px 0;">
            <div style="display: inline-block; padding: 20px; background: linear-gradient(45deg, #f72585, #4361ee); border-radius: 50%; margin: 10px;">
                â³
            </div>
                    <p><small>æ­£åœ¨ç”Ÿæˆâ€œ${result.itemName}â€çš„è§†è§‰å½¢è±¡...</small></p>
            </div>
                <div style="text-align: right; font-size: 12px; opacity: 0.7;">
                    ${new Date().toLocaleTimeString()}
                </div>
            `;
            
            resultsDiv.prepend(resultDiv);
            fusionResults.push(result);
            
            // å¦‚æœç»“æœå¤ªå¤šï¼Œç§»é™¤æ—§çš„
            if (fusionResults.length > 10) {
                fusionResults.shift();
                if (resultsDiv.children.length > 10) {
                    resultsDiv.removeChild(resultsDiv.lastChild);
                }
            }
            
            // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨çš„IDå¿…é¡»å’Œä¸Šé¢å ä½ç¬¦çš„IDå®Œå…¨ä¸€è‡´
            generateAndDisplayImage(result.itemName, result.useDescription || result.note, uniqueImageId);
        }
        
                // ============== æ ¸å¿ƒç”Ÿå›¾APIè°ƒç”¨å‡½æ•° ==============
        async function generateAndDisplayImage(name, description, placeholderId) {
            const placeholder = document.getElementById(placeholderId);
            if (!placeholder) {
                console.error('æ‰¾ä¸åˆ°å›¾ç‰‡å ä½ç¬¦:', placeholderId);
                return;
            }

            // æ›´æ–°å ä½ç¬¦å†…å®¹ä¸ºåŠ è½½çŠ¶æ€
            placeholder.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p>ğŸ¨ æ­£åœ¨ç»˜åˆ¶â€œ${name}â€...</p>
                </div>
            `;

            // æ„å»ºç”Ÿå›¾è¯·æ±‚ã€‚æ³¨æ„ï¼šä¸åŒæœåŠ¡å•†çš„è¯·æ±‚ä½“æ ¼å¼å¯èƒ½ä¸åŒï¼
            const requestBody = {
                model: IMG_MODEL,
                prompt: createImagePrompt(name, description, 'åˆæˆç‰©èµ„'), // ä½¿ç”¨å·¥å…·å‡½æ•°åˆ›å»ºprompt
                n: 1, // ç”Ÿæˆ1å¼ æ¨ªç‰ˆå›¾
                size: "1280x720", // é™ä½åˆ†è¾¨ç‡ä»¥åŠ å¿«ç”Ÿæˆé€Ÿåº¦
                quality: "standard", // æˆ– "hd" (DALL-E 3)
                // éƒ¨åˆ†æœåŠ¡å•†å¯èƒ½éœ€è¦å…¶ä»–å‚æ•°ï¼Œå¦‚ 'style', 'negative_prompt' ç­‰
            };

            try {
                console.log(`ğŸ–¼ï¸ æ­£åœ¨è¯·æ±‚ç”Ÿæˆç‰©èµ„â€œ${name}â€çš„å›¾ç‰‡...`);

                const response = await fetchWithTimeout(IMG_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // æˆæƒæ–¹å¼å› æœåŠ¡å•†è€Œå¼‚ï¼Œè¯·æŸ¥é˜…æ–‡æ¡£
                        'Authorization': `Bearer ${IMG_API_KEY}`,
                        // ä¹Ÿå¯èƒ½æ˜¯: 'api-key': IMG_API_KEY
                    },
                    body: JSON.stringify(requestBody)
                }, 30000);

                if (!response.ok) {
                    const errorText = await response.text();
                    const errorMessage = `ç”Ÿå›¾APIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`;
                    // ç‰¹æ®Šå¤„ç†403 RPMé™åˆ¶é”™è¯¯
                    if (response.status === 403 && errorText.includes('RPM limit exceeded')) {
                        showToast('å›¾ç‰‡ç”ŸæˆAPIå·²è¾¾åˆ°è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œè¯·ç¨åå†è¯•æˆ–å®Œæˆèº«ä»½éªŒè¯', 'warning', 'âš ï¸ å›¾ç‰‡ç”Ÿæˆå—é™', 5000);
                        throw new Error('RPM_LIMIT_EXCEEDED');
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('ç”Ÿå›¾APIå®Œæ•´å“åº”:', data); // é¦–æ¬¡è°ƒè¯•æ—¶éå¸¸é‡è¦ï¼

                // **å…³é”®æ­¥éª¤ï¼šä»å“åº”ä¸­æå–å›¾ç‰‡URL**
                // ä¸åŒæœåŠ¡å•†è¿”å›çš„æ•°æ®ç»“æ„å·®å¼‚å¾ˆå¤§ï¼Œè¯·æ ¹æ®ä¸Šä¸€æ­¥console.logçš„è¾“å‡ºè¿›è¡Œè°ƒæ•´ï¼
                let imageUrl;
                
                // 1. OpenAI DALL-E æ ¼å¼
                if (data.data && data.data[0] && data.data[0].url) {
                    imageUrl = data.data[0].url;
                }
                // 2. æŸäº›æœåŠ¡å•†å¯èƒ½ç›´æ¥è¿”å›ä¸€ä¸ªurlå­—æ®µ
                else if (data.url) {
                    imageUrl = data.url;
                }
                // 3. æŸäº›è¿”å›Base64ç¼–ç çš„å›¾ç‰‡æ•°æ®
                else if (data.data && data.data[0] && data.data[0].b64_json) {
                    // éœ€è¦å°†base64è½¬æ¢ä¸ºå¯ç›´æ¥æ˜¾ç¤ºçš„URL
                    imageUrl = `data:image/png;base64,${data.data[0].b64_json}`;
                }
                // 4. å…¶ä»–æ ¼å¼...
                else {
                    // å¦‚æœéƒ½ä¸åŒ¹é…ï¼ŒæŠ›å‡ºé”™è¯¯å¹¶æ‰“å°æ•°æ®ç»“æ„ä»¥ä¾¿è°ƒè¯•
                    console.warn('æ— æ³•è¯†åˆ«çš„å“åº”æ ¼å¼ï¼Œå°è¯•å…¶ä»–è·¯å¾„...', data);
                    // å¯ä»¥å°è¯•æ·±å…¥æŒ–æ˜å“åº”ï¼Œä¾‹å¦‚ data.images[0].url
                    // è¯·æ ¹æ®ä½ å®é™…ä½¿ç”¨çš„æœåŠ¡å•†æ–‡æ¡£ä¿®æ”¹æ­¤å¤„
                    throw new Error('æ— æ³•ä»å“åº”ä¸­è§£æå›¾ç‰‡URLï¼Œè¯·æ£€æŸ¥æ•°æ®ç»“æ„ã€‚');
                }

                // å°†å›¾ç‰‡URLæ’å…¥åˆ°é¡µé¢ä¸­
                placeholder.innerHTML = `
                    <img src="${imageUrl}" 
                        class="word-image" 
                        alt="${name}" 
                        style="width:100%; border-radius:10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);"
                        onerror="this.onerror=null; this.parentElement.innerHTML='<p style=\'color:red;\'>âš ï¸ å›¾ç‰‡åŠ è½½å¤±è´¥</p>';">
                        <!-- è¿™é‡Œä¸å†é‡å¤æ–‡å­—æ ‡ç­¾ï¼Œçº¯å›¾åƒå±•ç¤º -->
                `;
                // æ¸…é™¤å ä½ç¬¦å®¹å™¨çš„æ ·å¼ï¼Œé¿å…ç°è‰²èƒŒæ™¯æ®‹ç•™
                placeholder.style.background = '';
                placeholder.style.minHeight = '';
                placeholder.style.display = '';
                placeholder.style.alignItems = '';
                placeholder.style.justifyContent = '';
                placeholder.style.padding = '';

            } catch (error) {
                console.error('âŒ ç”Ÿå›¾å¤±è´¥:', error);
                // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„å ä½ç¬¦
                if (error.message === 'RPM_LIMIT_EXCEEDED') {
                    placeholder.innerHTML = `
                        <div style="text-align: center; padding: 30px; background: rgba(201, 184, 155, 0.2); border-radius: 10px; border: 2px dashed rgba(201, 184, 155, 0.4);">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ¨</div>
                            <p style="color: #c9b89b; font-weight: 500; margin-bottom: 8px;">å›¾ç‰‡ç”Ÿæˆå—é™</p>
                            <p style="font-size: 0.9em; color: #7a7773; opacity: 0.8;">APIè¯·æ±‚é¢‘ç‡å·²è¾¾ä¸Šé™ï¼Œè¯·ç¨åå†è¯•</p>
                        </div>
                    `;
                } else {
                    // ä¼˜é›…é™çº§ï¼šæ˜¾ç¤ºä¸€ä¸ªç¾è§‚çš„å ä½ç¬¦ï¼Œè€Œä¸æ˜¯è®©ç•Œé¢å´©æºƒ
                    placeholder.innerHTML = `
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 10px; color: white;">
                            <div style="font-size: 48px;">ğŸ¨</div>
                            <p><strong>"${word}"</strong></p>
                            <p>è§†è§‰æ¦‚å¿µå·²æ„ŸçŸ¥ï¼Œä½†æœªèƒ½å…·ç°åŒ–ã€‚</p>
                            <p style="font-size:0.7em; margin-top:10px;">è¯·ç¨åé‡è¯•</p>
                        </div>
                    `;
                }
            }
        }
        
        // ============== å·¥å…·å‡½æ•° ==============
        function resetSlots() {
            // å–æ¶ˆåˆæˆæ§½ä½ç‰©èµ„çš„ä½¿ç”¨æ ‡è®°
            selectedWords.forEach(word => {
                if (word) {
                    usedWordIds.delete(word.id);
                }
            });
            selectedWords = [null, null];
            // åªé‡ç½®åˆæˆæ§½ä½
            const slot1 = document.getElementById('slot1');
            const slot2 = document.getElementById('slot2');
            if (slot1) {
                slot1.innerHTML = 'æ‹–æ”¾ç‰©èµ„';
                slot1.style.background = 'rgba(220, 217, 212, 0.4)';
                slot1.style.borderColor = '#b8b3b5';
            }
            if (slot2) {
                slot2.innerHTML = 'æ‹–æ”¾ç‰©èµ„';
                slot2.style.background = 'rgba(220, 217, 212, 0.4)';
                slot2.style.borderColor = '#b8b3b5';
            }
        }
        
        // æ¸…ç©ºè¡ŒåŠ¨æ§½ä½ï¼ˆä¸æ‰§è¡Œè¡ŒåŠ¨åçš„æ¸…ç©ºé€»è¾‘ä¸€è‡´ï¼‰
        function resetActionSlot() {
            // å–æ¶ˆè¡ŒåŠ¨æ§½ä½ç‰©èµ„çš„ä½¿ç”¨æ ‡è®°
            if (actionSlotItem) {
                usedWordIds.delete(actionSlotItem.id);
            }
            actionSlotItem = null;
            
            const actionSlot = document.getElementById('action-slot');
            if (actionSlot) {
                actionSlot.innerHTML = 'æ‹–æ”¾ç‰©èµ„åˆ°æ­¤å¤„';
            }
            
            const menuEl = document.getElementById('action-menu');
            if (menuEl) {
                menuEl.style.display = 'none';
                menuEl.innerHTML = '';
            }
        }
        
        // ============== æŒ‘æˆ˜æè¿°ä¸åœºæ™¯å›¾ç”Ÿæˆ ==============
        async function generateChallengeNarrativeAndImage(challenge) {
            // å¦‚æœå·²ç»æœ‰æè¿°åˆ™ä¸é‡å¤ç”Ÿæˆ
            if (!challenge || (challenge.description && challenge.description.length > 0)) {
                if (challenge && challenge.description) {
                    document.getElementById('challenge-text').textContent = challenge.title + " - " + challenge.description;
                }
                return;
            }

            const challengeTextEl = document.getElementById('challenge-text');
            const imageContainer = document.getElementById('challenge-image');
            if (imageContainer) {
                imageContainer.innerHTML = `
                    <div style="text-align:center; padding:10px;">
                        <div class="spinner"></div>
                        <p>ğŸ¨ æ­£åœ¨æƒ³è±¡è¿™ä¸€å¹•è’å²›åœºæ™¯...</p>
                    </div>
                `;
            }

            try {
                const response = await fetchWithTimeout(LLM_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${LLM_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: LLM_MODEL_NAME,
                        messages: [
                            {
                                role: "system",
                                content: `ä½ æ˜¯ä¸€ä¸ªæ–‡å­—å™äº‹è®¾è®¡å¸ˆï¼Œè´Ÿè´£ä¸º"è’å²›æ±‚ç”Ÿ"æ¸¸æˆå†™å…³å¡æè¿°ã€‚
${playerName ? `ç©å®¶åå­—æ˜¯ã€${playerName}ã€‘ã€‚è¯·åœ¨æ‰€æœ‰æè¿°ä¸­ä½¿ç”¨ã€${playerName}ã€‘ä½œä¸ºä¸»è¯­ï¼Œä¸è¦ä½¿ç”¨"ä½ "å­—ã€‚` : ''}
                                è¯·ç”¨ç´§å¼ ä½†ä¸è¡€è…¥çš„ç¬”è§¦ï¼Œæå†™ä¸€æ®µ2-4å¥çš„ä¸­æ–‡åœºæ™¯æ–‡å­—ã€‚
                                åªè¿”å›çº¯æ–‡æœ¬ï¼Œä¸è¦è§£é‡Šã€‚`
                            },
                            {
                                role: "user",
                                content: `å…³å¡æ ‡é¢˜ï¼š${challenge.title}
                                èƒŒæ™¯æç¤ºï¼š${challenge.solutionHint}
                                è¯·å†™å‡ºè¿™ä¸€æŒ‘æˆ˜å‘ç”Ÿæ—¶çš„å…·ä½“ç¯å¢ƒä¸å±æœºç”»é¢ã€‚`
                            }
                        ],
                        temperature: 0.8,
                        max_tokens: 80
                    })
                }, 30000);

                if (!response.ok) throw new Error(`ç”ŸæˆæŒ‘æˆ˜æè¿°å¤±è´¥: ${response.status}`);
                const data = await response.json();
                const text = data.choices && data.choices[0] && data.choices[0].message
                    ? data.choices[0].message.content.trim()
                    : 'ä¸€åœºçªå¦‚å…¶æ¥çš„å±æœºæ­£å‘ä½ é€¼è¿‘ã€‚';

                challenge.description = text;
                if (challengeTextEl) {
                    challengeTextEl.textContent = challenge.title + " - " + challenge.description;
                }

                // ä½¿ç”¨ç”Ÿå›¾APIä¸ºå½“å‰æŒ‘æˆ˜ç”Ÿæˆåœºæ™¯å›¾
                if (imageContainer) {
                    const placeholderId = 'challenge-scene-image';
                    imageContainer.innerHTML = `<div id="${placeholderId}"></div>`;
                    generateAndDisplayImage(challenge.title, challenge.description, placeholderId);
                }
            } catch (e) {
                console.error('ç”ŸæˆæŒ‘æˆ˜æè¿°æˆ–å›¾ç‰‡å¤±è´¥ï¼š', e);
                if (challengeTextEl) {
                    challengeTextEl.textContent = challenge.title + " - " + (challenge.description || "ä¸€åœºå±é™©æ­£åœ¨é€¼è¿‘ï¼Œä½ å¿…é¡»è¿…é€Ÿåšå‡ºé€‰æ‹©ã€‚");
                }
                if (imageContainer) {
                    imageContainer.innerHTML = '';
                }
            }
        }
        
        // é€šè¿‡æŒ‘æˆ˜åç»™äºˆå¥–åŠ±ç‰©èµ„ï¼ˆä»é…æ–¹è¡¨ä¸­éšæœºé€‰æ‹©ï¼‰
        async function grantAiRewardItem(completedChallengeIndex) {
            try {
                // æ ¹æ®å®Œæˆçš„æŒ‘æˆ˜ç´¢å¼•å†³å®šå¥–åŠ±ç­‰çº§
                // ç¬¬ä¸€ä¸ªæŒ‘æˆ˜ï¼ˆindex 0ï¼‰è¿‡åç»™2çº§ç‰©èµ„
                // ç¬¬äºŒã€ä¸‰æŒ‘æˆ˜ï¼ˆindex 1, 2ï¼‰è¿‡åç»™3çº§ç‰©èµ„
                let rewardLevel;
                if (completedChallengeIndex === 0) {
                    rewardLevel = 2; // ç¬¬ä¸€ä¸ªæŒ‘æˆ˜åç»™2çº§ç‰©èµ„
                } else if (completedChallengeIndex === 1 || completedChallengeIndex === 2) {
                    rewardLevel = 3; // ç¬¬äºŒã€ä¸‰æŒ‘æˆ˜åç»™3çº§ç‰©èµ„
                } else {
                    // ç¬¬å››ä¸ªæŒ‘æˆ˜ï¼ˆæœ€ç»ˆæŒ‘æˆ˜ï¼‰ä¸ç»™å¥–åŠ±ï¼Œå› ä¸ºæ¸¸æˆç»“æŸ
                    return;
                }
                
                // ä»MATERIAL_DATABASEä¸­ç­›é€‰å‡ºå¯¹åº”ç­‰çº§çš„æ‰€æœ‰ç‰©èµ„
                // ç¬¬äºŒå…³å®Œæˆåï¼Œåªç»™åŸææ–™æˆ–é£Ÿç‰©ç±»å¥–åŠ±ï¼Œä¸èƒ½ç»™å·¥å…·ç±»ï¼ˆå› ä¸ºç¬¬ä¸‰å…³éœ€è¦ç©å®¶è‡ªå·±åˆæˆLv3å·¥å…·ï¼‰
                let availableItems = Object.entries(MATERIAL_DATABASE)
                    .filter(([name, info]) => info.level === rewardLevel);
                
                // å¦‚æœæ˜¯ç¬¬äºŒå…³ï¼ˆindex 1ï¼‰ï¼Œæ’é™¤å·¥å…·ç±»ç‰©èµ„
                if (completedChallengeIndex === 1) {
                    availableItems = availableItems.filter(([name, info]) => info.tag !== 'tool');
                }
                
                if (availableItems.length === 0) {
                    console.error(`æ‰¾ä¸åˆ° Lv${rewardLevel} çš„ç‰©èµ„ä½œä¸ºå¥–åŠ±`);
                    return;
                }
                
                // éšæœºé€‰æ‹©ä¸€ä¸ªç‰©èµ„
                const [itemName, itemInfo] = availableItems[Math.floor(Math.random() * availableItems.length)];
                
                // æ£€æŸ¥æ˜¯å¦å·²æ‹¥æœ‰è¯¥ç‰©èµ„ï¼ˆå¦‚æœå·²æ‹¥æœ‰ï¼Œå¯ä»¥é€‰æ‹©å¦ä¸€ä¸ªï¼‰
                if (!playerWords.some(w => w.text === itemName)) {
                    const newWord = {
                        id: getNextWordId(),
                        text: itemName,
                        emoji: itemInfo.emoji,
                        tag: itemInfo.tag,
                        level: itemInfo.level,
                        usesLeft: defaultUses(itemInfo.tag)
                    };
                    playerWords.push(newWord);
                    renderWordInventory();
                    setTimeout(async () => {
                        await showModal(
                            'æŒ‘æˆ˜å¥–åŠ±',
                            `ä½ è·å¾—äº†æ–°çš„ç‰©èµ„ï¼š<br><strong style="font-size: 18px;">ã€${newWord.text}ã€‘(Lv${newWord.level}Â·${tagLabel(newWord.tag)})</strong>`,
                            'ğŸ',
                            'ç¡®å®š'
                        );
                    }, 400);
                } else {
                    // å¦‚æœå·²æ‹¥æœ‰ï¼Œå°è¯•é€‰æ‹©å¦ä¸€ä¸ª
                    const otherItems = availableItems.filter(([name]) => !playerWords.some(w => w.text === name));
                    if (otherItems.length > 0) {
                        const [otherName, otherInfo] = otherItems[Math.floor(Math.random() * otherItems.length)];
                        const newWord = {
                            id: getNextWordId(),
                            text: otherName,
                            emoji: otherInfo.emoji,
                            tag: otherInfo.tag,
                            level: otherInfo.level,
                            usesLeft: defaultUses(otherInfo.tag)
                        };
                        playerWords.push(newWord);
                        renderWordInventory();
                        setTimeout(async () => {
                            await showModal(
                                'æŒ‘æˆ˜å¥–åŠ±',
                                `ä½ è·å¾—äº†æ–°çš„ç‰©èµ„ï¼š<br><strong style="font-size: 18px;">ã€${newWord.text}ã€‘(Lv${newWord.level}Â·${tagLabel(newWord.tag)})</strong>`,
                                'ğŸ',
                                'ç¡®å®š'
                            );
                        }, 400);
                    } else {
                        // å¦‚æœæ‰€æœ‰è¯¥ç­‰çº§çš„ç‰©èµ„éƒ½å·²æ‹¥æœ‰ï¼Œä»ç„¶ç»™äºˆä¸€ä¸ªï¼ˆå…è®¸é‡å¤ï¼‰
                        const newWord = {
                            id: getNextWordId(),
                            text: itemName,
                            emoji: itemInfo.emoji,
                            tag: itemInfo.tag,
                            level: itemInfo.level,
                            usesLeft: defaultUses(itemInfo.tag)
                        };
                        playerWords.push(newWord);
                        renderWordInventory();
                        setTimeout(async () => {
                            await showModal(
                                'æŒ‘æˆ˜å¥–åŠ±',
                                `ä½ è·å¾—äº†æ–°çš„ç‰©èµ„ï¼š<br><strong style="font-size: 18px;">ã€${newWord.text}ã€‘(Lv${newWord.level}Â·${tagLabel(newWord.tag)})</strong>`,
                                'ğŸ',
                                'ç¡®å®š'
                            );
                        }, 400);
                    }
                }
            } catch (e) {
                console.error('å¥–åŠ±ç‰©èµ„ç”Ÿæˆå¤±è´¥ï¼š', e);
            }
        }

        // ============== å¯»æ‰¾åŸææ–™åŠŸèƒ½ ==============
        async function findRawMaterial(locationId) {
            // æ£€æŸ¥è¡ŒåŠ¨ç‚¹
            if (actionPoints <= 0) {
                showToast('ä»Šæ—¥è¡ŒåŠ¨ç‚¹å·²ç”¨å®Œï¼Œè¯·ç»“æŸä»Šå¤©åå†ç»§ç»­', 'warning', 'âš ï¸ è¡ŒåŠ¨ç‚¹ä¸è¶³');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²æ­»äº¡
            if (isDead()) {
                alert('ä½ å·²æ— æ³•ç»§ç»­è¡ŒåŠ¨');
                return;
            }

            // æ£€æŸ¥åœ°ç‚¹æ˜¯å¦è§£é”
            const location = LOCATIONS[locationId];
            if (!location || !location.unlocked) {
                alert('è¯¥åœ°ç‚¹å°šæœªè§£é”ï¼');
                return;
            }

            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            const btn = document.getElementById(`location-btn-${locationId}`);
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = 'â³ å¯»æ‰¾ä¸­...';
                btn.style.opacity = '0.6';
                btn.style.cursor = 'not-allowed';
            }

            try {
                // ç›´æ¥ä»åœ°ç‚¹åå¥½åˆ—è¡¨ä¸­éšæœºé€‰æ‹©ç‰©èµ„ï¼Œä¸åŒºåˆ†ç¨€æœ‰åº¦æ¦‚ç‡
                const preferredItems = location.preferredItems || [];
                
                // ä»åå¥½åˆ—è¡¨ä¸­ç­›é€‰å‡ºåœ¨MATERIAL_DATABASEä¸­å­˜åœ¨çš„ç‰©èµ„
                const preferredAvailable = preferredItems
                    .filter(name => MATERIAL_DATABASE[name]) // ç¡®ä¿ç‰©èµ„å­˜åœ¨äºæ•°æ®åº“ä¸­
                    .map(name => [name, MATERIAL_DATABASE[name]]);
                
                // å¦‚æœåå¥½åˆ—è¡¨ä¸­æœ‰ç‰©èµ„ï¼Œéšæœºé€‰æ‹©ï¼›å¦åˆ™ä»æ‰€æœ‰ç‰©èµ„ä¸­éšæœºé€‰æ‹©ä½œä¸ºå›é€€
                let availableItems;
                if (preferredAvailable.length > 0) {
                    availableItems = preferredAvailable;
                } else {
                    // å›é€€ï¼šä»æ‰€æœ‰ç‰©èµ„ä¸­éšæœºé€‰æ‹©
                    availableItems = Object.entries(MATERIAL_DATABASE);
                }
                
                if (availableItems.length === 0) {
                    throw new Error(`æ‰¾ä¸åˆ°å¯ç”¨ç‰©èµ„`);
                }
                
                // æ£€æŸ¥å¤©æ°”å½±å“ï¼ˆä½¿ç”¨åœ°ç‚¹ç‰¹å®šçš„åˆ¤æ–­ï¼‰
                const isAffectedByWeather = checkLocationWeatherImpact(locationId);
                let weatherSuccess = true;
                let isDoubleReward = false;
                
                if (isAffectedByWeather) {
                    // 50%å¤±è´¥ç‡
                    weatherSuccess = Math.random() < 0.5;
                    if (weatherSuccess) {
                        // æˆåŠŸåˆ™åŒå€æ”¶ç›Š
                        isDoubleReward = true;
                    }
                }
                
                // å¦‚æœå¤©æ°”å½±å“å¯¼è‡´å¤±è´¥ï¼Œä¸ç”Ÿæˆç‰©èµ„
                if (!weatherSuccess && isAffectedByWeather) {
                    // æ¶ˆè€—è¡ŒåŠ¨ç‚¹
                    actionPoints -= 1;
                    actionPointCounter += 1;
                    // æ¯æ¶ˆè€—3è¡ŒåŠ¨ç‚¹æ¢ä¸€æ¬¡å¤©æ°”
                    if (actionPointCounter >= 3) {
                        changeWeather();
                    }
                    
                    // å¤±è´¥æ—¶ä¹Ÿæ‰£å‡ç”Ÿå­˜çŠ¶æ€å€¼ï¼ˆå› ä¸ºå¤©æ°”æ¶åŠ£ä¸”æ²¡æ‰¾åˆ°ç‰©èµ„ï¼Œæ¶ˆè€—æ›´å¤šä½“åŠ›ï¼‰
                    const survivalLoss = -6;
                    applyStatChanges({ health: Math.floor(survivalLoss / 2), hunger: Math.ceil(survivalLoss / 2) });
                    
                    // æ£€æŸ¥æ˜¯å¦æ­»äº¡
                    if (isDead()) {
                        showGameOverScreen("åœ¨å¯»æ‰¾ç‰©èµ„çš„è¿‡ç¨‹ä¸­ï¼Œä½ çš„çŠ¶æ€å·²ç»è·Œè‡³æé™ï¼Œå†ä¹Ÿæ’‘ä¸ä¸‹å»äº†ã€‚");
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        if (btn) {
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                            btn.style.opacity = '1';
                            btn.style.cursor = 'pointer';
                        }
                        return;
                    }
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    }
                    
                    updateDayAndActionUI();
                    
                    // æ˜¾ç¤ºå¤±è´¥ç»“æœ
                    const resultsDiv = document.getElementById('fusion-results');
                    if (resultsDiv) {
                        const resultCard = document.createElement('div');
                        resultCard.className = 'result-card';
                        resultCard.style.borderLeftColor = '#ef4444';
                        resultCard.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <span style="font-size: 24px;">${location.emoji}</span>
                                <span style="font-size: 18px; font-weight: 500;">${location.name} - å¯»æ‰¾ç‰©èµ„</span>
                            </div>
                            <p style="color:#c4a5a5; margin-bottom:8px;">âš ï¸ å¤©æ°”å½±å“ï¼šç”±äºã€${currentWeather}ã€‘å¤©æ°”ï¼Œå¯»æ‰¾ç‰©èµ„å¤±è´¥ï¼Œæœªèƒ½æ‰¾åˆ°ä»»ä½•ç‰©èµ„ã€‚</p>
                            <p style="margin-bottom: 8px; color: #9fa8b8;">
                                <strong>æ•°å€¼å˜åŒ–ï¼š</strong>ç”Ÿå­˜çŠ¶æ€å€¼ ${survivalLoss}
                            </p>
                            <div style="text-align: right; font-size: 12px; opacity: 0.7; margin-top: 8px;">
                                ${new Date().toLocaleTimeString()}
                            </div>
                        `;
                        resultsDiv.prepend(resultCard);
                    }
                    return;
                }
                
                // éšæœºé€‰æ‹©ä¸€ä¸ªç‰©èµ„
                const [itemName, itemInfo] = availableItems[Math.floor(Math.random() * availableItems.length)];
                const name = itemName;
                const emoji = itemInfo.emoji;
                const itemType = itemInfo.tag;
                const materialLevel = itemInfo.level;
                const typeName = tagLabel(itemType);

                // è°ƒç”¨AIç”Ÿæˆæè¿°ï¼ˆåªç”Ÿæˆæè¿°ï¼Œä¸ç”Ÿæˆç‰©èµ„åç§°ï¼‰
                let description = 'ä½ åœ¨æ¢ç´¢ä¸­æ‰¾åˆ°äº†è¿™ä¸ªç‰©èµ„ã€‚';
                try {
                    const response = await fetchWithTimeout(LLM_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${LLM_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: LLM_MODEL_NAME,
                            messages: [
                                {
                                    role: "system",
                                    content: `ä½ æ˜¯ä¸€ä¸ªè’å²›æ±‚ç”Ÿæ¸¸æˆçš„å™äº‹è€…ã€‚
è¯·æ ¹æ®ç©å®¶åœ¨ã€${location.name}ã€‘æ¢ç´¢çš„åœºæ™¯ï¼Œç”Ÿæˆä¸€æ®µç®€çŸ­æè¿°ï¼ˆ1-2å¥è¯ï¼‰ï¼Œæè¿°ç©å®¶å¦‚ä½•æ‰¾åˆ°ã€${name}ã€‘è¿™ä¸ªç‰©èµ„ã€‚
è¦æ±‚ï¼šè¯­è¨€ç®€æ´æœ‰åŠ›ï¼Œæœ‰ä»£å…¥æ„Ÿï¼Œç¬¦åˆè’å²›æ±‚ç”Ÿçš„æ°›å›´ï¼Œè¦ä½“ç°ã€${location.name}ã€‘çš„ç¯å¢ƒç‰¹ç‚¹ã€‚
${isAffectedByWeather ? `é‡è¦ï¼šå½“å‰å¤©æ°”æ˜¯ã€${currentWeather}ã€‘ï¼Œè¯·åœ¨æè¿°ä¸­ä½“ç°å¤©æ°”å¯¹å¯»æ‰¾ç‰©èµ„çš„å½±å“ã€‚` : `æ³¨æ„ï¼šå½“å‰å¤©æ°”æ˜¯ã€${currentWeather}ã€‘ï¼Œè¯·åœ¨æè¿°ä¸­é€‚å½“æåŠå¤©æ°”æƒ…å†µã€‚`}
è¿”å›JSONæ ¼å¼ï¼š
{
  "description": "ç®€çŸ­æè¿°ç©å®¶å¦‚ä½•åœ¨${location.name}æ‰¾åˆ°è¿™ä¸ªç‰©èµ„ï¼ˆ1-2å¥è¯ï¼‰"
}`
                                },
                                {
                                    role: "user",
                                    content: `å½“å‰ç¬¬ ${currentDay} å¤©ï¼Œç©å®¶åœ¨ã€${location.name}ã€‘æ‰¾åˆ°äº†ã€${name}ã€‘(Lv${materialLevel}Â·${typeName})ã€‚å½“å‰å¤©æ°”ï¼š${currentWeather}ã€‚è¯·ç”Ÿæˆä¸€æ®µæè¿°ã€‚`
                                }
                            ],
                            temperature: 0.8,
                            max_tokens: 60,
                            response_format: { "type": "json_object" }
                        })
                    }, 30000);

                    if (response.ok) {
                        const data = await response.json();
                        const parsed = safeParseJSON(data.choices[0].message.content);
                        description = parsed.description || description;
                    }
                } catch (e) {
                    console.warn('ç”Ÿæˆæè¿°å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æè¿°:', e);
                }

                // åˆ›å»ºæ–°ç‰©èµ„
                const newWord = {
                    id: getNextWordId(),
                    text: name,
                    emoji: emoji,
                    tag: itemType,
                    level: materialLevel,
                    usesLeft: defaultUses(itemType)
                };

                // æ·»åŠ åˆ°èµ„æºåº“
                playerWords.push(newWord);
                
                // åŒå€æ”¶ç›Šï¼šé¢å¤–è·å¾—ä¸€ä¸ª
                if (isDoubleReward) {
                    const extraWord = {
                        id: getNextWordId(),
                        text: name,
                        emoji: emoji,
                        tag: itemType,
                        level: materialLevel,
                        usesLeft: defaultUses(itemType)
                    };
                    playerWords.push(extraWord);
                }
                
                renderWordInventory();

                // æ¶ˆè€—è¡ŒåŠ¨ç‚¹
                actionPoints -= 1;
                actionPointCounter += 1;
                // æ¯æ¶ˆè€—3è¡ŒåŠ¨ç‚¹æ¢ä¸€æ¬¡å¤©æ°”
                if (actionPointCounter >= 3) {
                    changeWeather();
                }
                
                // å¯»æ‰¾ç‰©èµ„ä¹Ÿä¼šæ¶ˆè€—ä½“åŠ›å’Œç”Ÿå­˜çŠ¶æ€å€¼ï¼ˆç±»ä¼¼æ‰“çŒ/é’“é±¼/ç ä¼ï¼‰
                // æ ¹æ®å¤©æ°”å½±å“è°ƒæ•´æ‰£å‡ï¼šå¦‚æœå—å¤©æ°”å½±å“ä¸”å¤±è´¥ï¼Œæ‰£å‡æ›´å¤šï¼›å¦‚æœæˆåŠŸï¼Œæ‰£å‡è¾ƒå°‘
                let survivalLoss = -4; // åŸºç¡€æ‰£å‡ï¼ˆåˆå¹¶healthå’Œhungerï¼‰
                if (isAffectedByWeather) {
                    if (!weatherSuccess) {
                        // å¤±è´¥æ—¶æ‰£å‡æ›´å¤šï¼ˆå› ä¸ºå¤©æ°”æ¶åŠ£ä¸”æ²¡æ‰¾åˆ°ç‰©èµ„ï¼‰
                        survivalLoss = -6;
                    } else if (isDoubleReward) {
                        // æˆåŠŸä¸”åŒå€æ”¶ç›Šæ—¶ï¼Œæ‰£å‡è¾ƒå°‘ï¼ˆå› ä¸ºæ‰¾åˆ°äº†æ›´å¤šç‰©èµ„ï¼Œå¿ƒæƒ…å¥½ï¼‰
                        survivalLoss = -2;
                    }
                }
                applyStatChanges({ health: Math.floor(survivalLoss / 2), hunger: Math.ceil(survivalLoss / 2) });
                
                // æ£€æŸ¥æ˜¯å¦æ­»äº¡
                if (isDead()) {
                    showGameOverScreen("åœ¨å¯»æ‰¾ç‰©èµ„çš„è¿‡ç¨‹ä¸­ï¼Œä½ çš„çŠ¶æ€å·²ç»è·Œè‡³æé™ï¼Œå†ä¹Ÿæ’‘ä¸ä¸‹å»äº†ã€‚");
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    }
                    return;
                }
                
                updateDayAndActionUI();

                // æ˜¾ç¤ºç»“æœ
                const resultsDiv = document.getElementById('fusion-results');
                if (resultsDiv) {
                    const resultCard = document.createElement('div');
                    resultCard.className = 'result-card';
                    resultCard.style.borderLeftColor = '#4cc9f0';
                    
                    // ç”Ÿæˆå”¯ä¸€çš„å›¾ç‰‡å ä½ç¬¦ID
                    const imagePlaceholderId = `search-image-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    
                    resultCard.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 24px;">${location.emoji}</span>
                            <span style="font-size: 18px; font-weight: 500;">${location.name} - å¯»æ‰¾ç‰©èµ„</span>
                        </div>
                        <div id="${imagePlaceholderId}" style="margin-bottom: 12px; min-height: 200px; background: rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">
                            <!-- å›¾ç‰‡å°†åœ¨è¿™é‡ŒåŠ è½½ -->
                        </div>
                        <p style="margin-bottom: 8px;">
                            <strong>è·å¾—ç‰©èµ„ï¼š</strong>${emoji} ${name} (Lv${materialLevel}Â·${tagLabel(itemType)})${isDoubleReward ? ' x2ï¼ˆå¤©æ°”åŠ æˆï¼‰' : ''}
                        </p>
                        <p style="margin-bottom: 8px; color: #9fa8b8;">
                            <strong>æ•°å€¼å˜åŒ–ï¼š</strong>ç”Ÿå­˜çŠ¶æ€å€¼ ${survivalLoss}
                        </p>
                        <div style="margin-top: 8px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 5px;">
                            <p style="line-height: 1.6;"><strong>è¡ŒåŠ¨è¿‡ç¨‹ï¼š</strong>${description}</p>
                        </div>
                        <div style="text-align: right; font-size: 12px; opacity: 0.7; margin-top: 8px;">
                            ${new Date().toLocaleTimeString()}
                        </div>
                    `;
                    resultsDiv.prepend(resultCard);
                    resultsDiv.scrollTop = 0;
                    
                    // å¼‚æ­¥ç”Ÿæˆå¹¶æ˜¾ç¤ºå›¾ç‰‡ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
                    generateAndDisplayImageForSearch(
                        location.name,
                        location.emoji,
                        currentWeather,
                        name,
                        emoji,
                        description,
                        imagePlaceholderId
                    ).catch(err => {
                        console.error('ç”Ÿæˆå¯»æ‰¾ç‰©èµ„å›¾ç‰‡å¤±è´¥:', err);
                    });
                }

            } catch (e) {
                console.error('å¯»æ‰¾åŸææ–™å¤±è´¥ï¼š', e);
                alert('å¯»æ‰¾åŸææ–™å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (btn) {
                    btn.disabled = false;
                    if (location && location.unlocked) {
                        btn.innerHTML = `${location.emoji} ${location.name} `;
                    } else {
                        btn.innerHTML = originalText;
                    }
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            }
        }
        
        // ============== æ¸¸æˆç»“æŸä¸æ€§æ ¼è¯„è¯­ ==============
        function calcFinalScore() {
            // ç®€å•è¯„åˆ†ï¼šå½“å‰ä¸¤é¡¹å¹³å‡å€¼ + åˆæˆæ¬¡æ•°å¥–åŠ±
            const avgStat = survival;
            const fusionScore = fusionResults.length * 5;
            return Math.round(avgStat + fusionScore);
        }

        async function generateEndingSummary(success) {
            const endingEl = document.getElementById('ending-summary') || document.getElementById('room-display');
            if (!endingEl) return;

            // æ‰¾åˆ°ç©å®¶æ‹¥æœ‰è¿‡çš„æœ€é«˜çº§é£Ÿç‰©ï¼ˆå½“å‰æ‹¥æœ‰çš„å’Œæ›¾ç»åˆæˆè¿‡çš„ï¼‰
            let highestFoodLevel = 0;
            let highestFoodName = 'åŸºç¡€é£Ÿç‰©';
            
            // å…ˆæ£€æŸ¥å½“å‰æ‹¥æœ‰çš„é£Ÿç‰©
            playerWords.forEach(w => {
                if (w.tag === 'food' && w.level && w.level > highestFoodLevel) {
                    highestFoodLevel = w.level;
                    highestFoodName = w.text;
                }
            });
            
            // å†æ£€æŸ¥æ›¾ç»åˆæˆè¿‡çš„é£Ÿç‰©ï¼ˆä»åˆæˆè®°å½•ä¸­æŸ¥æ‰¾ï¼‰
            fusionResults.forEach(r => {
                const itemInfo = MATERIAL_DATABASE[r.itemName];
                if (itemInfo && itemInfo.tag === 'food' && itemInfo.level && itemInfo.level > highestFoodLevel) {
                    highestFoodLevel = itemInfo.level;
                    highestFoodName = r.itemName;
                }
            });

            try {
                const response = await fetchWithTimeout(LLM_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${LLM_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: LLM_MODEL_NAME,
                        messages: [
                            {
                                role: "system",
                                content: `ä½ æ˜¯ä¸€ä¸ªè’å²›æ±‚ç”Ÿæ¸¸æˆçš„å™äº‹è€…ã€‚è¯·æ ¹æ®ç©å®¶çš„è’å²›æ±‚ç”Ÿç»å†ï¼Œç”Ÿæˆä¸€æ®µç”ŸåŠ¨çš„è¿‡ç¨‹æ€»ç»“ã€‚

è¦æ±‚ï¼š
1. æ ¹æ®ç©å®¶æ‹¥æœ‰è¿‡çš„æœ€é«˜çº§é£Ÿç‰©åç§°å’Œåº‡æŠ¤æ‰€åšå›ºå€¼ï¼Œæè¿°ç©å®¶åœ¨è’å²›ä¸Šçš„ç”Ÿå­˜è¿‡ç¨‹ï¼ˆ100-150å­—ï¼‰
2. æœ€åæè¿°ç©å®¶é€ƒå‡ºåçš„ç”Ÿæ´»ï¼Œè¦éšæœºä¸”å……æ»¡åˆ›æ„ï¼Œå±•ç°ä¸åŒçš„å¯èƒ½æ€§ï¼ˆ50-100å­—ï¼‰
3. è¯­è¨€ç”ŸåŠ¨æœ‰è¶£ï¼Œæœ‰ä»£å…¥æ„Ÿï¼Œä¸è¦è¿‡äºä¸¥è‚ƒ

è¿”å›JSONï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
    "summary": "å®Œæ•´çš„æ€»ç»“æ–‡æœ¬ï¼ŒåŒ…å«è¿‡ç¨‹æè¿°å’Œé€ƒå‡ºåçš„ç”Ÿæ´»æè¿°"
}`
                            },
                            {
                                role: "user",
                                content: `ç©å®¶æ‹¥æœ‰è¿‡çš„æœ€é«˜çº§é£Ÿç‰©ï¼š${highestFoodName} (Lv${highestFoodLevel})
åº‡æŠ¤æ‰€åšå›ºå€¼ï¼š${shelterDurability}
é€šå…³çŠ¶æ€ï¼š${success ? 'æˆåŠŸè·æ•‘' : 'æœªèƒ½åšæŒåˆ°æœ€å'}

è¯·ç”Ÿæˆä¸€æ®µå®Œæ•´çš„è¿‡ç¨‹æ€»ç»“ï¼ŒåŒ…å«è’å²›æ±‚ç”Ÿè¿‡ç¨‹å’Œé€ƒå‡ºåçš„ç”Ÿæ´»ã€‚`
                            }
                        ],
                        temperature: 0.9,
                        max_tokens: 400,
                        response_format: { "type": "json_object" }
                    })
                }, 30000);

                if (!response.ok) throw new Error(`ç”Ÿæˆæ€»ç»“å¤±è´¥: ${response.status}`);
                const data = await response.json();
                const parsed = JSON.parse(data.choices[0].message.content);

                if (endingEl.id === 'ending-summary') {
                    endingEl.innerHTML = `
                        <div style="padding:20px; background:rgba(232,229,224,0.8); border-radius:12px; text-align:left; border: 2px solid rgba(157,150,167,0.3);">
                            <p style="line-height: 1.8; color: #5a5753; font-size: 1.05em;">${replaceYouWithPlayerName(parsed.summary || (playerName ? `${playerName}åœ¨è’å²›ä¸Šåº¦è¿‡äº†è‰°éš¾çš„æ—¶å…‰ï¼Œæœ€ç»ˆæˆåŠŸè·æ•‘ã€‚è¿™æ®µç»å†æ”¹å˜äº†${playerName}ï¼Œè®©${playerName}æ›´åŠ çæƒœç”Ÿæ´»ã€‚` : 'ä½ åœ¨è’å²›ä¸Šåº¦è¿‡äº†è‰°éš¾çš„æ—¶å…‰ï¼Œæœ€ç»ˆæˆåŠŸè·æ•‘ã€‚è¿™æ®µç»å†æ”¹å˜äº†ä½ ï¼Œè®©ä½ æ›´åŠ çæƒœç”Ÿæ´»ã€‚'))}</p>
                        </div>
                    `;
                } else {
                    // å¤±è´¥æ—¶å¯èƒ½ç›´æ¥è¦†ç›–æˆ¿é—´å†…å®¹
                    const extra = document.createElement('div');
                    extra.innerHTML = `
                        <div style="margin-top:16px; padding:20px; background:rgba(232,229,224,0.8); border-radius:12px; text-align:left; border: 2px solid rgba(157,150,167,0.3);">
                            <p style="line-height: 1.8; color: #5a5753; font-size: 1.05em;">${replaceYouWithPlayerName(parsed.summary || (playerName ? `${playerName}åœ¨è’å²›ä¸Šåº¦è¿‡äº†è‰°éš¾çš„æ—¶å…‰ã€‚è¿™æ®µç»å†æ”¹å˜äº†${playerName}ã€‚` : 'ä½ åœ¨è’å²›ä¸Šåº¦è¿‡äº†è‰°éš¾çš„æ—¶å…‰ã€‚è¿™æ®µç»å†æ”¹å˜äº†ä½ ã€‚'))}</p>
                        </div>
                    `;
                    endingEl.appendChild(extra);
                }
            } catch (e) {
                console.error('ç”Ÿæˆæ€»ç»“å¤±è´¥ï¼š', e);
                if (endingEl.id === 'ending-summary') {
                    const defaultSummary = playerName
                        ? `${playerName}åœ¨è’å²›ä¸Šå‡­å€Ÿæœ€é«˜çº§é£Ÿç‰©ã€${highestFoodName}ã€‘å’Œåšå›ºå€¼${shelterDurability}çš„åº‡æŠ¤æ‰€æˆåŠŸç”Ÿå­˜ä¸‹æ¥ï¼Œæœ€ç»ˆè·æ•‘ã€‚è¿™æ®µç»å†è®©${playerName}æ›´åŠ çæƒœå¹³å‡¡çš„ç”Ÿæ´»ã€‚`
                        : `ä½ åœ¨è’å²›ä¸Šå‡­å€Ÿæœ€é«˜çº§é£Ÿç‰©ã€${highestFoodName}ã€‘å’Œåšå›ºå€¼${shelterDurability}çš„åº‡æŠ¤æ‰€æˆåŠŸç”Ÿå­˜ä¸‹æ¥ï¼Œæœ€ç»ˆè·æ•‘ã€‚è¿™æ®µç»å†è®©ä½ æ›´åŠ çæƒœå¹³å‡¡çš„ç”Ÿæ´»ã€‚`;
                    endingEl.innerHTML = `<p style="line-height: 1.8; color: #5a5753;">${defaultSummary}</p>`;
                }
            }
        }

        function showGameOverScreen(reasonText) {
            const roomDisplay = document.getElementById('room-display');
            if (!roomDisplay) return;

            roomDisplay.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 80px; margin-bottom: 20px;">ğŸ’€</div>
                    <h2 style="color: #f87171;">è’å²›æ±‚ç”Ÿå¤±è´¥</h2>
                    <p style="margin-top:10px;">${reasonText}</p>
                    <div id="ending-summary" style="margin-top:20px;"></div>
                    <div style="margin: 30px 0;">
                        <button onclick="location.reload()" style="
                            background: linear-gradient(45deg, #ef4444, #b91c1c);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 25px;
                            font-size: 18px;
                            cursor: pointer;
                            margin: 10px;
                        ">é‡æ–°å¼€å§‹</button>
                    </div>
                </div>
            `;

            // ç”Ÿæˆå¤±è´¥ç»“å±€çš„æ€§æ ¼è¯„è¯­
            generateEndingSummary(false);
        }
        
        // ============== æ¯æ—¥ç»“ç®—ä¸å›ºå®šå¤§äº‹ä»¶ ==============
        function logDayEventToResults(title, description) {
            const resultsDiv = document.getElementById('fusion-results');
            if (!resultsDiv) return;
            const card = document.createElement('div');
            card.className = 'result-card';
            card.innerHTML = `
                <h4 style="margin:0 0 6px 0; color:#fbbf24;">${title}</h4>
                <p style="margin:0 0 4px 0; font-size:0.95em;">${description}</p>
                <div style="text-align:right; font-size:12px; opacity:0.7;">ç¬¬ ${currentDay} å¤©</div>
            `;
            resultsDiv.prepend(card);
        }

        function countItemsByTag(tag, minLevel = 1) {
            return playerWords.filter(w => w.tag === tag && (w.level || 1) >= minLevel).length;
        }

        async function resolveMajorEventForDay(day) {
            if (isDead()) return;
            
            // æŸ¥æ‰¾å¯¹åº”å¤©æ•°çš„æŒ‘æˆ˜
            const challenge = challenges.find(c => c.day === day);
            if (!challenge) {
                // æ™®é€šæ—¥å­ï¼šè½»å¾®æ¶ˆè€—æè¿°
                logDayEventToResults("å¹³é™çš„ä¸€å¤©",
                    "è¿™ä¸€å¤©æ²¡æœ‰å‘ç”Ÿä»€ä¹ˆå¤§äº‹ï¼Œä½ åªæ˜¯åå¤æ£€æŸ¥è¥åœ°ã€æ‘†å¼„æ‰‹ä¸­çš„å·¥å…·ï¼Œè¯•å›¾è®©è‡ªå·±çœ‹èµ·æ¥æ²¡é‚£ä¹ˆæ— åŠ©ã€‚");
                return;
            }
            
            // å¦‚æœæŒ‘æˆ˜å·²ç»å®Œæˆï¼ˆåœ¨å®Œæˆæ—¶å·²ç»“ç®—ï¼‰ï¼Œåˆ™ä¸å†å¤„ç†
            if (challenge.solved) {
                return;
            }
            
            // å¦‚æœæŒ‘æˆ˜æœªå®Œæˆï¼Œåœ¨æ¯æ—¥ç»“ç®—æ—¶åˆ¤å®šä¸ºå¤±è´¥
            const progressInfo = checkChallengeProgress(challenge);
            const success = progressInfo.completed;
            
            // å¦‚æœæŒ‘æˆ˜æœªå®Œæˆï¼ŒæŒ‰å¤±è´¥å¤„ç†
            if (!success) {
                await resolveChallengeImmediately(challenge, false);
            }
        }

        // å¸¦IDçš„äº‹ä»¶è®°å½•å‡½æ•°
        function logDayEventToResultsWithId(title, description, cardId) {
            const resultsDiv = document.getElementById('fusion-results');
            if (!resultsDiv) return;
            const card = document.createElement('div');
            card.id = cardId;
            card.className = 'result-card';
            card.innerHTML = `
                <h4 style="margin:0 0 6px 0; color:#5a5753;">${title}</h4>
                <p id="${cardId}-desc" style="margin:0 0 4px 0; font-size:0.95em;">${description}</p>
                <div style="text-align:right; font-size:12px; opacity:0.7;">ç¬¬ ${currentDay} å¤©</div>
            `;
            resultsDiv.prepend(card);
        }

        // æ›´æ–°äº‹ä»¶æè¿°
        function updateEventDescription(cardId, newDescription) {
            const descEl = document.getElementById(cardId + '-desc');
            if (descEl) {
                descEl.textContent = newDescription;
            }
        }

        // ç”ŸæˆæŒ‘æˆ˜æè¿°
        async function generateChallengeDescription(challengeTitle, success, allItems, statChanges) {
            try {
                const itemList = allItems.map(w => w.text).join('ã€');
                const response = await fetchWithTimeout(LLM_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${LLM_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: LLM_MODEL_NAME,
                        messages: [
                            {
                                role: "system",
                                content: `ä½ æ˜¯ä¸€ä¸ªè’å²›æ±‚ç”Ÿæ¸¸æˆçš„å™äº‹è€…ã€‚è¯·æ ¹æ®æŒ‘æˆ˜ç»“æœå’Œç©å®¶çš„å‡†å¤‡æƒ…å†µï¼Œç”Ÿæˆä¸€æ®µ60-100å­—çš„ç”ŸåŠ¨æè¿°ï¼Œæè¿°ç©å®¶å¦‚ä½•åº”å¯¹è¿™ä¸ªæŒ‘æˆ˜ï¼Œä»¥åŠç»“æœå¦‚ä½•ã€‚è¦æ±‚ï¼šè¯­è¨€ç®€æ´æœ‰åŠ›ï¼Œæœ‰ä»£å…¥æ„Ÿï¼Œç¬¦åˆè’å²›æ±‚ç”Ÿçš„ç´§å¼ æ°›å›´ã€‚`
                            },
                            {
                                role: "user",
                                content: `æŒ‘æˆ˜åç§°ï¼š${challengeTitle}
æŒ‘æˆ˜ç»“æœï¼š${success ? 'æˆåŠŸåº”å¯¹' : 'åº”å¯¹å¤±è´¥'}
ç©å®¶å½“å‰æ‹¥æœ‰çš„ç‰©èµ„ï¼š${itemList || 'å‡ ä¹æ²¡æœ‰ç‰©èµ„'}
æ•°å€¼å˜åŒ–ï¼š${JSON.stringify(statChanges)}
è¯·ç”Ÿæˆä¸€æ®µç”ŸåŠ¨çš„æŒ‘æˆ˜åº”å¯¹æè¿°ã€‚`
                            }
                        ],
                        temperature: 0.8,
                        max_tokens: 200
                    })
                }, 30000);
                
                if (!response.ok) throw new Error(`AIæè¿°ç”Ÿæˆå¤±è´¥: ${response.status}`);
                const data = await response.json();
                return data.choices[0].message.content.trim();
            } catch (error) {
                console.error('ç”ŸæˆæŒ‘æˆ˜æè¿°å¤±è´¥:', error);
                return null;
            }
        }

        function endDay() {
            if (isDead()) return;
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const endDayBtn = document.querySelector('button[onclick="endDay()"]');
            const originalText = endDayBtn ? endDayBtn.innerHTML : '';
            if (endDayBtn) {
                endDayBtn.disabled = true;
                endDayBtn.innerHTML = 'â³ ç»“ç®—ä¸­...';
                endDayBtn.style.opacity = '0.6';
                endDayBtn.style.cursor = 'not-allowed';
            }
            
            // æ¯å¤©ç»“æŸæ—¶çš„åŸºç¡€æ¶ˆè€—
            // æ ¹æ®åº‡æŠ¤æ‰€çŠ¶æ€å†³å®šæ‰£å‡ï¼šç³»ç»Ÿè§„å®šçš„å›ºå®šæ•°å€¼ï¼Œæœ‰åˆç†æ¢¯åº¦
            // åº‡æŠ¤æ‰€åšå›ºå€¼è¶Šé«˜ï¼Œæ‰£å‡è¶Šå°‘
            const shelter = shelterDurability || 0;
            
            // æ ¹æ®åº‡æŠ¤æ‰€åšå›ºå€¼è®¡ç®—æ‰£å‡ï¼ˆ0-100èŒƒå›´ï¼‰
            let survivalLoss;
            if (shelter >= 80) {
                // åº‡æŠ¤æ‰€å¾ˆå¥½ï¼šæ‰£å‡å¾ˆå°‘ï¼Œåˆå¹¶åä¸º-6
                survivalLoss = 6;
            } else if (shelter >= 60) {
                // åº‡æŠ¤æ‰€è¾ƒå¥½ï¼šæ‰£å‡è¾ƒå°‘ï¼Œåˆå¹¶åä¸º-10
                survivalLoss = 10;
            } else if (shelter >= 40) {
                // åº‡æŠ¤æ‰€ä¸€èˆ¬ï¼šæ‰£å‡ä¸­ç­‰ï¼Œåˆå¹¶åä¸º-14
                survivalLoss = 14;
            } else if (shelter >= 20) {
                // åº‡æŠ¤æ‰€è¾ƒå·®ï¼šæ‰£å‡è¾ƒå¤šï¼Œåˆå¹¶åä¸º-18
                survivalLoss = 18;
            } else {
                // åº‡æŠ¤æ‰€å¾ˆå·®ï¼šæ‰£å‡å¾ˆå¤šï¼Œåˆå¹¶åä¸º-26
                survivalLoss = 26;
            }
            
            // ä½¿ç”¨healthå’Œhungerå­—æ®µä»¥ä¾¿applyStatChangesæ­£ç¡®å¤„ç†
            applyStatChanges({ health: -Math.floor(survivalLoss / 2), hunger: -Math.ceil(survivalLoss / 2) });
            logDayEventToResults("æ—¥ç»ˆæ¶ˆè€—",
                `åº‡æŠ¤æ‰€åšå›ºå€¼ ${Math.round(shelterDurability)}ï¼Œæ‰£é™¤ ç”Ÿå­˜çŠ¶æ€å€¼ ${survivalLoss}`);
            if (isDead()) {
                showGameOverScreen("åœ¨æ—¥å¤ä¸€æ—¥çš„æ¶ˆè€—ä¸­ï¼Œä½ çš„èº«ä½“ç»ˆäºæ”¯æ’‘ä¸ä½ã€‚");
                return;
            }

            // è§¦å‘å½“å¤©å›ºå®šå¤§äº‹ä»¶ï¼ˆå¼‚æ­¥ï¼‰
            resolveMajorEventForDay(currentDay).then(() => {
                if (isDead()) return;
                if (currentDay >= MAX_DAY) {
                    // ç¬¬7å¤©äº‹ä»¶å·²å¤„ç†å®Œï¼Œæ— è®ºæˆè´¥æ¸¸æˆéƒ½ç»“æŸ
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    if (endDayBtn) {
                        endDayBtn.disabled = false;
                        endDayBtn.innerHTML = originalText;
                        endDayBtn.style.opacity = '1';
                        endDayBtn.style.cursor = 'pointer';
                    }
                    return;
                }

                // è¿›å…¥ä¸‹ä¸€å¤©
                currentDay += 1;
                actionPoints = 7; // æ¯å¤©å¼€å§‹æ—¶é‡ç½®ä¸º7ç‚¹
                fusionLeft += 3; // æ¯å¤©å¼€å§‹æ—¶ç»™3æ¬¡åˆæˆæœºä¼š
                updateFusionLeftDisplay();
                updateDayAndActionUI();
                updateChallengeDisplay();
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (endDayBtn) {
                    endDayBtn.disabled = false;
                    endDayBtn.innerHTML = originalText;
                    endDayBtn.style.opacity = '1';
                    endDayBtn.style.cursor = 'pointer';
                }
            }).catch((error) => {
                console.error('ç»“ç®—å¤±è´¥:', error);
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (endDayBtn) {
                    endDayBtn.disabled = false;
                    endDayBtn.innerHTML = originalText;
                    endDayBtn.style.opacity = '1';
                    endDayBtn.style.cursor = 'pointer';
                }
            });
        }
        
        // ============== æ·»åŠ ä¸€äº›äº’åŠ¨æ•ˆæœ ==============
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('word-item')) {
                // ç‚¹å‡»è¯è¯­æ—¶çš„åŠ¨ç”»
                e.target.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    e.target.style.transform = '';
                }, 150);
            }
        });

    </script>
</body>
</html>
