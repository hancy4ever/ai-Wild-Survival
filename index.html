<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è’å²›æ±‚ç”Ÿå¤§æŒ‘æˆ˜ - ç‰©èµ„ç‚¼é‡‘æœ¯</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .word-item.usable {
            box-shadow: 0 0 0 2px rgba(114, 9, 183, 0.3);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #4cc9f0;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 2.0fr 1.8fr 1.4fr; 
            gap: 20px;
            height: auto;
        }
        
        /* å·¦ä¾§ï¼šèµ„æºä¸çŠ¶æ€ */
        .left-pane {
            display: flex;
            flex-direction: row;
            gap: 16px;
            height: 100%;
        }
        .status-column {
            flex: 0 0 220px;
        }
        .left-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .inventory {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            max-height: 55vh;
            overflow-y: auto;
        }
        /* èµ„æºåº“ä¸€æ’ä¸¤ä¸ªç‰©èµ„ */
        #word-inventory {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }
        
        .word-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 10px;
            cursor: grab;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .word-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .word-emoji {
            font-size: 24px;
        }
        
        /* ä¸­é—´ï¼šæ¸¸æˆåŒºåŸŸ */
        .game-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .room-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            flex-grow: 1;
            border: 2px solid #4cc9f0;
        }
        
        .fusion-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            min-height: 200px;
            border: 2px dashed #4361ee;
        }
        
        .slot {
            display: block;
            width: 100%;
            min-height: 52px;
            margin: 6px 0;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 2px dashed #f72585;
            font-size: 16px;
            color: #ccc;
            text-align: left;
            line-height: 1.4;
        }
        
        .fusion-btn {
            background: linear-gradient(45deg, #f72585, #4361ee);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .fusion-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(247, 37, 133, 0.5);
        }
        
        /* å³ä¾§ï¼šç»“æœå±•ç¤º */
        .results {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: calc(100vh - 40px);
        }
        
        #fusion-results {
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            max-height: calc(100vh - 120px);
            padding-right: 10px;
            /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
            scrollbar-width: thin;
            scrollbar-color: rgba(76, 201, 240, 0.5) rgba(255, 255, 255, 0.1);
        }
        
        #fusion-results::-webkit-scrollbar {
            width: 8px;
        }
        
        #fusion-results::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        #fusion-results::-webkit-scrollbar-thumb {
            background: rgba(76, 201, 240, 0.5);
            border-radius: 10px;
        }
        
        #fusion-results::-webkit-scrollbar-thumb:hover {
            background: rgba(76, 201, 240, 0.7);
        }
        
        .result-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 5px solid #4cc9f0;
        }
        
        .word-image {
            width: 100%;
            border-radius: 10px;
            margin: 10px 0;
        }
        /* ç®€å•çš„çŠ¶æ€æ¡æ ·å¼ */
        .status-bar-bg {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 999px;
            overflow: hidden;
            margin-top: 4px;
        }
        .status-bar-fill {
            height: 100%;
            width: 50%;
            background: linear-gradient(90deg,#22c55e,#16a34a);
            border-radius: 999px;
            transition: width 0.3s ease;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
                height: auto;
            }
            .left-pane {
                flex-direction: column;
            }
            .inventory {
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; margin-bottom: 20px; color: #4cc9f0;">ğŸï¸ è’å²›æ±‚ç”Ÿå¤§æŒ‘æˆ˜ Â· ç‰©èµ„ç‚¼é‡‘æœ¯ ğŸï¸</h1>
    
    <div class="container">
        <!-- å·¦ä¾§ï¼šç”Ÿå­˜çŠ¶æ€ + èµ„æºåº“å­˜ -->
        <div class="left-pane">
            <!-- ç”Ÿå­˜çŠ¶æ€æ”¾åœ¨èµ„æºåº“å·¦è¾¹ -->
            <div class="status-column">
                <div class="fusion-area">
                    <h3>ğŸï¸ çŠ¶æ€</h3>
                    <div id="status-panel">
                        <p>ç”Ÿå­˜çŠ¶æ€å€¼ï¼š<span id="survival-value"></span></p>
                        <div class="status-bar-bg">
                            <div id="survival-bar" class="status-bar-fill"></div>
                        </div>
                        <p style="margin-top:8px;">åº‡æŠ¤æ‰€åšå›ºå€¼ï¼š<span id="shelter-durability-value"></span></p>
                        <div class="status-bar-bg">
                            <div id="shelter-durability-bar" class="status-bar-fill"></div>
                        </div>
                    </div>
                </div>
                <div class="fusion-area" style="margin-top: 10px;">
                    <h3>ğŸ” å¯»æ‰¾ç‰©èµ„</h3>
                    <p style="font-size: 0.9em; color: #9ca3af; margin: 4px 0 10px 0;">æ¶ˆè€—è¡ŒåŠ¨ç‚¹æ¢ç´¢åœ°ç‚¹ï¼Œå¯»æ‰¾ç‰©èµ„</p>
                    <div id="location-buttons-container" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- åœ°ç‚¹æŒ‰é’®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <!-- è§£é”ç•Œé¢ -->
                    <div id="unlock-location-modal" style="display: none; margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 2px dashed #fbbf24;">
                        <p style="font-size: 0.9em; margin-bottom: 8px; color: #fbbf24;" id="unlock-location-text"></p>
                        <div id="unlock-location-slot" class="slot" style="margin: 0 auto; width: 80%; cursor: pointer; min-height: 40px;">
                            æ‹–æ”¾ç‰©å“åˆ°æ­¤å¤„è§£é”
                        </div>
                        <div style="text-align: center; margin-top: 8px;">
                            <button class="fusion-btn" onclick="confirmUnlockLocation()" id="confirm-unlock-btn" style="display: none;">ç¡®è®¤è§£é”</button>
                            <button class="fusion-btn" onclick="cancelUnlockLocation()" style="background: rgba(239, 68, 68, 0.2); border-color: #ef4444; color: #fca5a5; margin-left: 8px;">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="left-main">
        <div class="inventory">
                    <h3>ğŸ’ æˆ‘çš„èµ„æºåº“</h3>
            <div id="word-inventory">
                        <!-- ç‰©èµ„ä¼šé€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
                <!-- åˆæˆåŒºåŸŸç§»åŠ¨åˆ°èµ„æºåº“ä¸‹æ–¹ -->
                <div class="fusion-area">
                    <h3>âš—ï¸ ç‰©èµ„åˆæˆ</h3>
                    <p>æ‹–æ‹½ä¸¤ä¸ªç‰©èµ„åˆ°ä¸‹é¢çš„æ§½ä½ï¼ˆæ¯è½®åˆæˆæ¬¡æ•°æœ‰é™ï¼‰ï¼š</p>
                    <p style="margin-top:4px;color:#fbbf24;">å‰©ä½™åˆæˆæ¬¡æ•°ï¼š<span id="fusion-left">0</span></p>
                    
                    <div style="margin: 16px 0;">
                        <div class="slot" id="slot1">æ‹–æ”¾ç‰©èµ„</div>
                        <div style="text-align:center; margin:6px 0; font-size:22px; color:#f72585;">ï¼‹</div>
                        <div class="slot" id="slot2">æ‹–æ”¾ç‰©èµ„</div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="fusion-btn" onclick="performFusion()">å¼€å§‹åˆæˆï¼( 1âš¡)</button>
                        <button class="fusion-btn" onclick="resetSlots()" style="margin-left: 10px; background: rgba(239, 68, 68, 0.2); border-color: #ef4444; color: #fca5a5;">æ¸…ç©º</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä¸­é—´ï¼šæ¸¸æˆåŒºåŸŸ -->
        <div class="game-area">
            <!-- å½“å‰æŒ‘æˆ˜ -->
        <div class="room-display" id="room-display">
                <h3>ğŸŒŠ å½“å‰ç”Ÿå­˜æŒ‘æˆ˜</h3>
            <p id="challenge-text">åŠ è½½ä¸­...</p>
            
                <!-- æŒ‘æˆ˜åœºæ™¯ç”Ÿå›¾ -->
                <div id="challenge-image" style="margin-top: 15px;"></div>
                
                <!-- è¡ŒåŠ¨æ§½ä½ï¼šæ‹–åŠ¨ç‰©èµ„é€‰æ‹©è¡ŒåŠ¨ -->
                <div style="margin-top: 20px; padding: 20px; 
                            border: 3px dashed #22c55e; 
                        border-radius: 15px; 
                        text-align: center;
                            background: rgba(34, 197, 94, 0.05);
                            min-height: 80px;">
                    <p style="color: #22c55e; margin-bottom: 12px; font-weight: 500;">
                        ( 1âš¡) è¡ŒåŠ¨æ§½ä½ï¼šæ‹–åŠ¨ç‰©èµ„åˆ°è¿™é‡Œé€‰æ‹©è¡ŒåŠ¨
                    </p>
                    <div id="action-slot" class="action-slot" style="
                        width: 100%;
                        min-height: 60px;
                        background: rgba(255, 255, 255, 0.05);
                        border-radius: 10px;
                        border: 2px dashed #22c55e;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #9ca3af;
                        font-size: 14px;
                        margin-bottom: 12px;
                    ">æ‹–æ”¾ç‰©èµ„åˆ°æ­¤å¤„</div>
                    <!-- è¡ŒåŠ¨é€‰æ‹©èœå•ï¼ˆæ‹–å…¥ç‰©èµ„åæ˜¾ç¤ºï¼‰ -->
                    <div id="action-menu" style="display: none;"></div>
                    <!-- æ¸…ç©ºè¡ŒåŠ¨æ§½ä½æŒ‰é’® -->
                    <div style="text-align: center; margin-top: 8px;">
                        <button onclick="resetActionSlot()" style="
                            background: rgba(239, 68, 68, 0.15);
                            border: 1px solid rgba(239, 68, 68, 0.7);
                            color: #fecaca;
                            padding: 4px 12px;
                            border-radius: 999px;
                            font-size: 12px;
                            cursor: pointer;
                        ">æ¸…ç©ºè¡ŒåŠ¨æ§½ä½</button>
                    </div>
            </div>
                <div style="margin-top: 16px; text-align: right;">
                    <button onclick="endDay()" style="
                        background: rgba(59,130,246,0.15);
                        border: 1px solid rgba(59,130,246,0.7);
                        color: #bfdbfe;
                        padding: 6px 14px;
                        border-radius: 999px;
                        font-size: 13px;
                        cursor: pointer;
                    ">ç»“æŸä»Šå¤© â–¶</button>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šç»“æœå±•ç¤º -->
        <div class="results">
            <!-- è¡ŒåŠ¨ç‚¹æ˜¾ç¤ºæ¿å— -->
                <div id="action-points-display" style="padding: 15px; background: rgba(244, 243, 237, 0.1); border-radius: 10px; border-left: 4px solid #ffd492;">
                    <p style="font-size: 1.1em; color: #f7f2ec; margin: 0;">
                        <span id="day-action-status"></span>
                    </p>
                </div>
            
            <h3 style="margin-top: 25px;">ğŸ“œ åˆæˆè®°å½•ä¸äº‹ä»¶</h3>
            <div id="fusion-results">
                <!-- åˆæˆç»“æœä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            </div>
        </div>
    </div>
    
    <script>
        // ============== æ ¸å¿ƒæ•°æ® ==============
        // é¢„ç½®çš„åŸºç¡€ç‰©èµ„ï¼ˆå¼€å±€ä»…æœ‰1ä¸ªLv1åŸææ–™"æœ¨æ£"ï¼‰
        const basicWords = [
            { id: 1, text: "æœ¨æ£", emoji: "ğŸŒ¿", tag: "material", level: 1, usesLeft: 2 }
        ];

        // ============== å®Œæ•´ç‰©èµ„åˆ—è¡¨ ==============
        // å®šä¹‰æ‰€æœ‰1-4çº§çš„ç‰©èµ„ï¼Œç”¨äºåˆæˆé…æ–¹åŒ¹é…
        const MATERIAL_DATABASE = {
            // ä¸€çº§ç‰©èµ„
            "æœ¨æ£": { emoji: "ğŸŒ¿", tag: "material", level: 1 },
            "çŸ³å¤´": { emoji: "ğŸª¨", tag: "material", level: 1 },
            "è—¤è”“": { emoji: "ğŸŒ¿", tag: "material", level: 1 },
            "å¹²è‰": { emoji: "ğŸŒ¾", tag: "material", level: 1 },
            "æ¤°å­": { emoji: "ğŸ¥¥", tag: "material", level: 1 },
            "è´å£³": { emoji: "ğŸš", tag: "material", level: 1 },
            "ç”Ÿé±¼": { emoji: "ğŸŸ", tag: "food", level: 1 },
            "é‡æœ": { emoji: "ğŸ", tag: "food", level: 1 },
            "æµ·è‰": { emoji: "ğŸŒ¿", tag: "food", level: 1 },
            "ç”Ÿè‚‰": { emoji: "ğŸ¥©", tag: "food", level: 1 },
            "é¸Ÿè›‹": { emoji: "ğŸ¥š", tag: "food", level: 1 },
            "ç®€æ˜“æœ¨æ–§": { emoji: "ğŸª“", tag: "tool", level: 1 },
            "ç®€æ˜“æœ¨çŸ›": { emoji: "ğŸ”±", tag: "tool", level: 1 },
            "ç®€æ˜“æœ¨å‰": { emoji: "ğŸ”±", tag: "tool", level: 1 },
            
            // äºŒçº§ç‰©èµ„
            "æœ¨æ¿": { emoji: "ğŸªµ", tag: "material", level: 2 },
            "ç²—ç»³": { emoji: "ğŸª¢", tag: "material", level: 2 },
            "çŸ³ç‰‡": { emoji: "ğŸª¨", tag: "material", level: 2 },
            "æœ¨ç‚­": { emoji: "âš«", tag: "material", level: 2 },
            "ç®€æ˜“çŸ³æ–§": { emoji: "ğŸª“", tag: "tool", level: 2 },
            "æœ¨çŸ›": { emoji: "ğŸ”±", tag: "tool", level: 2 },
            "ç¯ç«": { emoji: "ğŸ”¥", tag: "tool", level: 2 },
            "ç®€æ˜“é±¼å‰": { emoji: "ğŸ”±", tag: "tool", level: 2 },
            "çƒ¤é±¼": { emoji: "ğŸŸ", tag: "food", level: 2 },
            "æ¤°è‚‰": { emoji: "ğŸ¥¥", tag: "food", level: 2 },
            "é£å¹²æœå¹²": { emoji: "ğŸ", tag: "food", level: 2 },
            "çƒ¤é¸Ÿè›‹": { emoji: "ğŸ¥š", tag: "food", level: 2 },
            "å°å…½è‚‰": { emoji: "ğŸ–", tag: "food", level: 2 },
            
            // ä¸‰çº§ç‰©èµ„
            "åšéŸ§è—¤æ¡": { emoji: "ğŸŒ¿", tag: "material", level: 3 },
            "æ‰“ç£¨çŸ³ç‰‡": { emoji: "ğŸª¨", tag: "material", level: 3 },
            "æœ¨æ¡†æ¶": { emoji: "ğŸªµ", tag: "material", level: 3 },
            "çŸ³åˆ€": { emoji: "ğŸ”ª", tag: "tool", level: 3 },
            "é•¿çŸ›": { emoji: "ğŸ”±", tag: "tool", level: 3 },
            "ç«æŠŠ": { emoji: "ğŸ”¥", tag: "tool", level: 3 },
            "æ•é±¼ç½‘": { emoji: "ğŸ•¸ï¸", tag: "tool", level: 3 },
            "çƒ¤é±¼ä¸²": { emoji: "ğŸ¢", tag: "food", level: 3 },
            "æ¤°æ±": { emoji: "ğŸ¥¥", tag: "food", level: 3 },
            "ç†è‚‰": { emoji: "ğŸ¥©", tag: "food", level: 3 },
            "çƒ¤å…½è‚‰": { emoji: "ğŸ–", tag: "food", level: 3 },
            "å¤§å—é±¼è‚‰": { emoji: "ğŸŸ", tag: "food", level: 3 },
            "è‚‰å¹²": { emoji: "ğŸ¥“", tag: "food", level: 3 },
            
            // å››çº§ç‰©èµ„
            "ç²¾åˆ¶æœ¨æ": { emoji: "ğŸªµ", tag: "material", level: 4 },
            "çŸ³åˆ¶å·¥å…·": { emoji: "ğŸª¨", tag: "material", level: 4 },
            "å¤åˆå·¥å…·": { emoji: "ğŸ› ï¸", tag: "tool", level: 4 },
            "è¥å…»é¤": { emoji: "ğŸ±", tag: "food", level: 4 },
            "ä¿å­˜é£Ÿç‰©": { emoji: "ğŸ¥«", tag: "food", level: 4 },
            "ç²¾åˆ¶è‚‰æ’": { emoji: "ğŸ¥©", tag: "food", level: 4 },
            "æµ·é²œå¤§é¤": { emoji: "ğŸ¦", tag: "food", level: 4 },
            "å¤§å‹ä¿¡å·ç«": { emoji: "ğŸ”¥", tag: "tool", level: 4 },
            "æµ“çƒŸç«å †": { emoji: "ğŸ’¨", tag: "tool", level: 4 },
            "åå°„ä¿¡å·æ¿": { emoji: "ğŸª", tag: "material", level: 4 }
        };

        // ============== åˆæˆé…æ–¹è¡¨ ==============
        // æ ¼å¼ï¼šinputs: [ç‰©èµ„1åç§°, ç‰©èµ„2åç§°], result: ç»“æœç‰©èµ„åç§°
        // ç‰¹æ®Šé…æ–¹ï¼š
        // 1. ç¯ç«ï¼ˆå·¥å…·ï¼‰+ ç”Ÿé£Ÿï¼ˆé£Ÿç‰©ï¼‰= ç†Ÿé£Ÿï¼ˆé£Ÿç‰©ï¼‰
        // 2. é”‹åˆ©å·¥å…·ï¼ˆçŸ³åˆ€/é•¿çŸ›/ç®€æ˜“çŸ³æ–§/ç®€æ˜“é±¼å‰/æœ¨çŸ›ï¼‰+ æ¤°å­ï¼ˆåŸææ–™ï¼‰= æ¤°è‚‰ï¼ˆé£Ÿç‰©ï¼‰
        const FUSION_RECIPES = [
            // ä¸€çº§ -> äºŒçº§ï¼ˆåŸææ–™åˆæˆï¼‰
            { inputs: ["æœ¨æ£", "æœ¨æ£"], result: "æœ¨æ¿" },
            { inputs: ["è—¤è”“", "è—¤è”“"], result: "ç²—ç»³" },
            { inputs: ["çŸ³å¤´", "çŸ³å¤´"], result: "çŸ³ç‰‡" },
            { inputs: ["å¹²è‰", "æœ¨æ£"], result: "æœ¨ç‚­" },
            
            // ä¸€çº§ -> äºŒçº§ï¼ˆå·¥å…·åˆ¶ä½œï¼‰
            { inputs: ["æœ¨æ£", "çŸ³å¤´"], result: "ç®€æ˜“çŸ³æ–§" },
            { inputs: ["æœ¨æ£", "çŸ³ç‰‡"], result: "ç®€æ˜“çŸ³æ–§" },
            { inputs: ["æœ¨æ£", "è—¤è”“"], result: "æœ¨çŸ›" },
            { inputs: ["å¹²è‰", "æœ¨ç‚­"], result: "ç¯ç«" },
            { inputs: ["æœ¨æ£", "çŸ³ç‰‡"], result: "ç®€æ˜“é±¼å‰" },
            
            // ä¸€çº§ -> äºŒçº§ï¼ˆé£Ÿç‰©å¤„ç†ï¼‰
            { inputs: ["ç¯ç«", "ç”Ÿé±¼"], result: "çƒ¤é±¼" },
            { inputs: ["ç¯ç«", "é‡æœ"], result: "é£å¹²æœå¹²" },
            { inputs: ["ç¯ç«", "æµ·è‰"], result: "é£å¹²æœå¹²" },
            { inputs: ["çŸ³åˆ€", "æ¤°å­"], result: "æ¤°è‚‰" },
            { inputs: ["é•¿çŸ›", "æ¤°å­"], result: "æ¤°è‚‰" },
            { inputs: ["ç®€æ˜“çŸ³æ–§", "æ¤°å­"], result: "æ¤°è‚‰" },
            { inputs: ["ç®€æ˜“é±¼å‰", "æ¤°å­"], result: "æ¤°è‚‰" },
            { inputs: ["æœ¨çŸ›", "æ¤°å­"], result: "æ¤°è‚‰" },
            
            // äºŒçº§ -> ä¸‰çº§ï¼ˆåŸææ–™åˆæˆï¼‰
            { inputs: ["æœ¨æ¿", "ç²—ç»³"], result: "æœ¨æ¡†æ¶" },
            { inputs: ["ç²—ç»³", "ç²—ç»³"], result: "åšéŸ§è—¤æ¡" },
            { inputs: ["çŸ³ç‰‡", "çŸ³ç‰‡"], result: "æ‰“ç£¨çŸ³ç‰‡" },
            
            // äºŒçº§ -> ä¸‰çº§ï¼ˆå·¥å…·åˆ¶ä½œï¼‰
            { inputs: ["çŸ³ç‰‡", "ç²—ç»³"], result: "çŸ³åˆ€" },
            { inputs: ["æœ¨çŸ›", "çŸ³ç‰‡"], result: "é•¿çŸ›" },
            { inputs: ["æœ¨æ£", "æœ¨ç‚­"], result: "ç«æŠŠ" },
            { inputs: ["ç²—ç»³", "è—¤è”“"], result: "æ•é±¼ç½‘" },
            
            // äºŒçº§ -> ä¸‰çº§ï¼ˆé£Ÿç‰©å¤„ç†ï¼‰
            { inputs: ["ç¯ç«", "çƒ¤é±¼"], result: "çƒ¤é±¼ä¸²" },
            { inputs: ["æ¤°è‚‰", "æ¤°å­"], result: "æ¤°æ±" },
            { inputs: ["ç¯ç«", "ç”Ÿé±¼"], result: "ç†è‚‰" },
            
            // ä¸‰çº§ -> å››çº§ï¼ˆåŸææ–™åˆæˆï¼‰
            { inputs: ["æœ¨æ¡†æ¶", "åšéŸ§è—¤æ¡"], result: "ç²¾åˆ¶æœ¨æ" },
            { inputs: ["æ‰“ç£¨çŸ³ç‰‡", "çŸ³ç‰‡"], result: "çŸ³åˆ¶å·¥å…·" },
            
            // ä¸‰çº§ -> å››çº§ï¼ˆå·¥å…·åˆ¶ä½œï¼‰
            { inputs: ["çŸ³åˆ€", "é•¿çŸ›"], result: "å¤åˆå·¥å…·" },
            { inputs: ["æ‰“ç£¨çŸ³ç‰‡", "è´å£³"], result: "åå°„ä¿¡å·æ¿" },
            
            // ä¸‰çº§ -> å››çº§ï¼ˆé£Ÿç‰©å¤„ç†ï¼‰
            { inputs: ["çƒ¤é±¼ä¸²", "æ¤°æ±"], result: "è¥å…»é¤" },
            { inputs: ["ç†è‚‰", "æ¤°æ±"], result: "ä¿å­˜é£Ÿç‰©" },
            
            // ä¸‰çº§ -> å››çº§ï¼ˆæ±‚æ•‘ä¿¡å·åˆ¶ä½œï¼‰
            { inputs: ["ç«æŠŠ", "å¹²è‰"], result: "å¤§å‹ä¿¡å·ç«" },
            { inputs: ["ç«æŠŠ", "æœ¨ç‚­"], result: "æµ“çƒŸç«å †" },
            { inputs: ["åå°„ä¿¡å·æ¿", "ç²¾åˆ¶æœ¨æ"], result: "åå°„ä¿¡å·æ¿" },
            
            // å·¥å…·å‡çº§é…æ–¹ï¼šä¸¤ä¸ªç›¸åŒå·¥å…· -> æ›´é«˜çº§å·¥å…·
            // Lv2å·¥å…· -> Lv3å·¥å…·
            { inputs: ["ç®€æ˜“çŸ³æ–§", "ç®€æ˜“çŸ³æ–§"], result: "çŸ³åˆ€" },
            { inputs: ["æœ¨çŸ›", "æœ¨çŸ›"], result: "é•¿çŸ›" },
            { inputs: ["ç¯ç«", "ç¯ç«"], result: "ç«æŠŠ" },
            { inputs: ["ç®€æ˜“é±¼å‰", "ç®€æ˜“é±¼å‰"], result: "æ•é±¼ç½‘" },
            
            // Lv3å·¥å…· -> Lv4å·¥å…·
            { inputs: ["çŸ³åˆ€", "çŸ³åˆ€"], result: "å¤åˆå·¥å…·" },
            { inputs: ["é•¿çŸ›", "é•¿çŸ›"], result: "å¤åˆå·¥å…·" },
            { inputs: ["ç«æŠŠ", "ç«æŠŠ"], result: "å¤§å‹ä¿¡å·ç«" },
            { inputs: ["ç«æŠŠ", "ç¯ç«"], result: "æµ“çƒŸç«å †" },
            { inputs: ["æ•é±¼ç½‘", "æ•é±¼ç½‘"], result: "å¤åˆå·¥å…·" }
        ];

        // ============== è¡ŒåŠ¨é…æ–¹è¡¨ ==============
        // åˆ¶ä½œå·¥å…·é…æ–¹ï¼šåŸææ–™ -> å·¥å…·
        const CRAFT_TOOL_RECIPES = [
            // ä¸€çº§åŸææ–™ -> ä¸€çº§å·¥å…·
            { input: "æœ¨æ£", result: "ç®€æ˜“æœ¨æ–§", probability: 1.0, type: "tool" },
            { input: "çŸ³å¤´", result: "ç®€æ˜“æœ¨æ–§", probability: 1.0, type: "tool" },
            { input: "è—¤è”“", result: "ç®€æ˜“æœ¨çŸ›", probability: 1.0, type: "tool" },
            
            // äºŒçº§åŸææ–™ -> äºŒçº§å·¥å…·
            { input: "æœ¨æ¿", result: "ç®€æ˜“çŸ³æ–§", probability: 1.0, type: "tool" },
            { input: "ç²—ç»³", result: "ç®€æ˜“çŸ³æ–§", probability: 1.0, type: "tool" },
            { input: "çŸ³ç‰‡", result: "ç®€æ˜“çŸ³æ–§", probability: 1.0, type: "tool" },
            { input: "æœ¨ç‚­", result: "ç¯ç«", probability: 1.0, type: "tool" },
            
            // ä¸‰çº§åŸææ–™ -> ä¸‰çº§å·¥å…·
            { input: "åšéŸ§è—¤æ¡", result: "é•¿çŸ›", probability: 1.0, type: "tool" },
            { input: "æ‰“ç£¨çŸ³ç‰‡", result: "çŸ³åˆ€", probability: 1.0, type: "tool" },
            { input: "æœ¨æ¡†æ¶", result: "é•¿çŸ›", probability: 1.0, type: "tool" },
            
            // å››çº§åŸææ–™ -> å››çº§å·¥å…·
            { input: "ç²¾åˆ¶æœ¨æ", result: "å¤åˆå·¥å…·", probability: 0.9, type: "tool" },
            { input: "ç²¾åˆ¶æœ¨æ", result: "å¤§å‹ä¿¡å·ç«", probability: 0.1, type: "tool" },
            { input: "çŸ³åˆ¶å·¥å…·", result: "å¤åˆå·¥å…·", probability: 0.9, type: "tool" },
            { input: "çŸ³åˆ¶å·¥å…·", result: "æµ“çƒŸç«å †", probability: 0.1, type: "tool" }
        ];

        // æ•çŒ/é’“é±¼/ç ä¼å·¥å…·åˆ†ç±»
        // æ–§å­ç±»å·¥å…·ï¼ˆç”¨äºç ä¼äº§å‡ºæœ¨ææˆ–çŸ³å¤´ï¼‰
        const AXE_TOOLS = ["ç®€æ˜“æœ¨æ–§", "ç®€æ˜“çŸ³æ–§", "å¤åˆå·¥å…·"];
        
        // çŸ›/åˆ€ç±»å·¥å…·ï¼ˆç”¨äºæ‰“çŒäº§å‡ºå…½è‚‰ç±»é£Ÿç‰©ï¼‰
        const SPEAR_KNIFE_TOOLS = ["ç®€æ˜“æœ¨çŸ›", "æœ¨çŸ›", "é•¿çŸ›", "çŸ³åˆ€", "å¤åˆå·¥å…·"];
        
        // é±¼å‰/æ¸”ç½‘ç±»å·¥å…·ï¼ˆç”¨äºæ•é±¼äº§å‡ºé±¼ç±»é£Ÿç‰©ï¼‰
        const FISHING_TOOLS = ["ç®€æ˜“æœ¨å‰", "ç®€æ˜“é±¼å‰", "æ•é±¼ç½‘"];
        
        // æ ¹æ®å·¥å…·ç­‰çº§äº§å‡ºå¯¹åº”çš„æœ¨æç±»ç‰©èµ„
        const AXE_WOOD_OUTPUT = {
            1: "æœ¨æ£",    // Lv1æ–§å­ -> æœ¨æ£
            2: "æœ¨æ¿",    // Lv2æ–§å­ -> æœ¨æ¿
            3: "æœ¨æ¡†æ¶",  // Lv3æ–§å­ -> æœ¨æ¡†æ¶
            4: "ç²¾åˆ¶æœ¨æ" // Lv4æ–§å­ -> ç²¾åˆ¶æœ¨æ
        };
        
        // æ ¹æ®å·¥å…·ç­‰çº§äº§å‡ºå¯¹åº”çš„çŸ³å¤´ç±»ç‰©èµ„
        const AXE_STONE_OUTPUT = {
            1: "çŸ³å¤´",      // Lv1æ–§å­ -> çŸ³å¤´
            2: "çŸ³ç‰‡",      // Lv2æ–§å­ -> çŸ³ç‰‡
            3: "æ‰“ç£¨çŸ³ç‰‡",  // Lv3æ–§å­ -> æ‰“ç£¨çŸ³ç‰‡
            4: "çŸ³åˆ¶å·¥å…·"   // Lv4æ–§å­ -> çŸ³åˆ¶å·¥å…·
        };
        
        // æ ¹æ®å·¥å…·ç­‰çº§äº§å‡ºå¯¹åº”çš„å…½è‚‰ç±»é£Ÿç‰©ï¼ˆä¸€çº§å·¥å…·åªèƒ½äº§å‡ºä¸€çº§é£Ÿç‰©ï¼‰
        const MEAT_OUTPUT = {
            1: "ç”Ÿè‚‰",      // Lv1çŸ›/åˆ€ -> ç”Ÿè‚‰
            2: "å°å…½è‚‰",    // Lv2çŸ›/åˆ€ -> å°å…½è‚‰
            3: "çƒ¤å…½è‚‰",    // Lv3çŸ›/åˆ€ -> çƒ¤å…½è‚‰
            4: "ç²¾åˆ¶è‚‰æ’"   // Lv4çŸ›/åˆ€ -> ç²¾åˆ¶è‚‰æ’
        };
        
        // æ ¹æ®å·¥å…·ç­‰çº§äº§å‡ºå¯¹åº”çš„é±¼ç±»é£Ÿç‰©ï¼ˆä¸€çº§å·¥å…·åªèƒ½äº§å‡ºä¸€çº§é£Ÿç‰©ï¼‰
        const FISH_OUTPUT = {
            1: "ç”Ÿé±¼",      // Lv1é±¼å‰/ç½‘ -> ç”Ÿé±¼
            2: "ç”Ÿé±¼",      // Lv2é±¼å‰/ç½‘ -> ç”Ÿé±¼ï¼ˆäºŒçº§å·¥å…·ä¹Ÿèƒ½æ•åˆ°ä¸€çº§é±¼ï¼‰
            3: "å¤§å—é±¼è‚‰",  // Lv3é±¼å‰/ç½‘ -> å¤§å—é±¼è‚‰
            4: "æµ·é²œå¤§é¤"   // Lv4é±¼å‰/ç½‘ -> æµ·é²œå¤§é¤
        };
        
        // ä¸€çº§å·¥å…·åªèƒ½äº§å‡ºçš„ä¸€çº§åŸææ–™ï¼ˆç”¨äºæ–§å­ç±»å·¥å…·ï¼‰
        const LEVEL1_MATERIAL_OUTPUT = {
            wood: "æœ¨æ£",   // ä¸€çº§æ–§å­ -> æœ¨æ£
            stone: "çŸ³å¤´"   // ä¸€çº§æ–§å­ -> çŸ³å¤´
        };

        // è¾…åŠ©å‡½æ•°ï¼šæŸ¥æ‰¾åˆ¶ä½œå·¥å…·é…æ–¹
        function findCraftToolRecipe(material) {
            const materialLevel = material.level || 1;
            let recipes = CRAFT_TOOL_RECIPES.filter(r => r.input === material.text);
            
            // å¦‚æœæ˜¯ä¸€çº§åŸææ–™ï¼Œåªè¿”å›ä¸€çº§å·¥å…·çš„é…æ–¹
            if (materialLevel === 1) {
                recipes = recipes.filter(r => {
                    const resultInfo = MATERIAL_DATABASE[r.result];
                    return resultInfo && resultInfo.level === 1;
                });
            }
            
            if (recipes.length === 0) return null;
            
            // æ ¹æ®æ¦‚ç‡é€‰æ‹©ç»“æœ
            const toolRecipes = recipes.filter(r => r.type === 'tool');
            if (toolRecipes.length > 0) {
                // æ ¹æ®æ¦‚ç‡éšæœºé€‰æ‹©
                const rand = Math.random();
                let cumulative = 0;
                for (const recipe of toolRecipes) {
                    cumulative += recipe.probability;
                    if (rand < cumulative) {
                        return recipe;
                    }
                }
                // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œè¿”å›ç¬¬ä¸€ä¸ª
                return toolRecipes[0];
            }
            
            return null;
        }

        // è¾…åŠ©å‡½æ•°ï¼šæŸ¥æ‰¾æ•çŒ/é’“é±¼/ç ä¼é…æ–¹
        function findHuntFishRecipe(tool) {
            const toolLevel = tool.level || 1;
            
            // å¦‚æœæ˜¯æ–§å­ç±»å·¥å…·ï¼Œæ ¹æ®æ¦‚ç‡äº§å‡ºæœ¨ææˆ–çŸ³å¤´
            if (AXE_TOOLS.includes(tool.text)) {
                // ä¸€çº§å·¥å…·åªèƒ½äº§å‡ºä¸€çº§åŸææ–™
                if (toolLevel === 1) {
                    const rand = Math.random();
                    if (rand < 0.8) {
                        return {
                            input: tool.text,
                            result: LEVEL1_MATERIAL_OUTPUT.wood,
                            type: "material"
                        };
                    } else {
                        return {
                            input: tool.text,
                            result: LEVEL1_MATERIAL_OUTPUT.stone,
                            type: "material"
                        };
                    }
                }
                // äºŒçº§åŠä»¥ä¸Šå·¥å…·æŒ‰åŸé€»è¾‘
                const rand = Math.random();
                if (rand < 0.8) {
                    const woodOutput = AXE_WOOD_OUTPUT[toolLevel] || AXE_WOOD_OUTPUT[1];
                    return {
                        input: tool.text,
                        result: woodOutput,
                        type: "material"
                    };
                } else {
                    const stoneOutput = AXE_STONE_OUTPUT[toolLevel] || AXE_STONE_OUTPUT[1];
                    return {
                        input: tool.text,
                        result: stoneOutput,
                        type: "material"
                    };
                }
            }
            
            // å¦‚æœæ˜¯çŸ›/åˆ€ç±»å·¥å…·ï¼Œäº§å‡ºå…½è‚‰ç±»é£Ÿç‰©
            if (SPEAR_KNIFE_TOOLS.includes(tool.text)) {
                // ä¸€çº§å·¥å…·åªèƒ½äº§å‡ºä¸€çº§é£Ÿç‰©
                if (toolLevel === 1) {
                    return {
                        input: tool.text,
                        result: "ç”Ÿè‚‰",
                        type: "food"
                    };
                }
                const meatOutput = MEAT_OUTPUT[toolLevel] || MEAT_OUTPUT[1];
                return {
                    input: tool.text,
                    result: meatOutput,
                    type: "food"
                };
            }
            
            // å¦‚æœæ˜¯é±¼å‰/æ¸”ç½‘ç±»å·¥å…·ï¼Œäº§å‡ºé±¼ç±»é£Ÿç‰©
            if (FISHING_TOOLS.includes(tool.text)) {
                // ä¸€çº§å·¥å…·åªèƒ½äº§å‡ºä¸€çº§é£Ÿç‰©
                if (toolLevel === 1) {
                    return {
                        input: tool.text,
                        result: "ç”Ÿé±¼",
                        type: "food"
                    };
                }
                const fishOutput = FISH_OUTPUT[toolLevel] || FISH_OUTPUT[1];
                return {
                    input: tool.text,
                    result: fishOutput,
                    type: "food"
                };
            }
            
            // å…¶ä»–å·¥å…·ï¼ˆå¦‚ç«æŠŠã€ç¯ç«ç­‰ï¼‰é»˜è®¤äº§å‡ºç”Ÿé±¼ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
            return {
                input: tool.text,
                result: "ç”Ÿé±¼",
                type: "food"
            };
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥ä¸¤ä¸ªç‰©èµ„æ˜¯å¦å¯ä»¥åˆæˆ
        function findRecipe(word1, word2) {
            const name1 = word1.text;
            const name2 = word2.text;
            
            // å°è¯•ä¸¤ç§é¡ºåºåŒ¹é…
            for (const recipe of FUSION_RECIPES) {
                if ((recipe.inputs[0] === name1 && recipe.inputs[1] === name2) ||
                    (recipe.inputs[0] === name2 && recipe.inputs[1] === name1)) {
                    return recipe;
                }
            }
            
            // ç‰¹æ®Šé…æ–¹1ï¼šç¯ç« + ä»»ä½•ä¸€çº§ç”Ÿé£Ÿ = å¯¹åº”ç†Ÿé£Ÿ
            const campfire = name1 === "ç¯ç«" ? word1 : (name2 === "ç¯ç«" ? word2 : null);
            const rawFood = campfire ? (name1 === "ç¯ç«" ? word2 : word1) : null;
            
            if (campfire && rawFood && rawFood.tag === "food" && rawFood.level === 1) {
                // æ ¹æ®ç”Ÿé£Ÿç±»å‹è¿”å›å¯¹åº”çš„ç†Ÿé£Ÿ
                if (rawFood.text === "ç”Ÿé±¼") {
                    return { inputs: [name1, name2], result: "çƒ¤é±¼" };
                } else if (rawFood.text === "é‡æœ" || rawFood.text === "æµ·è‰") {
                    return { inputs: [name1, name2], result: "é£å¹²æœå¹²" };
                } else {
                    // å…¶ä»–ä¸€çº§ç”Ÿé£Ÿé»˜è®¤å˜æˆé£å¹²æœå¹²
                    return { inputs: [name1, name2], result: "é£å¹²æœå¹²" };
                }
            }
            
            // ç‰¹æ®Šé…æ–¹2ï¼šé”‹åˆ©å·¥å…· + æ¤°å­ = æ¤°è‚‰ï¼ˆåŒ…å«ä¸€çº§ã€äºŒçº§ã€ä¸‰çº§ä¸­â€œå¸¦åˆƒ/å°–ç«¯â€çš„å·¥å…·ï¼‰
            const sharpTools = [
                "ç®€æ˜“æœ¨æ–§", "ç®€æ˜“æœ¨çŸ›", "ç®€æ˜“æœ¨å‰", // Lv1 å·¥å…·
                "ç®€æ˜“çŸ³æ–§", "ç®€æ˜“é±¼å‰", "æœ¨çŸ›",     // Lv2 å·¥å…·
                "çŸ³åˆ€", "é•¿çŸ›"                      // Lv3 å·¥å…·
            ];
            const isSharpTool = sharpTools.includes(name1) || sharpTools.includes(name2);
            const coconut = name1 === "æ¤°å­" ? word1 : (name2 === "æ¤°å­" ? word2 : null);
            const tool = coconut ? (name1 === "æ¤°å­" ? word2 : word1) : null;
            
            if (isSharpTool && coconut && coconut.text === "æ¤°å­" && coconut.tag === "material" && coconut.level === 1) {
                return { inputs: [name1, name2], result: "æ¤°è‚‰" };
            }
            
            // ç‰¹æ®Šé…æ–¹3ï¼šåŒçº§é£Ÿç‰©ï¼ˆLv2åŠä»¥ä¸Šï¼‰å¯ä»¥åˆæˆé«˜ä¸€çº§é£Ÿç‰©
            if (word1.tag === "food" && word2.tag === "food" && 
                word1.level === word2.level && word1.level >= 2 && word1.level <= 3) {
                const currentLevel = word1.level;
                const nextLevel = currentLevel + 1;
                
                // ä»MATERIAL_DATABASEä¸­ç­›é€‰å‡ºå¯¹åº”ç­‰çº§çš„æ‰€æœ‰é£Ÿç‰©
                const availableFoods = Object.entries(MATERIAL_DATABASE)
                    .filter(([name, info]) => info.tag === "food" && info.level === nextLevel);
                
                if (availableFoods.length > 0) {
                    // éšæœºé€‰æ‹©ä¸€ä¸ªé«˜ä¸€çº§çš„é£Ÿç‰©
                    const [foodName, foodInfo] = availableFoods[Math.floor(Math.random() * availableFoods.length)];
                    return { inputs: [name1, name2], result: foodName };
                }
            }
            
            // ç‰¹æ®Šé…æ–¹4ï¼šåŒçº§å·¥å…·ï¼ˆLv1åŠä»¥ä¸Šï¼‰å¯ä»¥åˆæˆé«˜ä¸€çº§å·¥å…·
            if (word1.tag === "tool" && word2.tag === "tool" && 
                word1.level === word2.level && word1.level >= 1 && word1.level <= 3) {
                const currentLevel = word1.level;
                const nextLevel = currentLevel + 1;
                
                // ä»MATERIAL_DATABASEä¸­ç­›é€‰å‡ºå¯¹åº”ç­‰çº§çš„æ‰€æœ‰å·¥å…·
                const availableTools = Object.entries(MATERIAL_DATABASE)
                    .filter(([name, info]) => info.tag === "tool" && info.level === nextLevel);
                
                if (availableTools.length > 0) {
                    // éšæœºé€‰æ‹©ä¸€ä¸ªé«˜ä¸€çº§çš„å·¥å…·
                    const [toolName, toolInfo] = availableTools[Math.floor(Math.random() * availableTools.length)];
                    return { inputs: [name1, name2], result: toolName };
                }
            }
            
            return null;
        }
        // ============== æ¸¸æˆè¿›åº¦ç³»ç»Ÿ ==============
        // è’å²›æŒ‘æˆ˜æ•°æ®ï¼ˆæ”¹ä¸ºé¢„ç½®å™äº‹ï¼Œä¸å†ä¾èµ–AIç”Ÿæˆï¼‰
        const challenges = [
            {
                id: 1,
                day: 1,
                title: "æŒ‘æˆ˜ä¸€ï¼šæ¼‚æµåçš„é¥¥æ¸´",
                description: "ä½ è¢«æµ·æµªæ¨ä¸Šå²¸ï¼Œèº«ä¸Šè¿˜æ®‹ç•™ç€æµ·æ°´ã€‚å¤ªé˜³ç‚™çƒ¤ï¼Œå˜´å”‡å¼€è£‚ï¼Œé™„è¿‘åªå‰©ç¢æœ¨å’Œå‡ åªåŠè…åçš„æ¤°å­èŸ¹ã€‚æ—¥è½å‰å¿…é¡»å¼„åˆ°å¯å…¥å£çš„ä¸œè¥¿ï¼Œå¦åˆ™èº«ä½“ä¼šè¿…é€Ÿå®æ‰ã€‚",
                solutionHint: "ä¼˜å…ˆè·å–æ°´å’Œé£Ÿç‰©ï¼Œç®€å•å¤„ç†åå†å…¥å£ï¼Œåˆ«è®©èº«ä½“é€æ”¯ã€‚",
                victoryCondition: { type: 'hasItem', tag: 'food', level: 1, count: 1 },
                solved: false
            },
            {
                id: 2, 
                day: 3,
                title: "æŒ‘æˆ˜äºŒï¼šæš´é£é›¨å‹å¢ƒ",
                description: "å‚æ™šï¼Œæµ·å¹³çº¿ä¸Šå †èµ·å¢¨è‰²äº‘å¢™ï¼Œé›·å£°æ»šè¿‡ï¼Œæ½®æ°´æ‹æ‰“ç¤çŸ³ã€‚æ ‘å¶çš„é£å‘å˜äº†ï¼Œä½ å¿…é¡»åœ¨é£æš´æ¥ä¸´å‰æ‰¾åˆ°é®è”½æˆ–åŠ å›ºè¥åœ°ï¼Œå¦åˆ™ä¸€å¤œè¿‡ååªå‰©æ¹¿é€ä¸å¤±æ¸©ã€‚",
                solutionHint: "æ­ä¸ªèƒ½æŒ¡é£é›¨çš„åº‡æŠ¤ï¼Œå‡†å¤‡ç«ç§ä¸å›ºå®šææ–™ï¼Œé™ä½å¤±æ¸©é£é™©ã€‚",
                victoryCondition: { type: 'shelterStats', shelterDurability: 50 },
                solved: false
            },
            {
                id: 3,
                day: 5,
                title: "æŒ‘æˆ˜ä¸‰ï¼šæš—å¤œçš„çŒæ‰‹",
                description: "å¤œå¹•é™ä¸´ï¼Œæ—é—´ä¼ æ¥ä½æ²‰çš„å–˜æ¯ä¸æå¶æŠ˜æ–­å£°ã€‚æŸç§é‡å…½æ­£åœ¨è¯•æ¢ä½ çš„è¥åœ°ï¼Œä½ å¿…é¡»ç”¨å£°å“ã€ç«æˆ–æ­¦å™¨å‘Šè¯‰å®ƒï¼šè¿™é‡Œä¸å¥½æƒ¹ã€‚",
                solutionHint: "ç«å…‰æˆ–æ­¦å™¨èƒ½å¨æ…‘ï¼Œé™·é˜±/å°–åˆºå¯é˜»æŒ¡é è¿‘ã€‚",
                victoryCondition: { type: 'hasItem', tag: 'tool', level: 3, count: 1 },
                solved: false
            },
            {
                id: 4,
                day: 7,
                title: "æŒ‘æˆ˜å››ï¼šè´§è½®çš„å¾®å…‰",
                description: "ç¬¬ä¸ƒæ—¥é»„æ˜ï¼Œè¿œå¤„æµ·é¢å‡ºç°è´§è½®èˆªç¯ã€‚ç•™ç»™ä½ çš„åªæœ‰å‡ åˆ†é’Ÿï¼Œå¿…é¡»ç”¨çƒŸé›¾ã€å…‰äº®æˆ–åå°„ä¿¡å·æ‰“ç ´æµ·é£ï¼ŒæŠŠå­˜åœ¨æ„Ÿé€è¿›èˆ¹å‘˜çš„è§†çº¿é‡Œã€‚",
                solutionHint: "å‡†å¤‡2ä¸ªå¤§å‹ä¿¡å·ç«ï¼Œæˆ–è€…3ä¸ªåå°„ä¿¡å·æ¿ã€‚",
                victoryCondition: { 
                    type: 'hasItemMultiple', 
                    conditions: [
                        { text: 'å¤§å‹ä¿¡å·ç«', count: 2 },
                        { text: 'åå°„ä¿¡å·æ¿', count: 3 }
                    ]
                },
                solved: false
            }
        ];

        let currentChallengeIndex = 0;
        let currentChallenge = challenges[currentChallengeIndex];
        
        // ç”Ÿå­˜çŠ¶æ€å€¼ï¼ˆ0-100ï¼‰ï¼Œåˆå¹¶äº†ç”Ÿå‘½å€¼å’Œé¥±è…¹å€¼
        let survival = 0;
        // åº‡æŠ¤æ‰€åšå›ºå€¼ï¼ˆ0-100ï¼‰ï¼Œåˆå¹¶äº†åšå›ºå€¼å’Œé˜²é›¨å€¼
        let shelterDurability = 0;
        const MIN_STAT_FOR_START = 20; // åˆå§‹è¿‡ä½ç›´æ¥å¤±è´¥é˜ˆå€¼
        
        // åˆæˆæ¬¡æ•°ï¼ˆå½“å‰å…³å¡å¯ç”¨ï¼‰
        let fusionLeft = 0;

        // å¤©æ•°ä¸è¡ŒåŠ¨ç‚¹
        let currentDay = 1;
        const MAX_DAY = 7;
        let actionPoints = 7;
        const MAX_ACTION_POINTS = 10;

        // å¯»æ‰¾ç‰©èµ„åœ°ç‚¹å®šä¹‰
        const LOCATIONS = {
            forest: {
                name: 'é›¨æ—',
                emoji: 'ğŸŒ²',
                unlocked: true, // åˆå§‹è§£é”
                unlockRequirement: null, // æ— éœ€è§£é”ç‰©å“
                description: 'èŒ‚å¯†çš„é›¨æ—ä¸­éšè—ç€å„ç§èµ„æº',
                // é›¨æ—åå¥½ç‰©èµ„ï¼šæœ¨æ£ã€è—¤è”“ã€å¹²è‰ã€é‡æœã€ç”Ÿè‚‰ã€é¸Ÿè›‹ç­‰
                preferredItems: ['æœ¨æ£', 'è—¤è”“', 'å¹²è‰', 'é‡æœ', 'ç”Ÿè‚‰', 'é¸Ÿè›‹', 'æœ¨æ¿', 'ç²—ç»³', 'åšéŸ§è—¤æ¡', 'çƒ¤å…½è‚‰']
            },
            beach: {
                name: 'æµ·è¾¹',
                emoji: 'ğŸ–ï¸',
                unlocked: false,
                unlockRequirement: { text: 'ç®€æ˜“æœ¨å‰', tag: 'tool' }, // éœ€è¦æäº¤ç®€æ˜“æœ¨å‰æ¥è§£é”
                description: 'æµ·è¾¹å¯ä»¥æ‰¾åˆ°è´å£³ã€æµ·è‰ç­‰ç‰©èµ„',
                // æµ·è¾¹åå¥½ç‰©èµ„ï¼šè´å£³ã€æµ·è‰ã€ç”Ÿé±¼ã€æ¤°å­ç­‰
                preferredItems: ['è´å£³', 'æµ·è‰', 'ç”Ÿé±¼', 'æ¤°å­', 'æ¤°è‚‰', 'çƒ¤é±¼', 'æ¤°æ±', 'å¤§å—é±¼è‚‰']
            },
            cave: {
                name: 'å±±æ´',
                emoji: 'ğŸ•³ï¸',
                unlocked: false,
                unlockRequirement: { text: 'ç¯ç«', tag: 'tool' }, // éœ€è¦æäº¤ç¯ç«æ¥è§£é”
                description: 'é»‘æš—çš„å±±æ´ä¸­å¯èƒ½æœ‰ç¨€æœ‰èµ„æº',
                // å±±æ´åå¥½ç‰©èµ„ï¼šçŸ³å¤´ã€çŸ³ç‰‡ã€æœ¨ç‚­ã€æ‰“ç£¨çŸ³ç‰‡ã€çŸ³åˆ¶å·¥å…·ç­‰
                preferredItems: ['çŸ³å¤´', 'çŸ³ç‰‡', 'æœ¨ç‚­', 'æ‰“ç£¨çŸ³ç‰‡', 'çŸ³åˆ¶å·¥å…·', 'çŸ³åˆ€']
            }
        };

        // è¡ŒåŠ¨ç±»å‹å®šä¹‰ï¼šæ¯ä¸ªè¡ŒåŠ¨æœ‰å›ºå®šçš„æ•°å€¼å˜åŒ–è§„åˆ™ï¼ˆåç»­æŒ‰ç‰©èµ„ç­‰çº§å€ç‡ï¼‰
        const ACTION_TYPES = {
            craftTool: {
                name: "åˆ¶ä½œå·¥å…·",
                emoji: "ğŸ”§",
                description: "ç”¨ç‰©èµ„åˆ¶ä½œå·¥å…·",
                statChanges: { health: -2, hunger: -2 }, // å°†è¢«åˆå¹¶ä¸ºsurvivalå˜åŒ–
                aiPrompt: "æè¿°ç©å®¶å¦‚ä½•ç”¨è¿™ä»¶ç‰©èµ„åˆ¶ä½œä¸€ä¸ªç®€å•å·¥å…·ï¼Œä»¥åŠå·¥å…·å¤–è§‚ä¸ç”¨é€”",
                producesItem: true,
                itemType: "å·¥å…·",
                itemEmoji: "ğŸ› ï¸",
                tags: ["tool"]
            },
            eat: {
                name: "è¿›é£Ÿ",
                emoji: "ğŸš",
                description: "è¿›é£Ÿå¯ä»¥è¡¥å……ç”Ÿå­˜çŠ¶æ€å€¼ï¼Œå¹¶å¢åŠ è¡ŒåŠ¨ç‚¹",
                statChanges: { health: +2, hunger: +12 }, // åŸºç¡€å€¼ï¼Œä¼šè¢«åˆå¹¶ä¸ºsurvivalå˜åŒ–ï¼Œä¼šæ ¹æ®é£Ÿç‰©ç­‰çº§è°ƒæ•´
                aiPrompt: "æè¿°ç©å®¶å¦‚ä½•å¤„ç†å¹¶é£Ÿç”¨è¿™ä»¶ç‰©èµ„ï¼Œä½¿å…¶å¯å…¥å£ä¸”è¡¥å……ä½“åŠ›",
                producesItem: false
            },
            buildShelter: {
                name: "ä¿®å»ºåº‡æŠ¤æ‰€",
                emoji: "ğŸ ",
                description: "åŠ å›ºæˆ–å»ºé€ åº‡æŠ¤æ‰€ï¼Œæå‡å®‰å…¨æ„Ÿ",
                statChanges: { health: 0, hunger: 0 }, // ä¸å†ç›´æ¥ä¿®æ”¹ç”Ÿå­˜çŠ¶æ€ï¼Œç”±AIåˆ¤å®šåº‡æŠ¤æå‡
                aiPrompt: "æè¿°ç©å®¶å¦‚ä½•ç”¨è¿™ä»¶ç‰©èµ„ä¿®å»ºæˆ–åŠ å›ºåº‡æŠ¤æ‰€ï¼Œä»¥åŠåº‡æŠ¤æ‰€å¸¦æ¥çš„å®‰å…¨æ„Ÿï¼Œå¹¶ç»™å‡ºå¯¹åº‡æŠ¤æ‰€åšå›ºå€¼çš„æ”¹å–„å¹…åº¦",
                producesItem: false,
                improveShelter: true
            },
            huntFish: {
                name: "æ‰“çŒ/é’“é±¼/ç ä¼",
                emoji: "ğŸ£",
                description: "è®¾é™·é˜±ã€ä¸‹æ°´å–é£Ÿæˆ–ç ä¼æœ¨æï¼Œè·å–é£Ÿç‰©æˆ–åŸææ–™ï¼ˆè¿‡ç¨‹ä¼šæ¶ˆè€—ä½“åŠ›å’Œç”Ÿå­˜çŠ¶æ€ï¼‰",
                statChanges: { health: -4, hunger: -4 }, // å°†è¢«åˆå¹¶ä¸ºsurvivalå˜åŒ–
                aiPrompt: "æè¿°ç©å®¶å¦‚ä½•ç”¨è¿™ä»¶ç‰©èµ„è¿›è¡Œæ‰“çŒã€é’“é±¼æˆ–ç ä¼ï¼Œå¹¶è·å¾—ç‰©èµ„",
                producesItem: true,
                itemType: "é£Ÿç‰©æˆ–åŸææ–™",
                itemEmoji: "ğŸ–",
                tags: ["food", "material"]
            }
        };

        // å½“å‰è¡ŒåŠ¨æ§½ä½ä¸­çš„ç‰©èµ„ï¼ˆç”¨äºé€‰æ‹©è¡ŒåŠ¨ï¼‰
        let actionSlotItem = null;

        // ============== ç”Ÿå­˜æ•°å€¼ç›¸å…³å‡½æ•° ==============
        function initBaseStats() {
            // å›ºå®šåˆå§‹æ•°å€¼
            survival = 70; // ç”Ÿå­˜çŠ¶æ€å€¼åˆå§‹ä¸º70
            shelterDurability = 0; // åº‡æŠ¤æ‰€åšå›ºå€¼åˆå§‹ä¸º0
            updateBaseStatsUI();
            updateDayAndActionUI();
            
            // å¦‚æœåˆå§‹çŠ¶æ€å°±æå·®ï¼Œåˆ™ç›´æ¥åˆ¤å®šä¸ºå¤±è´¥å¼€å±€
            if (survival < MIN_STAT_FOR_START) {
                showGameOverScreen("ä½ åœ¨è¢«å†²ä¸Šè’å²›æ—¶å°±å·²ç»ä¼¤ç—•ç´¯ç´¯ã€é¥¥æ¸´éš¾è€ï¼Œæ²¡æœ‰åšæŒåˆ°çœŸæ­£çš„æ±‚ç”ŸæŒ‘æˆ˜å¼€å§‹ã€‚");
            }
        }

        function updateBaseStatsUI() {
            // åº‡æŠ¤æ‰€å±æ€§å˜åŒ–åæ£€æŸ¥æŒ‘æˆ˜æ˜¯å¦å®Œæˆ
            checkChallengeCompletion();
            const clamp = (v) => Math.max(0, Math.min(100, v));
            const surv = clamp(survival);
            const shelter = clamp(shelterDurability);

            const sv = document.getElementById('survival-value');
            const sdv = document.getElementById('shelter-durability-value');
            const sb = document.getElementById('survival-bar');
            const sdb = document.getElementById('shelter-durability-bar');

            if (!sv) return; // é¡µé¢å¯èƒ½å·²è¢«ç»“ç®—ç•Œé¢æ›¿æ¢

            sv.textContent = surv;
            sdv.textContent = shelter;

            sb.style.width = surv + '%';
            sdb.style.width = shelter + '%';
        }

        function applyStatChanges(changes) {
            const nonZero = {};
            // å¤„ç†ç”Ÿå­˜çŠ¶æ€å€¼å˜åŒ–ï¼ˆåˆå¹¶äº†healthå’Œhungerï¼‰
            const survivalDelta = (typeof changes.health === 'number' ? changes.health : 0) + 
                                  (typeof changes.hunger === 'number' ? changes.hunger : 0);
            if (survivalDelta !== 0) {
                survival += survivalDelta;
                nonZero.survival = survivalDelta;
            }
            // å¤¹ç´§èŒƒå›´
            survival = Math.max(0, Math.min(100, survival));

            updateBaseStatsUI();
            return nonZero;
        }

        function isDead() {
            // ç”Ÿå­˜çŠ¶æ€å€¼ <= 10 è§†ä¸ºæ’‘ä¸ä½äº†
            return survival <= 10;
        }

        function updateFusionLeftDisplay() {
            const el = document.getElementById('fusion-left');
            if (el) el.textContent = fusionLeft;
        }

        function updateDayAndActionUI() {
            const el = document.getElementById('day-action-status');
            if (!el) return;
            el.textContent = `ç¬¬ ${currentDay} å¤© / ${MAX_DAY} å¤© ï½œ ä»Šæ—¥è¡ŒåŠ¨ç‚¹ï¼š${actionPoints}/${MAX_ACTION_POINTS}âš¡`;
        }

        // æ£€æŸ¥æŒ‘æˆ˜æ¡ä»¶å¹¶è¿”å›è¿›åº¦ä¿¡æ¯
        function checkChallengeProgress(challenge) {
            if (!challenge || !challenge.victoryCondition) {
                return { completed: false, progress: '', conditionText: '' };
            }
            
            const condition = challenge.victoryCondition;
            let completed = false;
            let current = 0;
            let required = 1;
            let conditionText = '';
            
            if (condition.type === 'hasItem') {
                // æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šæ ‡ç­¾å’Œç­‰çº§çš„ç‰©èµ„
                const count = countItemsByTag(condition.tag, condition.level);
                current = count;
                required = condition.count || 1;
                completed = count >= required;
                
                const tagName = tagLabel(condition.tag);
                conditionText = `æ‹¥æœ‰ ${required} ä¸ª Lv${condition.level} ${tagName}ç±»ç‰©èµ„`;
            } else if (condition.type === 'hasItemMultiple') {
                // æ£€æŸ¥å¤šä¸ªæ¡ä»¶ï¼ˆäºŒé€‰ä¸€ï¼‰ï¼šåªè¦æ»¡è¶³å…¶ä¸­ä¸€ä¸ªæ¡ä»¶å³å¯
                const conditions = condition.conditions || [];
                let satisfiedCondition = null;
                
                for (const cond of conditions) {
                    const count = playerWords.filter(w => w.text === cond.text).length;
                    if (count >= (cond.count || 1)) {
                        satisfiedCondition = cond;
                        completed = true;
                        break;
                    }
                }
                
                if (satisfiedCondition) {
                    current = playerWords.filter(w => w.text === satisfiedCondition.text).length;
                    required = satisfiedCondition.count;
                    conditionText = `æ‹¥æœ‰ ${required} ä¸ªã€${satisfiedCondition.text}ã€‘`;
                } else {
                    // æ˜¾ç¤ºæ‰€æœ‰æ¡ä»¶ï¼ˆç”¨"æˆ–"è¿æ¥ï¼‰
                    const conditionTexts = conditions.map(cond => {
                        const count = playerWords.filter(w => w.text === cond.text).length;
                        return `æ‹¥æœ‰ ${cond.count} ä¸ªã€${cond.text}ã€‘(${count}/${cond.count})`;
                    });
                    conditionText = conditionTexts.join(' æˆ– ');
                    current = 0;
                    required = 1;
                }
            } else if (condition.type === 'shelterStats') {
                // æ£€æŸ¥åº‡æŠ¤æ‰€åšå›ºå€¼
                const shelterOk = shelterDurability >= (condition.shelterDurability || 0);
                completed = shelterOk;
                current = shelterOk ? 1 : 0;
                required = 1;
                conditionText = `åº‡æŠ¤æ‰€åšå›ºå€¼ â‰¥ ${condition.shelterDurability || 0}`;
            }
            
            const progress = completed ? `âœ… å·²å®Œæˆ` : `(${current}/${required})`;
            
            return {
                completed,
                progress,
                conditionText,
                current,
                required
            };
        }

        // æ›´æ–°å½“å‰æŒ‘æˆ˜æ˜¾ç¤ºçš„è¾…åŠ©å‡½æ•°
        function updateChallengeDisplay() {
            document.getElementById('challenge-text').textContent = currentChallenge.title + " - " + (currentChallenge.description || "æ­£åœ¨ç”±AIç¼–å†™è¯¦ç»†æƒ…æ™¯...");
            document.getElementById('challenge-image').innerHTML = '';
            
            // æ˜¾ç¤ºæŒ‘æˆ˜è¿›åº¦
            const progressText = `æŒ‘æˆ˜ ${currentChallengeIndex + 1} / ${challenges.length}`;
            if (!document.getElementById('challenge-progress')) {
                const progressEl = document.createElement('p');
                progressEl.id = 'challenge-progress';
                progressEl.style = 'font-size: 0.9em; color: #9d4edd; margin-top: 10px;';
                document.getElementById('room-display').appendChild(progressEl);
            }
            document.getElementById('challenge-progress').textContent = progressText;
            
            // æ˜¾ç¤ºæŒ‘æˆ˜æ¡ä»¶å’Œè¿›åº¦
            const progressInfo = checkChallengeProgress(currentChallenge);
            let conditionEl = document.getElementById('challenge-condition');
            if (!conditionEl) {
                conditionEl = document.createElement('div');
                conditionEl.id = 'challenge-condition';
                conditionEl.style = 'margin-top: 15px; padding: 12px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; border-left: 4px solid #fbbf24;';
                const challengeTextEl = document.getElementById('challenge-text');
                challengeTextEl.parentNode.insertBefore(conditionEl, challengeTextEl.nextSibling);
            }
            
            if (progressInfo.conditionText) {
                conditionEl.innerHTML = `
                    <p style="margin: 0 0 6px 0; color: #fbbf24; font-weight: 500;">ğŸ“‹ è¾¾æˆæ¡ä»¶ï¼š</p>
                    <p style="margin: 0 0 6px 0; color: #d1d5db; font-size: 0.95em;">${progressInfo.conditionText}</p>
                    <p style="margin: 0; color: ${progressInfo.completed ? '#22c55e' : '#fbbf24'}; font-weight: 500;">
                        è¿›åº¦ï¼š${progressInfo.progress}
                    </p>
                `;
            } else {
                conditionEl.innerHTML = '';
            }
            
            // æ‹‰å–AIç”Ÿæˆçš„æŒ‘æˆ˜æè¿°ä¸åœºæ™¯å›¾
            generateChallengeNarrativeAndImage(currentChallenge);
        }
        
        // å®æ—¶æ£€æŸ¥æŒ‘æˆ˜æ˜¯å¦å®Œæˆ
        async function checkChallengeCompletion() {
            if (!currentChallenge || currentChallenge.solved) return;
            
            const progressInfo = checkChallengeProgress(currentChallenge);
            if (progressInfo.completed) {
                // ç«‹å³å®ŒæˆæŒ‘æˆ˜
                currentChallenge.solved = true;
                
                // æ˜¾ç¤ºå®Œæˆæç¤º
                const resultsDiv = document.getElementById('fusion-results');
                if (resultsDiv) {
                    const resultCard = document.createElement('div');
                    resultCard.className = 'result-card';
                    resultCard.style.borderLeftColor = '#22c55e';
                    resultCard.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 24px;">ğŸ‰</span>
                            <span style="font-size: 18px; font-weight: 500; color: #22c55e;">æŒ‘æˆ˜å®Œæˆï¼</span>
                        </div>
                        <p style="margin-bottom: 8px; color: #d1d5db;">
                            <strong>${currentChallenge.title}</strong> çš„è¾¾æˆæ¡ä»¶å·²æ»¡è¶³ï¼
                        </p>
                        <p style="margin: 0; color: #9ca3af; font-size: 0.9em;">
                            æ­£åœ¨ç»“ç®—æŒ‘æˆ˜...
                        </p>
                    `;
                    resultsDiv.prepend(resultCard);
                }
                
                // æ›´æ–°æ˜¾ç¤º
                updateChallengeDisplay();
                
                // ç«‹å³ç»“ç®—æŒ‘æˆ˜å¹¶åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡
                await resolveChallengeImmediately(currentChallenge, true);
            }
        }
        
        // ç«‹å³ç»“ç®—æŒ‘æˆ˜ï¼ˆä¸ç­‰å¾…æ¯æ—¥ç»“ç®—ï¼‰
        async function resolveChallengeImmediately(challenge, success) {
            if (isDead()) return;
            const allItems = [...playerWords];
            
            // æ ¹æ®æŒ‘æˆ˜ç»“æœè®¾ç½®æ•°å€¼å˜åŒ–ï¼ˆä¿ç•™æ¸¸æˆæœºåˆ¶ï¼Œä½¿ç”¨healthå’Œhungerä»¥ä¾¿applyStatChangesåˆå¹¶ï¼‰
            let statChanges = {};
            if (challenge.id === 1) {
                // æŒ‘æˆ˜ä¸€ï¼šå¹²æ¸´ä¸é¥¥é¥¿
                if (success) {
                    statChanges = { health: 0, hunger: +6 }; // åˆå¹¶åä¸º+6
                } else {
                    statChanges = { health: -4, hunger: -10 }; // åˆå¹¶åä¸º-14
                }
            } else if (challenge.id === 2) {
                // æŒ‘æˆ˜äºŒï¼šæš´é£é›¨
                if (success) {
                    statChanges = { health: -2, hunger: -4 }; // åˆå¹¶åä¸º-6
                } else {
                    statChanges = { health: -12, hunger: -6 }; // åˆå¹¶åä¸º-18
                }
            } else if (challenge.id === 3) {
                // æŒ‘æˆ˜ä¸‰ï¼šæš—å¤œé‡å…½
                if (success) {
                    statChanges = { health: -3, hunger: -4 }; // åˆå¹¶åä¸º-7
                } else {
                    statChanges = { health: -15, hunger: -4 }; // åˆå¹¶åä¸º-19
                }
            } else if (challenge.id === 4) {
                // æŒ‘æˆ˜å››ï¼šè´§è½®é€ƒç”Ÿ
                if (success) {
                    statChanges = {};
                } else {
                    statChanges = { health: -4, hunger: -6 }; // åˆå¹¶åä¸º-10
                }
            }
            
            const challengeTitle = challenge.title;

            // åº”ç”¨æ•°å€¼å˜åŒ–
            if (Object.keys(statChanges).length > 0) {
                applyStatChanges(statChanges);
            }

            // å¦‚æœæŒ‘æˆ˜æˆåŠŸï¼Œç«‹å³å‘æ”¾å¥–åŠ±ï¼ˆä¸ç­‰å¾…æ–‡æœ¬ç”Ÿæˆï¼‰
            if (success && challenge.id !== 4) {
                grantAiRewardItem(currentChallengeIndex);
            }

            // æ£€æŸ¥æ˜¯å¦æ­»äº¡
            if (isDead()) {
                showGameOverScreen("åœ¨æŒ‘æˆ˜ä¸­ï¼Œä½ çš„çŠ¶æ€å·²ç»è·Œè‡³æé™ï¼Œå†ä¹Ÿæ’‘ä¸ä¸‹å»äº†ã€‚");
                return;
            }

            // å¼‚æ­¥ç”ŸæˆAIæè¿°ï¼ˆä¸é˜»å¡å¥–åŠ±å‘æ”¾ï¼‰
            const eventCardId = 'event-' + Date.now();
            generateChallengeDescription(challengeTitle, success, allItems, statChanges)
                .then(aiDescription => {
                    logDayEventToResultsWithId(challengeTitle, aiDescription || "æŒ‘æˆ˜å‘ç”Ÿäº†ï¼Œä½ å°½åŠ›åº”å¯¹ã€‚", eventCardId);
                })
                .catch(error => {
                    console.error('ç”ŸæˆæŒ‘æˆ˜æè¿°å¤±è´¥:', error);
                    logDayEventToResultsWithId(challengeTitle, "æŒ‘æˆ˜å‘ç”Ÿäº†ï¼Œä½ å°½åŠ›åº”å¯¹ã€‚", eventCardId);
                });

            // å¦‚æœæŒ‘æˆ˜æˆåŠŸï¼Œç«‹å³æ¨è¿›åˆ°ä¸‹ä¸€å…³ï¼ˆä½†ç¬¬4ä¸ªæŒ‘æˆ˜æ˜¯æœ€ç»ˆæŒ‘æˆ˜ï¼Œä¸æ¨è¿›ï¼‰
            if (success && challenge.id !== 4) {
                // çŸ­æš‚å»¶è¿Ÿåæ¨è¿›ï¼Œè®©ç©å®¶çœ‹åˆ°ç»“ç®—ä¿¡æ¯
                setTimeout(() => {
                    advanceToNextChallenge();
                }, 2000);
            }
            
            // ç¬¬4ä¸ªæŒ‘æˆ˜ï¼ˆæœ€ç»ˆæŒ‘æˆ˜ï¼‰ç‰¹æ®Šå¤„ç†
            if (challenge.id === 4) {
                if (success) {
                    setTimeout(() => {
                        showVictoryScreen();
                    }, 2000);
                } else {
                    if (!isDead()) {
                        setTimeout(() => {
                            showGameOverScreen("ä½ é”™è¿‡äº†å”¯ä¸€æ˜ç¡®çš„è·æ•‘æœºä¼šï¼Œåªèƒ½ç»§ç»­åœ¨è’å²›ä¸Šä¸å­¤ç‹¬ä¸ºä¼ã€‚");
                        }, 2000);
                    }
                }
            }
        }

        // æ¨è¿›åˆ°ä¸‹ä¸€å…³
        function advanceToNextChallenge() {
            // ä¿å­˜å½“å‰æŒ‘æˆ˜ç´¢å¼•ï¼ˆç”¨äºå¥–åŠ±åˆ¤æ–­ï¼‰
            const completedChallengeIndex = currentChallengeIndex;
            
            // æ ‡è®°å½“å‰æŒ‘æˆ˜ä¸ºå·²è§£å†³
            challenges[currentChallengeIndex].solved = true;
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æŒ‘æˆ˜éƒ½å·²å®Œæˆ
            if (currentChallengeIndex >= challenges.length - 1) {
                // æ¸¸æˆé€šå…³ï¼
                showVictoryScreen();
                return;
            }
            
            // æ¨è¿›åˆ°ä¸‹ä¸€å…³
            currentChallengeIndex++;
            currentChallenge = challenges[currentChallengeIndex];
            
            // æ¯ä¸ªæŒ‘æˆ˜èƒœåˆ©è·å¾—4æ¬¡ç‰©èµ„åˆæˆæœºä¼š
            fusionLeft += 4;
            updateFusionLeftDisplay();
            
            // çŸ­æš‚å»¶è¿Ÿåæ›´æ–°æ˜¾ç¤ºï¼Œè®©æˆåŠŸåé¦ˆåœç•™ä¸€ä¼šå„¿
            setTimeout(() => {
                updateChallengeDisplay();
                
                // æ˜¾ç¤ºä¸€ä¸ªç®€å•çš„è¿‡æ¸¡åŠ¨ç”»
                const roomDisplay = document.getElementById('room-display');
                roomDisplay.style.opacity = '0.7';
                setTimeout(() => {
                    roomDisplay.style.opacity = '1';
                }, 300);
            }, 2000);
        }

        // æ¸¸æˆé€šå…³ç•Œé¢
        function showVictoryScreen() {
            const roomDisplay = document.getElementById('room-display');
            roomDisplay.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 80px; margin-bottom: 20px;">ğŸ†</div>
                    <h2 style="color: #fbbf24;">è’å²›æ±‚ç”Ÿè¾¾äººï¼</h2>
                    <p>ä½ å‡­å€Ÿå†·é™ä¸åˆ›é€ åŠ›ï¼Œåœ¨ç»å¢ƒä¸­å­˜æ´»äº†ä¸‹æ¥ã€‚</p>
                    <p>å…±åˆæˆäº† <strong style="color: #4cc9f0;">${fusionResults.length}</strong> ä¸ªå…³é”®ç‰©èµ„/å·¥å…·ã€‚</p>
                    <div id="ending-summary" style="margin-top:20px;"></div>
                    <div style="margin: 30px 0;">
                        <button onclick="location.reload()" style="
                            background: linear-gradient(45deg, #fbbf24, #f59e0b);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 25px;
                            font-size: 18px;
                            cursor: pointer;
                            margin: 10px;
                        ">é‡æ–°å¼€å§‹</button>
                    </div>
                    <p style="font-size: 0.9em; color: #9ca3af; margin-top: 40px;">
                        "ä½ åœ¨è’å²›ä¸Šçš„ä¸€ä¸¾ä¸€åŠ¨ï¼Œéƒ½æ‚„æ‚„æš´éœ²äº†ä½ çš„æ€§æ ¼ã€‚"
                    </p>
                </div>
            `;
            
            // ç”ŸæˆåŸºäºèµ„æºåº“çš„æ€§æ ¼è¯„è¯­
            generateEndingSummary(true);
        }

        // ============== ç”Ÿå›¾APIé…ç½® ==============

        // æ³¨æ„ï¼šä½ éœ€è¦æ ¹æ®é€‰æ‹©çš„ç”Ÿå›¾æœåŠ¡å•†ï¼ˆå¦‚DALL-Eã€Midjourney APIã€å›½å†…å¹³å°ç­‰ï¼‰å¡«å†™ä»¥ä¸‹ä¿¡æ¯
        const IMG_API_URL = 'https://api.siliconflow.cn/v1/images/generations'; // æ›¿æ¢ä¸ºç”Ÿå›¾APIçš„çœŸå®åœ°å€
        const IMG_API_KEY = 'sk-qmqcbvermnhrnqanznlmlfqkwxvijjzfjftflxrhsahmttfa'; // æ›¿æ¢ä¸ºä½ çš„ç”Ÿå›¾APIå¯†é’¥
        const IMG_MODEL = 'Kwai-Kolors/Kolors'; // æˆ– 'dall-e-2', 'midjourney', 'stable-diffusion-v1-6' ç­‰ï¼Œæ ¹æ®æœåŠ¡å•†æ”¯æŒå¡«å†™

        // å·¥å…·å‡½æ•°ï¼šå°†ç”Ÿæˆçš„è¯è¯­è½¬æ¢ä¸ºé€‚åˆç”Ÿå›¾çš„æè¿°ï¼ˆPromptï¼‰
        function createImagePrompt(name, description, categoryHint) {
            // ç”¨äºä¸ºå·¥å…·/é£Ÿç‰©ç­‰ç”Ÿæˆæ’ç”»
            return `ä¸€å¹…è’å²›æ±‚ç”Ÿæ¸¸æˆæ’ç”»ï¼Œå±•ç¤ºç‰©å“"${name}"ã€‚
        åœºæ™¯æè¿°ï¼š${description}ã€‚
        é£æ ¼ï¼šå†™å®ä¸æ’ç”»ç»“åˆï¼Œè‰²å½©é²œæ˜ï¼Œç”µå½±åˆ†é•œæ„Ÿï¼Œé«˜æ¸…ï¼Œä¸­å¿ƒæ„å›¾ï¼Œæ— æ–‡å­—ã€‚
        ç‰©å“ç±»å‹æç¤ºï¼š${categoryHint || 'å·¥å…·æˆ–é£Ÿç‰©'}ï¼Œè’å²›ã€æ±‚ç”Ÿã€è‡ªç„¶ç¯å¢ƒã€‚`;
        }
        
        // ä¸“é—¨ç”¨äºä¿®å»ºåº‡æŠ¤æ‰€çš„ç”Ÿå›¾å‡½æ•°
        async function generateAndDisplayImageForShelter(materialName, description, placeholderId) {
            const placeholder = document.getElementById(placeholderId);
            if (!placeholder) {
                console.error('æ‰¾ä¸åˆ°å›¾ç‰‡å ä½ç¬¦:', placeholderId);
                return;
            }

            // æ›´æ–°å ä½ç¬¦å†…å®¹ä¸ºåŠ è½½çŠ¶æ€
            placeholder.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p>ğŸ¨ æ­£åœ¨ç»˜åˆ¶ä¿®å»ºåº‡æŠ¤æ‰€çš„åœºæ™¯...</p>
                </div>
            `;

            // æ„å»ºç”Ÿå›¾è¯·æ±‚
            const imagePrompt = `ä¸€å¹…è’å²›æ±‚ç”Ÿæ¸¸æˆæ’ç”»ï¼Œå±•ç¤ºç©å®¶ä½¿ç”¨ã€${materialName}ã€‘ä¿®å»ºæˆ–åŠ å›ºåº‡æŠ¤æ‰€çš„åœºæ™¯ã€‚
åœºæ™¯æè¿°ï¼š${description}
é£æ ¼ï¼šå†™å®ä¸æ’ç”»ç»“åˆï¼Œè‰²å½©é²œæ˜ï¼Œç”µå½±åˆ†é•œæ„Ÿï¼Œé«˜æ¸…ï¼Œæ¨ªå‘æ„å›¾ï¼Œæ— æ–‡å­—ã€‚
é‡ç‚¹ï¼šå±•ç¤ºåº‡æŠ¤æ‰€çš„ç»“æ„ã€ä½¿ç”¨çš„ç‰©èµ„ã€${materialName}ã€‘ã€ä»¥åŠè’å²›ç¯å¢ƒã€‚`;

            const requestBody = {
                model: IMG_MODEL,
                prompt: imagePrompt,
                n: 1,
                size: "768x512",
                quality: "standard"
            };

            try {
                console.log(`ğŸ–¼ï¸ æ­£åœ¨è¯·æ±‚ç”Ÿæˆä¿®å»ºåº‡æŠ¤æ‰€çš„å›¾ç‰‡...`);

                const response = await fetch(IMG_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${IMG_API_KEY}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`ç”Ÿå›¾APIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`);
                }

                const data = await response.json();
                console.log('ç”Ÿå›¾APIå®Œæ•´å“åº”:', data);

                // ä»å“åº”ä¸­æå–å›¾ç‰‡URL
                let imageUrl;
                
                if (data.data && data.data[0] && data.data[0].url) {
                    imageUrl = data.data[0].url;
                } else if (data.url) {
                    imageUrl = data.url;
                } else if (data.data && data.data[0] && data.data[0].b64_json) {
                    imageUrl = `data:image/png;base64,${data.data[0].b64_json}`;
                } else {
                    console.warn('æ— æ³•è¯†åˆ«çš„å“åº”æ ¼å¼ï¼Œå°è¯•å…¶ä»–è·¯å¾„...', data);
                    throw new Error('æ— æ³•ä»å“åº”ä¸­è§£æå›¾ç‰‡URLï¼Œè¯·æ£€æŸ¥æ•°æ®ç»“æ„ã€‚');
                }

                // å°†å›¾ç‰‡URLæ’å…¥åˆ°é¡µé¢ä¸­
                placeholder.innerHTML = `
                    <img src="${imageUrl}" 
                        alt="ä¿®å»ºåº‡æŠ¤æ‰€" 
                        style="width:100%; border-radius:8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);"
                        onerror="this.onerror=null; this.parentElement.innerHTML='<p style=\'color:red;\'>âš ï¸ å›¾ç‰‡åŠ è½½å¤±è´¥</p>';">
                `;
            } catch (error) {
                console.error('ç”Ÿæˆåº‡æŠ¤æ‰€å›¾ç‰‡å¤±è´¥:', error);
                placeholder.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #ff6b6b;">
                        <p>âš ï¸ å›¾ç‰‡ç”Ÿæˆå¤±è´¥</p>
                        <p style="font-size: 0.9em; opacity: 0.8;">${error.message}</p>
                    </div>
                `;
            }
    }

        // ============== æ¸¸æˆçŠ¶æ€ ==============
        let playerWords = [...basicWords];  // ç©å®¶æ‹¥æœ‰çš„ç‰©èµ„
        let fusionResults = [];  // åˆæˆè®°å½•
        let selectedWords = [null, null];  // ä¸¤ä¸ªåˆæˆæ§½ä½
        let usedWordIds = new Set();  // å·²ä½¿ç”¨çš„ç‰©èµ„IDï¼ˆé˜²æ­¢ä¸€ä¸ªç‰©èµ„è¢«æ‹–åˆ°å¤šä¸ªä½ç½®ï¼‰
        
        // ============== åœ°ç‚¹ç›¸å…³å‡½æ•° ==============
        let currentUnlockingLocation = null; // å½“å‰æ­£åœ¨è§£é”çš„åœ°ç‚¹ID
        let unlockSlotItem = null; // è§£é”æ§½ä½ä¸­çš„ç‰©å“

        function renderLocationButtons() {
            const container = document.getElementById('location-buttons-container');
            if (!container) return;

            container.innerHTML = '';
            
            // æŒ‰é¡ºåºæ˜¾ç¤ºï¼šé›¨æ—ã€æµ·è¾¹ã€å±±æ´
            const locationOrder = ['forest', 'beach', 'cave'];
            locationOrder.forEach(locId => {
                const location = LOCATIONS[locId];
                const btn = document.createElement('button');
                btn.className = 'fusion-btn';
                
                if (location.unlocked) {
                    btn.innerHTML = `${location.emoji} ${location.name} ( 1âš¡)`;
                    btn.onclick = () => findRawMaterial(locId);
                    btn.id = `location-btn-${locId}`;
                } else {
                    btn.innerHTML = `ğŸ”’ ${location.emoji} ${location.name}`;
                    btn.onclick = () => showUnlockLocationModal(locId);
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'pointer';
                    btn.id = `location-btn-${locId}`;
                }
                
                container.appendChild(btn);
            });
        }

        function showUnlockLocationModal(locationId) {
            const location = LOCATIONS[locationId];
            if (!location || location.unlocked) return;

            const modal = document.getElementById('unlock-location-modal');
            const textEl = document.getElementById('unlock-location-text');
            const slotEl = document.getElementById('unlock-location-slot');
            
            if (!modal || !textEl || !slotEl) return;

            currentUnlockingLocation = locationId;
            unlockSlotItem = null;
            
            const req = location.unlockRequirement;
            textEl.textContent = `è§£é”${location.name}éœ€è¦ï¼š${req.text}ï¼ˆ${tagLabel(req.tag)}ï¼‰`;
            slotEl.innerHTML = 'æ‹–æ”¾ç‰©å“åˆ°æ­¤å¤„è§£é”';
            slotEl.style.borderColor = '#fbbf24';
            slotEl.style.backgroundColor = 'rgba(251, 191, 36, 0.1)';
            
            document.getElementById('confirm-unlock-btn').style.display = 'none';
            modal.style.display = 'block';

            // è®¾ç½®æ‹–æ”¾äº‹ä»¶
            setupUnlockSlotDragAndDrop(slotEl);
        }

        function setupUnlockSlotDragAndDrop(slotEl) {
            // æ¸…é™¤ä¹‹å‰çš„å†…å®¹å’ŒçŠ¶æ€
            unlockSlotItem = null;
            slotEl.innerHTML = 'æ‹–æ”¾ç‰©å“åˆ°æ­¤å¤„è§£é”';
            slotEl.style.borderColor = '#fbbf24';
            slotEl.style.backgroundColor = 'rgba(251, 191, 36, 0.1)';
            
            // ç§»é™¤ä¹‹å‰çš„æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼ˆé€šè¿‡å…‹éš†èŠ‚ç‚¹ï¼‰
            const newSlotEl = slotEl.cloneNode(true);
            slotEl.parentNode.replaceChild(newSlotEl, slotEl);
            
            // è·å–æ›´æ–°åçš„å…ƒç´ å¼•ç”¨
            const unlockSlot = document.getElementById('unlock-location-slot');
            if (!unlockSlot) return;
            
            unlockSlot.addEventListener('dragover', (e) => {
                e.preventDefault();
                unlockSlot.style.borderColor = '#22c55e';
                unlockSlot.style.backgroundColor = 'rgba(34, 197, 94, 0.2)';
            });

            unlockSlot.addEventListener('dragleave', (e) => {
                e.preventDefault();
                if (!unlockSlotItem) {
                    unlockSlot.style.borderColor = '#fbbf24';
                    unlockSlot.style.backgroundColor = 'rgba(251, 191, 36, 0.1)';
                }
            });

            unlockSlot.addEventListener('drop', (e) => {
                e.preventDefault();
                const wordId = e.dataTransfer.getData('text/plain');
                const word = playerWords.find(w => String(w.id) === wordId);
                
                if (word && !usedWordIds.has(Number(word.id))) {
                    const location = LOCATIONS[currentUnlockingLocation];
                    if (!location) return;
                    const req = location.unlockRequirement;
                    if (!req) return;
                    
                    // æ£€æŸ¥ç‰©å“æ˜¯å¦ç¬¦åˆè¦æ±‚
                    if (word.text === req.text && word.tag === req.tag) {
                        unlockSlotItem = word;
                        usedWordIds.add(Number(word.id));
                        unlockSlot.innerHTML = `
                            <div style="font-size: 16px; font-weight: 500; color: #fff;">
                                ${word.emoji} ${word.text}
                            </div>
                        `;
                        unlockSlot.style.borderColor = '#22c55e';
                        unlockSlot.style.backgroundColor = 'rgba(34, 197, 94, 0.3)';
                        const confirmBtn = document.getElementById('confirm-unlock-btn');
                        if (confirmBtn) {
                            confirmBtn.style.display = 'inline-block';
                        }
                    } else {
                        alert(`éœ€è¦æäº¤ã€${req.text}ã€‘æ¥è§£é”${location.name}ï¼`);
                        unlockSlot.style.borderColor = '#fbbf24';
                        unlockSlot.style.backgroundColor = 'rgba(251, 191, 36, 0.1)';
                    }
                } else if (word && usedWordIds.has(Number(word.id))) {
                    alert('è¯¥ç‰©å“å·²è¢«ä½¿ç”¨ï¼');
                    unlockSlot.style.borderColor = '#fbbf24';
                    unlockSlot.style.backgroundColor = 'rgba(251, 191, 36, 0.1)';
                }
            });
        }

        function confirmUnlockLocation() {
            if (!currentUnlockingLocation || !unlockSlotItem) return;

            const location = LOCATIONS[currentUnlockingLocation];
            const req = location.unlockRequirement;
            
            // éªŒè¯ç‰©å“
            if (unlockSlotItem.text === req.text && unlockSlotItem.tag === req.tag) {
                // æ¶ˆè€—ç‰©å“
                consumeItem(unlockSlotItem, 1);
                renderWordInventory();
                
                // è§£é”åœ°ç‚¹
                location.unlocked = true;
                
                // éšè—è§£é”ç•Œé¢
                cancelUnlockLocation();
                
                // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                renderLocationButtons();
                
                // æ˜¾ç¤ºè§£é”æˆåŠŸæ¶ˆæ¯
                const resultsDiv = document.getElementById('fusion-results');
                if (resultsDiv) {
                    const resultCard = document.createElement('div');
                    resultCard.className = 'result-card';
                    resultCard.style.borderLeftColor = '#fbbf24';
                    resultCard.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 24px;">ğŸ”“</span>
                            <span style="font-size: 18px; font-weight: 500;">è§£é”æ–°åœ°ç‚¹</span>
                        </div>
                        <p style="margin-bottom: 8px;">
                            ä½¿ç”¨ã€${unlockSlotItem.emoji} ${unlockSlotItem.text}ã€‘è§£é”äº†ã€${location.emoji} ${location.name}ã€‘ï¼
                        </p>
                        <div style="text-align: right; font-size: 12px; opacity: 0.7; margin-top: 8px;">
                            ${new Date().toLocaleTimeString()}
                        </div>
                    `;
                    resultsDiv.prepend(resultCard);
                    resultsDiv.scrollTop = 0;
                }
            }
        }

        function cancelUnlockLocation() {
            if (unlockSlotItem) {
                usedWordIds.delete(unlockSlotItem.id);
                unlockSlotItem = null;
            }
            currentUnlockingLocation = null;
            const modal = document.getElementById('unlock-location-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ============== åˆå§‹åŒ– ==============
        function initGame() {
            // åˆå§‹åŒ–ç‰©èµ„åº“å­˜
            renderWordInventory();
            
            // åˆå§‹åŒ–éšæœºåŸºç¡€æ•°å€¼
            initBaseStats();
            
            // åˆå§‹åˆæˆæ¬¡æ•°ï¼ˆç¬¬ä¸€å…³å¼€å§‹å‰ç»™ä¸€æ¬¡é¢„å¤‡åˆæˆï¼‰
            fusionLeft = 4;
            updateFusionLeftDisplay();
            
            // åˆå§‹åŒ–æŒ‘æˆ˜
            updateChallengeDisplay();
            
            // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            initDragAndDrop();
            
            // åˆå§‹åŒ–åœ°ç‚¹æŒ‰é’®
            renderLocationButtons();
        }
        
        // æ¸²æŸ“è¯è¯­åº“å­˜
        function tagLabel(tag) {
            switch (tag) {
                case 'food': return 'é£Ÿç‰©';
                case 'material': return 'åŸææ–™';
                case 'tool': return 'å·¥å…·';
                default: return 'æœªçŸ¥';
            }
        }

        function getTagDisplayName(tag) {
            return tagLabel(tag);
        }

        function defaultUses(tag) {
            if (tag === 'material') return 2;
            if (tag === 'tool') return 5;
            if (tag === 'food') return 1;
            return 1;
        }

        // ç”Ÿæˆå”¯ä¸€çš„ç‰©èµ„IDï¼ˆæ‰¾åˆ°å½“å‰æœ€å¤§çš„IDï¼Œç„¶å+1ï¼‰
        function getNextWordId() {
            if (playerWords.length === 0) return 1;
            const maxId = Math.max(...playerWords.map(w => w.id || 0));
            return maxId + 1;
        }

        function consumeItem(item, amount = 1) {
            item.usesLeft = (item.usesLeft ?? defaultUses(item.tag)) - amount;
            if (item.usesLeft <= 0) {
                playerWords = playerWords.filter(w => w.id !== item.id);
                renderWordInventory();
            }
        }

        function renderWordInventory() {
            // ç‰©èµ„å˜åŒ–åæ£€æŸ¥æŒ‘æˆ˜æ˜¯å¦å®Œæˆ
            checkChallengeCompletion();
            const container = document.getElementById('word-inventory');
            container.innerHTML = '';
            
            playerWords.forEach(word => {
                const div = document.createElement('div');
                div.className = 'word-item';
                div.draggable = true;
                div.dataset.wordId = word.id;
                
                const lvl = word.level || 1;
                const uses = word.usesLeft ?? defaultUses(word.tag);
                // å¯¹äºå·¥å…·å’ŒåŸææ–™ï¼Œæ˜¾ç¤ºä½¿ç”¨æ¬¡æ•°
                let usesDisplay = '';
                if (word.tag === 'tool' || word.tag === 'material') {
                    usesDisplay = ` [${uses}æ¬¡]`;
                }
                div.innerHTML = `
                    <span class="word-emoji">${word.emoji}</span>
                    <span>${word.text} (Lv${lvl}Â·${tagLabel(word.tag)})${usesDisplay}</span>
                `;
                
                div.addEventListener('dragstart', handleDragStart);
                container.appendChild(div);
            });
        }
        
        // ============== æ‹–æ‹½åŠŸèƒ½ ==============
        function initDragAndDrop() {
            // åªå¤„ç†åˆæˆæ§½ä½ï¼ˆslot1å’Œslot2ï¼‰ï¼Œå¿½ç•¥å…¶ä»–slot
            const slot1 = document.getElementById('slot1');
            const slot2 = document.getElementById('slot2');
            const fusionSlots = [slot1, slot2];
            
            fusionSlots.forEach((slot, index) => {
                if (!slot) return;
                
                slot.addEventListener('dragover', e => {
                    e.preventDefault();
                    slot.style.borderColor = '#4cc9f0';
                });
                
                slot.addEventListener('dragleave', () => {
                    slot.style.borderColor = '#f72585';
                });
                
                slot.addEventListener('drop', e => {
                    e.preventDefault();
                    const wordId = e.dataTransfer.getData('text/plain');
                    
                    // ç¡®ä¿wordIdæœ‰æ•ˆ
                    if (!wordId || wordId === '') {
                        console.error('æ— æ•ˆçš„ç‰©èµ„ID');
                        return;
                    }
                    
                    // ç¡®ä¿IDç±»å‹ä¸€è‡´ï¼ˆè½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒï¼Œå› ä¸ºword.idæ˜¯æ•°å­—ï¼‰
                    const wordIdNum = parseInt(wordId, 10);
                    if (isNaN(wordIdNum)) {
                        console.error('æ— æ³•è§£æç‰©èµ„ID:', wordId);
                        return;
                    }
                    
                    // ä½¿ç”¨ä¸¥æ ¼æ•°å­—åŒ¹é…æŸ¥æ‰¾ç‰©èµ„ï¼ˆç¡®ä¿æ‰¾åˆ°æ­£ç¡®çš„ç‰©èµ„ï¼Œå³ä½¿åç§°ç›¸åŒï¼‰
                    const word = playerWords.find(w => Number(w.id) === wordIdNum);
                    
                    if (word) {
                        // æ£€æŸ¥ç‰©èµ„æ˜¯å¦å·²è¢«ä½¿ç”¨
                        if (usedWordIds.has(wordIdNum)) {
                            alert('è¯¥ç‰©èµ„å·²è¢«ä½¿ç”¨ï¼Œè¯·å…ˆæ¸…ç©ºå…¶ä»–ä½ç½®ï¼');
                            return;
                        }
                        
                        // å¦‚æœè¿™ä¸ªæ§½ä½ä¹‹å‰æœ‰ç‰©èµ„ï¼Œå…ˆå–æ¶ˆä¹‹å‰çš„æ ‡è®°
                        if (selectedWords[index]) {
                            const oldWordId = selectedWords[index].id;
                            usedWordIds.delete(oldWordId);
                        }
                        
                        // æ ‡è®°æ–°ç‰©èµ„ä¸ºå·²ä½¿ç”¨
                        usedWordIds.add(wordIdNum);
                        // ç¡®ä¿ä½¿ç”¨æ‰¾åˆ°çš„ç‰©èµ„å¯¹è±¡ï¼Œè€Œä¸æ˜¯é€šè¿‡å…¶ä»–æ–¹å¼è·å–
                        selectedWords[index] = word;
                        slot.innerHTML = `
                            <div>${word.emoji} ${word.text} (Lv${word.level || 1})</div>
                        `;
                        slot.style.borderColor = '#4cc9f0';
                        slot.style.background = 'rgba(76, 201, 240, 0.1)';
                    } else {
                        console.error('æ‰¾ä¸åˆ°ç‰©èµ„ï¼ŒwordId:', wordId, 'wordIdNum:', wordIdNum);
                        console.log('å½“å‰ç‰©èµ„åº“:', playerWords.map(w => ({id: w.id, text: w.text})));
                        alert(`æ— æ³•æ‰¾åˆ°ç‰©èµ„ï¼ˆID: ${wordId}ï¼‰ï¼Œè¯·é‡è¯•ã€‚`);
                    }
                });
            });
    
            // è¡ŒåŠ¨æ§½ä½çš„æ‹–æ‹½å¤„ç†
            const actionSlot = document.getElementById('action-slot');
            if (actionSlot) {
                actionSlot.addEventListener('dragover', (e) => {
                e.preventDefault();
                    actionSlot.style.borderColor = '#22c55e';
                    actionSlot.style.background = 'rgba(34, 197, 94, 0.1)';
            });
            
                actionSlot.addEventListener('dragleave', () => {
                    actionSlot.style.borderColor = '#22c55e';
                    actionSlot.style.background = 'rgba(255, 255, 255, 0.05)';
            });
            
                actionSlot.addEventListener('drop', (e) => {
                e.preventDefault();
                    actionSlot.style.borderColor = '#22c55e';
                    actionSlot.style.background = 'rgba(255, 255, 255, 0.05)';
                    
                    if (actionPoints <= 0) {
                        alert('ä»Šæ—¥è¡ŒåŠ¨ç‚¹å·²ç”¨å®Œï¼Œæ— æ³•å†æ‰§è¡Œè¡ŒåŠ¨ã€‚è¯·ç»“æŸä»Šå¤©ã€‚');
                        return;
                    }
                
                const wordId = e.dataTransfer.getData('text/plain');
                    
                    // ç¡®ä¿wordIdæœ‰æ•ˆ
                    if (!wordId || wordId === '') {
                        console.error('æ— æ•ˆçš„ç‰©èµ„ID');
                        return;
                    }
                    
                    // ç¡®ä¿IDç±»å‹ä¸€è‡´ï¼ˆè½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒï¼Œå› ä¸ºword.idæ˜¯æ•°å­—ï¼‰
                    const wordIdNum = parseInt(wordId, 10);
                    if (isNaN(wordIdNum)) {
                        console.error('æ— æ³•è§£æç‰©èµ„ID:', wordId);
                        return;
                    }
                    
                    // æ£€æŸ¥ç‰©èµ„æ˜¯å¦å·²è¢«ä½¿ç”¨
                    if (usedWordIds.has(wordIdNum)) {
                        alert('è¯¥ç‰©èµ„å·²è¢«ä½¿ç”¨ï¼Œè¯·å…ˆæ¸…ç©ºå…¶ä»–ä½ç½®ï¼');
                        return;
                    }
                    
                    // ä½¿ç”¨ä¸¥æ ¼åŒ¹é…æŸ¥æ‰¾ç‰©èµ„
                    const word = playerWords.find(w => Number(w.id) === wordIdNum);
                
                    if (word) {
                        // å¦‚æœè¡ŒåŠ¨æ§½ä½ä¹‹å‰æœ‰ç‰©èµ„ï¼Œå…ˆå–æ¶ˆä¹‹å‰çš„æ ‡è®°
                        if (actionSlotItem) {
                            const oldWordId = actionSlotItem.id;
                            usedWordIds.delete(oldWordId);
                        }
                        
                        // æ ‡è®°æ–°ç‰©èµ„ä¸ºå·²ä½¿ç”¨
                        usedWordIds.add(wordIdNum);
                        
                        // ç¡®ä¿ä½¿ç”¨æ‰¾åˆ°çš„ç‰©èµ„ï¼Œè€Œä¸æ˜¯ä¹‹å‰çš„å€¼
                        actionSlotItem = word;
                        actionSlot.innerHTML = `
                            <div style="font-size: 16px; font-weight: 500; color: #fff;">
                                ${word.emoji} ${word.text}
                        </div>
                        `;
                        showActionMenu(word);
                    } else {
                        console.error('æ‰¾ä¸åˆ°ç‰©èµ„ï¼ŒwordId:', wordId, 'wordIdNum:', wordIdNum);
                        console.log('å½“å‰ç‰©èµ„åº“:', playerWords.map(w => ({id: w.id, text: w.text})));
                        alert(`æ— æ³•æ‰¾åˆ°ç‰©èµ„ï¼ˆID: ${wordId}ï¼‰ï¼Œè¯·é‡è¯•ã€‚`);
                }
            });
            }
        }
        
        function handleDragStart(e) {
            // ä½¿ç”¨currentTargetç¡®ä¿è·å–åˆ°æ­£ç¡®çš„å…ƒç´ ï¼ˆåŒ…å«dataset.wordIdçš„divï¼‰
            // å› ä¸ºäº‹ä»¶ç›‘å¬å™¨ç»‘å®šåœ¨divä¸Šï¼ŒcurrentTargetåº”è¯¥å°±æ˜¯é‚£ä¸ªdiv
            const target = e.currentTarget;
            let wordId = target.dataset.wordId;
            
            // å¦‚æœå½“å‰å…ƒç´ æ²¡æœ‰wordIdï¼Œå‘ä¸ŠæŸ¥æ‰¾
            if (!wordId) {
                const closest = target.closest('[data-word-id]');
                if (closest && closest.dataset.wordId) {
                    wordId = closest.dataset.wordId;
                }
            }
            
            if (wordId) {
                // ç¡®ä¿wordIdæ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼Œå¹¶æ¸…é™¤å¯èƒ½çš„ç©ºç™½å­—ç¬¦
                const cleanWordId = String(wordId).trim();
                const wordIdNum = parseInt(cleanWordId, 10);
                
                // æ£€æŸ¥ç‰©èµ„æ˜¯å¦å·²è¢«ä½¿ç”¨
                if (usedWordIds.has(wordIdNum)) {
                    e.preventDefault();
                    alert('è¯¥ç‰©èµ„å·²è¢«ä½¿ç”¨ï¼Œè¯·å…ˆæ¸…ç©ºå…¶ä»–ä½ç½®ï¼');
                    return;
                }
                
                e.dataTransfer.setData('text/plain', cleanWordId);
            } else {
                console.error('æ— æ³•æ‰¾åˆ°ç‰©èµ„ID:', {
                    target: target,
                    dataset: target.dataset,
                    closest: target.closest('[data-word-id]')
                });
            }
            }
            
        // æ˜¾ç¤ºè¡ŒåŠ¨é€‰æ‹©èœå•
        function showActionMenu(item) {
            const menuEl = document.getElementById('action-menu');
            if (!menuEl) return;
            
            menuEl.style.display = 'block';
            menuEl.innerHTML = '<p style="color: #22c55e; margin-bottom: 12px; font-weight: 500;">é€‰æ‹©è¦æ‰§è¡Œçš„è¡ŒåŠ¨ï¼š</p>';
            
            const actionsGrid = document.createElement('div');
            actionsGrid.style.display = 'grid';
            actionsGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
            actionsGrid.style.gap = '10px';
            
            Object.keys(ACTION_TYPES).forEach(actionKey => {
                const action = ACTION_TYPES[actionKey];
                const btn = document.createElement('button');
                btn.style.cssText = `
                    padding: 12px;
                    background: rgba(34, 197, 94, 0.1);
                    border: 2px solid rgba(34, 197, 94, 0.5);
                    border-radius: 10px;
                    color: #fff;
                    cursor: pointer;
                    transition: all 0.3s;
                    text-align: left;
                `;
                btn.innerHTML = `
                    <div style="font-size: 20px; margin-bottom: 4px;">${action.emoji}</div>
                    <div style="font-weight: 500; margin-bottom: 2px;">${action.name}</div>
                    <div style="font-size: 12px; opacity: 0.8;">${action.description}</div>
                `;
                btn.onmouseover = () => {
                    btn.style.background = 'rgba(34, 197, 94, 0.2)';
                    btn.style.borderColor = '#22c55e';
                };
                btn.onmouseout = () => {
                    btn.style.background = 'rgba(34, 197, 94, 0.1)';
                    btn.style.borderColor = 'rgba(34, 197, 94, 0.5)';
                };
                btn.onclick = () => executeAction(actionKey, item);
                actionsGrid.appendChild(btn);
            });
            
            menuEl.appendChild(actionsGrid);
        }

        // æ‰§è¡Œè¡ŒåŠ¨ï¼šåº”ç”¨æ•°å€¼å˜åŒ– + AIåé¦ˆ
        async function executeAction(actionKey, item) {
            const action = ACTION_TYPES[actionKey];
            if (!action) return;
            const tag = item.tag || 'material';
            // è¡Œä¸ºæ ¡éªŒ
            if (actionKey === 'craftTool' && tag !== 'material') { alert('åˆ¶ä½œå·¥å…·åªèƒ½ä½¿ç”¨åŸææ–™ç±»ç‰©èµ„'); return; }
            if (actionKey === 'eat' && tag !== 'food') { alert('è¿›é£Ÿåªèƒ½ä½¿ç”¨é£Ÿç‰©ç±»ç‰©èµ„'); return; }
            if (actionKey === 'buildShelter' && tag !== 'material') { alert('ä¿®å»ºåº‡æŠ¤æ‰€åªèƒ½ä½¿ç”¨åŸææ–™ç±»ç‰©èµ„'); return; }
            if (actionKey === 'huntFish' && tag !== 'tool') { alert('æ‰“çŒ/é’“é±¼/ç ä¼éœ€è¦å·¥å…·ç±»ç‰©èµ„'); return; }
            
            // æ¶ˆè€—è¡ŒåŠ¨ç‚¹ï¼ˆè¿›é£Ÿè¡ŒåŠ¨ä¸æ¶ˆè€—è¡ŒåŠ¨ç‚¹ï¼‰
            if (actionKey !== 'eat') {
                if (actionPoints <= 0) { alert('ä»Šæ—¥è¡ŒåŠ¨ç‚¹å·²ç”¨å®Œ'); return; }
                actionPoints -= 1;
                updateDayAndActionUI();
            }
            
            // ç¦ç”¨æ‰€æœ‰è¡ŒåŠ¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const actionMenu = document.getElementById('action-menu');
            const actionButtons = actionMenu ? actionMenu.querySelectorAll('button') : [];
            const originalButtonStates = [];
            actionButtons.forEach((btn, index) => {
                originalButtonStates[index] = {
                    disabled: btn.disabled,
                    innerHTML: btn.innerHTML,
                    opacity: btn.style.opacity,
                    cursor: btn.style.cursor
                };
                btn.disabled = true;
                if (btn.innerHTML.includes(action.emoji)) {
                    btn.innerHTML = `â³ ${action.name}ä¸­...`;
                }
                btn.style.opacity = '0.6';
                btn.style.cursor = 'not-allowed';
            });
            
            // å…ˆè®¡ç®—ç³»ç»Ÿé»˜è®¤çš„æ•°å€¼å˜åŒ–ï¼ˆæŒ‰ç‰©èµ„ç­‰çº§è°ƒæ•´ï¼‰
            const lvl = item.level || 1;
            let defaultChanges = {};
            
            if (actionKey === 'eat') {
                // è¿›é£Ÿé€»è¾‘ï¼šç³»ç»Ÿè§„å®šçš„å›ºå®šæ•°å€¼ï¼Œæœ‰åˆç†æ¢¯åº¦ï¼ˆåˆå¹¶ä¸ºsurvivalå˜åŒ–ï¼‰
                // ä¸€çº§é£Ÿç‰©ï¼šç”Ÿçš„æˆ–éš¾å’½ä¸‹çš„ï¼Œæ•ˆæœå·®ï¼Œå¯èƒ½æ‰£ç”Ÿå‘½å€¼
                if (lvl === 1) {
                    defaultChanges = {
                        health: -1,  // ä¸€çº§é£Ÿç‰©å¯èƒ½è½»å¾®æ‰£ç”Ÿå‘½å€¼
                        hunger: 5     // ä¸€çº§é£Ÿç‰©åŠ çš„é¥±è…¹å€¼å°‘ï¼Œåˆå¹¶åä¸º+4
                    };
                } else if (lvl === 2) {
                    // äºŒçº§é£Ÿç‰©ï¼šç®€å•å¤„ç†è¿‡çš„ï¼Œæ•ˆæœä¸€èˆ¬ï¼Œåˆå¹¶åä¸º+13
                    defaultChanges = {
                        health: 3,
                        hunger: 10
                    };
                } else if (lvl === 3) {
                    // ä¸‰çº§é£Ÿç‰©ï¼šè¾ƒå¥½å¤„ç†çš„ï¼Œæ•ˆæœä¸é”™ï¼Œåˆå¹¶åä¸º+21
                    defaultChanges = {
                        health: 6,
                        hunger: 15
                    };
                } else {
                    // å››çº§é£Ÿç‰©ï¼šç²¾å¿ƒåˆ¶ä½œçš„ï¼Œæ•ˆæœå¾ˆå¥½ï¼Œåˆå¹¶åä¸º+30
                    defaultChanges = {
                        health: 10,
                        hunger: 20
                    };
                }
            } else {
                // å…¶ä»–è¡ŒåŠ¨ï¼šæŒ‰ç­‰çº§æ”¾å¤§
                const factor = 1 + 0.5 * (lvl - 1); // Lv1=1.0, Lv4=2.5
                defaultChanges = {
                    health: Math.round((action.statChanges.health || 0) * factor),
                    hunger: Math.round((action.statChanges.hunger || 0) * factor)
                };
            }
            
            // å…ˆæŒ‰é…æ–¹è¡¨ç”Ÿæˆç‰©èµ„ï¼ˆåˆ¶ä½œå·¥å…·å’Œæ•çŒ/é’“é±¼ï¼‰ï¼Œç„¶åå†è°ƒç”¨AI
            let newItem = null;
            let newItemBlock = '';
            
            // æŒ‰ç±»åˆ«æ¶ˆè€—è¾“å…¥ç‰©èµ„
            if (actionKey === 'craftTool' || actionKey === 'buildShelter') {
                if (tag === 'material') consumeItem(item, 1);
            } else if (actionKey === 'eat') {
                if (tag === 'food') consumeItem(item, item.usesLeft || 1);
            } else if (actionKey === 'huntFish') {
                // æ‰“çŒ/é’“é±¼/ç ä¼ä½¿ç”¨å·¥å…·ï¼Œæ¶ˆè€—1æ¬¡ä½¿ç”¨æ¬¡æ•°
                if (tag === 'tool') consumeItem(item, 1);
            }

            // æŒ‰é…æ–¹è¡¨ç”Ÿæˆç‰©èµ„ï¼ˆåˆ¶ä½œå·¥å…·å’Œæ•çŒ/é’“é±¼ï¼‰
            if (actionKey === 'craftTool') {
                const recipe = findCraftToolRecipe(item);
                if (!recipe) {
                    alert(`æ— æ³•ç”¨ã€${item.text}ã€‘åˆ¶ä½œå·¥å…·ï¼`);
                    actionPoints += 1; // è¿”è¿˜è¡ŒåŠ¨ç‚¹
                    updateDayAndActionUI();
                    return;
                }
                const resultInfo = MATERIAL_DATABASE[recipe.result];
                if (!resultInfo) {
                    alert(`é…æ–¹é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç‰©èµ„ã€${recipe.result}ã€‘çš„ä¿¡æ¯ï¼`);
                    actionPoints += 1; // è¿”è¿˜è¡ŒåŠ¨ç‚¹
                    updateDayAndActionUI();
                    return;
                }
                // äº§ç‰©ç­‰çº§ï¼šä¸¥æ ¼æŒ‰ç…§MATERIAL_DATABASEä¸­å®šä¹‰çš„ç­‰çº§
                const resultLevel = resultInfo.level || 1;
                newItem = {
                    id: getNextWordId(),
                    text: recipe.result,
                    emoji: resultInfo.emoji,
                    tag: resultInfo.tag,
                    level: resultLevel,
                    usesLeft: defaultUses(resultInfo.tag),
                    effects: {}
                };
                playerWords.push(newItem);
                renderWordInventory();
                newItemBlock = `<p style="margin-bottom: 6px;"><strong>è·å¾—ç‰©èµ„ï¼š</strong>${newItem.emoji} ${newItem.text} (Lv${resultLevel}Â·${tagLabel(resultInfo.tag)})</p>`;
            } else if (actionKey === 'huntFish') {
                const recipe = findHuntFishRecipe(item);
                if (!recipe) {
                    alert(`æ— æ³•ç”¨ã€${item.text}ã€‘è¿›è¡Œæ‰“çŒ/é’“é±¼/ç ä¼ï¼`);
                    actionPoints += 1; // è¿”è¿˜è¡ŒåŠ¨ç‚¹
                    updateDayAndActionUI();
                    return;
                }
                const resultInfo = MATERIAL_DATABASE[recipe.result];
                if (!resultInfo) {
                    alert(`é…æ–¹é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç‰©èµ„ã€${recipe.result}ã€‘çš„ä¿¡æ¯ï¼`);
                    actionPoints += 1; // è¿”è¿˜è¡ŒåŠ¨ç‚¹
                    updateDayAndActionUI();
                    return;
                }
                // äº§ç‰©ç­‰çº§ï¼šä¸¥æ ¼æŒ‰ç…§MATERIAL_DATABASEä¸­å®šä¹‰çš„ç­‰çº§
                const resultLevel = resultInfo.level || 1;
                newItem = {
                    id: getNextWordId(),
                    text: recipe.result,
                    emoji: resultInfo.emoji,
                    tag: resultInfo.tag,
                    level: resultLevel,
                    usesLeft: defaultUses(resultInfo.tag),
                    effects: {}
                };
                playerWords.push(newItem);
                renderWordInventory();
                newItemBlock = `<p style="margin-bottom: 6px;"><strong>è·å¾—ç‰©èµ„ï¼š</strong>${newItem.emoji} ${newItem.text} (Lv${resultLevel}Â·${tagLabel(resultInfo.tag)})</p>`;
            }

            // è°ƒç”¨AIç”Ÿæˆè¡ŒåŠ¨æè¿°ï¼ˆåªç”Ÿæˆæè¿°ï¼Œä¸å†³å®šæ•°å€¼å˜åŒ–ï¼‰
            const aiResult = await generateActionDescription(action, item, newItem);
            
            // è¿›é£Ÿè¡ŒåŠ¨ï¼šå®Œå…¨ä½¿ç”¨ç³»ç»Ÿè§„å®šçš„æ•°å€¼ï¼Œä¸ä½¿ç”¨AIè¿”å›çš„æ•°å€¼
            let finalChanges = {};
            if (actionKey === 'eat') {
                finalChanges = {
                    health: defaultChanges.health,
                    hunger: defaultChanges.hunger
                };
                
                // è¿›é£Ÿå¢åŠ è¡ŒåŠ¨ç‚¹ï¼š4çº§é£Ÿç‰©+3ç‚¹ï¼Œ2-3çº§é£Ÿç‰©+2ç‚¹ï¼Œ1çº§é£Ÿç‰©+1ç‚¹
                let actionPointGain = 1;
                if (lvl === 4) {
                    actionPointGain = 3;
                } else if (lvl === 2 || lvl === 3) {
                    actionPointGain = 2;
                } else {
                    actionPointGain = 1;
                }
                actionPoints = Math.min(MAX_ACTION_POINTS, actionPoints + actionPointGain);
                updateDayAndActionUI();
            } else {
                // å…¶ä»–è¡ŒåŠ¨ï¼šä½¿ç”¨AIè¿”å›çš„æ•°å€¼å˜åŒ–ï¼ˆå¦‚æœAIæä¾›äº†ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨ç³»ç»Ÿé»˜è®¤å€¼
                let finalHealthDelta = aiResult.healthDelta !== null ? aiResult.healthDelta : defaultChanges.health;
                let finalHungerDelta = aiResult.hungerDelta !== null ? aiResult.hungerDelta : defaultChanges.hunger;
                
                // æ‰“çŒ/é’“é±¼/ç ä¼è¡ŒåŠ¨ä¸å‡†å¢åŠ é¥±è…¹å€¼
                if (actionKey === 'huntFish' && finalHungerDelta > 0) {
                    finalHungerDelta = 0; // å¼ºåˆ¶è®¾ä¸º0ï¼Œä¸å…è®¸å¢åŠ 
                }
                
                finalChanges = {
                    health: finalHealthDelta,
                    hunger: finalHungerDelta
                };
            }
            const nonZeroChanges = applyStatChanges(finalChanges);
            // è‹¥æ˜¯å»ºé€ åº‡æŠ¤æ‰€ï¼Œåç»­ç”±AIå†³å®šåº‡æŠ¤æå‡
            let shelterChangeText = '';
            
            // æ£€æŸ¥æ˜¯å¦æ­»äº¡
            if (isDead()) {
                showGameOverScreen("åœ¨æ‰§è¡Œè¡ŒåŠ¨åï¼Œä½ çš„çŠ¶æ€å·²ç»è·Œè‡³æé™ï¼Œå†ä¹Ÿæ’‘ä¸ä¸‹å»äº†ã€‚");
                return;
            }
            
            // æ˜¾ç¤ºè¡ŒåŠ¨ç»“æœï¼ˆå…ˆæ˜¾ç¤ºæ•°å€¼å˜åŒ–ï¼‰
            const resultsDiv = document.getElementById('fusion-results');
            const resultCard = document.createElement('div');
            resultCard.className = 'result-card';
            resultCard.style.borderLeftColor = '#22c55e';
            
            // æ„å»ºæ•°å€¼å˜åŒ–æ˜¾ç¤ºæ–‡æœ¬
            const changeTexts = [];
            if (nonZeroChanges.survival !== undefined && nonZeroChanges.survival !== 0) {
                changeTexts.push(`ç”Ÿå­˜çŠ¶æ€å€¼ ${nonZeroChanges.survival > 0 ? '+' : ''}${nonZeroChanges.survival}`);
            }
            // å¦‚æœæ˜¯è¿›é£Ÿè¡ŒåŠ¨ï¼Œæ˜¾ç¤ºè¡ŒåŠ¨ç‚¹å¢åŠ 
            if (actionKey === 'eat') {
                let actionPointGain = 1;
                if (lvl === 4) {
                    actionPointGain = 3;
                } else if (lvl === 2 || lvl === 3) {
                    actionPointGain = 2;
                } else {
                    actionPointGain = 1;
                }
                changeTexts.push(`è¡ŒåŠ¨ç‚¹ +${actionPointGain}`);
            }

            // å¦‚æœæ˜¯åº‡æŠ¤æå‡ï¼Œå…ˆè¯»å–AIè¿”å›çš„æå‡å¹…åº¦å¹¶æ›´æ–°shelterChangeText
            if (action.improveShelter && aiResult) {
                // åˆå¹¶sturdyDeltaå’ŒrainDeltaä¸ºshelterDurabilityDelta
                const sturdyDelta = aiResult.sturdyDelta ? parseInt(aiResult.sturdyDelta, 10) : 0;
                const rainDelta = aiResult.rainDelta ? parseInt(aiResult.rainDelta, 10) : 0;
                const shelterDurabilityDelta = (isNaN(sturdyDelta) ? 0 : sturdyDelta) + (isNaN(rainDelta) ? 0 : rainDelta);
                
                if (shelterDurabilityDelta !== 0) {
                    shelterDurability = Math.max(0, Math.min(100, shelterDurability + shelterDurabilityDelta));
                    updateBaseStatsUI(); // ç°åœ¨è¿™ä¸ªå‡½æ•°ä¹Ÿæ›´æ–°åº‡æŠ¤æ‰€UI
                    shelterChangeText = ` | åº‡æŠ¤æ‰€åšå›ºå€¼${shelterDurabilityDelta > 0 ? '+' : ''}${shelterDurabilityDelta}`;
                }
            }

            // ä¸ºä¿®å»ºåº‡æŠ¤æ‰€ç”Ÿæˆå”¯ä¸€çš„å›¾ç‰‡ID
            const shelterImageId = actionKey === 'buildShelter' ? `shelter-image-${Date.now()}` : null;
            
            resultCard.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 24px;">${action.emoji}</span>
                    <span style="font-size: 18px; font-weight: 500;">${action.name}</span>
                </div>
                <p style="margin-bottom: 8px;">
                    <strong>ä½¿ç”¨ç‰©èµ„ï¼š</strong>${item.emoji} ${item.text}
                </p>
                ${newItemBlock}
                <p style="margin-bottom: 8px; color: #4cc9f0;">
                    <strong>æ•°å€¼å˜åŒ–ï¼š</strong>${changeTexts.join('ï¼Œ')}${shelterChangeText}
                </p>
                ${shelterImageId ? `<div id="${shelterImageId}" style="margin: 12px 0; border-radius: 8px; overflow: hidden;"></div>` : ''}
                <div id="action-ai-feedback-${Date.now()}" style="margin-top: 8px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 8px; font-size: 0.9em; opacity: 0.8;">æ­£åœ¨ç”Ÿæˆè¡ŒåŠ¨æè¿°...</p>
                </div>
                <div style="text-align: right; font-size: 12px; opacity: 0.7; margin-top: 8px;">
                    ${new Date().toLocaleTimeString()}
                </div>
            `;
            
            resultsDiv.prepend(resultCard);
            const feedbackEl = resultCard.querySelector(`[id^="action-ai-feedback-"]`);

            // æ˜¾ç¤ºAIæè¿°
            try {
                const aiDescription = aiResult && aiResult.description ? aiResult.description : '';
                if (feedbackEl) {
                    feedbackEl.innerHTML = `
                        <p style="line-height: 1.6;"><strong>è¡ŒåŠ¨è¿‡ç¨‹ï¼š</strong>${aiDescription}</p>
                    `;
                }
                
                // å¦‚æœæ˜¯ä¿®å»ºåº‡æŠ¤æ‰€ï¼Œç”Ÿæˆå›¾ç‰‡
                if (actionKey === 'buildShelter' && shelterImageId && aiDescription) {
                    // å¼‚æ­¥ç”Ÿæˆå›¾ç‰‡ï¼Œä¸é˜»å¡ä¸»æµç¨‹
                    setTimeout(() => {
                        generateAndDisplayImageForShelter(item.text, aiDescription, shelterImageId);
                    }, 500);
                }
            } catch (error) {
                console.error('ç”Ÿæˆè¡ŒåŠ¨æè¿°å¤±è´¥:', error);
                if (feedbackEl) {
                    feedbackEl.innerHTML = `
                        <p style="opacity: 0.7;">ä½ å®Œæˆäº†è¿™æ¬¡è¡ŒåŠ¨ï¼Œè™½ç„¶è¿‡ç¨‹æœ‰äº›æ¨¡ç³Šï¼Œä½†ç»“æœå·²ç»ä½“ç°åœ¨æ•°å€¼å˜åŒ–ä¸­ã€‚</p>
                    `;
            }
        }
            
            // æ¢å¤è¡ŒåŠ¨æŒ‰é’®çŠ¶æ€ï¼ˆåœ¨æ¸…ç©ºèœå•ä¹‹å‰ï¼‰
            actionButtons.forEach((btn, index) => {
                if (originalButtonStates[index]) {
                    btn.disabled = originalButtonStates[index].disabled;
                    btn.innerHTML = originalButtonStates[index].innerHTML;
                    btn.style.opacity = originalButtonStates[index].opacity || '1';
                    btn.style.cursor = originalButtonStates[index].cursor || 'pointer';
                }
            });
            
            // æ¸…ç©ºè¡ŒåŠ¨æ§½ä½å’Œèœå•
            // å–æ¶ˆè¡ŒåŠ¨æ§½ä½ç‰©èµ„çš„ä½¿ç”¨æ ‡è®°
            if (actionSlotItem) {
                usedWordIds.delete(actionSlotItem.id);
            }
            actionSlotItem = null;
            const actionSlot = document.getElementById('action-slot');
            if (actionSlot) {
                actionSlot.innerHTML = 'æ‹–æ”¾ç‰©èµ„åˆ°æ­¤å¤„';
            }
            const menuEl = document.getElementById('action-menu');
            if (menuEl) {
                menuEl.style.display = 'none';
                menuEl.innerHTML = '';
            }
        }

        // è°ƒç”¨AIç”Ÿæˆè¡ŒåŠ¨æè¿°ï¼ˆå¿…è¦æ—¶è¿”å›ç‰©èµ„åï¼‰
        async function generateActionDescription(action, item, resultItem = null) {
            try {
                // æ„å»ºç³»ç»Ÿæç¤ºè¯
                let systemPrompt = `ä½ æ˜¯ä¸€ä¸ªè’å²›æ±‚ç”Ÿæ¸¸æˆçš„å™äº‹è€…ã€‚
è¯·è¿”å›JSONï¼Œæ ¼å¼ï¼š
{
  "description": "50-80å­—è¡ŒåŠ¨è¿‡ç¨‹æè¿°",
  "healthDelta": "æ•´æ•°ï¼Œå¯æ­£å¯è´Ÿï¼Œè¡¨ç¤ºç”Ÿå‘½å€¼å˜åŒ–ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸æä¾›åˆ™ä½¿ç”¨ç³»ç»Ÿé»˜è®¤å€¼ï¼Œä¼šä¸hungerDeltaåˆå¹¶ä¸ºç”Ÿå­˜çŠ¶æ€å€¼å˜åŒ–ï¼‰",
  "hungerDelta": "æ•´æ•°ï¼Œå¯æ­£å¯è´Ÿï¼Œè¡¨ç¤ºé¥±è…¹å€¼å˜åŒ–ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸æä¾›åˆ™ä½¿ç”¨ç³»ç»Ÿé»˜è®¤å€¼ï¼Œä¼šä¸healthDeltaåˆå¹¶ä¸ºç”Ÿå­˜çŠ¶æ€å€¼å˜åŒ–ï¼‰",
  "sturdyDelta": "æ•´æ•°ï¼Œå¯æ­£å¯è´Ÿï¼Œè¡¨ç¤ºåº‡æŠ¤åšå›ºå€¼å˜åŒ–ï¼ˆä»…ä¿®å»ºåº‡æŠ¤æ‰€æ—¶éœ€è¦ï¼Œä¼šä¸rainDeltaåˆå¹¶ä¸ºåº‡æŠ¤æ‰€åšå›ºå€¼å˜åŒ–ï¼‰",
  "rainDelta": "æ•´æ•°ï¼Œå¯æ­£å¯è´Ÿï¼Œè¡¨ç¤ºé˜²é›¨å€¼å˜åŒ–ï¼ˆä»…ä¿®å»ºåº‡æŠ¤æ‰€æ—¶éœ€è¦ï¼Œä¼šä¸sturdyDeltaåˆå¹¶ä¸ºåº‡æŠ¤æ‰€åšå›ºå€¼å˜åŒ–ï¼‰"
}
é‡è¦è§„åˆ™ï¼š
- å¯¹äº"åˆ¶ä½œå·¥å…·"è¡ŒåŠ¨ï¼šæè¿°ç©å®¶å¦‚ä½•ä½¿ç”¨ã€${item.text}ã€‘åˆ¶ä½œå‡ºã€${resultItem ? resultItem.text : 'å·¥å…·'}ã€‘çš„è¿‡ç¨‹ã€‚
- å¯¹äº"æ‰“çŒ/é’“é±¼/ç ä¼"è¡ŒåŠ¨ï¼šæè¿°ç©å®¶å¦‚ä½•ä½¿ç”¨ã€${item.text}ã€‘è¿›è¡Œè¡ŒåŠ¨ï¼Œè·å¾—ã€${resultItem ? resultItem.text : 'ç‰©èµ„'}ã€‘çš„è¿‡ç¨‹ã€‚
  * å…³é”®ï¼šå¿…é¡»æ ¹æ®ä½¿ç”¨çš„å·¥å…·ç±»å‹å’Œè·å¾—çš„ç‰©èµ„ç±»å‹æ¥ç”Ÿæˆåˆç†çš„æè¿°ï¼
  * å¦‚æœä½¿ç”¨æ–§å­ç±»å·¥å…·è·å¾—"åŸææ–™"ï¼ˆå¦‚æœ¨æ£ã€çŸ³å¤´ã€æœ¨æ¿ç­‰ï¼‰ï¼Œå¿…é¡»æè¿°ç ä¼æ ‘æœ¨ã€æŒ–æ˜çŸ³å¤´ç­‰è·å–åŸææ–™çš„è¿‡ç¨‹ï¼Œåœºæ™¯åº”è¯¥åœ¨æ£®æ—ã€çŸ³åœºç­‰ã€‚
  * å¦‚æœä½¿ç”¨çŸ›/åˆ€ç±»å·¥å…·è·å¾—"å…½è‚‰ç±»é£Ÿç‰©"ï¼ˆå¦‚ç”Ÿè‚‰ã€å°å…½è‚‰ã€çƒ¤å…½è‚‰ç­‰ï¼‰ï¼Œå¿…é¡»æè¿°åœ¨ä¸›æ—ã€æ£®æ—ä¸­æ‰“çŒå°å‹åŠ¨ç‰©ï¼ˆå¦‚é‡å…”ã€é¸Ÿç±»ç­‰ï¼‰çš„è¿‡ç¨‹ï¼Œåœºæ™¯åº”è¯¥åœ¨ä¸›æ—ã€æ£®æ—ç­‰ã€‚
  * å¦‚æœä½¿ç”¨é±¼å‰/æ¸”ç½‘ç±»å·¥å…·è·å¾—"é±¼ç±»é£Ÿç‰©"ï¼ˆå¦‚ç”Ÿé±¼ã€å¤§å—é±¼è‚‰ç­‰ï¼‰ï¼Œå¿…é¡»æè¿°åœ¨æ²³æµã€æµ·è¾¹æ•é±¼çš„è¿‡ç¨‹ï¼Œåœºæ™¯åº”è¯¥åœ¨æ°´è¾¹ã€æµ·è¾¹ç­‰ã€‚
  * æè¿°å¿…é¡»ä¸å·¥å…·ç±»å‹å’Œè·å¾—çš„ç‰©èµ„å®Œå…¨åŒ¹é…ï¼Œä¸èƒ½å‡ºç°"ä½¿ç”¨æœ¨çŸ›åœ¨ä¸›æ—é‡Œæ•æ‰ç”Ÿé±¼"è¿™ç§ä¸åˆç†çš„æƒ…å†µã€‚
  * é‡è¦ï¼šæ‰“çŒ/é’“é±¼/ç ä¼è¡ŒåŠ¨ä¼šæ¶ˆè€—ä½“åŠ›å’Œç”Ÿå­˜çŠ¶æ€ï¼ŒhungerDeltaå¿…é¡»æ˜¯0æˆ–è´Ÿæ•°ï¼Œä¸èƒ½æ˜¯æ­£æ•°ï¼ˆä¸èƒ½å¢åŠ ç”Ÿå­˜çŠ¶æ€å€¼ï¼‰ã€‚
- å¯¹äº"ä¿®å»ºåº‡æŠ¤æ‰€"è¡ŒåŠ¨ï¼šæè¿°ç©å®¶å¦‚ä½•ä½¿ç”¨ã€${item.text}ã€‘ä¿®å»ºæˆ–åŠ å›ºåº‡æŠ¤æ‰€çš„è¿‡ç¨‹ã€‚æ ¹æ®ç‰©èµ„çš„ç±»å‹ã€ç­‰çº§å’Œåç§°ï¼Œåˆç†è¯„åˆ¤å¯¹åº‡æŠ¤æ‰€çš„æ”¹å–„æ•ˆæœï¼š
  * ç‰©èµ„ç±»å‹ï¼šå·¥å…·ç±»ç‰©èµ„é€šå¸¸èƒ½æä¾›æ›´å¥½çš„åšå›ºå€¼ï¼ŒåŸææ–™ç±»ç‰©èµ„å¯èƒ½æ›´é€‚åˆé˜²é›¨
  * ç‰©èµ„ç­‰çº§ï¼šç­‰çº§è¶Šé«˜ï¼Œæ”¹å–„æ•ˆæœè¶Šå¥½ï¼ˆLv1: 5-10, Lv2: 10-15, Lv3: 15-20, Lv4: 20-25ï¼‰
  * ç‰©èµ„åç§°ï¼šæ ¹æ®ç‰©èµ„çš„å®é™…ç”¨é€”åˆ¤æ–­ï¼ˆå¦‚"æœ¨æ¿"å¯èƒ½æ›´åå‘åšå›ºå€¼ï¼Œ"ç²—ç»³"å¯èƒ½æ›´åå‘é˜²é›¨å€¼ï¼Œ"ç¯ç«"å¯èƒ½ä¸¤è€…éƒ½æœ‰ï¼‰
  * å¿…é¡»ç»™å‡ºåˆç†çš„ sturdyDelta å’Œ rainDeltaï¼ˆèŒƒå›´ 0 åˆ° +25ï¼Œæ ¹æ®ç‰©èµ„ç‰¹æ€§åˆ†é…ï¼Œæ€»å’Œä¸è¶…è¿‡ç‰©èµ„ç­‰çº§*8ï¼Œç³»ç»Ÿä¼šå°†ä¸¤è€…åˆå¹¶ä¸ºåº‡æŠ¤æ‰€åšå›ºå€¼å˜åŒ–ï¼‰
- å¯¹äº"è¿›é£Ÿ"è¡ŒåŠ¨ï¼šæè¿°ç©å®¶å¦‚ä½•å¤„ç†å¹¶é£Ÿç”¨ã€${item.text}ã€‘çš„è¿‡ç¨‹ã€‚æ³¨æ„ï¼šæ•°å€¼å˜åŒ–ç”±ç³»ç»Ÿè§„å®šï¼ŒAIåªéœ€è¦ç”Ÿæˆæè¿°ï¼Œä¸éœ€è¦è¿”å›healthDeltaå’ŒhungerDeltaã€‚
- å¯¹äºå…¶ä»–è¡ŒåŠ¨ï¼šhealthDelta å’Œ hungerDelta æ˜¯å¯é€‰çš„ï¼Œå¦‚æœä¸æä¾›åˆ™ä½¿ç”¨ç³»ç»Ÿé»˜è®¤å€¼ã€‚ç³»ç»Ÿä¼šå°†healthDeltaå’ŒhungerDeltaåˆå¹¶ä¸ºç”Ÿå­˜çŠ¶æ€å€¼å˜åŒ–ã€‚`;

                let userPrompt = `è¡ŒåŠ¨ç±»å‹ï¼š${action.name}ï¼ˆ${action.description}ï¼‰
ä½¿ç”¨çš„ç‰©èµ„ï¼š${item.text} (Lv${item.level || 1}Â·${tagLabel(item.tag)})
${resultItem ? `è·å¾—çš„ç‰©èµ„ï¼š${resultItem.text} (Lv${resultItem.level || 1}Â·${tagLabel(resultItem.tag)})` : ''}
${resultItem && action.name === 'æ‰“çŒ/é’“é±¼/ç ä¼' ? `\né‡è¦ï¼šä½¿ç”¨çš„å·¥å…·æ˜¯ã€${item.text}ã€‘ï¼Œè·å¾—çš„ç‰©èµ„æ˜¯ã€${resultItem.text}ã€‘ã€‚è¯·æ ¹æ®å·¥å…·ç±»å‹å’Œç‰©èµ„ç±»å‹ç”Ÿæˆåˆç†çš„æè¿°ï¼š
- å¦‚æœå·¥å…·æ˜¯æ–§å­ç±»ä¸”è·å¾—åŸææ–™ï¼Œæè¿°ç ä¼/æŒ–æ˜è¿‡ç¨‹ï¼ˆåœºæ™¯ï¼šæ£®æ—ã€çŸ³åœºï¼‰
- å¦‚æœå·¥å…·æ˜¯çŸ›/åˆ€ç±»ä¸”è·å¾—å…½è‚‰ç±»é£Ÿç‰©ï¼Œæè¿°æ‰“çŒè¿‡ç¨‹ï¼ˆåœºæ™¯ï¼šä¸›æ—ã€æ£®æ—ï¼‰
- å¦‚æœå·¥å…·æ˜¯é±¼å‰/æ¸”ç½‘ç±»ä¸”è·å¾—é±¼ç±»é£Ÿç‰©ï¼Œæè¿°æ•é±¼è¿‡ç¨‹ï¼ˆåœºæ™¯ï¼šæ°´è¾¹ã€æµ·è¾¹ï¼‰
ä¸è¦å‡ºç°å·¥å…·ç±»å‹ä¸åœºæ™¯ä¸åŒ¹é…çš„æƒ…å†µï¼ˆå¦‚ç”¨æœ¨çŸ›åœ¨ä¸›æ—æ•é±¼ï¼‰ã€‚` : ''}
${action.aiPrompt}
è¯·ç”¨JSONæ ¼å¼å›ç­”ã€‚`;

                const response = await fetch(LLM_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${LLM_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: LLM_MODEL_NAME,
                        messages: [
                            {
                                role: "system",
                                content: systemPrompt
                            },
                            {
                                role: "user",
                                content: userPrompt
                            }
                        ],
                        temperature: 0.8,
                        response_format: { "type": "json_object" }
                    })
                });
                
                if (!response.ok) throw new Error(`AIæè¿°ç”Ÿæˆå¤±è´¥: ${response.status}`);
                const data = await response.json();
                const parsed = JSON.parse(data.choices[0].message.content);
                
                // å¦‚æœAIæä¾›äº†æ•°å€¼å˜åŒ–ï¼Œä½¿ç”¨AIçš„å€¼ï¼›å¦åˆ™ä½¿ç”¨ç³»ç»Ÿé»˜è®¤å€¼
                const healthDelta = parsed.healthDelta !== undefined ? parseInt(parsed.healthDelta, 10) : null;
                const hungerDelta = parsed.hungerDelta !== undefined ? parseInt(parsed.hungerDelta, 10) : null;
                
                return {
                    description: parsed.description || '',
                    healthDelta: healthDelta,
                    hungerDelta: hungerDelta,
                    sturdyDelta: parsed.sturdyDelta ? parseInt(parsed.sturdyDelta, 10) : 0,
                    rainDelta: parsed.rainDelta ? parseInt(parsed.rainDelta, 10) : 0
                };
            } catch (error) {
                console.error('ç”Ÿæˆè¡ŒåŠ¨æè¿°å¤±è´¥:', error);
                return {
                    description: `ä½ ç”¨${item.text}å®Œæˆäº†${action.name}ï¼Œè™½ç„¶è¿‡ç¨‹è‰°éš¾ï¼Œä½†æ€»ç®—æœ‰æ‰€æ”¶è·ã€‚`,
                    healthDelta: null,
                    hungerDelta: null,
                    sturdyDelta: 0,
                    rainDelta: 0
                };
            }
        }
        
        // ============== æ ¸å¿ƒåˆæˆåŠŸèƒ½ ==============
        async function performFusion() {
            const [word1, word2] = selectedWords;
            
            if (!word1 || !word2) {
                alert('è¯·é€‰æ‹©ä¸¤ä¸ªç‰©èµ„è¿›è¡Œåˆæˆï¼');
                return;
            }
            if (fusionLeft <= 0) {
                alert('æœ¬è½®åˆæˆæ¬¡æ•°å·²ç”¨å°½ï¼Œè¯·å…ˆæƒ³åŠæ³•é€šè¿‡å½“å‰æŒ‘æˆ˜ï¼');
                return;
            }
            if (actionPoints <= 0) {
                alert('ä»Šæ—¥è¡ŒåŠ¨ç‚¹å·²ç”¨å®Œï¼Œæ— æ³•å†è¿›è¡Œç‰©èµ„åˆæˆã€‚è¯·ç»“æŸä»Šå¤©ã€‚');
                return;
            }
            
            // æŸ¥æ‰¾é…æ–¹
            const recipe = findRecipe(word1, word2);
            if (!recipe) {
                alert(`ã€${word1.text}ã€‘å’Œã€${word2.text}ã€‘æ— æ³•åˆæˆï¼è¯·æŸ¥çœ‹åˆæˆé…æ–¹è¡¨ã€‚`);
                return;
            }
            
            // è·å–ç»“æœç‰©èµ„ä¿¡æ¯
            const resultInfo = MATERIAL_DATABASE[recipe.result];
            if (!resultInfo) {
                alert(`é…æ–¹é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç‰©èµ„ã€${recipe.result}ã€‘çš„ä¿¡æ¯ï¼`);
                return;
        }

            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const fusionBtn = document.querySelector('.fusion-btn[onclick="performFusion()"]');
            const originalText = fusionBtn ? fusionBtn.innerHTML : '';
            if (fusionBtn) {
                fusionBtn.disabled = true;
                fusionBtn.innerHTML = 'â³ åˆæˆä¸­...';
                fusionBtn.style.opacity = '0.6';
                fusionBtn.style.cursor = 'not-allowed';
            }
            
            // æ¶ˆè€—ä¸€æ¬¡åˆæˆæ¬¡æ•°ä¸è¡ŒåŠ¨ç‚¹
            fusionLeft -= 1;
            actionPoints -= 1;
            updateFusionLeftDisplay();
            updateDayAndActionUI();
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const resultsDiv = document.getElementById('fusion-results');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'result-card';
            loadingDiv.innerHTML = `<div style="text-align: center;">ğŸ”§ æ­£åœ¨å°è¯•åˆæˆæ–°çš„ç‰©èµ„...</div>`;
            resultsDiv.prepend(loadingDiv);
            
            try {
                // è°ƒç”¨å¤§æ¨¡å‹APIï¼šåªç”Ÿæˆæè¿°å’Œå›¾ç‰‡ï¼Œä¸å†³å®šåˆæˆç»“æœ
                const result = await callLLMFusionAPI(
                    word1.text,
                    word2.text,
                    recipe.result
                );
                
                // ç§»é™¤åŠ è½½çŠ¶æ€
                resultsDiv.removeChild(loadingDiv);
                
                // å°†æ–°ç‰©èµ„åŠ å…¥åº“å­˜ï¼ˆä½¿ç”¨é…æ–¹è¡¨çš„ç»“æœï¼‰
                const newWord = {
                    id: getNextWordId(),
                    text: recipe.result,
                    emoji: resultInfo.emoji,
                    tag: resultInfo.tag,
                    level: resultInfo.level,
                    usesLeft: defaultUses(resultInfo.tag),
                    effects: {}
                };
                playerWords.push(newWord);
                renderWordInventory();

                // æ¶ˆè€—åŸææ–™/é£Ÿç‰©/ä¿¡å·çš„ä½¿ç”¨æ¬¡æ•°
                // å¦‚æœæ˜¯å·¥å…·ç±»ç‰©èµ„åˆæˆï¼ˆä¸¤ä¸ªç›¸åŒå·¥å…·åˆæˆæ›´é«˜çº§å·¥å…·ï¼‰ï¼Œç›´æ¥æ¶ˆè€—åˆ°0ï¼ˆç§»é™¤ï¼‰
                const isToolFusion = word1.tag === 'tool' && word2.tag === 'tool' && word1.text === word2.text;
                if (isToolFusion) {
                    // ä¸¤ä¸ªå®Œå…¨ç›¸åŒçš„å·¥å…·åˆæˆæ—¶ï¼Œç›´æ¥æ¶ˆè€—åˆ°0ï¼ˆç§»é™¤ï¼‰
                    playerWords = playerWords.filter(w => w.id !== word1.id && w.id !== word2.id);
                    renderWordInventory();
                } else {
                    // éå·¥å…·åˆæˆæˆ–ä¸åŒå·¥å…·åˆæˆï¼ŒæŒ‰åŸé€»è¾‘æ¶ˆè€—
                    consumeItem(word1, 1);
                    consumeItem(word2, 1);
                }
                
                // ä½¿ç”¨æœ€ç»ˆåç§°æ„é€ ç”¨äºå±•ç¤ºçš„åˆæˆç»“æœï¼Œç¡®ä¿ä¸èµ„æºåº“ä¸€è‡´
                const displayResult = {
                    word1: word1.text,
                    word2: word2.text,
                    itemName: recipe.result,
                    itemType: getTagDisplayName(resultInfo.tag),
                    useDescription: result.useDescription,
                    note: result.note || ''
                };
                
                // æ˜¾ç¤ºç»“æœ
                displayFusionResult(displayResult);
                
                // æ¸…ç©ºåˆæˆæ§½ä½
                resetSlots();
            } catch (error) {
                console.error('åˆæˆå¤±è´¥:', error);
                loadingDiv.innerHTML = `<div style="color: #ff6b6b;">âŒ åˆæˆå¤±è´¥: ${error.message}</div>`;
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (fusionBtn) {
                    fusionBtn.disabled = false;
                    fusionBtn.innerHTML = originalText;
                    fusionBtn.style.opacity = '1';
                    fusionBtn.style.cursor = 'pointer';
        }
            }
        }
        
        // 1. ä½ çš„APIæœåŠ¡å•†æä¾›çš„çœŸå®è¯·æ±‚åœ°å€
        const LLM_API_URL = 'https://api.siliconflow.cn/v1/chat/completions'; 
        // 2. ä½ çš„APIæœåŠ¡å•†æä¾›çš„å¯†é’¥
        const LLM_API_KEY = 'sk-qmqcbvermnhrnqanznlmlfqkwxvijjzfjftflxrhsahmttfa'; 
        // 3. æŒ‡å®šä½¿ç”¨çš„æ¨¡å‹ï¼Œä¾‹å¦‚ 'deepseek-chat', 'gpt-3.5-turbo' ç­‰ï¼Œæ ¹æ®æœåŠ¡å•†æ”¯æŒå¡«å†™
        const LLM_MODEL_NAME = 'deepseek-ai/DeepSeek-R1-0528-Qwen3-8B';

        // ============== æ ¸å¿ƒAPIè°ƒç”¨å‡½æ•° ==============
        async function callLLMFusionAPI(word1, word2, resultName) {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆå¯é€‰ï¼Œæå‡ä½“éªŒï¼‰
            console.log(`ğŸ”„ æ­£åœ¨è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆæè¿°: ${word1} + ${word2} = ${resultName}`);

            const requestBody = {
                model: LLM_MODEL_NAME, // ä½¿ç”¨é…ç½®çš„æ¨¡å‹å
                messages: [
                    {
                        role: "system",
                        content: `ä½ æ˜¯ä¸€ä¸ª"è’å²›æ±‚ç”Ÿ"æ¸¸æˆçš„æè¿°ç”Ÿæˆå™¨ã€‚
                        ç©å®¶å·²ç»é€šè¿‡é…æ–¹è¡¨ç¡®å®šäº†åˆæˆç»“æœï¼šã€${resultName}ã€‘ã€‚
                        ä½ çš„ä»»åŠ¡æ˜¯ï¼šæ ¹æ®ç©å®¶ä½¿ç”¨çš„ä¸¤ç§ç‰©èµ„ã€${word1}ã€‘å’Œã€${word2}ã€‘ï¼Œç”Ÿæˆä¸€æ®µç”ŸåŠ¨çš„æè¿°ï¼Œè¯´æ˜ç©å®¶æ˜¯å¦‚ä½•åœ¨è’å²›ä¸Šé€šè¿‡å®é™…æ“ä½œå¾—åˆ°ã€${resultName}ã€‘çš„ã€‚
                        
                        è¦æ±‚ï¼š
                        1. æè¿°è¦çœŸå®ã€å…·ä½“ï¼Œç¬¦åˆè’å²›æ±‚ç”Ÿåœºæ™¯
                        2. é‡ç‚¹æè¿°ç©å®¶å¦‚ä½•åˆ©ç”¨ã€${word1}ã€‘å’Œã€${word2}ã€‘ä¸€æ­¥æ­¥åˆ¶ä½œæˆ–å¤„ç†å¾—åˆ°ã€${resultName}ã€‘çš„è¿‡ç¨‹
                        3. ä¸è¦å‡ºç°é­”æ³•æˆ–è¶…è‡ªç„¶ç°è±¡ï¼Œè¦ç¬¦åˆç‰©ç†é€»è¾‘
                        4. æè¿°é•¿åº¦1-3å¥è¯å³å¯
                        
                        è¯·ä¸¥æ ¼è¿”å›ä»¥ä¸‹JSONæ ¼å¼ï¼š
                        {
                            "useDescription": "ç”¨1-3å¥è¯ï¼Œå…·ä½“æè¿°ç©å®¶æ˜¯æ€ä¹ˆç”¨ã€${word1}ã€‘å’Œã€${word2}ã€‘åŠ¨æ‰‹æ“ä½œï¼Œæœ€ç»ˆå¾—åˆ°ã€${resultName}ã€‘çš„å…¨è¿‡ç¨‹",
                            "note": "å¯é€‰çš„ä¸€å¥è¯´æ˜ï¼šè¿™ä¸ªã€${resultName}ã€‘åœ¨è’å²›ç”Ÿå­˜ä¸­ä¸»è¦èƒ½å¸®ä¸Šä»€ä¹ˆå¿™"
                        }`
                    },
                    {
                        role: "user",
                        content: `ç©å®¶ä½¿ç”¨ã€${word1}ã€‘å’Œã€${word2}ã€‘åˆæˆå‡ºäº†ã€${resultName}ã€‘ã€‚
                        è¯·ç”Ÿæˆåˆæˆè¿‡ç¨‹çš„æè¿°ã€‚`
                    }
                ],
                temperature: 0.8, // æ§åˆ¶åˆ›æ„ç¨‹åº¦ (0-1)ï¼Œ0.8æ¯”è¾ƒæœ‰åˆ›æ„
                // å¤šæ•°æœåŠ¡å•†è¦æ±‚å°†è¿”å›æ ¼å¼è®¾ä¸ºJSONï¼Œä½†å‚æ•°åå¯èƒ½æ˜¯ response_format æˆ–å…¶å®ƒï¼Œè¯·æŸ¥é˜…æ–‡æ¡£
                response_format: { "type": "json_object" }
        };

    try {
        // å‘é€è¯·æ±‚åˆ°ä»£ç†æœåŠ¡
        const response = await fetch(LLM_API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // å¤§å¤šæ•°æœåŠ¡å•†ç”¨ 'Authorization' å¤´ä¼ é€’å¯†é’¥ï¼Œæ ¼å¼å¯èƒ½æ˜¯ 'Bearer KEY' æˆ–ç›´æ¥æ˜¯KEY
                'Authorization': `Bearer ${LLM_API_KEY}`,
                // æŸäº›æœåŠ¡å•†å¯èƒ½æœ‰è‡ªå®šä¹‰å¤´éƒ¨ï¼Œå¦‚ 'api-key'ï¼Œè¯·ä»¥æœåŠ¡å•†æ–‡æ¡£ä¸ºå‡†
                // 'api-key': LLM_API_KEY
            },
            body: JSON.stringify(requestBody)
        });

        // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`APIè¯·æ±‚å¤±è´¥ (çŠ¶æ€ç : ${response.status}): ${errorText}`);
        }

        // è§£æè¿”å›çš„JSONæ•°æ®
        const data = await response.json();
        
        // é‡è¦ï¼šä»è¿”å›ç»“æ„ä¸­æå–å†…å®¹ã€‚ä¸åŒæœåŠ¡å•†æ•°æ®ç»“æ„ä¸åŒï¼
        // å¸¸è§æ ¼å¼1: data.choices[0].message.content (OpenAI/DeepSeekå…¼å®¹æ ¼å¼)
        // å¸¸è§æ ¼å¼2: data.result æˆ– data.content
        let resultContent = data.choices[0].message.content; // è¿™æ˜¯æœ€å¸¸è§çš„è·¯å¾„
        
        // å°è¯•è§£æcontentä¸­çš„JSONå­—ç¬¦ä¸²
        const parsedResult = JSON.parse(resultContent);
        
        // å°†è§£æç»“æœä¸ä½ åŸæœ‰çš„æ¸¸æˆæ•°æ®ç»“æ„å¯¹é½å¹¶è¿”å›
        return {
            useDescription: parsedResult.useDescription || `ä½ ä½¿ç”¨ã€${word1}ã€‘å’Œã€${word2}ã€‘åˆ¶ä½œå‡ºäº†ã€${resultName}ã€‘ã€‚`,
            note: parsedResult.note || ''
        };

    } catch (error) {
        console.error('âŒ è°ƒç”¨å¤§æ¨¡å‹APIæ—¶å‘ç”Ÿé”™è¯¯:', error);
        // æä¾›ä¸€ä¸ªå‹å¥½çš„é”™è¯¯å›é€€ï¼Œé˜²æ­¢æ¸¸æˆå¡ä½
        return {
            useDescription: `ä½ ä½¿ç”¨ã€${word1}ã€‘å’Œã€${word2}ã€‘åˆ¶ä½œå‡ºäº†ã€${resultName}ã€‘ã€‚`,
            note: `AI æè¿°ç”Ÿæˆå‡ºé”™ï¼š${error.message}ï¼Œä¸‹æ¬¡ç½‘ç»œçŠ¶å†µå¥½ç‚¹å†è¯•è¯•ã€‚`
        };
    }
}
        // ============== ç»“æœå±•ç¤º ==============
        function displayFusionResult(result) {
            const resultsDiv = document.getElementById('fusion-results');
            const uniqueImageId = 'image-' + Date.now();
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result-card';
            
            resultDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 24px;">${result.word1}</span>
                    <span style="font-size: 20px;">+</span>
                    <span style="font-size: 24px;">${result.word2}</span>
                    <span style="font-size: 20px;">â†’</span>
                    <span style="font-size: 28px; color: #4cc9f0;">${result.itemName}</span>
                </div>
                <p style="margin: 6px 0 2px 0;">${result.useDescription}</p>
                ${result.note ? `<p style="font-size:0.85em; opacity:0.9; margin-top:4px;">æç¤ºï¼š${result.note}</p>` : ''}
                <div id="${uniqueImageId}" style="text-align: center; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 5px; margin: 10px 0;">
            <div style="display: inline-block; padding: 20px; background: linear-gradient(45deg, #f72585, #4361ee); border-radius: 50%; margin: 10px;">
                â³
            </div>
                    <p><small>æ­£åœ¨ç”Ÿæˆâ€œ${result.itemName}â€çš„è§†è§‰å½¢è±¡...</small></p>
            </div>
                <div style="text-align: right; font-size: 12px; opacity: 0.7;">
                    ${new Date().toLocaleTimeString()}
                </div>
            `;
            
            resultsDiv.prepend(resultDiv);
            fusionResults.push(result);
            
            // å¦‚æœç»“æœå¤ªå¤šï¼Œç§»é™¤æ—§çš„
            if (fusionResults.length > 10) {
                fusionResults.shift();
                if (resultsDiv.children.length > 10) {
                    resultsDiv.removeChild(resultsDiv.lastChild);
                }
            }
            
            // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨çš„IDå¿…é¡»å’Œä¸Šé¢å ä½ç¬¦çš„IDå®Œå…¨ä¸€è‡´
            generateAndDisplayImage(result.itemName, result.useDescription || result.note, uniqueImageId);
        }
        
                // ============== æ ¸å¿ƒç”Ÿå›¾APIè°ƒç”¨å‡½æ•° ==============
        async function generateAndDisplayImage(name, description, placeholderId) {
            const placeholder = document.getElementById(placeholderId);
            if (!placeholder) {
                console.error('æ‰¾ä¸åˆ°å›¾ç‰‡å ä½ç¬¦:', placeholderId);
                return;
            }

            // æ›´æ–°å ä½ç¬¦å†…å®¹ä¸ºåŠ è½½çŠ¶æ€
            placeholder.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p>ğŸ¨ æ­£åœ¨ç»˜åˆ¶â€œ${name}â€...</p>
                </div>
            `;

            // æ„å»ºç”Ÿå›¾è¯·æ±‚ã€‚æ³¨æ„ï¼šä¸åŒæœåŠ¡å•†çš„è¯·æ±‚ä½“æ ¼å¼å¯èƒ½ä¸åŒï¼
            const requestBody = {
                model: IMG_MODEL,
                prompt: createImagePrompt(name, description, 'åˆæˆç‰©èµ„'), // ä½¿ç”¨å·¥å…·å‡½æ•°åˆ›å»ºprompt
                n: 1, // ç”Ÿæˆ1å¼ æ¨ªç‰ˆå›¾
                size: "768x512", // æ”¹ä¸ºæ¨ªå‘é•¿æ–¹å½¢æ¯”ä¾‹ï¼Œæ›´åƒå…³å¡/ç‰©èµ„åœºæ™¯æ’ç”»
                quality: "standard", // æˆ– "hd" (DALL-E 3)
                // éƒ¨åˆ†æœåŠ¡å•†å¯èƒ½éœ€è¦å…¶ä»–å‚æ•°ï¼Œå¦‚ 'style', 'negative_prompt' ç­‰
            };

            try {
                console.log(`ğŸ–¼ï¸ æ­£åœ¨è¯·æ±‚ç”Ÿæˆç‰©èµ„â€œ${name}â€çš„å›¾ç‰‡...`);

                const response = await fetch(IMG_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // æˆæƒæ–¹å¼å› æœåŠ¡å•†è€Œå¼‚ï¼Œè¯·æŸ¥é˜…æ–‡æ¡£
                        'Authorization': `Bearer ${IMG_API_KEY}`,
                        // ä¹Ÿå¯èƒ½æ˜¯: 'api-key': IMG_API_KEY
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`ç”Ÿå›¾APIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`);
                }

                const data = await response.json();
                console.log('ç”Ÿå›¾APIå®Œæ•´å“åº”:', data); // é¦–æ¬¡è°ƒè¯•æ—¶éå¸¸é‡è¦ï¼

                // **å…³é”®æ­¥éª¤ï¼šä»å“åº”ä¸­æå–å›¾ç‰‡URL**
                // ä¸åŒæœåŠ¡å•†è¿”å›çš„æ•°æ®ç»“æ„å·®å¼‚å¾ˆå¤§ï¼Œè¯·æ ¹æ®ä¸Šä¸€æ­¥console.logçš„è¾“å‡ºè¿›è¡Œè°ƒæ•´ï¼
                let imageUrl;
                
                // 1. OpenAI DALL-E æ ¼å¼
                if (data.data && data.data[0] && data.data[0].url) {
                    imageUrl = data.data[0].url;
                }
                // 2. æŸäº›æœåŠ¡å•†å¯èƒ½ç›´æ¥è¿”å›ä¸€ä¸ªurlå­—æ®µ
                else if (data.url) {
                    imageUrl = data.url;
                }
                // 3. æŸäº›è¿”å›Base64ç¼–ç çš„å›¾ç‰‡æ•°æ®
                else if (data.data && data.data[0] && data.data[0].b64_json) {
                    // éœ€è¦å°†base64è½¬æ¢ä¸ºå¯ç›´æ¥æ˜¾ç¤ºçš„URL
                    imageUrl = `data:image/png;base64,${data.data[0].b64_json}`;
                }
                // 4. å…¶ä»–æ ¼å¼...
                else {
                    // å¦‚æœéƒ½ä¸åŒ¹é…ï¼ŒæŠ›å‡ºé”™è¯¯å¹¶æ‰“å°æ•°æ®ç»“æ„ä»¥ä¾¿è°ƒè¯•
                    console.warn('æ— æ³•è¯†åˆ«çš„å“åº”æ ¼å¼ï¼Œå°è¯•å…¶ä»–è·¯å¾„...', data);
                    // å¯ä»¥å°è¯•æ·±å…¥æŒ–æ˜å“åº”ï¼Œä¾‹å¦‚ data.images[0].url
                    // è¯·æ ¹æ®ä½ å®é™…ä½¿ç”¨çš„æœåŠ¡å•†æ–‡æ¡£ä¿®æ”¹æ­¤å¤„
                    throw new Error('æ— æ³•ä»å“åº”ä¸­è§£æå›¾ç‰‡URLï¼Œè¯·æ£€æŸ¥æ•°æ®ç»“æ„ã€‚');
                }

                // å°†å›¾ç‰‡URLæ’å…¥åˆ°é¡µé¢ä¸­
                placeholder.innerHTML = `
                    <img src="${imageUrl}" 
                        class="word-image" 
                        alt="${name}" 
                        style="width:100%; border-radius:10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);"
                        onerror="this.onerror=null; this.parentElement.innerHTML='<p style=\'color:red;\'>âš ï¸ å›¾ç‰‡åŠ è½½å¤±è´¥</p>';">
                        <!-- è¿™é‡Œä¸å†é‡å¤æ–‡å­—æ ‡ç­¾ï¼Œçº¯å›¾åƒå±•ç¤º -->
                `;

            } catch (error) {
                console.error('âŒ ç”Ÿå›¾å¤±è´¥:', error);
                // ä¼˜é›…é™çº§ï¼šæ˜¾ç¤ºä¸€ä¸ªç¾è§‚çš„å ä½ç¬¦ï¼Œè€Œä¸æ˜¯è®©ç•Œé¢å´©æºƒ
                placeholder.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 10px; color: white;">
                        <div style="font-size: 48px;">ğŸ¨</div>
                        <p><strong>â€œ${word}â€</strong></p>
                        <p>è§†è§‰æ¦‚å¿µå·²æ„ŸçŸ¥ï¼Œä½†æœªèƒ½å…·ç°åŒ–ã€‚</p>
                        <p style="font-size:0.7em; margin-top:10px;">ï¼ˆæŠ€æœ¯åŸå› : ${error.message}ï¼‰</p>
                    </div>
                `;
            }
        }
        
        // ============== å·¥å…·å‡½æ•° ==============
        function resetSlots() {
            // å–æ¶ˆåˆæˆæ§½ä½ç‰©èµ„çš„ä½¿ç”¨æ ‡è®°
            selectedWords.forEach(word => {
                if (word) {
                    usedWordIds.delete(word.id);
                }
            });
            selectedWords = [null, null];
            // åªé‡ç½®åˆæˆæ§½ä½
            const slot1 = document.getElementById('slot1');
            const slot2 = document.getElementById('slot2');
            if (slot1) {
                slot1.innerHTML = 'æ‹–æ”¾ç‰©èµ„';
                slot1.style.background = 'rgba(255, 255, 255, 0.05)';
                slot1.style.borderColor = '#f72585';
            }
            if (slot2) {
                slot2.innerHTML = 'æ‹–æ”¾ç‰©èµ„';
                slot2.style.background = 'rgba(255, 255, 255, 0.05)';
                slot2.style.borderColor = '#f72585';
            }
        }
        
        // æ¸…ç©ºè¡ŒåŠ¨æ§½ä½ï¼ˆä¸æ‰§è¡Œè¡ŒåŠ¨åçš„æ¸…ç©ºé€»è¾‘ä¸€è‡´ï¼‰
        function resetActionSlot() {
            // å–æ¶ˆè¡ŒåŠ¨æ§½ä½ç‰©èµ„çš„ä½¿ç”¨æ ‡è®°
            if (actionSlotItem) {
                usedWordIds.delete(actionSlotItem.id);
            }
            actionSlotItem = null;
            
            const actionSlot = document.getElementById('action-slot');
            if (actionSlot) {
                actionSlot.innerHTML = 'æ‹–æ”¾ç‰©èµ„åˆ°æ­¤å¤„';
            }
            
            const menuEl = document.getElementById('action-menu');
            if (menuEl) {
                menuEl.style.display = 'none';
                menuEl.innerHTML = '';
            }
        }
        
        // ============== æŒ‘æˆ˜æè¿°ä¸åœºæ™¯å›¾ç”Ÿæˆ ==============
        async function generateChallengeNarrativeAndImage(challenge) {
            // å¦‚æœå·²ç»æœ‰æè¿°åˆ™ä¸é‡å¤ç”Ÿæˆ
            if (!challenge || (challenge.description && challenge.description.length > 0)) {
                if (challenge && challenge.description) {
                    document.getElementById('challenge-text').textContent = challenge.title + " - " + challenge.description;
                }
                return;
            }

            const challengeTextEl = document.getElementById('challenge-text');
            const imageContainer = document.getElementById('challenge-image');
            if (imageContainer) {
                imageContainer.innerHTML = `
                    <div style="text-align:center; padding:10px;">
                        <div class="spinner"></div>
                        <p>ğŸ¨ æ­£åœ¨æƒ³è±¡è¿™ä¸€å¹•è’å²›åœºæ™¯...</p>
                    </div>
                `;
            }

            try {
                const response = await fetch(LLM_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${LLM_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: LLM_MODEL_NAME,
                        messages: [
                            {
                                role: "system",
                                content: `ä½ æ˜¯ä¸€ä¸ªæ–‡å­—å™äº‹è®¾è®¡å¸ˆï¼Œè´Ÿè´£ä¸ºâ€œè’å²›æ±‚ç”Ÿâ€æ¸¸æˆå†™å…³å¡æè¿°ã€‚
                                è¯·ç”¨ç´§å¼ ä½†ä¸è¡€è…¥çš„ç¬”è§¦ï¼Œæå†™ä¸€æ®µ2-4å¥çš„ä¸­æ–‡åœºæ™¯æ–‡å­—ã€‚
                                åªè¿”å›çº¯æ–‡æœ¬ï¼Œä¸è¦è§£é‡Šã€‚`
                            },
                            {
                                role: "user",
                                content: `å…³å¡æ ‡é¢˜ï¼š${challenge.title}
                                èƒŒæ™¯æç¤ºï¼š${challenge.solutionHint}
                                è¯·å†™å‡ºè¿™ä¸€æŒ‘æˆ˜å‘ç”Ÿæ—¶çš„å…·ä½“ç¯å¢ƒä¸å±æœºç”»é¢ã€‚`
                            }
                        ],
                        temperature: 0.8
                    })
                });

                if (!response.ok) throw new Error(`ç”ŸæˆæŒ‘æˆ˜æè¿°å¤±è´¥: ${response.status}`);
                const data = await response.json();
                const text = data.choices && data.choices[0] && data.choices[0].message
                    ? data.choices[0].message.content.trim()
                    : 'ä¸€åœºçªå¦‚å…¶æ¥çš„å±æœºæ­£å‘ä½ é€¼è¿‘ã€‚';

                challenge.description = text;
                if (challengeTextEl) {
                    challengeTextEl.textContent = challenge.title + " - " + challenge.description;
                }

                // ä½¿ç”¨ç”Ÿå›¾APIä¸ºå½“å‰æŒ‘æˆ˜ç”Ÿæˆåœºæ™¯å›¾
                if (imageContainer) {
                    const placeholderId = 'challenge-scene-image';
                    imageContainer.innerHTML = `<div id="${placeholderId}"></div>`;
                    generateAndDisplayImage(challenge.title, challenge.description, placeholderId);
                }
            } catch (e) {
                console.error('ç”ŸæˆæŒ‘æˆ˜æè¿°æˆ–å›¾ç‰‡å¤±è´¥ï¼š', e);
                if (challengeTextEl) {
                    challengeTextEl.textContent = challenge.title + " - " + (challenge.description || "ä¸€åœºå±é™©æ­£åœ¨é€¼è¿‘ï¼Œä½ å¿…é¡»è¿…é€Ÿåšå‡ºé€‰æ‹©ã€‚");
                }
                if (imageContainer) {
                    imageContainer.innerHTML = '';
                }
            }
        }
        
        // é€šè¿‡æŒ‘æˆ˜åç»™äºˆå¥–åŠ±ç‰©èµ„ï¼ˆä»é…æ–¹è¡¨ä¸­éšæœºé€‰æ‹©ï¼‰
        function grantAiRewardItem(completedChallengeIndex) {
            try {
                // æ ¹æ®å®Œæˆçš„æŒ‘æˆ˜ç´¢å¼•å†³å®šå¥–åŠ±ç­‰çº§
                // ç¬¬ä¸€ä¸ªæŒ‘æˆ˜ï¼ˆindex 0ï¼‰è¿‡åç»™2çº§ç‰©èµ„
                // ç¬¬äºŒã€ä¸‰æŒ‘æˆ˜ï¼ˆindex 1, 2ï¼‰è¿‡åç»™3çº§ç‰©èµ„
                let rewardLevel;
                if (completedChallengeIndex === 0) {
                    rewardLevel = 2; // ç¬¬ä¸€ä¸ªæŒ‘æˆ˜åç»™2çº§ç‰©èµ„
                } else if (completedChallengeIndex === 1 || completedChallengeIndex === 2) {
                    rewardLevel = 3; // ç¬¬äºŒã€ä¸‰æŒ‘æˆ˜åç»™3çº§ç‰©èµ„
                } else {
                    // ç¬¬å››ä¸ªæŒ‘æˆ˜ï¼ˆæœ€ç»ˆæŒ‘æˆ˜ï¼‰ä¸ç»™å¥–åŠ±ï¼Œå› ä¸ºæ¸¸æˆç»“æŸ
                    return;
                }
                
                // ä»MATERIAL_DATABASEä¸­ç­›é€‰å‡ºå¯¹åº”ç­‰çº§çš„æ‰€æœ‰ç‰©èµ„
                const availableItems = Object.entries(MATERIAL_DATABASE)
                    .filter(([name, info]) => info.level === rewardLevel);
                
                if (availableItems.length === 0) {
                    console.error(`æ‰¾ä¸åˆ° Lv${rewardLevel} çš„ç‰©èµ„ä½œä¸ºå¥–åŠ±`);
                    return;
                }
                
                // éšæœºé€‰æ‹©ä¸€ä¸ªç‰©èµ„
                const [itemName, itemInfo] = availableItems[Math.floor(Math.random() * availableItems.length)];
                
                // æ£€æŸ¥æ˜¯å¦å·²æ‹¥æœ‰è¯¥ç‰©èµ„ï¼ˆå¦‚æœå·²æ‹¥æœ‰ï¼Œå¯ä»¥é€‰æ‹©å¦ä¸€ä¸ªï¼‰
                if (!playerWords.some(w => w.text === itemName)) {
                    const newWord = {
                        id: getNextWordId(),
                        text: itemName,
                        emoji: itemInfo.emoji,
                        tag: itemInfo.tag,
                        level: itemInfo.level,
                        usesLeft: defaultUses(itemInfo.tag)
                    };
                    playerWords.push(newWord);
                    renderWordInventory();
                    setTimeout(() => {
                        alert(`ğŸ‰ é€šè¿‡æŒ‘æˆ˜ï¼Œä½ è·å¾—äº†æ–°çš„ç‰©èµ„ï¼šã€${newWord.text}ã€‘(Lv${newWord.level}Â·${tagLabel(newWord.tag)})ï¼`);
                    }, 400);
                } else {
                    // å¦‚æœå·²æ‹¥æœ‰ï¼Œå°è¯•é€‰æ‹©å¦ä¸€ä¸ª
                    const otherItems = availableItems.filter(([name]) => !playerWords.some(w => w.text === name));
                    if (otherItems.length > 0) {
                        const [otherName, otherInfo] = otherItems[Math.floor(Math.random() * otherItems.length)];
                        const newWord = {
                            id: getNextWordId(),
                            text: otherName,
                            emoji: otherInfo.emoji,
                            tag: otherInfo.tag,
                            level: otherInfo.level,
                            usesLeft: defaultUses(otherInfo.tag)
                        };
                        playerWords.push(newWord);
                        renderWordInventory();
                        setTimeout(() => {
                            alert(`ğŸ‰ é€šè¿‡æŒ‘æˆ˜ï¼Œä½ è·å¾—äº†æ–°çš„ç‰©èµ„ï¼šã€${newWord.text}ã€‘(Lv${newWord.level}Â·${tagLabel(newWord.tag)})ï¼`);
                        }, 400);
                    } else {
                        // å¦‚æœæ‰€æœ‰è¯¥ç­‰çº§çš„ç‰©èµ„éƒ½å·²æ‹¥æœ‰ï¼Œä»ç„¶ç»™äºˆä¸€ä¸ªï¼ˆå…è®¸é‡å¤ï¼‰
                        const newWord = {
                            id: getNextWordId(),
                            text: itemName,
                            emoji: itemInfo.emoji,
                            tag: itemInfo.tag,
                            level: itemInfo.level,
                            usesLeft: defaultUses(itemInfo.tag)
                        };
                        playerWords.push(newWord);
                        renderWordInventory();
                        setTimeout(() => {
                            alert(`ğŸ‰ é€šè¿‡æŒ‘æˆ˜ï¼Œä½ è·å¾—äº†æ–°çš„ç‰©èµ„ï¼šã€${newWord.text}ã€‘(Lv${newWord.level}Â·${tagLabel(newWord.tag)})ï¼`);
                        }, 400);
                    }
                }
            } catch (e) {
                console.error('å¥–åŠ±ç‰©èµ„ç”Ÿæˆå¤±è´¥ï¼š', e);
            }
        }

        // ============== å¯»æ‰¾åŸææ–™åŠŸèƒ½ ==============
        async function findRawMaterial(locationId) {
            // æ£€æŸ¥è¡ŒåŠ¨ç‚¹
            if (actionPoints <= 0) {
                alert('ä»Šæ—¥è¡ŒåŠ¨ç‚¹å·²ç”¨å®Œ');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²æ­»äº¡
            if (isDead()) {
                alert('ä½ å·²æ— æ³•ç»§ç»­è¡ŒåŠ¨');
                return;
            }

            // æ£€æŸ¥åœ°ç‚¹æ˜¯å¦è§£é”
            const location = LOCATIONS[locationId];
            if (!location || !location.unlocked) {
                alert('è¯¥åœ°ç‚¹å°šæœªè§£é”ï¼');
                return;
            }

            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            const btn = document.getElementById(`location-btn-${locationId}`);
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = 'â³ å¯»æ‰¾ä¸­...';
                btn.style.opacity = '0.6';
                btn.style.cursor = 'not-allowed';
            }

            try {
                // æ ¹æ®ä¸åŒåœ°ç‚¹å†³å®šç‰©èµ„æ¦‚ç‡
                let materialLevel, itemType, typeName;
                
                if (locationId === 'forest') {
                    // é›¨æ—ï¼š60% Lv1, 30% Lv2, 10% Lv3ï¼›70%åŸææ–™ï¼Œ30%é£Ÿç‰©
                    const randLevel = Math.random();
                    if (randLevel < 0.6) {
                        materialLevel = 1;
                    } else if (randLevel < 0.9) {
                        materialLevel = 2;
                    } else {
                        materialLevel = 3;
                    }
                    const randType = Math.random();
                    itemType = randType < 0.7 ? 'material' : 'food';
                    typeName = itemType === 'material' ? 'åŸææ–™' : 'é£Ÿç‰©';
                } else if (locationId === 'beach') {
                    // æµ·è¾¹ï¼š50% Lv1, 40% Lv2, 10% Lv3ï¼›æ›´å¤šé£Ÿç‰©ï¼ˆè´å£³ã€æµ·è‰ç­‰ï¼‰
                    const randLevel = Math.random();
                    if (randLevel < 0.5) {
                        materialLevel = 1;
                    } else if (randLevel < 0.9) {
                        materialLevel = 2;
                    } else {
                        materialLevel = 3;
                    }
                    const randType = Math.random();
                    itemType = randType < 0.6 ? 'food' : 'material'; // æµ·è¾¹æ›´å¤šé£Ÿç‰©
                    typeName = itemType === 'material' ? 'åŸææ–™' : 'é£Ÿç‰©';
                } else if (locationId === 'cave') {
                    // å±±æ´ï¼š30% Lv1, 50% Lv2, 20% Lv3ï¼›æ›´å¤šåŸææ–™ï¼ˆçŸ³å¤´ã€æœ¨ç‚­ç­‰ï¼‰
                    const randLevel = Math.random();
                    if (randLevel < 0.3) {
                        materialLevel = 1;
                    } else if (randLevel < 0.8) {
                        materialLevel = 2;
                    } else {
                        materialLevel = 3;
                    }
                    const randType = Math.random();
                    itemType = randType < 0.7 ? 'material' : 'food'; // å±±æ´æ›´å¤šåŸææ–™
                    typeName = itemType === 'material' ? 'åŸææ–™' : 'é£Ÿç‰©';
                }

                // ä»MATERIAL_DATABASEä¸­ç­›é€‰ç¬¦åˆç­‰çº§å’Œç±»å‹çš„ç‰©èµ„
                // ä¼˜å…ˆä»åœ°ç‚¹åå¥½åˆ—è¡¨ä¸­ç­›é€‰
                const preferredItems = location.preferredItems || [];
                const allAvailableItems = Object.entries(MATERIAL_DATABASE)
                    .filter(([name, info]) => 
                        info.level === materialLevel && 
                        info.tag === itemType
                    );
                
                // ç­›é€‰åå¥½ç‰©å“
                const preferredAvailable = allAvailableItems.filter(([name, info]) => 
                    preferredItems.includes(name)
                );
                
                // å¦‚æœåå¥½åˆ—è¡¨ä¸­æœ‰ç¬¦åˆæ¡ä»¶çš„ï¼Œä¼˜å…ˆé€‰æ‹©ï¼›å¦åˆ™ä»æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„ç‰©èµ„ä¸­éšæœºé€‰æ‹©
                const availableItems = preferredAvailable.length > 0 ? preferredAvailable : allAvailableItems;
                
                if (availableItems.length === 0) {
                    throw new Error(`æ‰¾ä¸åˆ° Lv${materialLevel} çš„${typeName}ç±»ç‰©èµ„`);
                }
                
                // éšæœºé€‰æ‹©ä¸€ä¸ªç‰©èµ„
                const [itemName, itemInfo] = availableItems[Math.floor(Math.random() * availableItems.length)];
                const name = itemName;
                const emoji = itemInfo.emoji;

                // è°ƒç”¨AIç”Ÿæˆæè¿°ï¼ˆåªç”Ÿæˆæè¿°ï¼Œä¸ç”Ÿæˆç‰©èµ„åç§°ï¼‰
                let description = 'ä½ åœ¨æ¢ç´¢ä¸­æ‰¾åˆ°äº†è¿™ä¸ªç‰©èµ„ã€‚';
                try {
                    const response = await fetch(LLM_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${LLM_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: LLM_MODEL_NAME,
                            messages: [
                                {
                                    role: "system",
                                    content: `ä½ æ˜¯ä¸€ä¸ªè’å²›æ±‚ç”Ÿæ¸¸æˆçš„å™äº‹è€…ã€‚
è¯·æ ¹æ®ç©å®¶åœ¨ã€${location.name}ã€‘æ¢ç´¢çš„åœºæ™¯ï¼Œç”Ÿæˆä¸€æ®µç®€çŸ­æè¿°ï¼ˆ1-2å¥è¯ï¼‰ï¼Œæè¿°ç©å®¶å¦‚ä½•æ‰¾åˆ°ã€${name}ã€‘è¿™ä¸ªç‰©èµ„ã€‚
è¦æ±‚ï¼šè¯­è¨€ç®€æ´æœ‰åŠ›ï¼Œæœ‰ä»£å…¥æ„Ÿï¼Œç¬¦åˆè’å²›æ±‚ç”Ÿçš„æ°›å›´ï¼Œè¦ä½“ç°ã€${location.name}ã€‘çš„ç¯å¢ƒç‰¹ç‚¹ã€‚
è¿”å›JSONæ ¼å¼ï¼š
{
  "description": "ç®€çŸ­æè¿°ç©å®¶å¦‚ä½•åœ¨${location.name}æ‰¾åˆ°è¿™ä¸ªç‰©èµ„ï¼ˆ1-2å¥è¯ï¼‰"
}`
                                },
                                {
                                    role: "user",
                                    content: `å½“å‰ç¬¬ ${currentDay} å¤©ï¼Œç©å®¶åœ¨ã€${location.name}ã€‘æ‰¾åˆ°äº†ã€${name}ã€‘(Lv${materialLevel}Â·${typeName})ã€‚è¯·ç”Ÿæˆä¸€æ®µæè¿°ã€‚`
                                }
                            ],
                            temperature: 0.8,
                            response_format: { "type": "json_object" }
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const parsed = JSON.parse(data.choices[0].message.content);
                        description = parsed.description || description;
                    }
                } catch (e) {
                    console.warn('ç”Ÿæˆæè¿°å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æè¿°:', e);
                }

                // åˆ›å»ºæ–°ç‰©èµ„
                const newWord = {
                    id: getNextWordId(),
                    text: name,
                    emoji: emoji,
                    tag: itemType,
                    level: materialLevel,
                    usesLeft: defaultUses(itemType)
                };

                // æ·»åŠ åˆ°èµ„æºåº“
                playerWords.push(newWord);
                renderWordInventory();

                // æ¶ˆè€—è¡ŒåŠ¨ç‚¹
                actionPoints -= 1;
                updateDayAndActionUI();

                // æ˜¾ç¤ºç»“æœ
                const resultsDiv = document.getElementById('fusion-results');
                if (resultsDiv) {
                    const resultCard = document.createElement('div');
                    resultCard.className = 'result-card';
                    resultCard.style.borderLeftColor = '#4cc9f0';
                    resultCard.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 24px;">${location.emoji}</span>
                            <span style="font-size: 18px; font-weight: 500;">${location.name} - å¯»æ‰¾ç‰©èµ„</span>
                        </div>
                        <p style="margin-bottom: 8px;">
                            <strong>è·å¾—ç‰©èµ„ï¼š</strong>${emoji} ${name} (Lv${materialLevel}Â·${tagLabel(itemType)})
                        </p>
                        <div style="margin-top: 8px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                            <p style="line-height: 1.6;"><strong>è¡ŒåŠ¨è¿‡ç¨‹ï¼š</strong>${description}</p>
                        </div>
                        <div style="text-align: right; font-size: 12px; opacity: 0.7; margin-top: 8px;">
                            ${new Date().toLocaleTimeString()}
                        </div>
                    `;
                    resultsDiv.prepend(resultCard);
                    resultsDiv.scrollTop = 0;
                }

            } catch (e) {
                console.error('å¯»æ‰¾åŸææ–™å¤±è´¥ï¼š', e);
                alert('å¯»æ‰¾åŸææ–™å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (btn) {
                    btn.disabled = false;
                    if (location && location.unlocked) {
                        btn.innerHTML = `${location.emoji} ${location.name} ( 1âš¡)`;
                    } else {
                        btn.innerHTML = originalText;
                    }
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            }
        }
        
        // ============== æ¸¸æˆç»“æŸä¸æ€§æ ¼è¯„è¯­ ==============
        function calcFinalScore() {
            // ç®€å•è¯„åˆ†ï¼šå½“å‰ä¸¤é¡¹å¹³å‡å€¼ + åˆæˆæ¬¡æ•°å¥–åŠ±
            const avgStat = survival;
            const fusionScore = fusionResults.length * 5;
            return Math.round(avgStat + fusionScore);
        }

        async function generateEndingSummary(success) {
            const endingEl = document.getElementById('ending-summary') || document.getElementById('room-display');
            if (!endingEl) return;

            const score = calcFinalScore();
            const inventoryText = playerWords.map(w => w.text).join('ã€');
            const craftedItemsText = fusionResults
                .map(r => r.itemName || '')
                .filter(Boolean)
                .join('ã€');

            try {
                const response = await fetch(LLM_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${LLM_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: LLM_MODEL_NAME,
                        messages: [
                            {
                                role: "system",
                                content: `ä½ æ˜¯ä¸€ä¸ªå¸¦ç‚¹æ¸©æŸ”æ¯’èˆŒé£æ ¼çš„â€œè’å²›æ±‚ç”Ÿæ€§æ ¼æµ‹è¯•â€è§£è¯»è€…ã€‚
                                è¯·æ ¹æ®ç©å®¶åœ¨è’å²›ä¸Šã€åˆæˆå‡ºæ¥çš„ç‰©èµ„ã€‘ä»¥åŠæ•´ä½“èµ„æºé€‰æ‹©å€¾å‘ï¼Œä¸ºTAç”Ÿæˆä¸€æ®µç®€çŸ­çš„æ€§æ ¼è§£è¯»ã€‚
                                ç‰¹åˆ«æ³¨æ„ï¼šè¯·ä¼˜å…ˆä»ä»¥ä¸‹æ–¹é¢æ¥æ€»ç»“ï¼š
                                - ä»–æ›´åå‘å“ªç§ç”Ÿå­˜é£æ ¼ï¼Ÿä¾‹å¦‚ï¼šå–œæ¬¢é€ å·¥å…·ã€å›¤é£Ÿç‰©ã€å¼ºåŒ–åº‡æŠ¤ã€é˜²å¾¡ä¸ºä¸»ç­‰ã€‚
                                - è¿™äº›ç‰©èµ„èƒŒåä½“ç°çš„æ˜¯è°¨æ…ã€å†’é™©ã€åˆ›é€ åŠ›ã€æœªé›¨ç»¸ç¼ªï¼Œè¿˜æ˜¯â€œèººå¹³ä½›ç³»â€ç­‰æ€§æ ¼ç‰¹å¾ï¼Ÿ
                                - å¯ä»¥é€‚å½“å¼•ç”¨ä¸€ä¸¤ä¸ªå…·ä½“ç‰©èµ„ä½œä¸ºä¾‹å­ï¼ˆä¾‹å¦‚â€œä½ é€ äº†ä¸€å †æ­¦å™¨ï¼Œå´å¿˜äº†å¤šå‡†å¤‡ç‚¹æ°´â€ï¼‰ã€‚
                                è¿”å›JSONï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
                                {
                                    "title": "ä¸€å¥æ¦‚æ‹¬æ€§çš„è¯„ä»·ï¼ˆå¯ä»¥æœ‰ä¸€ç‚¹ç‚¹æ¯’èˆŒï¼‰",
                                    "persona": "2-3å¥è¯çš„äººæ ¼æè¿°ï¼Œè¯­æ°”è½»æ¾å¹½é»˜ï¼Œè¦å°½é‡ç»“åˆå…·ä½“ç‰©èµ„æ¥ä¸¾ä¾‹",
                                    "advice": "ä¸€æ¡ç®€çŸ­çš„äººç”Ÿ/å¤„ä¸–å»ºè®®ï¼Œå¯ä»¥å‚è€ƒTAåœ¨è’å²›ä¸Šçš„åå¥½"
                                }`
                            },
                            {
                                role: "user",
                                content: `é€šå…³çŠ¶æ€ï¼š${success ? 'æˆåŠŸè·æ•‘' : 'æœªèƒ½åšæŒåˆ°æœ€å'}
                                æœ€ç»ˆè¯„åˆ†ï¼š${score}
                                èµ„æºåº“ä¸­å¸¸è§ç‰©èµ„ï¼š${inventoryText}
                                åˆæˆå‡ºæ¥çš„ä»£è¡¨æ€§ç‰©èµ„ï¼š${craftedItemsText || 'æœ¬å±€å‡ ä¹æ²¡æœ‰æˆåŠŸåˆæˆæ–°çš„ç‰©èµ„'}
                                å½“å‰åŸºç¡€æ•°å€¼ï¼šsurvival=${survival}, shelterDurability=${shelterDurability}`
                            }
                        ],
                        temperature: 0.7,
                        response_format: { "type": "json_object" }
                    })
                });

                if (!response.ok) throw new Error(`ç”Ÿæˆç»“å±€è¯„è¯­å¤±è´¥: ${response.status}`);
                const data = await response.json();
                const parsed = JSON.parse(data.choices[0].message.content);

                if (endingEl.id === 'ending-summary') {
                    endingEl.innerHTML = `
                        <div style="padding:16px; background:rgba(15,23,42,0.7); border-radius:12px; text-align:left;">
                            <p><strong>æœ€ç»ˆè¯„åˆ†ï¼š</strong><span style="color:#4cc9f0;">${score}</span></p>
                            <p><strong>${parsed.title || 'ä½ çš„è’å²›äººæ ¼'}</strong></p>
                            <p style="margin-top:6px;">${parsed.persona || ''}</p>
                            <p style="margin-top:6px; font-size:0.9em; opacity:0.9;"><strong>ç»™ä½ çš„å»ºè®®ï¼š</strong>${parsed.advice || ''}</p>
                        </div>
                    `;
                } else {
                    // å¤±è´¥æ—¶å¯èƒ½ç›´æ¥è¦†ç›–æˆ¿é—´å†…å®¹
                    const extra = document.createElement('div');
                    extra.innerHTML = `
                        <div style="margin-top:16px; padding:16px; background:rgba(15,23,42,0.7); border-radius:12px; text-align:left;">
                            <p><strong>æœ€ç»ˆè¯„åˆ†ï¼š</strong><span style="color:#4cc9f0;">${score}</span></p>
                            <p><strong>${parsed.title || 'ä½ çš„è’å²›äººæ ¼'}</strong></p>
                            <p style="margin-top:6px;">${parsed.persona || ''}</p>
                            <p style="margin-top:6px; font-size:0.9em; opacity:0.9;"><strong>ç»™ä½ çš„å»ºè®®ï¼š</strong>${parsed.advice || ''}</p>
                        </div>
                    `;
                    endingEl.appendChild(extra);
                }
            } catch (e) {
                console.error('ç”Ÿæˆæ€§æ ¼è¯„è¯­å¤±è´¥ï¼š', e);
                if (endingEl.id === 'ending-summary') {
                    endingEl.innerHTML = `<p>æœ€ç»ˆè¯„åˆ†ï¼š${score}ã€‚ä½ åœ¨æç«¯ç¯å¢ƒä¸­çš„è¡¨ç°ï¼Œå·²ç»è¯´æ˜ä½ æ˜¯ä¸€ä¸ªæœ‰æ•…äº‹çš„äººã€‚</p>`;
                }
            }
        }

        function showGameOverScreen(reasonText) {
            const roomDisplay = document.getElementById('room-display');
            if (!roomDisplay) return;

            roomDisplay.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 80px; margin-bottom: 20px;">ğŸ’€</div>
                    <h2 style="color: #f87171;">è’å²›æ±‚ç”Ÿå¤±è´¥</h2>
                    <p style="margin-top:10px;">${reasonText}</p>
                    <div id="ending-summary" style="margin-top:20px;"></div>
                    <div style="margin: 30px 0;">
                        <button onclick="location.reload()" style="
                            background: linear-gradient(45deg, #ef4444, #b91c1c);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 25px;
                            font-size: 18px;
                            cursor: pointer;
                            margin: 10px;
                        ">é‡æ–°å¼€å§‹</button>
                    </div>
                </div>
            `;

            // ç”Ÿæˆå¤±è´¥ç»“å±€çš„æ€§æ ¼è¯„è¯­
            generateEndingSummary(false);
        }
        
        // ============== æ¯æ—¥ç»“ç®—ä¸å›ºå®šå¤§äº‹ä»¶ ==============
        function logDayEventToResults(title, description) {
            const resultsDiv = document.getElementById('fusion-results');
            if (!resultsDiv) return;
            const card = document.createElement('div');
            card.className = 'result-card';
            card.innerHTML = `
                <h4 style="margin:0 0 6px 0; color:#fbbf24;">${title}</h4>
                <p style="margin:0 0 4px 0; font-size:0.95em;">${description}</p>
                <div style="text-align:right; font-size:12px; opacity:0.7;">ç¬¬ ${currentDay} å¤©</div>
            `;
            resultsDiv.prepend(card);
        }

        function countItemsByTag(tag, minLevel = 1) {
            return playerWords.filter(w => w.tag === tag && (w.level || 1) >= minLevel).length;
        }

        async function resolveMajorEventForDay(day) {
            if (isDead()) return;
            
            // æŸ¥æ‰¾å¯¹åº”å¤©æ•°çš„æŒ‘æˆ˜
            const challenge = challenges.find(c => c.day === day);
            if (!challenge) {
                // æ™®é€šæ—¥å­ï¼šè½»å¾®æ¶ˆè€—æè¿°
                logDayEventToResults("å¹³é™çš„ä¸€å¤©",
                    "è¿™ä¸€å¤©æ²¡æœ‰å‘ç”Ÿä»€ä¹ˆå¤§äº‹ï¼Œä½ åªæ˜¯åå¤æ£€æŸ¥è¥åœ°ã€æ‘†å¼„æ‰‹ä¸­çš„å·¥å…·ï¼Œè¯•å›¾è®©è‡ªå·±çœ‹èµ·æ¥æ²¡é‚£ä¹ˆæ— åŠ©ã€‚");
                return;
            }
            
            // å¦‚æœæŒ‘æˆ˜å·²ç»å®Œæˆï¼ˆåœ¨å®Œæˆæ—¶å·²ç»“ç®—ï¼‰ï¼Œåˆ™ä¸å†å¤„ç†
            if (challenge.solved) {
                return;
            }
            
            // å¦‚æœæŒ‘æˆ˜æœªå®Œæˆï¼Œåœ¨æ¯æ—¥ç»“ç®—æ—¶åˆ¤å®šä¸ºå¤±è´¥
            const progressInfo = checkChallengeProgress(challenge);
            const success = progressInfo.completed;
            
            // å¦‚æœæŒ‘æˆ˜æœªå®Œæˆï¼ŒæŒ‰å¤±è´¥å¤„ç†
            if (!success) {
                await resolveChallengeImmediately(challenge, false);
            }
        }

        // å¸¦IDçš„äº‹ä»¶è®°å½•å‡½æ•°
        function logDayEventToResultsWithId(title, description, cardId) {
            const resultsDiv = document.getElementById('fusion-results');
            if (!resultsDiv) return;
            const card = document.createElement('div');
            card.id = cardId;
            card.className = 'result-card';
            card.innerHTML = `
                <h4 style="margin:0 0 6px 0; color:#fbbf24;">${title}</h4>
                <p id="${cardId}-desc" style="margin:0 0 4px 0; font-size:0.95em;">${description}</p>
                <div style="text-align:right; font-size:12px; opacity:0.7;">ç¬¬ ${currentDay} å¤©</div>
            `;
            resultsDiv.prepend(card);
        }

        // æ›´æ–°äº‹ä»¶æè¿°
        function updateEventDescription(cardId, newDescription) {
            const descEl = document.getElementById(cardId + '-desc');
            if (descEl) {
                descEl.textContent = newDescription;
            }
        }

        // ç”ŸæˆæŒ‘æˆ˜æè¿°
        async function generateChallengeDescription(challengeTitle, success, allItems, statChanges) {
            try {
                const itemList = allItems.map(w => w.text).join('ã€');
                const response = await fetch(LLM_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${LLM_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: LLM_MODEL_NAME,
                        messages: [
                            {
                                role: "system",
                                content: `ä½ æ˜¯ä¸€ä¸ªè’å²›æ±‚ç”Ÿæ¸¸æˆçš„å™äº‹è€…ã€‚è¯·æ ¹æ®æŒ‘æˆ˜ç»“æœå’Œç©å®¶çš„å‡†å¤‡æƒ…å†µï¼Œç”Ÿæˆä¸€æ®µ60-100å­—çš„ç”ŸåŠ¨æè¿°ï¼Œæè¿°ç©å®¶å¦‚ä½•åº”å¯¹è¿™ä¸ªæŒ‘æˆ˜ï¼Œä»¥åŠç»“æœå¦‚ä½•ã€‚è¦æ±‚ï¼šè¯­è¨€ç®€æ´æœ‰åŠ›ï¼Œæœ‰ä»£å…¥æ„Ÿï¼Œç¬¦åˆè’å²›æ±‚ç”Ÿçš„ç´§å¼ æ°›å›´ã€‚`
                            },
                            {
                                role: "user",
                                content: `æŒ‘æˆ˜åç§°ï¼š${challengeTitle}
æŒ‘æˆ˜ç»“æœï¼š${success ? 'æˆåŠŸåº”å¯¹' : 'åº”å¯¹å¤±è´¥'}
ç©å®¶å½“å‰æ‹¥æœ‰çš„ç‰©èµ„ï¼š${itemList || 'å‡ ä¹æ²¡æœ‰ç‰©èµ„'}
æ•°å€¼å˜åŒ–ï¼š${JSON.stringify(statChanges)}
è¯·ç”Ÿæˆä¸€æ®µç”ŸåŠ¨çš„æŒ‘æˆ˜åº”å¯¹æè¿°ã€‚`
                            }
                        ],
                        temperature: 0.8,
                        max_tokens: 200
                    })
                });
                
                if (!response.ok) throw new Error(`AIæè¿°ç”Ÿæˆå¤±è´¥: ${response.status}`);
                const data = await response.json();
                return data.choices[0].message.content.trim();
            } catch (error) {
                console.error('ç”ŸæˆæŒ‘æˆ˜æè¿°å¤±è´¥:', error);
                return null;
            }
        }

        function endDay() {
            if (isDead()) return;
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const endDayBtn = document.querySelector('button[onclick="endDay()"]');
            const originalText = endDayBtn ? endDayBtn.innerHTML : '';
            if (endDayBtn) {
                endDayBtn.disabled = true;
                endDayBtn.innerHTML = 'â³ ç»“ç®—ä¸­...';
                endDayBtn.style.opacity = '0.6';
                endDayBtn.style.cursor = 'not-allowed';
            }
            
            // æ¯å¤©ç»“æŸæ—¶çš„åŸºç¡€æ¶ˆè€—
            // æ ¹æ®åº‡æŠ¤æ‰€çŠ¶æ€å†³å®šæ‰£å‡ï¼šç³»ç»Ÿè§„å®šçš„å›ºå®šæ•°å€¼ï¼Œæœ‰åˆç†æ¢¯åº¦
            // åº‡æŠ¤æ‰€åšå›ºå€¼è¶Šé«˜ï¼Œæ‰£å‡è¶Šå°‘
            const shelter = shelterDurability || 0;
            
            // æ ¹æ®åº‡æŠ¤æ‰€åšå›ºå€¼è®¡ç®—æ‰£å‡ï¼ˆ0-100èŒƒå›´ï¼‰
            let survivalLoss;
            if (shelter >= 80) {
                // åº‡æŠ¤æ‰€å¾ˆå¥½ï¼šæ‰£å‡å¾ˆå°‘ï¼Œåˆå¹¶åä¸º-6
                survivalLoss = 6;
            } else if (shelter >= 60) {
                // åº‡æŠ¤æ‰€è¾ƒå¥½ï¼šæ‰£å‡è¾ƒå°‘ï¼Œåˆå¹¶åä¸º-10
                survivalLoss = 10;
            } else if (shelter >= 40) {
                // åº‡æŠ¤æ‰€ä¸€èˆ¬ï¼šæ‰£å‡ä¸­ç­‰ï¼Œåˆå¹¶åä¸º-14
                survivalLoss = 14;
            } else if (shelter >= 20) {
                // åº‡æŠ¤æ‰€è¾ƒå·®ï¼šæ‰£å‡è¾ƒå¤šï¼Œåˆå¹¶åä¸º-18
                survivalLoss = 18;
            } else {
                // åº‡æŠ¤æ‰€å¾ˆå·®ï¼šæ‰£å‡å¾ˆå¤šï¼Œåˆå¹¶åä¸º-26
                survivalLoss = 26;
            }
            
            // ä½¿ç”¨healthå’Œhungerå­—æ®µä»¥ä¾¿applyStatChangesæ­£ç¡®å¤„ç†
            applyStatChanges({ health: -Math.floor(survivalLoss / 2), hunger: -Math.ceil(survivalLoss / 2) });
            logDayEventToResults("æ—¥ç»ˆæ¶ˆè€—",
                `åº‡æŠ¤æ‰€åšå›ºå€¼ ${Math.round(shelterDurability)}ï¼Œæ‰£é™¤ ç”Ÿå­˜çŠ¶æ€å€¼ ${survivalLoss}`);
            if (isDead()) {
                showGameOverScreen("åœ¨æ—¥å¤ä¸€æ—¥çš„æ¶ˆè€—ä¸­ï¼Œä½ çš„èº«ä½“ç»ˆäºæ”¯æ’‘ä¸ä½ã€‚");
                return;
            }

            // è§¦å‘å½“å¤©å›ºå®šå¤§äº‹ä»¶ï¼ˆå¼‚æ­¥ï¼‰
            resolveMajorEventForDay(currentDay).then(() => {
                if (isDead()) return;
                if (currentDay >= MAX_DAY) {
                    // ç¬¬7å¤©äº‹ä»¶å·²å¤„ç†å®Œï¼Œæ— è®ºæˆè´¥æ¸¸æˆéƒ½ç»“æŸ
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    if (endDayBtn) {
                        endDayBtn.disabled = false;
                        endDayBtn.innerHTML = originalText;
                        endDayBtn.style.opacity = '1';
                        endDayBtn.style.cursor = 'pointer';
                    }
                    return;
                }

                // è¿›å…¥ä¸‹ä¸€å¤©
                currentDay += 1;
                actionPoints = 7; // æ¯å¤©å¼€å§‹æ—¶é‡ç½®ä¸º7ç‚¹
                updateDayAndActionUI();
                updateChallengeDisplay();
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (endDayBtn) {
                    endDayBtn.disabled = false;
                    endDayBtn.innerHTML = originalText;
                    endDayBtn.style.opacity = '1';
                    endDayBtn.style.cursor = 'pointer';
                }
            }).catch((error) => {
                console.error('ç»“ç®—å¤±è´¥:', error);
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (endDayBtn) {
                    endDayBtn.disabled = false;
                    endDayBtn.innerHTML = originalText;
                    endDayBtn.style.opacity = '1';
                    endDayBtn.style.cursor = 'pointer';
                }
            });
        }
        
        // ============== åˆå§‹åŒ–æ¸¸æˆ ==============
        document.addEventListener('DOMContentLoaded', initGame);
        
        // ============== æ·»åŠ ä¸€äº›äº’åŠ¨æ•ˆæœ ==============
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('word-item')) {
                // ç‚¹å‡»è¯è¯­æ—¶çš„åŠ¨ç”»
                e.target.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    e.target.style.transform = '';
                }, 150);
            }
        });

    </script>
</body>
</html>
